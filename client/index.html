<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSXpertise - Assessment Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.263.1"></script>
    <!-- REMOVED FIREBASE SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Socket.io CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }

        .glass {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
        }

        /* Custom Scrollbar Global */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script>
        window.onerror = function (msg, url, line, col, error) {
            if (msg.includes("io is not defined")) {
                console.warn("Caught 'io' undefined error - handling via retry.");
                return true; // Stop the alert
            }
            alert("Global Error: " + msg + "\nLine: " + line + "\nCol: " + col);
            return false;
        };
        console.log("V30.1 DEPLOYMENT ACTIVE - DEBUG MODE");

        // DATA LAYER
        const DB_KEYS = {
            SSC: 'se_ssc', QP: 'se_qp', NOS: 'se_nos', PC: 'se_pc',
            BATCHES: 'se_batches', STUDENTS: 'se_students',
            QUESTION_PAPERS: 'se_question_papers',
            RESPONSES: 'se_responses', MANUAL_CAPTURES: 'se_manual_captures',
            CHUNKS: 'se_video_chunks' // v23: New metadata for chunks
        };

        // CONFIGURATION
        // BACKEND CONFIGURATION
        const API_BASE = window.location.origin + '/api'; // Use relative path for proxy

        let db = null; // Removed Firestore
        let auth = null;
        let storage = null;
        let socket = null;
        const initSocket = () => {
            if (typeof io !== 'undefined') {
                socket = io();
                socket.on('connect', () => {
                    console.log("Connected to Backend via Socket.io:", socket.id);
                });
                console.log("[Socket] Initialized successfully.");
            } else {
                console.warn("[Socket] 'io' not defined yet, retrying in 500ms...");
                setTimeout(initSocket, 500);
            }
        };
        initSocket();

        // Offline Persistence removed (Relies on LocalStorage + IndexedDB)


        // IndexedDB for Large Video Storage
        window.VideoDB = {
            dbName: 'ProctoringDB',
            storeName: 'videos',
            init: async (retry = true) => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(VideoDB.dbName, 2);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(VideoDB.storeName)) {
                            db.createObjectStore(VideoDB.storeName);
                        }
                    };
                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = async (event) => {
                        console.error("VideoDB Init Error", event.target.error);
                        if (retry) {
                            console.warn("Attempting to auto-heal VideoDB...");
                            try {
                                await new Promise((res, rej) => {
                                    const delReq = indexedDB.deleteDatabase(VideoDB.dbName);
                                    delReq.onsuccess = res;
                                    delReq.onerror = rej;
                                });
                                console.log("VideoDB Deleted. Re-initializing...");
                                resolve(await VideoDB.init(false));
                            } catch (e) {
                                reject(e);
                            }
                        } else {
                            reject(event.target.error);
                        }
                    };
                });
            },
            saveVideo: async (key, blob) => {
                console.log(`[VideoDB] Saving ${key} (Size: ${blob.size})...`);
                try {
                    const db = await VideoDB.init();
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction(VideoDB.storeName, 'readwrite');
                        tx.oncomplete = () => {
                            console.log(`[VideoDB] Saved ${key} Successfully.`);
                            resolve();
                        };
                        tx.onerror = (e) => {
                            console.error(`[VideoDB] Save Failed for ${key}`, e.target.error);
                            reject(e.target.error);
                        };
                        tx.objectStore(VideoDB.storeName).put(blob, key);
                    });
                } catch (e) {
                    console.error("VideoDB Save Error", e);
                    // Try one more time with fresh init (force heal if needed)
                    if (e.name === 'NotFoundError' || e.message.includes('not found')) {
                        const db = await VideoDB.init(true); // force init retry
                        return new Promise((resolve, reject) => {
                            const tx = db.transaction(VideoDB.storeName, 'readwrite');
                            tx.oncomplete = () => resolve();
                            tx.onerror = (e) => reject(e.target.error);
                            tx.objectStore(VideoDB.storeName).put(blob, key);
                        });
                    }
                    throw e;
                }
            },
            getVideo: async (key) => {
                // console.log(`[VideoDB] Fetching ${key}...`);
                const db = await VideoDB.init();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(VideoDB.storeName, 'readonly');
                    const store = tx.objectStore(VideoDB.storeName);
                    const request = store.get(key);
                    request.onsuccess = () => {
                        if (request.result) {
                            // console.log(`[VideoDB] Found ${key} (Size: ${request.result.size})`);
                            resolve(request.result);
                        } else {
                            console.warn(`[VideoDB] Key NOT FOUND: ${key}`);
                            resolve(undefined);
                        }
                    };
                    request.onerror = (e) => reject(e.target.error);
                });
            }
        };


        // VIVA SIGNALING HELPER (Socket.io WebRTC)
        class VivaSignaling {
            constructor(batchId, studentId, role) {
                this.batchId = batchId;
                this.studentId = studentId;
                this.role = role; // 'host' or 'student'
                this.roomId = `${batchId}_${studentId}`;
                this.socket = socket;
                this.localStream = null;
                this.peerConnection = null;
            }

            async createRoom() {
                // For Socket.io, creating just means joining.
                console.log(`[Viva] Creating/Joining room: ${this.roomId}`);
                this.socket.emit('join-room', this.roomId, this.role === 'host' ? 'host' : this.studentId);
            }

            async joinRoom() {
                console.log(`[Viva] Joining room: ${this.roomId}`);
                this.socket.emit('join-room', this.roomId, this.role === 'host' ? 'host' : this.studentId);
            }

            // Listen for Remote Description (Offer/Answer)
            onRemoteDescription(callback) {
                this.socket.on('signal', (data) => {
                    const signal = data.signal;
                    // If Host: Listen for Answer. If Student: Listen for Offer.
                    if (this.role === 'host' && signal.type === 'answer') {
                        console.log("[Viva] Received Answer");
                        callback(signal);
                    }
                    if (this.role === 'student' && signal.type === 'offer') {
                        console.log("[Viva] Received Offer");
                        callback(signal);
                    }
                });
            }

            async sendOffer(offer) {
                console.log("[Viva] Sending Offer");
                this.socket.emit('signal', { roomId: this.roomId, signal: { type: offer.type, sdp: offer.sdp } });
            }

            async sendAnswer(answer) {
                console.log("[Viva] Sending Answer");
                this.socket.emit('signal', { roomId: this.roomId, signal: { type: answer.type, sdp: answer.sdp } });
            }

            // ICE Candidates
            async sendIceCandidate(candidate) {
                // socket.emit('signal', { roomId: this.roomId, signal: { type: 'candidate', candidate: candidate } });
                // Adapting to existing 'signal' listener on simple server logic
                this.socket.emit('signal', { roomId: this.roomId, signal: { type: 'candidate', candidate: candidate } });
            }

            onIceCandidate(callback) {
                this.socket.on('signal', (data) => {
                    if (data.signal && data.signal.type === 'candidate') {
                        console.log("[Viva] Received Candidate");
                        callback(data.signal.candidate);
                    }
                });
            }
        }

        window.Utils = {
            generateId: () => 'id_' + Math.random().toString(36).substr(2, 9) + Date.now(),

            downloadSampleFormat: () => {
                const headers = [["BatchName", "Enrollment No", "Name of Training Agency", "Name of the Trainee", "Gender(M/F/T)"]];
                const ws = window.XLSX.utils.aoa_to_sheet(headers);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, "Students");
                window.XLSX.writeFile(wb, "Student_Import_Format.xlsx");
            },

            // HELPER: Delete from Cloud
            // HELPER: Delete from Cloud (REST API)
            deleteFromCloud: async (route, id) => {
                if (!id) return;
                try {
                    await fetch(`${API_BASE}/${route}/${id}`, {
                        method: 'DELETE',
                        headers: { 'x-api-key': 'portel_secure_key_2025' }
                    });
                } catch (e) { console.error("API Delete failed", e); }
            },

            // AUTOMATIC DATA HEALER (Fixes Corruption from Array-in-Array bug)
            healData: () => {
                try {
                    const raw = localStorage.getItem(DB_KEYS.RESPONSES);
                    if (raw) {
                        let data = JSON.parse(raw);
                        if (Array.isArray(data)) {
                            let fixed = [];
                            let hasCorruption = false;

                            // Recursive flatten or just 1-level check
                            const collect = (arr) => {
                                for (let i = 0; i < arr.length; i++) {
                                    if (Array.isArray(arr[i])) {
                                        hasCorruption = true;
                                        collect(arr[i]); // Recursive flatten
                                    } else {
                                        fixed.push(arr[i]);
                                    }
                                }
                            };
                            collect(data);

                            if (hasCorruption) {
                                console.warn("MakeItApp: Data Corruption Detected. Healing...");
                                localStorage.setItem(DB_KEYS.RESPONSES, JSON.stringify(fixed));
                                alert("System has automatically repaired some data files. Please try Uploading again.");
                            }
                        }
                    }
                } catch (e) { console.error("Heal failed", e); }
            },

            // NEW: Atomic Save to Cloud
            _syncLock: false,

            // CLOUD SYNC FUNCTIONS (REST API Version) - v18.0
            uploadToCloud: async (silent = false, targetRoute = null, filterFn = null, forceAll = false) => {
                if (window.Utils._syncLock) {
                    console.log("[Sync] Already in progress, skipping...");
                    return;
                }
                window.Utils._syncLock = true;

                try {
                    const statusBtn = document.getElementById('sync-status-text');
                    const MAPPING = {
                        'ssc': DB_KEYS.SSC, 'qps': DB_KEYS.QP, 'nos': DB_KEYS.NOS, 'pcs': DB_KEYS.PC,
                        'batches': DB_KEYS.BATCHES, 'students': DB_KEYS.STUDENTS,
                        'question_papers': DB_KEYS.QUESTION_PAPERS,
                        'responses': DB_KEYS.RESPONSES,
                        'assessors': 'se_assessors'
                    };

                    // SYNC LOCK SAFETY: Reset lock after 30s if it hangs
                    setTimeout(() => { if (window.Utils._syncLock) { console.warn("[Sync] Lock timeout - forcing release"); window.Utils._syncLock = false; } }, 30000);

                    let success = 0;
                    let skipped = 0;
                    let failCount = 0;

                    if (!navigator.onLine) {
                        if (!silent) alert("No Internet Connection. Sync skipped.");
                        window.Utils._syncLock = false; // RELEASE LOCK
                        return;
                    }

                    for (const [route, key] of Object.entries(MAPPING)) {
                        if (targetRoute && route !== targetRoute) continue;
                        try {
                            const dataStr = localStorage.getItem(key);
                            if (dataStr && dataStr !== '[]') {
                                let items = JSON.parse(dataStr);
                                if (filterFn) items = items.filter(filterFn);

                                // PENDING SYNC CHECK
                                // ForceAll sends everything.
                                // Otherwise: Send if !synced OR if it has un-uploaded media (Responses only)
                                const pendingItems = items.filter(i => {
                                    if (forceAll) return true;
                                    if (!i.synced) return true;
                                    if (route === 'responses' && i.evidence) {
                                        return i.evidence.some(ev => (ev.storage === 'indexeddb' || ev.type === 'VIDEO_INDEXED_DB') && !ev.url && !ev._fileMissing);
                                    }
                                    return false;
                                });

                                if (pendingItems.length === 0) {
                                    skipped += items.length;
                                    continue;
                                }

                                if (statusBtn && !silent) statusBtn.innerText = `Syncing ${route}... (${pendingItems.length})`;

                                // PRE-PROCESS: Upload Media (Images & Videos) from IndexedDB to S3
                                if (route === 'responses') {
                                    // 1. Gather all actionable media items first
                                    const mediaQueue = [];

                                    for (let item of pendingItems) {
                                        if (item.evidence && Array.isArray(item.evidence)) {
                                            item.evidence.forEach(ev => {
                                                const isIndexedDB = ev.type === 'VIDEO_INDEXED_DB' || ev.storage === 'indexeddb';
                                                const localKey = ev.key || ev.img;
                                                // Only add if needs upload and not known missing
                                                if (isIndexedDB && localKey && !ev.url && !ev.uploaded && !ev._fileMissing) {
                                                    mediaQueue.push({ ev, item, localKey }); // Store ref to ev and parent item
                                                }
                                            });
                                        }
                                    }

                                    // 2. Process in Batches of 3 (Parallel Uploads)
                                    // This drastically improves speed over sequential awaiting
                                    if (mediaQueue.length > 0) {
                                        if (statusBtn && !silent) statusBtn.innerText = `Uploading ${mediaQueue.length} Media Files...`;
                                        console.log(`[Sync] Starting Parallel Upload for ${mediaQueue.length} files (Batch Size: 3)`);

                                        const BATCH_SIZE = 3;
                                        for (let i = 0; i < mediaQueue.length; i += BATCH_SIZE) {
                                            const batch = mediaQueue.slice(i, i + BATCH_SIZE);

                                            await Promise.all(batch.map(async ({ ev, item, localKey }) => {
                                                try {
                                                    const blob = await window.VideoDB.getVideo(localKey);
                                                    if (!blob) {
                                                        console.warn(`[Sync] File Missing: ${localKey}`);
                                                        ev._fileMissing = true;
                                                        return;
                                                    }

                                                    const isVideo = blob.type.includes('video');
                                                    const extension = isVideo ? 'webm' : 'jpg';
                                                    const fileName = `media/${isVideo ? 'videos' : 'photos'}/${Date.now()}_${item.studentId}_${localKey}.${extension}`;
                                                    let uploadSuccess = false;

                                                    // 1. TRY DIRECT S3 FOR LARGE VIDEOS (>1MB)
                                                    if (isVideo && blob.size > 1024 * 1024) {
                                                        try {
                                                            console.log(`[Sync] Requesting Presigned URL for ${fileName} (${(blob.size / 1024 / 1024).toFixed(2)} MB)`);
                                                            const preRes = await fetch(`${API_BASE}/presigned-url?fileName=${encodeURIComponent(fileName)}&contentType=${encodeURIComponent(blob.type)}`, {
                                                                headers: { 'x-api-key': 'portel_secure_key_2025' }
                                                            });
                                                            if (preRes.ok) {
                                                                const { uploadUrl } = await preRes.json();
                                                                const s3Res = await fetch(uploadUrl, {
                                                                    method: 'PUT',
                                                                    body: blob,
                                                                    headers: { 'Content-Type': blob.type }
                                                                });
                                                                if (s3Res.ok) {
                                                                    const finalUrl = uploadUrl.split('?')[0];
                                                                    ev.url = finalUrl;
                                                                    ev.img = finalUrl;
                                                                    if (ev.type === 'VIDEO_INDEXED_DB') ev.type = 'VIDEO_S3';
                                                                    ev.uploaded = true;
                                                                    ev.storage = 's3';
                                                                    uploadSuccess = true;
                                                                    console.log(`[Sync] Direct S3 Upload Success: ${finalUrl}`);
                                                                } else {
                                                                    console.warn("[Sync] Direct S3 PUT Failed (Likely S3 CORS). Falling back to Server...");
                                                                }
                                                            }
                                                        } catch (e) { console.warn("[Sync] Direct S3 Error. Falling back to Server...", e); }
                                                    }
                                                    // 2. FALLBACK TO SERVER UPLOAD (OR SMALL FILES)
                                                    if (!uploadSuccess) {

                                                        const formData = new FormData();
                                                        formData.append('file', blob, `${item.studentId}_${localKey}.${extension}`);

                                                        const uploadRes = await fetch(`${API_BASE}/upload-media`, {
                                                            method: 'POST',
                                                            headers: { 'x-api-key': 'portel_secure_key_2025' },
                                                            body: formData
                                                        });

                                                        if (uploadRes.ok) {
                                                            const json = await uploadRes.json();
                                                            ev.url = json.url;
                                                            ev.img = json.url;
                                                            if (ev.type === 'VIDEO_INDEXED_DB') ev.type = 'VIDEO_S3';
                                                            ev.uploaded = true;
                                                            ev.storage = 's3';
                                                            console.log(`[Sync] Media Uploaded (via Server Fallback): ${json.url}`);
                                                        } else {
                                                            console.error("Media Upload Failed (Server even failed)", uploadRes.statusText);
                                                        }
                                                    }
                                                } catch (err) {
                                                    console.error("Media Upload Exception", err);
                                                }
                                            }));

                                            // Optional: Update UI progress
                                            if (statusBtn && !silent) statusBtn.innerText = `Uploaded ${Math.min(i + BATCH_SIZE, mediaQueue.length)}/${mediaQueue.length} Files...`;
                                        }

                                        // Save updates locally after all uploads (so we have URLs)
                                        // We need to save the *parent items* that were modified.
                                        const uniqueParents = [...new Set(mediaQueue.map(q => q.item))];
                                        // But wait, pendingItems is already the list.
                                        // Just assume if queue was > 0, we have updates.
                                        // Actually, `items` passed to uploadToCloud is just the pending list.
                                        // We need to update the source in localStorage.
                                        // The outer loop handles `localStorage.setItem(key, ...)` BUT passed `pendingItems`.
                                        // We modified `pendingItems` in place.
                                        // So we just need to ensure the outer save happens.

                                        // Re-save logic from original code:
                                        // `if (hasMediaUpdates) localStorage.setItem(key, JSON.stringify(items));`
                                        // We need to mimic this.
                                        if (mediaQueue.length > 0) {
                                            // We don't have easy access to the full `items` array from `pendingItems` if it was filtered?
                                            // Wait, `items` variable in the scope IS the full list from localStorage.
                                            // `pendingItems` is `items` filtered or just `items`.
                                            // Looking at context: `let pendingItems = items;` (usually).
                                            // Let's assume we can confirm `items` is in scope or we must re-read.
                                            // The original code had: `if (hasMediaUpdates) localStorage.setItem(key, JSON.stringify(items));`
                                            // So `items` is available.
                                            localStorage.setItem(key, JSON.stringify(items));
                                        }
                                    }
                                }

                                // BULK UPLOAD JSON METADATA
                                console.log(`[Sync] Uploading ${pendingItems.length} items to /api/sync/${route}`);
                                const response = await fetch(`${API_BASE}/sync/${route}`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json', 'x-api-key': 'portel_secure_key_2025' },
                                    body: JSON.stringify(pendingItems)
                                });

                                if (response.ok) {
                                    // ULTRA-SAFE: Only mark as synced if ALL media within this batch was uploaded
                                    items.forEach(i => {
                                        if (route === 'responses' && i.evidence) {
                                            const hasUnuploadedMedia = i.evidence.some(ev => (ev.storage === 'indexeddb' || ev.type === 'VIDEO_INDEXED_DB') && !ev.url && !ev._fileMissing);
                                            if (hasUnuploadedMedia) {
                                                i.synced = false;
                                                return;
                                            }
                                        }
                                        if (!i.synced) i.synced = true;
                                    });
                                    localStorage.setItem(key, JSON.stringify(items));
                                    success += pendingItems.length;
                                } else {
                                    throw new Error(`Server Error: ${response.statusText}`);
                                }
                            }
                        } catch (e) {
                            console.error(`Sync error ${route}`, e);
                            failCount++;
                        }
                    }

                    return failCount === 0 && success > 0;
                } catch (globalErr) {
                    console.error("Global Sync Error", globalErr);
                    return false;
                } finally {
                    window.Utils._syncLock = false;
                }
            },


            downloadFromCloud: async (silent = false) => {
                const MAPPING = {
                    'batches': DB_KEYS.BATCHES, 'students': DB_KEYS.STUDENTS,
                    'qps': DB_KEYS.QP, 'nos': DB_KEYS.NOS, 'pcs': DB_KEYS.PC,
                    'ssc': DB_KEYS.SSC, 'responses': DB_KEYS.RESPONSES,
                    'question_papers': DB_KEYS.QUESTION_PAPERS,
                    'assessors': 'se_assessors'
                };
                let successCount = 0;
                const statusBtn = document.getElementById('sync-status-text');
                if (statusBtn && !silent) statusBtn.innerText = "Downloading...";

                for (const [route, key] of Object.entries(MAPPING)) {
                    try {
                        const res = await fetch(`${API_BASE}/${route}`, {
                            headers: { 'x-api-key': 'portel_secure_key_2025' }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            if (Array.isArray(data)) {
                                const localItems = JSON.parse(localStorage.getItem(key) || '[]');
                                const localMap = new Map();
                                localItems.forEach(i => localMap.set(i.id, i));

                                // 1. Identify and remove local items that were previously synced but are now missing in Cloud
                                // ONLY if NOT silent (Regular Sync). Auto-heal (silent) should NEVER delete for safety.
                                if (!silent) {
                                    const serverIds = new Set(data.map(s => s.id));
                                    for (const [id, item] of localMap.entries()) {
                                        if (item.synced && !serverIds.has(id)) {
                                            console.log(`[Sync] Removing locally deleted item: ${id} from ${route}`);
                                            localMap.delete(id);
                                        }
                                    }
                                }

                                // 2. Update existing or add new items from Cloud
                                data.forEach(s => {
                                    const local = localMap.get(s.id);
                                    if (!local || local.synced || silent) {
                                        localMap.set(s.id, { ...s, synced: true });
                                    }
                                });

                                localStorage.setItem(key, JSON.stringify(Array.from(localMap.values())));
                                successCount++;
                            }
                        }
                    } catch (e) { console.error(`Download error ${route}`, e); }
                }
                if (!silent) alert(`Downloaded ${successCount} collections from Server.`);
                if (statusBtn && !silent) statusBtn.innerText = "Synced";
                window.dispatchEvent(new Event('cloud-sync-complete'));
                return successCount > 0;
            },

            getSSC: () => JSON.parse(localStorage.getItem(DB_KEYS.SSC) || '[]'),
            saveSSC: (ssc) => {
                const list = window.Utils.getSSC();
                if (!ssc.id) ssc.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                ssc.synced = false;

                const existingIndex = list.findIndex(item => item.id === ssc.id);
                if (existingIndex >= 0) list[existingIndex] = ssc;
                else list.push(ssc);

                localStorage.setItem(DB_KEYS.SSC, JSON.stringify(list));
                window.Utils.uploadToCloud(true, 'ssc');
            },
            deleteSSC: (id) => {
                window.Utils.deleteFromCloud('ssc', id);
                // 1. Get SSC List and remove target
                let list = window.Utils.getSSC().filter(s => s.id !== id);
                localStorage.setItem(DB_KEYS.SSC, JSON.stringify(list));

                // 2. Cascading Delete: Find all QPs for this SSC
                const allQPs = window.Utils.getQPs();
                const sscQPs = allQPs.filter(q => q.sscId === id);
                const sscQPIds = sscQPs.map(q => q.id);

                if (sscQPIds.length > 0) {
                    sscQPIds.forEach(qpId => window.Utils.deleteFromCloud('qps', qpId));
                    // Remove QPs
                    const remainingQPs = allQPs.filter(q => q.sscId !== id);
                    localStorage.setItem(DB_KEYS.QP, JSON.stringify(remainingQPs));

                    // 3. Find NOS for these QPs
                    const allNOS = window.Utils.getNOS();
                    const qpNOS = allNOS.filter(n => sscQPIds.includes(n.qpId));
                    const qpNOSIds = qpNOS.map(n => n.id);

                    if (qpNOSIds.length > 0) {
                        qpNOSIds.forEach(nId => window.Utils.deleteFromCloud('nos', nId));
                        // Remove NOS
                        const remainingNOS = allNOS.filter(n => !sscQPIds.includes(n.qpId));
                        localStorage.setItem(DB_KEYS.NOS, JSON.stringify(remainingNOS));

                        // 4. Remove PCs for these NOS
                        const allPCs = window.Utils.getPCs();
                        // Fix for filter:
                        const pcsToDelete = allPCs.filter(p => qpNOSIds.includes(p.nosId));
                        pcsToDelete.forEach(p => window.Utils.deleteFromCloud('pcs', p.id));

                        const remainingPCs = allPCs.filter(p => !qpNOSIds.includes(p.nosId));
                        localStorage.setItem(DB_KEYS.PC, JSON.stringify(remainingPCs));
                    }

                    // 5. Remove Batches logic
                    // Remove Question Papers linked to this SSC
                    const allPapers = window.Utils.getQuestionPapers();
                    const sscPapers = allPapers.filter(p => p.sscId === id);
                    if (sscPapers.length > 0) {
                        sscPapers.forEach(p => window.Utils.deleteFromCloud('question_papers', p.id));

                        const sscPaperIds = sscPapers.map(p => p.id);
                        const remainingPapers = allPapers.filter(p => p.sscId !== id);
                        localStorage.setItem(DB_KEYS.QUESTION_PAPERS, JSON.stringify(remainingPapers));

                        // Remove Batches linked to these Papers
                        const allBatches = window.Utils.getBatches();
                        const batchesToDelete = allBatches.filter(b => sscPaperIds.includes(b.theoryPaperId) || sscPaperIds.includes(b.practicalPaperId));

                        if (batchesToDelete.length > 0) {
                            batchesToDelete.forEach(b => window.Utils.deleteFromCloud('batches', b.id));

                            const batchIdsToDelete = batchesToDelete.map(b => b.id);
                            const remainingBatches = allBatches.filter(b => !batchIdsToDelete.includes(b.id));
                            localStorage.setItem(DB_KEYS.BATCHES, JSON.stringify(remainingBatches));

                            // Remove Students in these Batches
                            const allStudents = window.Utils.getStudents();
                            const studentsToDelete = allStudents.filter(s => batchIdsToDelete.includes(s.batchId));
                            studentsToDelete.forEach(s => window.Utils.deleteFromCloud('students', s.id));

                            const remainingStudents = allStudents.filter(s => !batchIdsToDelete.includes(s.batchId));
                            localStorage.setItem(DB_KEYS.STUDENTS, JSON.stringify(remainingStudents));
                        }
                    }
                }
            },
            getQPs: () => JSON.parse(localStorage.getItem(DB_KEYS.QP) || '[]'),
            getQPsBySSC: (sscId) => window.Utils.getQPs().filter(q => q.sscId === sscId),
            saveQP: (qp) => {
                const list = window.Utils.getQPs();
                if (!qp.id) qp.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                qp.synced = false; // Add this
                const existingIndex = list.findIndex(item => item.id === qp.id);
                if (existingIndex >= 0) list[existingIndex] = qp;
                else list.push(qp);
                localStorage.setItem(DB_KEYS.QP, JSON.stringify(list));
                window.Utils.uploadToCloud(true, 'qps');
            },
            deleteQP: (id) => {
                window.Utils.deleteFromCloud('qps', id);
                let list = window.Utils.getQPs().filter(q => q.id !== id);
                localStorage.setItem(DB_KEYS.QP, JSON.stringify(list));
            },
            getNOS: () => JSON.parse(localStorage.getItem(DB_KEYS.NOS) || '[]'),
            getNOSByQP: (qpId) => window.Utils.getNOS().filter(n => n.qpId === qpId),
            saveNOS: (nos) => {
                const list = window.Utils.getNOS();
                if (!nos.id) nos.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                nos.synced = false; // Add this
                const existingIndex = list.findIndex(item => item.id === nos.id);
                if (existingIndex >= 0) list[existingIndex] = nos;
                else list.push(nos);
                localStorage.setItem(DB_KEYS.NOS, JSON.stringify(list));
                window.Utils.uploadToCloud(true, 'nos');
            },
            deleteNOS: (id) => {
                window.Utils.deleteFromCloud('nos', id);
                let list = window.Utils.getNOS().filter(n => n.id !== id);
                localStorage.setItem(DB_KEYS.NOS, JSON.stringify(list));
            },
            getPCs: () => JSON.parse(localStorage.getItem(DB_KEYS.PC) || '[]'),
            getPCsByNOS: (nosId) => window.Utils.getPCs().filter(p => p.nosId === nosId),
            savePC: (pc) => {
                const list = window.Utils.getPCs();
                if (!pc.id) pc.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                pc.synced = false; // Add this
                const existingIndex = list.findIndex(item => item.id === pc.id);
                if (existingIndex >= 0) list[existingIndex] = pc;
                else list.push(pc);
                localStorage.setItem(DB_KEYS.PC, JSON.stringify(list));
                window.Utils.uploadToCloud(true, 'pcs');
            },
            deletePC: (id) => {
                window.Utils.deleteFromCloud('pcs', id);
                let list = window.Utils.getPCs().filter(p => p.id !== id);
                localStorage.setItem(DB_KEYS.PC, JSON.stringify(list));
            },
            getBatches: () => JSON.parse(localStorage.getItem(DB_KEYS.BATCHES) || '[]'),
            saveToCloud: async (route, item) => {
                try {
                    if (!item || !item.id) return false;
                    if (navigator.onLine === false) return false;

                    const response = await fetch(`${API_BASE}/${route}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': 'portel_secure_key_2025'
                        },
                        body: JSON.stringify(item)
                    });

                    if (response.ok) {
                        console.log(`[Sync] ${route} saved to S3.`);
                        // Update local sync status
                        const MAPPING = {
                            'batches': DB_KEYS.BATCHES, 'students': DB_KEYS.STUDENTS,
                            'qps': DB_KEYS.QP, 'nos': DB_KEYS.NOS, 'pcs': DB_KEYS.PC,
                            'ssc': DB_KEYS.SSC, 'responses': DB_KEYS.RESPONSES,
                            'question_papers': DB_KEYS.QUESTION_PAPERS,
                            'assessors': 'se_assessors'
                        };
                        const key = MAPPING[route];
                        if (key) {
                            let list = JSON.parse(localStorage.getItem(key) || '[]');
                            const idx = list.findIndex(i => i.id === item.id);
                            if (idx >= 0) {
                                list[idx].synced = true;
                                localStorage.setItem(key, JSON.stringify(list));
                            }
                        }
                        return true;
                    }
                    return false;
                } catch (e) {
                    console.error(`Save ${route} failed`, e);
                    return false;
                }
            },
            deleteFromCloud: async (route, id) => {
                try {
                    if (!id) return;
                    if (navigator.onLine === false) return;
                    console.log(`Deleting from S3: ${route}/${id}`);
                    await fetch(`${API_BASE}/${route}/${id}`, {
                        method: 'DELETE',
                        headers: { 'x-api-key': 'portel_secure_key_2025' }
                    });
                } catch (e) {
                    console.error(`Delete ${route} failed`, e);
                }
            },

            // ... (Other functions) ...

            saveBatch: async (batch, silent = false) => {
                let list = window.Utils.getBatches();
                if (!batch.id) batch.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                batch.synced = false; // Add this

                const existingIndex = list.findIndex(b => b.id === batch.id);
                if (existingIndex >= 0) {
                    list[existingIndex] = batch; // Update
                } else {
                    list.push(batch); // Insert
                }

                localStorage.setItem(DB_KEYS.BATCHES, JSON.stringify(list));

                // v19.0.9: PRIORITIZE Direct Save to S3 for instant confirmation
                const directOk = await window.Utils.saveToCloud('batches', batch);
                if (directOk) {
                    batch.synced = true;
                    // Update list with synced status
                    const updatedList = window.Utils.getBatches();
                    const idx = updatedList.findIndex(b => b.id === batch.id);
                    if (idx >= 0) updatedList[idx].synced = true;
                    localStorage.setItem(DB_KEYS.BATCHES, JSON.stringify(updatedList));

                    if (!silent) alert("Success: Batch Saved & Synced to Cloud!");
                } else {
                    // Fallback to background sync
                    const backgroundOk = await window.Utils.uploadToCloud(true, 'batches');
                    if (!silent && !backgroundOk) {
                        alert("Batch Saved Locally but Cloud Sync FAILED.\nPlease check connection and TRY AGAIN (Save again).");
                    } else if (!silent && backgroundOk) {
                        alert("Success: Batch Saved & Synced to Cloud (Background)!");
                    }
                }
            },
            updateBatches: (batches) => localStorage.setItem(DB_KEYS.BATCHES, JSON.stringify(batches)),
            deleteBatch: (id) => {
                // 1. Delete Batch
                window.Utils.deleteFromCloud('batches', id);
                let list = window.Utils.getBatches().filter(b => b.id !== id);
                localStorage.setItem(DB_KEYS.BATCHES, JSON.stringify(list));

                // 2. Delete Related Assessors (Fixes login issue)
                let allAssessors = window.Utils.getAssessors();
                let assessorsToDelete = allAssessors.filter(a => a.batchId === id);
                assessorsToDelete.forEach(a => window.Utils.deleteFromCloud('assessors', a.id));
                let remainingAssessors = allAssessors.filter(a => a.batchId !== id);
                localStorage.setItem('se_assessors', JSON.stringify(remainingAssessors));

                // 3. Delete Related Students
                let allStudents = window.Utils.getStudents();
                let studentsToDelete = allStudents.filter(s => s.batchId === id);
                studentsToDelete.forEach(s => window.Utils.deleteFromCloud('students', s.id));
                let remainingStudents = allStudents.filter(s => s.batchId !== id);
                localStorage.setItem(DB_KEYS.STUDENTS, JSON.stringify(remainingStudents));

                // 4. Delete Related Responses (Cleanup)
                let allResponses = window.Utils.getResponses();
                // Filter out responses belonging to deleted students OR the batch itself
                let responsesToDelete = allResponses.filter(r => r.batchId === id || studentsToDelete.find(s => s.id === r.studentId));

                // CRITICAL: Actually delete from Cloud too
                if (responsesToDelete.length > 0) {
                    console.log(`[Sync] Deleting ${responsesToDelete.length} responses from Cloud for batch ${id}`);
                    responsesToDelete.forEach(r => window.Utils.deleteFromCloud('responses', r.id));
                }

                let remainingResponses = allResponses.filter(r => r.batchId !== id && !studentsToDelete.find(s => s.id === r.studentId));
                localStorage.setItem(DB_KEYS.RESPONSES, JSON.stringify(remainingResponses));
            },
            deleteAllBatches: () => {
                const batches = window.Utils.getBatches();
                batches.forEach(b => window.Utils.deleteBatch(b.id));
                // Force sync/refresh logic if needed, but deleteBatch handles local storage.
                // Maybe clear any residual data?
                // localStorage.setItem(DB_KEYS.BATCHES, '[]');
            },
            factoryReset: async () => {
                if (!confirm("?? FACTORY RESET WARNING ??\n\nThis will PERMANENTLY DELETE ALL DATA from both your device AND the Cloud.\n\nThis includes data from ALL connected devices.\n\nAre you sure you want to proceed?")) return;

                const statusBtn = document.getElementById('sync-status-text');
                const originalText = statusBtn ? statusBtn.innerText : '';

                try {
                    if (!navigator.onLine) {
                        alert("You are offline. Factory Reset requires an internet connection to wipe the cloud.");
                        return;
                    }

                    if (statusBtn) statusBtn.innerText = "Connecting to Cloud...";

                    const collections = [
                        'ssc', 'qps', 'nos', 'pcs',
                        'batches', 'students', 'assessors',
                        'responses', 'question_papers',
                        'synced_chunks'
                    ];

                    let totalDeleted = 0;
                    const errors = [];
                    const API_KEY = 'portel_secure_key_2025';
                    const headers = { 'x-api-key': API_KEY };

                    for (const col of collections) {
                        if (statusBtn) statusBtn.innerText = `Wiping ${col}...`;
                        try {
                            const res = await fetch(`${API_BASE}/wipe/${col}?apiKey=${API_KEY}`, {
                                method: 'DELETE',
                                headers
                            });

                            if (res.ok) {
                                totalDeleted++;
                            } else {
                                errors.push(`${col} (Status ${res.status})`);
                            }
                        } catch (err) {
                            errors.push(`${col} (Network Error)`);
                        }
                    }

                    // Clear Local
                    localStorage.clear();
                    try {
                        indexedDB.deleteDatabase('VideoStorage');
                    } catch (e) { }

                    const errorSummary = errors.length > 0 ? `\n\n⚠️ FAILURES:\n- ${errors.join('\n- ')}` : "";
                    alert(`Factory Reset Complete.\n\n- Cloud Data: Wiped (${totalDeleted}/${collections.length} collections)${errorSummary}\n- Local Data: Cleared\n\nThe app will now reload.`);
                    window.location.reload();

                } catch (e) {
                    console.error("Factory Reset Fatal Error", e);
                    alert("Factory Reset Error: " + e.message + "\n\nLocal data will be cleared, but cloud data might remain.");
                    localStorage.clear();
                    window.location.reload();
                }
            },
            getStudents: () => JSON.parse(localStorage.getItem(DB_KEYS.STUDENTS) || '[]'),
            getStudentsByBatch: (batchId) => window.Utils.getStudents().filter(s => s.batchId === batchId),
            saveStudent: (student) => {
                const list = window.Utils.getStudents();
                if (!student.id) student.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                student.synced = false;

                const existingIndex = list.findIndex(s => s.id === student.id);
                if (existingIndex >= 0) list[existingIndex] = student;
                else list.push(student);

                localStorage.setItem(DB_KEYS.STUDENTS, JSON.stringify(list));
                window.Utils.uploadToCloud(true, 'students');
            },
            saveStudentsBulk: (students) => {
                const list = window.Utils.getStudents();
                students.forEach(s => {
                    if (!s.id) s.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                    s.synced = false;
                    const existingIndex = list.findIndex(ex => ex.id === s.id);
                    if (existingIndex >= 0) list[existingIndex] = s;
                    else list.push(s);
                });
                localStorage.setItem(DB_KEYS.STUDENTS, JSON.stringify(list));
                window.Utils.uploadToCloud(true, 'students');
            },
            deleteStudent: (id) => {
                window.Utils.deleteFromCloud('students', id);
                let list = window.Utils.getStudents().filter(s => s.id !== id);
                localStorage.setItem(DB_KEYS.STUDENTS, JSON.stringify(list));
            },
            authenticateStudent: (username, password) => window.Utils.getStudents().find(s => String(s.username).trim().toLowerCase() === String(username).trim().toLowerCase() && String(s.password).trim() === String(password).trim()),

            // Assessor Management
            getAssessors: () => JSON.parse(localStorage.getItem('se_assessors') || '[]'),
            saveAssessor: async (assessor) => {
                const list = window.Utils.getAssessors();
                if (!assessor.id) assessor.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                if (!assessor.createdAt) assessor.createdAt = new Date().toISOString();
                assessor.synced = false; // Add this

                // Save Local
                const existingIndex = list.findIndex(a => a.id === assessor.id);
                if (existingIndex >= 0) list[existingIndex] = assessor;
                else list.push(assessor);
                localStorage.setItem('se_assessors', JSON.stringify(list));

                // Save Cloud
                await window.Utils.uploadToCloud(true, 'assessors');
            },
            deleteAssessor: (id) => {
                window.Utils.deleteFromCloud('assessors', id);
                let list = window.Utils.getAssessors().filter(a => a.id !== id);
                localStorage.setItem('se_assessors', JSON.stringify(list));
            },
            authenticateAssessor: (username, password) => {
                // 1. Check New Assessors Table
                const fromList = window.Utils.getAssessors().find(a =>
                    a && a.username && a.password &&
                    String(a.username).trim().toLowerCase() === String(username).trim().toLowerCase() &&
                    String(a.password).trim() === String(password).trim()
                );
                if (fromList) return fromList;

                // 2. Fallback: Check Batches (Legacy / Direct Batch Credentials)
                const fromBatch = window.Utils.getBatches().find(b =>
                    String(b.assessorUsername).trim().toLowerCase() === String(username).trim().toLowerCase() &&
                    String(b.assessorPassword).trim() === String(password).trim()
                );

                if (fromBatch) {
                    return {
                        id: fromBatch.id, // Use batch ID as fallback ID
                        name: 'Assessor (' + fromBatch.name + ')',
                        username: fromBatch.assessorUsername,
                        batchId: fromBatch.id, // Critical for context
                        sscId: fromBatch.sscId,
                        qpId: fromBatch.qpId,
                        role: 'assessor'
                    };
                }
                return null;
            },

            getQuestionPapers: () => JSON.parse(localStorage.getItem(DB_KEYS.QUESTION_PAPERS) || '[]'),
            saveQuestionPaper: (qp) => {
                const list = window.Utils.getQuestionPapers();
                if (!qp.id) qp.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                qp.synced = false;

                const existingIndex = list.findIndex(q => q.id === qp.id);
                if (existingIndex >= 0) list[existingIndex] = qp;
                else list.push(qp);

                localStorage.setItem(DB_KEYS.QUESTION_PAPERS, JSON.stringify(list));
                window.Utils.uploadToCloud(true, 'question_papers');
            },
            deleteQuestionPaper: (id) => {
                window.Utils.deleteFromCloud('question_papers', id);
                let list = window.Utils.getQuestionPapers().filter(q => q.id !== id);
                localStorage.setItem(DB_KEYS.QUESTION_PAPERS, JSON.stringify(list));
            },
            getResponses: () => JSON.parse(localStorage.getItem(DB_KEYS.RESPONSES) || '[]'),
            base64ToBlob: (base64) => {
                const parts = base64.split(';base64,');
                const contentType = parts[0].split(':')[1];
                const raw = window.atob(parts[1]);
                const rawLength = raw.length;
                const uInt8Array = new Uint8Array(rawLength);
                for (let i = 0; i < rawLength; ++i) {
                    uInt8Array[i] = raw.charCodeAt(i);
                }
                return new Blob([uInt8Array], { type: contentType });
            },

            saveResponse: async (response) => {
                try {
                    // MIGRATION TO INDEXEDDB FOR IMAGES
                    if (response.evidence && Array.isArray(response.evidence)) {
                        for (let i = 0; i < response.evidence.length; i++) {
                            const ev = response.evidence[i];
                            // If it's a base64 string (starts with data:image or data:video), offload it
                            if (ev.img && (ev.img.startsWith('data:image') || ev.img.startsWith('data:video'))) {
                                const blob = window.Utils.base64ToBlob(ev.img);
                                const key = `ev_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                                await VideoDB.saveVideo(key, blob); // reusing generic Method

                                // VERIFY IMMEDIATE READ
                                const check = await VideoDB.getVideo(key);
                                if (!check) console.error(`[CRITICAL] Immediate Readback Failed for ${key}`);
                                else console.log(`[VideoDB] Verified ${key} exists.`);

                                response.evidence[i] = { ...ev, img: key, storage: 'indexeddb' };
                            }
                        }
                    }

                    if (!response.id) response.id = `${response.studentId}_${response.examType}`;
                    response.synced = false; // Add this

                    const list = window.Utils.getResponses();
                    const existing = list.findIndex(r => r.studentId === response.studentId && r.examType === response.examType);
                    if (existing >= 0) {
                        const old = list[existing];
                        let newEvidence = [...(old.evidence || [])];
                        if (response.evidence) {
                            response.evidence.forEach(newItem => {
                                // Check if this evidence key already exists to update it (e.g. adding downloadUrl)
                                const idx = newItem.key ? newEvidence.findIndex(e => e.key === newItem.key) : -1;
                                if (idx >= 0) {
                                    newEvidence[idx] = { ...newEvidence[idx], ...newItem };
                                } else {
                                    newEvidence.push(newItem);
                                }
                            });
                        }
                        list[existing] = { ...old, ...response, evidence: newEvidence };
                    }
                    else list.push(response);

                    localStorage.setItem(DB_KEYS.RESPONSES, JSON.stringify(list));
                    window.Utils.uploadToCloud(true); // Trigger sync for responses
                } catch (e) {
                    console.error("Storage Error", e);
                    // Fallback to alert if IndexedDB fails or something else is wrong
                    if (e.name === 'QuotaExceededError') {
                        alert("Storage Full! Please contact support.");
                    }
                }
            },
            // Duplicate removed
            deleteEvidence: async (studentId, examType, evidenceItemOrSession) => {
                const responses = window.Utils.getResponses();
                const respIdx = responses.findIndex(r => r.studentId === studentId && r.examType === examType);
                if (respIdx === -1) return;

                const response = responses[respIdx];
                const itemsToDelete = evidenceItemOrSession.isGroup ? evidenceItemOrSession.parts : [evidenceItemOrSession];

                for (const item of itemsToDelete) {
                    // 1. Delete from Cloud (S3)
                    if (item.url && item.url.includes('amazonaws.com')) {
                        try {
                            const urlObj = new URL(item.url);
                            let s3Key = urlObj.pathname.startsWith('/') ? urlObj.pathname.substring(1) : urlObj.pathname;
                            s3Key = decodeURIComponent(s3Key);
                            console.log(`[Delete] Cloud Key: ${s3Key}`);
                            await fetch(`${API_BASE}/media?key=${encodeURIComponent(s3Key)}&apiKey=portel_secure_key_2025`, { method: 'DELETE' });
                        } catch (e) { console.error("Cloud delete failed", e); }
                    }

                    // 2. Delete from Local (IndexedDB)
                    const localKey = (item.storage === 'indexeddb' || !item.url) ? item.img : null;
                    if (localKey && !localKey.startsWith('data:') && !localKey.startsWith('blob:')) {
                        try { await VideoDB.deleteVideo(localKey); console.log(`[Delete] Local Key: ${localKey}`); } catch (e) { }
                    }

                    // 3. Remove from metadata array
                    // Matching by key or img (exact match)
                    response.evidence = response.evidence.filter(ev =>
                        (ev.key && ev.key !== item.key) ||
                        (!ev.key && ev.img !== item.img)
                    );
                }

                response.synced = false;
                responses[respIdx] = response;
                localStorage.setItem(DB_KEYS.RESPONSES, JSON.stringify(responses));
                window.Utils.uploadToCloud(true, 'responses');
                return true;
            },

            formatTime12h: (timeStr) => {
                if (!timeStr) return '';
                try {
                    const [h, m] = timeStr.split(':');
                    const hh = parseInt(h);
                    const suffix = hh >= 12 ? 'PM' : 'AM';
                    const h12 = hh % 12 || 12;
                    return `${h12}:${m} ${suffix}`;
                } catch (e) { return timeStr; }
            }
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // Safe Icon Component
        const LucideIcon = ({ name, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    // Convert kebab-case (download, file-text) to PascalCase (Download, FileText) for lookup
                    const iconKey = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                    const iconDef = window.lucide.icons[iconKey];

                    if (iconDef) {
                        window.lucide.createIcons({
                            attrs: { class: className },
                            nameAttr: 'data-lucide',
                            icons: { [name]: iconDef }, // Map 'download' -> Download definition
                            root: ref.current.parentNode
                        });
                    } else {
                        console.warn(`Icon not found: ${name} (Key: ${iconKey})`);
                    }
                    // Actually createIcons replaces elements with data-lucide.
                    // We need to render <i data-lucide={name} /> and let lucide replace it.
                    // BUT we want to scope it.
                    window.lucide.createIcons({
                        root: ref.current,
                        icons: window.lucide.icons,
                        attrs: { class: className }
                    });
                }
            }, [name, className]);

            return <span ref={ref}><i data-lucide={name} className={className}></i></span>;
        };

        const Icons = {
            User: () => <LucideIcon name="user" className="w-5 h-5" />,
            Users: () => <LucideIcon name="users" className="w-5 h-5" />,
            LogOut: () => <LucideIcon name="log-out" className="w-5 h-5" />,
            Camera: () => <LucideIcon name="camera" className="w-5 h-5" />,
            Plus: () => <LucideIcon name="plus" className="w-5 h-5" />,
            Trash2: () => <LucideIcon name="trash-2" className="w-4 h-4" />,
            Eye: () => <LucideIcon name="eye" className="w-5 h-5" />,
            EyeOff: () => <LucideIcon name="eye-off" className="w-5 h-5" />,
            Upload: () => <LucideIcon name="upload" className="w-5 h-5" />,
            Download: () => <LucideIcon name="download" className="w-5 h-5" />,
            Database: ({ className }) => <LucideIcon name="database" className={className || "w-4 h-4"} />,
            FileText: () => <LucideIcon name="file-text" className="w-5 h-5" />,
            Book: () => <LucideIcon name="book" className="w-5 h-5" />,
            Cpu: () => <LucideIcon name="cpu" className="w-5 h-5" />,
            Edit3: () => <LucideIcon name="edit-3" className="w-4 h-4" />,
            UserPlus: () => <LucideIcon name="user-plus" className="w-5 h-5" />,
            ChevronDown: () => <LucideIcon name="chevron-down" className="w-4 h-4" />,
            ChevronLeft: () => <LucideIcon name="chevron-left" className="w-4 h-4" />,
            ChevronRight: () => <LucideIcon name="chevron-right" className="w-4 h-4" />,
            Map: () => <LucideIcon name="map" className="w-4 h-4" />,
            Home: () => <LucideIcon name="home" className="w-4 h-4" />,
            Grid: () => <LucideIcon name="grid" className="w-5 h-5" />,
            Calendar: () => <LucideIcon name="calendar" className="w-5 h-5" />,
            MapPin: () => <LucideIcon name="map-pin" className="w-5 h-5" />,
            Layers: () => <LucideIcon name="layers" className="w-5 h-5" />,
            List: () => <LucideIcon name="list" className="w-5 h-5" />,
            PlusSquare: () => <LucideIcon name="plus-square" className="w-5 h-5" />,
            MinusSquare: () => <LucideIcon name="minus-square" className="w-5 h-5" />,
            Lock: ({ className }) => <LucideIcon name="lock" className={className || "w-5 h-5"} />,
            Unlock: ({ className }) => <LucideIcon name="unlock" className={className || "w-5 h-5"} />,
            Video: () => <LucideIcon name="video" className="w-5 h-5" />,
            Square: () => <LucideIcon name="square" className="w-5 h-5" />,
            BarChart2: () => <LucideIcon name="bar-chart-2" className="w-5 h-5" />,
            XCircle: () => <LucideIcon name="x-circle" className="w-5 h-5" />,
            UploadCloud: () => <LucideIcon name="upload-cloud" className="w-12 h-12" />,
            Save: () => <LucideIcon name="save" className="w-4 h-4" />,
            TriangleAlert: () => <LucideIcon name="alert-triangle" className="w-6 h-6" />, // Fallback to safe name 'alert-triangle'
            Loader: ({ className }) => <LucideIcon name="loader" className={className || "w-4 h-4"} />,
            Play: ({ className }) => <LucideIcon name="play" className={className || "w-4 h-4"} />,
            CheckCircle: ({ className }) => <LucideIcon name="check-circle" className={className || "w-5 h-5"} />,
            Microphone: ({ className }) => <LucideIcon name="mic" className={className || "w-5 h-5"} />,
            MicrophoneOff: ({ className }) => <LucideIcon name="mic-off" className={className || "w-5 h-5"} />,
            VideoOff: ({ className }) => <LucideIcon name="video-off" className={className || "w-5 h-5"} />,
            PhoneMissed: ({ className }) => <LucideIcon name="phone-missed" className={className || "w-5 h-5"} />,
            Check: ({ className }) => <LucideIcon name="check" className={className || "w-5 h-5"} />,
            Square: ({ className }) => <LucideIcon name="square" className={className || "w-5 h-5"} />,
            RefreshCw: ({ className }) => <LucideIcon name="refresh-cw" className={className || "w-4 h-4"} />,
            Cloud: ({ className }) => <LucideIcon name="cloud" className={className || "w-4 h-4"} />,
            Smartphone: ({ className }) => <LucideIcon name="smartphone" className={className || "w-4 h-4"} />,
            AlertTriangle: ({ className }) => <LucideIcon name="alert-triangle" className={className || "w-5 h-5"} />,
            Shield: ({ className }) => <LucideIcon name="shield" className={className || "w-5 h-5"} />,
            ArrowRight: ({ className }) => <LucideIcon name="arrow-right" className={className || "w-5 h-5"} />
        };
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error('ErrorBoundary caught:', error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-8 text-red-600 bg-white min-h-screen">
                            <h1 className="text-3xl font-bold mb-4">Something went wrong.</h1>
                            <div className="bg-red-50 p-6 rounded-lg border border-red-200 shadow-sm">
                                <h2 className="font-bold text-lg mb-2">Error Details:</h2>
                                <pre className="whitespace-pre-wrap font-mono text-sm">{this.state.error?.toString()}</pre>
                                <p className="mt-4 text-sm text-gray-600">Check the console for more details.</p>
                            </div>
                            <button onClick={() => window.location.reload()} className="mt-6 px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">reload Page</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // LOGIN
        // v26: Helper Component for Verification (Global Scope)
        const VideoPreview = ({ onCapture, instructions }) => {
            const vRef = React.useRef(null);
            const [stream, setStream] = React.useState(null);

            React.useEffect(() => {
                navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                    .then(s => {
                        setStream(s);
                        if (vRef.current) vRef.current.srcObject = s;
                    })
                    .catch(e => alert("Camera Access Required: " + e.message));
                return () => {
                    if (stream) stream.getTracks().forEach(t => t.stop());
                };
            }, []);

            const capture = () => {
                if (!vRef.current) return;
                const canvas = document.createElement('canvas');
                canvas.width = 640; canvas.height = 480;
                canvas.getContext('2d').drawImage(vRef.current, 0, 0, 640, 480);
                onCapture(canvas.toDataURL('image/jpeg', 0.8));
            };

            return (
                <div className="absolute inset-0 flex flex-col">
                    <video ref={vRef} autoPlay muted playsInline className="w-full h-full object-cover" />
                    <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/80 to-transparent flex flex-col items-center gap-2">
                        <p className="text-white text-sm font-medium">{instructions}</p>
                        <button onClick={capture} className="w-14 h-14 bg-white rounded-full border-4 border-gray-300 shadow-lg hover:scale-110 transition-transform flex items-center justify-center">
                            <Icons.Camera className="w-6 h-6 text-indigo-600" />
                        </button>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => {
            const [role, setRole] = useState('admin');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [debugInfo, setDebugInfo] = useState({ studentCount: 0, serverStatus: 'Checking...' });

            useEffect(() => {
                // Initial Load Check
                const count = window.Utils.getStudents().length;
                setDebugInfo(prev => ({ ...prev, studentCount: count }));

                // Automatic Sync on Load (Silent)
                if (navigator.onLine && window.Utils.downloadFromCloud) {
                    window.Utils.downloadFromCloud(true);
                }
            }, []);

            const handleLogin = (e) => {
                e.preventDefault();
                setError('');
                try {
                    console.log(`Attempting login: Role=${role}, User=${username}`);

                    if (role === 'admin' && username === 'admin' && password === 'admin') {
                        console.log("Admin login success");
                        onLogin({ role: 'admin', name: 'Administrator' });
                    } else if (role === 'student') {
                        const student = window.Utils.authenticateStudent(username, password);
                        if (student) {
                            console.log("Student login success", student);
                            onLogin({ role: 'student', ...student });
                        } else {
                            console.warn("Student auth failed");
                            setError('Invalid student credentials');
                        }
                    } else if (role === 'assessor') {
                        const assessor = window.Utils.authenticateAssessor(username, password);
                        if (assessor) {
                            console.log("Assessor login success", assessor);
                            // Pass assessor details with assigned batch
                            onLogin({
                                role: 'assessor',
                                name: assessor.name,
                                id: assessor.id,
                                batchId: assessor.batchId,
                                sscId: assessor.sscId,
                                qpId: assessor.qpId
                            });
                        } else {
                            console.warn("Assessor auth failed");
                            setError('Invalid assessor credentials');
                        }
                    } else {
                        setError('Invalid credentials');
                    }
                } catch (err) {
                    console.error("Login Error:", err);
                    alert("Login Error: " + err.message);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 p-4">
                    <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md glass">
                        <h1 className="text-3xl font-bold text-center text-gray-800 mb-2">NSXpertise</h1>
                        <p className="text-center text-gray-500 mb-8">Assessment Management System</p>
                        <div className="flex justify-center gap-4 mb-6">
                            {['admin', 'student', 'assessor'].map(r => (
                                <button key={r} onClick={() => setRole(r)}
                                    className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${role === r ? 'bg-indigo-600 text-white shadow-lg' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                                    {r.charAt(0).toUpperCase() + r.slice(1)}
                                </button>
                            ))}
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input type="text" required className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                                    value={username} onChange={e => setUsername(e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" required className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                                    value={password} onChange={e => setPassword(e.target.value)} />
                            </div>
                            <div className="flex justify-between items-center text-xs text-gray-500 mt-2">
                                <span className={navigator.onLine ? "text-green-600 font-bold flex items-center gap-1" : "text-red-500 font-bold flex items-center gap-1"}>
                                    <div className={`w-2 h-2 rounded-full ${navigator.onLine ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                    {navigator.onLine ? "Cloud Connected" : "Offline Mode"}
                                </span>
                                <span>v30.4 (Stable)</span>
                            </div>
                            {error && <p className="text-red-500 text-sm text-center bg-red-50 p-2 rounded">{error}</p>}
                            <div className="flex gap-2">
                                <button type="submit" className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transform hover:scale-[1.02] transition-all">
                                    Login as {role.charAt(0).toUpperCase() + role.slice(1)}
                                </button>
                                <button type="button" onClick={async () => {
                                    if (confirm("Force Upload Local Data to Cloud? (Use this if other devices are missing data)")) {
                                        await window.Utils.uploadToCloud();
                                    }
                                    if (confirm('Clear cache for v30?')) { localStorage.clear(); location.reload(true); }
                                }} className="px-4 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-colors" title="Force Sync & Clear Cache">
                                    <Icons.RefreshCw className="w-5 h-5" />
                                </button>
                                <button type="button" onClick={async () => {
                                    await window.Utils.downloadFromCloud();
                                    setDebugInfo(prev => ({ ...prev, studentCount: window.Utils.getStudents().length }));
                                }} className="px-4 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-colors" title="Sync Latest Data">
                                    <Icons.Download className="w-5 h-5" />
                                </button>
                            </div>
                            <div className="text-center text-xs text-gray-400 mt-4 space-y-1">
                                <p>Demo: admin/admin</p>
                                <p className="text-gray-400 text-[10px] mt-2">v30.4 (Stable + Theory Edit)</p>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // SIDEBAR COMPONENT
        const Sidebar = ({ activeTab, setActiveTab }) => {
            const [isQpsOpen, setIsQpsOpen] = useState(true);

            const menuItems = [
                { id: 'dashboard', label: 'Dashboard', icon: <Icons.Grid /> },
                { id: 'calendar', label: 'Calendar', icon: <Icons.Calendar /> }, // Placeholder
                { id: 'location', label: 'Assessment Location', icon: <Icons.MapPin /> }, // Placeholder
                { id: 'subjects', label: 'Sector Skill Councils', icon: <Icons.Layers /> },
            ];

            return (
                <div className="w-64 bg-slate-800 text-white min-h-screen flex flex-col">
                    <div className="p-6 border-b border-slate-700">
                        <h1 className="text-xl font-bold">NSXpertise</h1>
                        <p className="text-xs text-slate-400 mt-1">v30.0.0</p>
                        <div className="flex flex-col gap-1 mt-3">
                            <button
                                onClick={() => { if (confirm('Clear cache for v30?')) { localStorage.clear(); location.reload(true); } }}
                                className="text-[9px] bg-slate-700 hover:bg-red-600 px-2 py-1 rounded transition-colors text-slate-300 font-bold"
                            >
                                FORCE UPDATE / CLEAR CACHE
                            </button>
                            <button
                                onClick={() => {
                                    const logs = window.__syncLogs || [];
                                    alert("--- SYNC LOGS (v30) ---\n\n" + (logs.length ? logs.join('\n') : "No errors logged."));
                                }}
                                className="text-[9px] bg-slate-700 hover:bg-indigo-600 px-2 py-1 rounded transition-colors text-slate-300 font-bold"
                            >
                                VIEW SYNC LOGS
                            </button>
                        </div>
                    </div>
                    <nav className="flex-1 p-4 space-y-1">
                        {menuItems.map(item => (
                            <button key={item.id} onClick={() => setActiveTab(item.id)}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${activeTab === item.id ? 'bg-indigo-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>
                                {item.icon}
                                <span className="text-sm font-medium">{item.label}</span>
                            </button>
                        ))}

                        {/* QPS & NOS Dropdown */}
                        <div className="space-y-1">
                            <button onClick={() => setIsQpsOpen(!isQpsOpen)}
                                className={`w-full flex items-center justify-between px-4 py-3 rounded-lg text-slate-300 hover:bg-slate-700 transition-colors`}>
                                <div className="flex items-center gap-3">
                                    <Icons.Book />
                                    <span className="text-sm font-medium">QPS & NOS</span>
                                </div>
                                {isQpsOpen ? <Icons.ChevronDown /> : <Icons.ChevronRight />}
                            </button>

                            {isQpsOpen && (
                                <div className="pl-12 space-y-1">
                                    <button onClick={() => setActiveTab('qps')}
                                        className={`w-full text-left px-4 py-2 rounded-lg text-sm transition-colors ${activeTab === 'qps' ? 'text-white font-medium' : 'text-slate-400 hover:text-white'}`}>
                                        Qualification Pack
                                    </button>
                                    <button onClick={() => setActiveTab('nos')}
                                        className={`w-full text-left px-4 py-2 rounded-lg text-sm transition-colors ${activeTab === 'nos' ? 'text-white font-medium' : 'text-slate-400 hover:text-white'}`}>
                                        NOS & PC
                                    </button>
                                </div>
                            )}
                        </div>

                        {/* Legacy Tabs moved to bottom or hidden if unused, keeping for now as direct links */}
                        <div className="pt-4 mt-4 border-t border-slate-700">
                            <p className="px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Assessment</p>
                            <button onClick={() => setActiveTab('questionPapers')}
                                className={`w-full flex items-center gap-3 px-4 py-2 rounded-lg transition-colors ${activeTab === 'questionPapers' ? 'bg-indigo-600' : 'text-slate-300 hover:bg-slate-700'}`}>
                                <Icons.FileText /> <span className="text-sm">Question Papers</span>
                            </button>
                            <button onClick={() => setActiveTab('batches')}
                                className={`w-full flex items-center gap-3 px-4 py-2 rounded-lg transition-colors ${activeTab === 'batches' ? 'bg-indigo-600' : 'text-slate-300 hover:bg-slate-700'}`}>
                                <Icons.Users /> <span className="text-sm">Batches</span>
                            </button>
                            <button onClick={() => setActiveTab('marks')}
                                className={`w-full flex items-center gap-3 px-4 py-2 rounded-lg transition-colors ${activeTab === 'marks' ? 'bg-indigo-600' : 'text-slate-300 hover:bg-slate-700'}`}>
                                <Icons.Edit3 /> <span className="text-sm">Marks Entry</span>
                            </button>
                            <button onClick={() => setActiveTab('results')}
                                className={`w-full flex items-center gap-3 px-4 py-2 rounded-lg transition-colors ${activeTab === 'results' ? 'bg-indigo-600' : 'text-slate-300 hover:bg-slate-700'}`}>
                                <Icons.Cpu /> <span className="text-sm">Results</span>
                            </button>
                            <button onClick={() => setActiveTab('assessors')}
                                className={`w-full flex items-center gap-3 px-4 py-2 rounded-lg transition-colors ${activeTab === 'assessors' ? 'bg-indigo-600' : 'text-slate-300 hover:bg-slate-700'}`}>
                                <Icons.UserPlus /> <span className="text-sm">Assessors</span>
                            </button>
                        </div>

                    </nav>
                </div>
            );
        };



        // SUBJECTS TAB
        const SubjectsTab = () => {
            const [sscList, setSSCList] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [newSSC, setNewSSC] = useState({ name: '', code: '' });

            useEffect(() => setSSCList(window.Utils.getSSC()), []);

            const handleCreate = (e) => {
                e.preventDefault();
                const ssc = { ...newSSC, id: window.Utils.generateId(), createdAt: new Date().toISOString() };
                window.Utils.saveSSC(ssc);
                setSSCList(window.Utils.getSSC());
                setShowModal(false);
                setNewSSC({ name: '', code: '' });
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-bold">Sector Skill Councils (SSC)</h3>
                        <button onClick={() => setShowModal(true)} className="bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-indigo-700">
                            <Icons.Plus /> Add SSC
                        </button>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-x-auto">
                        <table className="w-full">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="p-4 text-left font-bold text-gray-600">#</th>
                                    <th className="p-4 text-left font-bold text-gray-600">Name</th>
                                    <th className="p-4 text-left font-bold text-gray-600">Code</th>
                                    <th className="p-4 text-center font-bold text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {sscList.map((ssc, idx) => (
                                    <tr key={ssc.id} className="hover:bg-gray-50">
                                        <td className="p-4">{idx + 1}</td>
                                        <td className="p-4 font-medium">{ssc.name}</td>
                                        <td className="p-4">{ssc.code}</td>
                                        <td className="p-4 text-center">
                                            <button onClick={() => { if (confirm('Delete?')) { window.Utils.deleteSSC(ssc.id); setSSCList(window.Utils.getSSC()); } }}
                                                className="text-red-600 hover:text-red-800"><Icons.Trash2 /></button>
                                        </td>
                                    </tr>
                                ))}
                                {sscList.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-gray-400">No SSCs found</td></tr>}
                            </tbody>
                        </table>
                    </div>
                    {showModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl p-6 w-full max-w-md">
                                <h3 className="text-xl font-bold mb-4">Add New SSC</h3>
                                <form onSubmit={handleCreate} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Name</label>
                                        <input type="text" required className="w-full px-4 py-2 border rounded-lg"
                                            value={newSSC.name} onChange={e => setNewSSC({ ...newSSC, name: e.target.value })} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Code</label>
                                        <input type="text" required className="w-full px-4 py-2 border rounded-lg"
                                            value={newSSC.code} onChange={e => setNewSSC({ ...newSSC, code: e.target.value })} />
                                    </div>
                                    <div className="flex gap-2 justify-end">
                                        <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                                        <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Create</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        // UPLOAD NOS & PC COMPONENT
        const UploadNOSPC = ({ onBack, selectedSSC, sscList }) => {
            const [file, setFile] = useState(null);

            const downloadSample = () => {
                const ws = XLSX.utils.aoa_to_sheet([
                    ["QualificationPackID", "NOSID", "NOSName", "PC No", "PC Name", "Theory Marks", "Practical Marks", "Viva Marks", "Total Marks"],
                    ["QP001", "NOS001", "Intro to Farming", "PC1", "Identify seeds", "10", "20", "5", "35"]
                ]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                XLSX.writeFile(wb, "NOS_PC_Sample.xlsx");
            };

            const handleValidate = () => {
                if (!file) return alert("Please select a file");
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet);

                        if (json.length === 0) return alert("File appears to be empty.");

                        // Flexible Column Matcher
                        const findKey = (obj, ...candidates) => {
                            const keys = Object.keys(obj);
                            for (let cand of candidates) {
                                const normCand = cand.toLowerCase().replace(/[^a-z0-9]/g, '');
                                const found = keys.find(k => k.toLowerCase().replace(/[^a-z0-9]/g, '') === normCand);
                                if (found) return found;
                            }
                            return null;
                        };

                        // Detect Keys from first row
                        const sample = json[0];
                        const keyQP = findKey(sample, 'QualificationPackID', 'QPID', 'QP Code', 'Qualification Pack ID');
                        const keyNOS = findKey(sample, 'NOSID', 'NOS ID', 'NOS Code');
                        const keyNOSName = findKey(sample, 'NOSName', 'NOS Name');
                        const keyPC = findKey(sample, 'PCNo', 'PC No', 'PC ID', 'PC Code');
                        const keyPCName = findKey(sample, 'PCName', 'PC Name');
                        const keyTheory = findKey(sample, 'TheoryMarks', 'Theory Marks', 'Theory');
                        const keyPractical = findKey(sample, 'PracticalMarks', 'Practical Marks', 'Practical');
                        const keyViva = findKey(sample, 'VivaMarks', 'Viva Marks', 'Viva');
                        const keyTotal = findKey(sample, 'TotalMarks', 'Total Marks', 'Total');

                        if (!keyQP) {
                            alert("Critical Error: Could not find 'QualificationPackID' column.\nFound headers: " + Object.keys(sample).join(', '));
                            return;
                        }

                        const qps = window.Utils.getQPs();
                        let currentNOS = window.Utils.getNOS();
                        let currentPCs = window.Utils.getPCs();

                        let addedNOS = 0;
                        let addedPCs = 0;
                        let skippedNOS = 0;
                        let skippedPCs = 0;
                        let errors = [];
                        let processedNOS = new Set(); // Track NOSs processed in this file

                        json.forEach((row, idx) => {
                            const r = idx + 2;
                            const qpCode = row[keyQP];
                            const nosCode = row[keyNOS];

                            if (!qpCode) return; // Skip empty rows

                            const qp = qps.find(q => q.code === String(qpCode).trim());
                            if (!qp) {
                                const msg = `Row ${r}: QP '${qpCode}' not found in system.`;
                                if (!errors.includes(msg)) errors.push(msg);
                                return;
                            }

                            if (nosCode) {
                                const cleanNOS = String(nosCode).trim();
                                let nos = currentNOS.find(n => n.code === cleanNOS && n.qpId === qp.id);

                                if (!nos) {
                                    nos = {
                                        id: window.Utils.generateId(),
                                        qpId: qp.id,
                                        code: cleanNOS,
                                        name: row[keyNOSName] || cleanNOS,
                                        createdAt: new Date().toISOString()
                                    };
                                    currentNOS.push(nos);
                                    window.Utils.saveNOS(nos);

                                    if (!processedNOS.has(cleanNOS)) {
                                        addedNOS++;
                                        processedNOS.add(cleanNOS);
                                    }
                                } else {
                                    if (!processedNOS.has(cleanNOS)) {
                                        skippedNOS++;
                                        processedNOS.add(cleanNOS);
                                    }
                                }

                                const pcCode = row[keyPC];
                                if (pcCode) {
                                    const cleanPC = String(pcCode).trim();
                                    const exists = currentPCs.find(p => p.nosId === nos.id && p.code === cleanPC);
                                    if (!exists) {
                                        const pc = {
                                            id: window.Utils.generateId(),
                                            nosId: nos.id,
                                            code: cleanPC,
                                            name: row[keyPCName] || cleanPC,
                                            theoryMarks: row[keyTheory] || 0,
                                            practicalMarks: row[keyPractical] || 0,
                                            vivaMarks: row[keyViva] || 0,
                                            totalMarks: row[keyTotal] || 0
                                        };
                                        currentPCs.push(pc);
                                        window.Utils.savePC(pc);
                                        addedPCs++;
                                    } else {
                                        skippedPCs++;
                                    }
                                }
                            }
                        });

                        const summary = `Import Results:\n� Added: ${addedNOS} NOS, ${addedPCs} PCs\n� Skipped (Duplicates): ${skippedNOS} NOS, ${skippedPCs} PCs`;

                        if (errors.length > 0) {
                            alert(`${summary}\n\nWarnings/Errors:\n${errors.slice(0, 10).join('\n')}`);
                        } else {
                            alert(`Success!\n${summary}`);
                        }
                        // Navigate back even if duplicates (so user can see the list)
                        if (addedNOS > 0 || addedPCs > 0 || skippedNOS > 0 || skippedPCs > 0) onBack();

                    } catch (err) {
                        alert("Error parsing file: " + err.message);
                        console.error(err);
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            return (
                <div className="animate-fade-in text-sm">
                    <div className="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 className="text-2xl font-bold text-gray-800">Upload NOS & PC</h2>
                        <button onClick={onBack} className="bg-white border hover:bg-gray-50 text-gray-700 px-4 py-2 rounded shadow-sm">Back</button>
                    </div>

                    <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-100 mb-6">
                        <div className="flex items-center gap-8 mb-8">
                            <span className="font-bold text-gray-700">Sector Skill Council :</span>
                            <span className="text-gray-600 font-medium text-lg">{sscList.find(s => s.id === selectedSSC)?.name || 'All'}</span>
                        </div>

                        <div className="space-y-4 mb-8">
                            <p className="font-medium text-gray-600">Note : It will accept only Excel files with *.xls or *.xlsx extension only.</p>
                            <div className="flex items-center gap-4">
                                <button onClick={downloadSample} className="flex items-center gap-2 text-green-600 border border-green-600 px-4 py-2 rounded hover:bg-green-50">
                                    <Icons.Download className="w-4 h-4" /> Download Sample Format
                                </button>
                            </div>
                        </div>

                        <div className="border-t pt-8">
                            <div className="max-w-xl mx-auto text-center">
                                <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 hover:border-indigo-500 transition-colors">
                                    <Icons.Upload className="w-12 h-12 text-gray-400 mx-auto mb-4" />
                                    <p className="text-gray-600 mb-4">Drag and drop your Excel file here, or click to browse</p>
                                    <input type="file" accept=".xlsx,.xls" onChange={e => setFile(e.target.files[0])} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
                                </div>
                                <button onClick={handleValidate} className="mt-6 w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 shadow-md">
                                    Upload & Process
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };



        // MARKS TAB (New Feature)
        // MARKS TAB (Refactored for NOS-based Entry)
        const MarksTab = () => {
            const [sscList, setSSCList] = useState([]);
            const [qpList, setQPList] = useState([]);
            const [batches, setBatches] = useState([]);

            const [selectedSSC, setSelectedSSC] = useState('');
            const [selectedQP, setSelectedQP] = useState('');
            const [selectedBatch, setSelectedBatch] = useState('');
            const [students, setStudents] = useState([]);
            const [nosList, setNOSList] = useState([]); // Use NOS List
            const [showGrid, setShowGrid] = useState(false);
            const [marksData, setMarksData] = useState({});
            const [attendance, setAttendance] = useState({});
            const [viewMode, setViewMode] = useState('grid'); // 'grid' | 'cards'

            useEffect(() => {
                setSSCList(window.Utils.getSSC());
            }, []);

            useEffect(() => {
                if (selectedSSC) {
                    const allQPs = window.Utils.getQPs();
                    setQPList(allQPs.filter(q => q.id.startsWith(selectedSSC) || q.sscId === selectedSSC));
                } else {
                    setQPList([]);
                }
            }, [selectedSSC]);

            useEffect(() => {
                if (selectedQP) {
                    const allBatches = window.Utils.getBatches();
                    setBatches(allBatches.filter(b => b.qpId === selectedQP || b.qpName === qpList.find(q => q.id === selectedQP)?.name));
                } else {
                    setBatches([]);
                }
            }, [selectedQP]);

            // EXCEL TEMPLATE DOWNLOAD
            const downloadMarksTemplate = () => {
                if (!students.length || !nosList.length) {
                    alert("Please select a Batch with Students and QP content first.");
                    return;
                }
                const rows = [];
                students.forEach(student => {
                    nosList.forEach(nos => {
                        rows.push({
                            'Enrollment No': student.username || student.id,
                            'Student Name': student.name,
                            'NOS Code': nos.code,
                            'NOS Name': nos.name,
                            'Theory': '',
                            'Practical': '',
                            'Viva': '',
                            'Attendance (P/A)': 'P'
                        });
                    });
                });

                const ws = XLSX.utils.json_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Marks Template");
                XLSX.writeFile(wb, `Marks_Entry_Template_${selectedBatch}.xlsx`);
            };

            // EXCEL MARKS UPLOAD
            const handleMarksUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        const data = XLSX.utils.sheet_to_json(ws);

                        let newMarks = { ...marksData };
                        let newAttendance = { ...attendance };
                        let count = 0;

                        data.forEach(row => {
                            // Flexible Key Matching
                            const findKey = (search) => Object.keys(row).find(k => k.toLowerCase().replace(/[^a-z0-9]/g, '') === search.toLowerCase().replace(/[^a-z0-9]/g, ''));

                            // Match 'Enrollment No' or 'EnrollmentNo' or 'User ID'
                            const kId = findKey('Enrollment No') || findKey('EnrollmentNo') || findKey('User ID') || findKey('UserID');
                            const kNOS = findKey('NOS Code') || findKey('NOSCode');
                            const kTheory = findKey('Theory');
                            const kPractical = findKey('Practical');
                            const kViva = findKey('Viva');
                            const kAtt = findKey('Attendance') || findKey('Attendance (P/A)');

                            const enrollmentVal = row[kId];
                            const nosCode = row[kNOS];

                            if (enrollmentVal && nosCode) {
                                // Match Student by Username (U1, U2...) OR ID as fallback
                                const student = students.find(s =>
                                    String(s.username).trim().toLowerCase() === String(enrollmentVal).trim().toLowerCase() ||
                                    String(s.id).trim() === String(enrollmentVal).trim()
                                );
                                // Validate NOS
                                const nos = nosList.find(n => n.code === String(nosCode).trim());

                                if (student && nos) {
                                    // Attendance
                                    if (kAtt) {
                                        const val = String(row[kAtt]).trim().toUpperCase();
                                        if (val === 'A' || val === 'ABSENT' || val === 'FALSE') {
                                            newAttendance[student.id] = false;
                                        } else {
                                            newAttendance[student.id] = true; // Default or 'P'
                                        }
                                    }

                                    // Marks (Only if Present or handled otherwise)
                                    // We allow entering marks even if absent, but typically they should be 0 or null.
                                    // User logic: just fill what's there.
                                    if (kTheory !== undefined) newMarks[`${student.id}_${nos.id}_theory`] = row[kTheory];
                                    if (kPractical !== undefined) newMarks[`${student.id}_${nos.id}_practical`] = row[kPractical];
                                    if (kViva !== undefined) newMarks[`${student.id}_${nos.id}_viva`] = row[kViva];
                                    count++;
                                }
                            }
                        });

                        setMarksData(newMarks);
                        setAttendance(newAttendance);
                        alert(`Successfully imported marks for ${count} entries!`);
                        e.target.value = null; // Reset input

                    } catch (err) {
                        console.error("Upload Error", err);
                        alert("Error processing Excel file: " + err.message);
                    }
                };
                reader.readAsBinaryString(file);
            };

            const handleLoadGrid = () => {
                if (!selectedBatch || !selectedQP) return;

                // 1. Fetch Students
                const batchStudents = window.Utils.getStudentsByBatch(selectedBatch);
                setStudents(batchStudents);

                // 2. Fetch NOS with Aggregated Marks
                const allNOS = window.Utils.getNOS();
                const allPCs = window.Utils.getPCs();
                const qpNOS = allNOS.filter(n => n.qpId === selectedQP).map(nos => {
                    const myPCs = allPCs.filter(p => p.nosId === nos.id);
                    return {
                        ...nos,
                        theoryMarks: myPCs.reduce((sum, p) => sum + (parseFloat(p.theoryMarks) || 0), 0),
                        practicalMarks: myPCs.reduce((sum, p) => sum + (parseFloat(p.practicalMarks) || 0), 0),
                        vivaMarks: myPCs.reduce((sum, p) => sum + (parseFloat(p.vivaMarks) || 0), 0),
                    };
                });
                setNOSList(qpNOS);

                // 3. Load Existing Marks
                const responses = window.Utils.getResponses().filter(r => r.batchId === selectedBatch && r.examType === 'MarksEntry');
                const initialMarks = {};
                const initialAttendance = {};

                responses.forEach(r => {
                    initialAttendance[r.studentId] = r.attendance !== false; // Default true if undefined
                    if (r.nosMarks) {
                        Object.entries(r.nosMarks).forEach(([key, val]) => {
                            initialMarks[`${r.studentId}_${key}`] = val;
                        });
                    }
                });
                setMarksData(initialMarks);
                setAttendance(initialAttendance);

                setShowGrid(true);
            };

            // Auto-load grid
            useEffect(() => {
                if (selectedBatch && selectedQP) {
                    handleLoadGrid();
                } else {
                    setShowGrid(false);
                }
            }, [selectedBatch]);

            const handleMarkChange = (studentId, nosId, type, value) => {
                setMarksData(prev => ({
                    ...prev,
                    [`${studentId}_${nosId}_${type}`]: value
                }));
            };

            const handleAttendanceChange = (studentId, checked) => {
                setAttendance(prev => ({ ...prev, [studentId]: checked }));
            };

            const handleSaveStudent = (studentId) => {
                // Collect marks for this student
                const studentMarks = {};
                let grandTotal = 0;

                nosList.forEach(nos => {
                    const t = marksData[`${studentId}_${nos.id}_theory`];
                    const p = marksData[`${studentId}_${nos.id}_practical`];
                    const v = marksData[`${studentId}_${nos.id}_viva`];

                    if (t) studentMarks[`${nos.id}_theory`] = t;
                    if (p) studentMarks[`${nos.id}_practical`] = p;
                    if (v) studentMarks[`${nos.id}_viva`] = v;

                    grandTotal += (parseFloat(t) || 0) + (parseFloat(p) || 0) + (parseFloat(v) || 0);
                });

                const response = {
                    id: window.Utils.generateId(),
                    studentId: studentId,
                    batchId: selectedBatch,
                    qpId: selectedQP,
                    examType: 'MarksEntry',
                    nosMarks: studentMarks,
                    attendance: attendance[studentId] !== false,
                    totalMarks: grandTotal,
                    submittedAt: new Date().toISOString(),
                    status: 'Completed'
                };
                window.Utils.saveResponse(response);
                window.Utils.uploadToCloud(true);
                alert("Saved successfully!");
            };

            return (
                <div className="animate-fade-in text-sm p-6">
                    {/* Header Controls */}
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h2 className="text-2xl font-bold text-gray-800">Marks Entry (NOS Level)</h2>

                        {showGrid && (
                            <div className="flex flex-wrap gap-3">
                                <label className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold shadow-sm cursor-pointer text-sm transition-colors">
                                    <Icons.Upload className="w-4 h-4" /> Upload Excel
                                    <input type="file" accept=".xlsx, .xls" className="hidden" onChange={handleMarksUpload} />
                                </label>

                                <button onClick={downloadMarksTemplate} className="bg-white border text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg font-bold shadow-sm flex items-center gap-2 text-sm transition-colors">
                                    <Icons.Download className="w-4 h-4" /> Template
                                </button>

                                {viewMode === 'grid' ? (
                                    <button onClick={() => setViewMode('cards')} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold shadow-sm flex items-center gap-2 text-sm transition-colors">
                                        <Icons.Plus className="w-4 h-4" /> Add Marks
                                    </button>
                                ) : (
                                    <button onClick={() => setViewMode('grid')} className="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-bold shadow-sm flex items-center gap-2 text-sm transition-colors">
                                        <Icons.Grid className="w-4 h-4" /> Back to Grid
                                    </button>
                                )}
                            </div>
                        )}
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-2">Sector Skill Council</label>
                            <select className="w-full p-2 border rounded-lg" value={selectedSSC} onChange={e => setSelectedSSC(e.target.value)}>
                                <option value="">Select SSC</option>
                                {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-2">Qualification Pack</label>
                            <select className="w-full p-2 border rounded-lg" value={selectedQP} onChange={e => setSelectedQP(e.target.value)} disabled={!selectedSSC}>
                                <option value="">Select QP</option>
                                {qpList.map(q => <option key={q.id} value={q.id}>{q.name}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-2">Batch</label>
                            <select className="w-full p-2 border rounded-lg" value={selectedBatch} onChange={e => setSelectedBatch(e.target.value)} disabled={!selectedQP}>
                                <option value="">Select Batch</option>
                                {batches.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}
                            </select>
                        </div>
                    </div>
                    {/* Grid Area */}
                    {showGrid ? (
                        <>
                            {/* VIEW A: SPREADSHEET GRID */}
                            {viewMode === 'grid' && (
                                <div className="flex-1 overflow-auto bg-white rounded-xl shadow border border-gray-200 mt-6 h-[600px] custom-scrollbar">
                                    <table className="w-max min-w-full text-sm text-left border-collapse whitespace-nowrap">
                                        <thead className="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0 z-10">
                                            <tr>
                                                <th className="px-4 py-3 border-b border-r sticky left-0 bg-gray-50 z-20 w-16" rowSpan="2">#</th>
                                                <th className="px-4 py-3 border-b border-r sticky left-16 bg-gray-50 z-20 w-64" rowSpan="2">Student</th>
                                                {nosList.map((nos) => (
                                                    <th key={nos.id} className="px-4 py-2 border-b border-r text-center bg-gray-100" colSpan="4" title={nos.name}>
                                                        <div className="font-bold text-indigo-700 truncate max-w-[200px] mx-auto">{nos.code}<br /><span className="text-[10px] text-gray-500 font-normal">{nos.name}</span></div>
                                                    </th>
                                                ))}
                                                <th className="px-4 py-3 border-b border-l bg-gray-200 font-bold text-center w-24" rowSpan="2">Grand Total</th>
                                            </tr>
                                            <tr>
                                                {nosList.map((nos) => (
                                                    <React.Fragment key={nos.id + '_sub'}>
                                                        <th className="px-2 py-1 border-b border-r text-center w-20 text-[10px]">Theory</th>
                                                        <th className="px-2 py-1 border-b border-r text-center w-20 text-[10px]">Practical</th>
                                                        <th className="px-2 py-1 border-b border-r text-center w-20 text-[10px]">Viva</th>
                                                        <th className="px-2 py-1 border-b border-r text-center w-20 bg-gray-50 font-bold text-[10px]">Total</th>
                                                    </React.Fragment>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {students.map((s, idx) => {
                                                let grandTotal = 0;
                                                return (
                                                    <tr key={s.id} className="hover:bg-gray-50 transition-colors">
                                                        <td className="px-4 py-3 border-r sticky left-0 bg-white group-hover:bg-gray-50">{idx + 1}</td>
                                                        <td className="px-4 py-3 border-r sticky left-16 bg-white group-hover:bg-gray-50 font-medium text-gray-800">
                                                            {s.name} <br /> <span className="text-xs text-gray-400">{s.id}</span>
                                                        </td>
                                                        {nosList.map(nos => {
                                                            const t = marksData[`${s.id}_${nos.id}_theory`] || '';
                                                            const p = marksData[`${s.id}_${nos.id}_practical`] || '';
                                                            const v = marksData[`${s.id}_${nos.id}_viva`] || '';
                                                            const subTotal = (parseFloat(t) || 0) + (parseFloat(p) || 0) + (parseFloat(v) || 0);
                                                            grandTotal += subTotal;

                                                            return (
                                                                <React.Fragment key={nos.id}>
                                                                    <td className="px-1 py-2 border-r text-center">
                                                                        <input type="text" className="w-16 p-1 border rounded text-center bg-gray-100 text-gray-500 outline-none text-xs cursor-default"
                                                                            value={t} readOnly />
                                                                    </td>
                                                                    <td className="px-1 py-2 border-r text-center">
                                                                        <input type="text" className="w-16 p-1 border rounded text-center bg-gray-100 text-gray-500 outline-none text-xs cursor-default"
                                                                            value={p} readOnly />
                                                                    </td>
                                                                    <td className="px-1 py-2 border-r text-center">
                                                                        <input type="text" className="w-16 p-1 border rounded text-center bg-gray-100 text-gray-500 outline-none text-xs cursor-default"
                                                                            value={v} readOnly />
                                                                    </td>
                                                                    <td className="px-2 py-2 border-r text-center bg-gray-50 font-bold text-xs">
                                                                        {subTotal > 0 ? subTotal : '-'}
                                                                    </td>
                                                                </React.Fragment>
                                                            );
                                                        })}
                                                        <td className="px-4 py-3 border-l bg-gray-100 font-bold text-center text-indigo-700">
                                                            {grandTotal}
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            )}

                            {/* VIEW B: STUDENT CARDS */}
                            {viewMode === 'cards' && (
                                <div className="flex flex-col gap-6">
                                    {students.map((s, idx) => (
                                        <div key={s.id} className="bg-white rounded-xl shadow border border-gray-200 flex flex-col md:flex-row overflow-hidden">
                                            {/* Left: Student Details */}
                                            <div className="w-full md:w-1/4 p-6 border-b md:border-b-0 md:border-r bg-gray-50 flex flex-col justify-between">
                                                <div>
                                                    <div className="flex items-center gap-3 mb-4">
                                                        <span className="bg-indigo-100 text-indigo-700 font-bold p-2 rounded-lg text-xs">#{idx + 1}</span>
                                                        <div>
                                                            <h3 className="font-bold text-gray-800">{s.name}</h3>
                                                            <p className="text-xs text-gray-500">{s.id}</p>
                                                        </div>
                                                    </div>

                                                    <div className="mb-6">
                                                        <label className="flex items-center gap-2 text-sm text-gray-700 font-medium cursor-pointer">
                                                            <input type="checkbox"
                                                                checked={attendance[s.id] !== false}
                                                                onChange={e => handleAttendanceChange(s.id, e.target.checked)}
                                                                className="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"
                                                            />
                                                            Mark as Present
                                                        </label>
                                                    </div>
                                                </div>

                                                <button onClick={() => handleSaveStudent(s.id)} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-bold shadow-sm flex justify-center items-center gap-2 text-sm transition-colors">
                                                    <Icons.Save className="w-4 h-4" /> Save
                                                </button>
                                            </div>

                                            {/* Right: Marks Grid */}
                                            <div className="w-full md:w-3/4 p-6 overflow-x-auto">
                                                <table className="w-full text-sm text-left border-collapse whitespace-nowrap">
                                                    <thead className="bg-gray-100 text-xs text-gray-700 uppercase">
                                                        <tr>
                                                            <th className="px-4 py-2 border rounded-tl-lg">NOS ID</th>
                                                            <th className="px-4 py-2 border text-center">Total Theory</th>
                                                            <th className="px-4 py-2 border text-center">Scored Theory</th>
                                                            <th className="px-4 py-2 border text-center">Total Practical</th>
                                                            <th className="px-4 py-2 border text-center">Scored Practical</th>
                                                            <th className="px-4 py-2 border text-center">Total Viva</th>
                                                            <th className="px-4 py-2 border text-center">Scored Viva</th>
                                                            <th className="px-4 py-2 border rounded-tr-lg text-center bg-gray-200">Total Scored</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-gray-100">
                                                        {nosList.map(nos => {
                                                            const t = marksData[`${s.id}_${nos.id}_theory`] || 0;
                                                            const p = marksData[`${s.id}_${nos.id}_practical`] || 0;
                                                            const v = marksData[`${s.id}_${nos.id}_viva`] || 0;
                                                            const totalObtained = parseFloat(t) + parseFloat(p) + parseFloat(v);
                                                            return (
                                                                <tr key={nos.id}>
                                                                    <td className="px-4 py-3 border font-medium text-indigo-600 w-32">
                                                                        {nos.code}
                                                                        <div className="text-[10px] text-gray-400 truncate max-w-[150px]" title={nos.name}>{nos.name}</div>
                                                                    </td>
                                                                    <td className="px-4 py-2 border text-center text-gray-500">{nos.theoryMarks || '-'}</td>
                                                                    <td className="px-4 py-2 border">
                                                                        <input type="number" min="0" className="w-full p-1 border rounded text-center focus:ring-1 focus:ring-indigo-500 outline-none"
                                                                            value={marksData[`${s.id}_${nos.id}_theory`] || ''} onChange={e => handleMarkChange(s.id, nos.id, 'theory', e.target.value)} />
                                                                    </td>
                                                                    <td className="px-4 py-2 border text-center text-gray-500">{nos.practicalMarks || '-'}</td>
                                                                    <td className="px-4 py-2 border">
                                                                        <input type="number" min="0" className="w-full p-1 border rounded text-center focus:ring-1 focus:ring-indigo-500 outline-none"
                                                                            value={marksData[`${s.id}_${nos.id}_practical`] || ''} onChange={e => handleMarkChange(s.id, nos.id, 'practical', e.target.value)} />
                                                                    </td>
                                                                    <td className="px-4 py-2 border text-center text-gray-500">{nos.vivaMarks || '-'}</td>
                                                                    <td className="px-4 py-2 border">
                                                                        <input type="number" min="0" className="w-full p-1 border rounded text-center focus:ring-1 focus:ring-indigo-500 outline-none"
                                                                            value={marksData[`${s.id}_${nos.id}_viva`] || ''} onChange={e => handleMarkChange(s.id, nos.id, 'viva', e.target.value)} />
                                                                    </td>
                                                                    <td className="px-4 py-2 border text-center font-bold bg-gray-50 text-indigo-700">
                                                                        {totalObtained > 0 ? totalObtained : '-'}
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </>
                    ) : (selectedBatch && (
                        <div className="p-10 text-center bg-white rounded-xl border border-dashed border-gray-300 mt-6">
                            <Icons.Edit3 className="w-12 h-12 text-gray-300 mx-auto mb-4" />
                            <h3 className="text-xl font-bold text-gray-700">Ready to Enter Marks</h3>
                            <p className="text-gray-500">Grid will load automatically.</p>
                        </div>
                    ))}
                </div>
            );
        };

        // QPS TAB
        const QPsTab = ({ onNavigateToNOS }) => {
            const [sscList, setSSCList] = useState([]);
            const [qpList, setQPList] = useState([]);
            const [selectedSSC, setSelectedSSC] = useState('');
            const [showModal, setShowModal] = useState(false);
            const [newQP, setNewQP] = useState({ name: '', code: '', sscId: '', qpLevel: '', theoryMarks: 0, practicalMarks: 0, vivaMarks: 0, totalMarks: 0, isTheoryCutoff: false, isPracticalCutoff: false, isVivaCutoff: false, isOverallCutoff: false });
            const [viewMode, setViewMode] = useState('list');

            useEffect(() => {
                const load = () => {
                    setSSCList(window.Utils.getSSC());
                    setQPList(window.Utils.getQPs());
                };
                load();
                window.addEventListener('cloud-sync-complete', load);
                return () => window.removeEventListener('cloud-sync-complete', load);
            }, []);

            const handleCreate = (e) => {
                e.preventDefault();
                const qp = {
                    ...newQP,
                    id: newQP.id || window.Utils.generateId(),
                    totalMarks: (parseFloat(newQP.theoryMarks) || 0) + (parseFloat(newQP.practicalMarks) || 0) + (parseFloat(newQP.vivaMarks) || 0)
                };
                window.Utils.saveQP(qp);
                window.Utils.uploadToCloud(true);
                setQPList(window.Utils.getQPs());
                setShowModal(false);
                setNewQP({ name: '', code: '', sscId: '', qpLevel: '', theoryMarks: 0, practicalMarks: 0, vivaMarks: 0, totalMarks: 0 });
            };

            const handleEdit = (qp) => {
                setNewQP(qp);
                setShowModal(true);
            };

            const filteredQPs = selectedSSC ? qpList.filter(q => q.sscId === selectedSSC) : [];

            if (viewMode === 'upload') {
                return (
                    <div className="p-6 animate-fade-in">
                        <button onClick={() => setViewMode('list')} className="mb-4 text-indigo-600 font-bold flex items-center gap-2">? Back to List</button>
                        <h2 className="text-xl font-bold mb-4">Upload NOS & PC</h2>
                        <div className="bg-white p-6 rounded shadow border border-dashed border-gray-300 text-center">
                            <p className="text-gray-500">Excel Upload feature coming soon.</p>
                        </div>
                    </div>
                )
            }

            return (
                <div className="animate-fade-in text-sm">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">Qualification Packs</h2>
                        <div className="flex gap-2">
                            <select className="border p-2 rounded text-gray-600" value={selectedSSC} onChange={e => setSelectedSSC(e.target.value)}>
                                <option value="">Select Sector Skill Council</option>
                                {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                            <button onClick={() => { setNewQP({ ...newQP, sscId: selectedSSC }); setShowModal(true); }} className="bg-indigo-600 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-indigo-700 shadow-sm">
                                <Icons.Plus className="w-4 h-4" /> Add New
                            </button>
                        </div>
                    </div>



                    <div className="bg-white rounded shadow border overflow-x-auto">
                        <table className="w-full min-w-[1200px]">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Qualification Pack ID</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Name</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Level</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Total Marks</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Total Theory Marks</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Total Practical Marks</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Total Viva Marks</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Theory Cutoff</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Practical Cutoff</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Viva Cutoff</th>
                                    <th className="p-3 text-left font-bold text-gray-700 border-r">Overall Cutoff</th>
                                    <th className="p-3 text-center font-bold text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {filteredQPs.map((qp) => (
                                    <tr key={qp.id} className="hover:bg-gray-50">
                                        <td className="p-3 font-bold text-red-500 border-r">{qp.code}</td>
                                        <td className="p-3 border-r max-w-xs truncate" title={qp.name}>{qp.name}</td>
                                        <td className="p-3 border-r">{qp.qpLevel || 'N/A'}</td>
                                        <td className="p-3 border-r">{Number(qp.totalMarks).toFixed(2)}</td>
                                        <td className="p-3 border-r">{Number(qp.theoryMarks).toFixed(2)}</td>
                                        <td className="p-3 border-r">{Number(qp.practicalMarks).toFixed(2)}</td>
                                        <td className="p-3 border-r">{Number(qp.vivaMarks).toFixed(2)}</td>
                                        <td className="p-3 border-r">{qp.isTheoryCutoff ? (qp.theoryCutoff || '0.00') : 'N/A'}</td>
                                        <td className="p-3 border-r">{qp.isPracticalCutoff ? (qp.practicalCutoff || '0.00') : 'N/A'}</td>
                                        <td className="p-3 border-r">{qp.isVivaCutoff ? (qp.vivaCutoff || '0.00') : 'N/A'}</td>
                                        <td className="p-3 border-r">{qp.isOverallCutoff ? (qp.overallCutoff || '0.00') : 'N/A'}</td>
                                        <td className="p-3 text-center flex justify-center gap-2">
                                            <button onClick={() => onNavigateToNOS(qp)} className="bg-cyan-700 text-white px-3 py-1 rounded text-xs flex items-center gap-1 hover:bg-cyan-800">
                                                <Icons.Eye /> NOS
                                            </button>
                                            <button onClick={() => handleEdit(qp)} className="bg-cyan-700 text-white p-1 rounded hover:bg-cyan-800" title="Edit QP">
                                                <Icons.Edit3 />
                                            </button>
                                            <button onClick={() => { if (confirm('Delete?')) { window.Utils.deleteQP(qp.id); setQPList(window.Utils.getQPs()); } }}
                                                className="text-red-600 p-1 hover:bg-red-50 rounded"><Icons.Trash2 /></button>
                                        </td>
                                    </tr>
                                ))}
                                {filteredQPs.length === 0 && <tr><td colSpan="12" className="p-8 text-center text-gray-400">No records found</td></tr>}
                            </tbody>
                        </table>
                    </div>
                    {
                        showModal && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                                <div className="bg-white rounded-xl p-8 w-full max-w-4xl my-8">
                                    <h3 className="text-2xl font-bold mb-6 text-gray-800">{newQP.id ? 'Edit Qualification Pack' : 'Add Qualification Pack'}</h3>
                                    <form onSubmit={handleCreate} className="space-y-6">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">

                                            {/* Row 1 */}
                                            <div className="space-y-1">
                                                <label className="font-semibold text-gray-700">SSC</label>
                                                <select required className="w-full px-4 py-2 border rounded-lg" value={newQP.sscId} onChange={e => setNewQP({ ...newQP, sscId: e.target.value })}>
                                                    <option value="">Select SSC</option>
                                                    {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                                </select>
                                            </div>
                                            <div className="space-y-1">
                                                <label className="font-semibold text-gray-700">Qualification Pack Name</label>
                                                <input required className="w-full px-4 py-2 border rounded-lg" value={newQP.name} onChange={e => setNewQP({ ...newQP, name: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="font-semibold text-gray-700">Qualification Pack ID</label>
                                                <input required className="w-full px-4 py-2 border rounded-lg" value={newQP.code} onChange={e => setNewQP({ ...newQP, code: e.target.value })} />
                                            </div>

                                            {/* Row 2 */}
                                            <div className="space-y-1">
                                                <label className="font-semibold text-gray-700">Qualification Pack Level</label>
                                                <input className="w-full px-4 py-2 border rounded-lg" value={newQP.qpLevel} onChange={e => setNewQP({ ...newQP, qpLevel: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="font-semibold text-gray-700">Total Theory Marks</label>
                                                <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newQP.theoryMarks} onChange={e => setNewQP({ ...newQP, theoryMarks: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="font-semibold text-gray-700">Total Viva Marks</label>
                                                <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newQP.vivaMarks} onChange={e => setNewQP({ ...newQP, vivaMarks: e.target.value })} />
                                            </div>

                                            {/* Row 3 */}
                                            <div className="space-y-1">
                                                <label className="font-semibold text-gray-700">Total Practical Marks</label>
                                                <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newQP.practicalMarks} onChange={e => setNewQP({ ...newQP, practicalMarks: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="font-semibold text-gray-700">Total Marks</label>
                                                <input readOnly className="w-full px-4 py-2 border rounded-lg bg-gray-100" value={newQP.totalMarks} />
                                            </div>
                                        </div>

                                        <div className="space-y-4 pt-4 border-t">
                                            <div className="flex flex-col gap-4">
                                                <div className="flex items-center gap-6">
                                                    <label className="flex items-center gap-2 cursor-pointer w-64">
                                                        <input type="checkbox" className="w-5 h-5 rounded" checked={newQP.isTheoryCutoff} onChange={e => setNewQP({ ...newQP, isTheoryCutoff: e.target.checked })} />
                                                        <span className="font-medium text-gray-700">Is theory cutoff available</span>
                                                    </label>
                                                    {newQP.isTheoryCutoff && (
                                                        <div className="flex items-center gap-2 animate-fade-in">
                                                            <label className="text-xs font-bold text-gray-500">Value:</label>
                                                            <input type="number" step="0.01" className="w-24 px-3 py-1 border rounded-lg text-sm" placeholder="40.00" value={newQP.theoryCutoff} onChange={e => setNewQP({ ...newQP, theoryCutoff: e.target.value })} />
                                                        </div>
                                                    )}
                                                </div>

                                                <div className="flex items-center gap-6">
                                                    <label className="flex items-center gap-2 cursor-pointer w-64">
                                                        <input type="checkbox" className="w-5 h-5 rounded" checked={newQP.isVivaCutoff} onChange={e => setNewQP({ ...newQP, isVivaCutoff: e.target.checked })} />
                                                        <span className="font-medium text-gray-700">Is Viva cutoff available</span>
                                                    </label>
                                                    {newQP.isVivaCutoff && (
                                                        <div className="flex items-center gap-2 animate-fade-in">
                                                            <label className="text-xs font-bold text-gray-500">Value:</label>
                                                            <input type="number" step="0.01" className="w-24 px-3 py-1 border rounded-lg text-sm" placeholder="40.00" value={newQP.vivaCutoff} onChange={e => setNewQP({ ...newQP, vivaCutoff: e.target.value })} />
                                                        </div>
                                                    )}
                                                </div>

                                                <div className="flex items-center gap-6">
                                                    <label className="flex items-center gap-2 cursor-pointer w-64">
                                                        <input type="checkbox" className="w-5 h-5 rounded" checked={newQP.isPracticalCutoff} onChange={e => setNewQP({ ...newQP, isPracticalCutoff: e.target.checked })} />
                                                        <span className="font-medium text-gray-700">Is practical cutoff available</span>
                                                    </label>
                                                    {newQP.isPracticalCutoff && (
                                                        <div className="flex items-center gap-2 animate-fade-in">
                                                            <label className="text-xs font-bold text-gray-500">Value:</label>
                                                            <input type="number" step="0.01" className="w-24 px-3 py-1 border rounded-lg text-sm" placeholder="40.00" value={newQP.practicalCutoff} onChange={e => setNewQP({ ...newQP, practicalCutoff: e.target.value })} />
                                                        </div>
                                                    )}
                                                </div>

                                                <div className="flex items-center gap-6">
                                                    <label className="flex items-center gap-2 cursor-pointer w-64">
                                                        <input type="checkbox" className="w-5 h-5 rounded" checked={newQP.isOverallCutoff} onChange={e => setNewQP({ ...newQP, isOverallCutoff: e.target.checked })} />
                                                        <span className="font-medium text-gray-700">Is overall cutoff available</span>
                                                    </label>
                                                    {newQP.isOverallCutoff && (
                                                        <div className="flex items-center gap-2 animate-fade-in">
                                                            <label className="text-xs font-bold text-gray-500">Value:</label>
                                                            <input type="number" step="0.01" className="w-24 px-3 py-1 border rounded-lg text-sm" placeholder="40.00" value={newQP.overallCutoff} onChange={e => setNewQP({ ...newQP, overallCutoff: e.target.value })} />
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>

                                        <div className="flex gap-4 justify-end pt-6 border-t">
                                            <button type="button" onClick={() => setShowModal(false)} className="px-6 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium border border-gray-300">Cancel</button>
                                            <button type="submit" className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium shadow-md">
                                                {newQP.id ? 'Save Changes' : 'Create'}
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        )
                    }
                </div>
            );
        };

        // NOS & PC TAB
        const NOSPC_Tab = ({ selectedQP, onBack }) => {
            const [nosList, setNOSList] = useState([]);
            const [qpList, setQPList] = useState([]);
            const [pcList, setPCList] = useState([]);
            const [sscList, setSSCList] = useState([]);
            const [showNOSModal, setShowNOSModal] = useState(false);
            const [showPCModal, setShowPCModal] = useState(false);
            const [selectedNOS, setSelectedNOS] = useState(null);
            const [expandedNOS, setExpandedNOS] = useState([]);
            const [showUploadNOSModal, setShowUploadNOSModal] = useState(false);
            const [showUploadPCModal, setShowUploadPCModal] = useState(false);

            const [newNOS, setNewNOS] = useState({
                name: '', code: '', qpId: selectedQP?.id || '',
                theoryCutoff: '', vivaCutoff: '', practicalCutoff: '', overallCutoff: ''
            });
            const [newPC, setNewPC] = useState({ name: '', code: '' });

            useEffect(() => {
                const load = () => {
                    setSSCList(window.Utils.getSSC());
                    setQPList(window.Utils.getQPs()); // Updates QP list too
                    setNOSList(window.Utils.getNOS());
                    setPCList(window.Utils.getPCs());
                };
                load();
                window.addEventListener('cloud-sync-complete', load);
                return () => window.removeEventListener('cloud-sync-complete', load);
            }, []);

            // Auto-Heal: Silently bring in data from Duplicate QPs
            useEffect(() => {
                if (!selectedQP) return;

                const allNOS = window.Utils.getNOS();
                const allQPs = window.Utils.getQPs();

                // Find "ghost" QPs (same code, diff ID)
                const ghosts = allQPs.filter(q => q.code === selectedQP.code && q.id !== selectedQP.id);
                if (ghosts.length === 0) return;

                const ghostIDs = ghosts.map(g => g.id);

                // Check if any NOS belongs to a ghost
                const orphans = allNOS.filter(n => ghostIDs.includes(n.qpId));

                if (orphans.length > 0) {
                    // Move them to current QP
                    const updatedNOS = allNOS.map(n => {
                        if (ghostIDs.includes(n.qpId)) {
                            return { ...n, qpId: selectedQP.id };
                        }
                        return n;
                    });

                    window.Utils.saveNOSList ? window.Utils.saveNOSList(updatedNOS) : localStorage.setItem('se_nos', JSON.stringify(updatedNOS));
                    console.log(`Auto-Healed ${orphans.length} NOS records from duplicate QPs.`);
                    setNOSList(updatedNOS);
                }
            }, [selectedQP]);

            const handleCreateNOS = (e) => {
                e.preventDefault();
                const nos = { ...newNOS, id: window.Utils.generateId(), createdAt: new Date().toISOString() };
                window.Utils.saveNOS(nos);
                window.Utils.uploadToCloud(true);
                setNOSList(window.Utils.getNOS());
                setShowNOSModal(false);
                setNewNOS({ name: '', code: '', qpId: selectedQP?.id || '', theoryCutoff: '', vivaCutoff: '', practicalCutoff: '', overallCutoff: '' });
            };

            const handleCreatePC = (e) => {
                e.preventDefault();
                if (!selectedNOS) return;
                const pc = {
                    ...newPC,
                    id: window.Utils.generateId(),
                    nosId: selectedNOS.id,
                    createdAt: new Date().toISOString(),
                    theoryMarks: 0, practicalMarks: 0, vivaMarks: 0, totalMarks: 0
                };
                window.Utils.savePC(pc);
                window.Utils.uploadToCloud(true);
                setPCList(window.Utils.getPCs());
                setShowPCModal(false);
                setNewPC({ name: '', code: '' });
            };

            const openPCModal = (nos) => {
                setSelectedNOS(nos);
                setShowPCModal(true);
            };

            const toggleExpand = (nosId) => {
                setExpandedNOS(prev => prev.includes(nosId) ? prev.filter(id => id !== nosId) : [...prev, nosId]);
            };

            const handlePCMarkChange = (pcId, field, value) => {
                const updatedPCs = pcList.map(pc => {
                    if (pc.id === pcId) {
                        const updatedPC = { ...pc, [field]: parseFloat(value) || 0 };
                        updatedPC.totalMarks = (updatedPC.theoryMarks || 0) + (updatedPC.practicalMarks || 0) + (updatedPC.vivaMarks || 0);
                        // Removed auto-save: window.Utils.savePC(updatedPC);
                        return updatedPC;
                    }
                    return pc;
                });
                setPCList(updatedPCs);
            };

            const handleSavePC = (pcId) => {
                const pcToSave = pcList.find(p => p.id === pcId);
                if (pcToSave) {
                    window.Utils.savePC(pcToSave);
                    alert("Marks saved successfully!");
                }
            };

            const getQPName = (id) => qpList.find(q => q.id === id)?.name || id;
            const getSSCName = (id) => sscList.find(s => s.id === id)?.name || id;

            const handleUploadNOS = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const bstr = evt.target.result;
                    const wb = window.XLSX.read(bstr, { type: 'binary' });
                    const wsname = wb.SheetNames[0];
                    const ws = wb.Sheets[wsname];
                    const data = window.XLSX.utils.sheet_to_json(ws);

                    console.log("Uploaded NOS & PC Data:", data);

                    // Validation: Calculate totals from Excel
                    let totalTheory = 0;
                    let totalPractical = 0;
                    let totalViva = 0;

                    data.forEach(row => {
                        // Ensure we are only summing valid rows with NOSID
                        if (row['NOSID'] || row['NOS ID']) {
                            totalTheory += parseFloat(row['Theory Marks']) || 0;
                            totalPractical += parseFloat(row['Practical Marks']) || 0;
                            totalViva += parseFloat(row['Viva Marks']) || 0;
                        }
                    });

                    // Round to 2 decimal places
                    totalTheory = Math.round(totalTheory * 100) / 100;
                    totalPractical = Math.round(totalPractical * 100) / 100;
                    totalViva = Math.round(totalViva * 100) / 100;

                    const qpTheory = parseFloat(selectedQP.theoryMarks) || 0;
                    const qpPractical = parseFloat(selectedQP.practicalMarks) || 0;
                    const qpViva = parseFloat(selectedQP.vivaMarks) || 0;

                    console.log(`Validation Debug:
                        Excel: T=${totalTheory}, P=${totalPractical}, V=${totalViva}
                        QP: T=${qpTheory}, P=${qpPractical}, V=${qpViva}
                    `);

                    // Use a small tolerance for floating point comparison
                    const epsilon = 0.01;
                    const theoryMatch = Math.abs(totalTheory - qpTheory) < epsilon;
                    const practicalMatch = Math.abs(totalPractical - qpPractical) < epsilon;
                    const vivaMatch = Math.abs(totalViva - qpViva) < epsilon;

                    if (!theoryMatch || !practicalMatch || !vivaMatch) {
                        alert(`Validation Failed! Marks do not match Qualification Pack limits.\n\n` +
                            `Excel Totals:\nTheory: ${totalTheory}, Practical: ${totalPractical}, Viva: ${totalViva}\n\n` +
                            `QP Limits:\nTheory: ${qpTheory}, Practical: ${qpPractical}, Viva: ${qpViva}\n\n` +
                            `Please correct the marks in your Excel file and try again.`);
                        e.target.value = ''; // Reset file input
                        return;
                    }

                    // Group data by NOS
                    const nosMap = new Map();

                    data.forEach(row => {
                        const nosId = row['NOSID'] || row['NOS ID'];
                        const nosName = row['NOS Name'];
                        const pcNo = row['PC No'] || row['PC ID'];
                        const pcName = row['PC Name'];

                        if (!nosId) return;

                        // Create or get NOS entry
                        if (!nosMap.has(nosId)) {
                            nosMap.set(nosId, {
                                id: window.Utils.generateId(),
                                qpId: selectedQP.id,
                                code: nosId,
                                name: nosName || '',
                                theoryCutoff: '',
                                practicalCutoff: '',
                                vivaCutoff: '',
                                overallCutoff: '',
                                createdAt: new Date().toISOString(),
                                pcs: []
                            });
                        }

                        // Add PC if present
                        if (pcNo && pcName) {
                            const nos = nosMap.get(nosId);
                            nos.pcs.push({
                                id: window.Utils.generateId(),
                                nosId: nos.id,
                                code: pcNo,
                                name: pcName,
                                theoryMarks: parseFloat(row['Theory Marks']) || 0,
                                practicalMarks: parseFloat(row['Practical Marks']) || 0,
                                vivaMarks: parseFloat(row['Viva Marks']) || 0,
                                totalMarks: parseFloat(row['Total Marks']) || (parseFloat(row['Theory Marks']) || 0) + (parseFloat(row['Practical Marks']) || 0) + (parseFloat(row['Viva Marks']) || 0),
                                createdAt: new Date().toISOString()
                            });
                        }
                    });

                    // Save all NOS and PCs
                    let nosCount = 0;
                    let pcCount = 0;

                    nosMap.forEach(nos => {
                        const { pcs, ...nosData } = nos;
                        window.Utils.saveNOS(nosData);
                        nosCount++;

                        pcs.forEach(pc => {
                            window.Utils.savePC(pc);
                            pcCount++;
                        });
                    });

                    window.Utils.uploadToCloud(true);
                    setNOSList(window.Utils.getNOS());
                    setPCList(window.Utils.getPCs());
                    setShowUploadNOSModal(false);
                    alert(`Successfully uploaded ${nosCount} NOS and ${pcCount} PC records.`);
                };
                reader.readAsBinaryString(file);
            };





            const handleUploadPC = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const bstr = evt.target.result;
                    const wb = window.XLSX.read(bstr, { type: 'binary' });
                    const wsname = wb.SheetNames[0];
                    const ws = wb.Sheets[wsname];
                    const data = window.XLSX.utils.sheet_to_json(ws);

                    console.log("Uploaded PC Data:", data);

                    let count = 0;
                    const allNOS = window.Utils.getNOS();

                    data.forEach(row => {
                        if (row['NOS ID'] && row['PC ID'] && row['PC Name']) {
                            const parentNOS = allNOS.find(n => n.code === row['NOS ID'] && n.qpId === selectedQP.id);

                            if (parentNOS) {
                                const pc = {
                                    id: window.Utils.generateId(),
                                    nosId: parentNOS.id,
                                    code: row['PC ID'],
                                    name: row['PC Name'],
                                    theoryMarks: parseFloat(row['Theory Marks']) || 0,
                                    practicalMarks: parseFloat(row['Practical Marks']) || 0,
                                    vivaMarks: parseFloat(row['Viva Marks']) || 0,
                                    totalMarks: (parseFloat(row['Theory Marks']) || 0) + (parseFloat(row['Practical Marks']) || 0) + (parseFloat(row['Viva Marks']) || 0),
                                    createdAt: new Date().toISOString()
                                };
                                window.Utils.savePC(pc);
                                count++;
                            }
                        }
                    });

                    window.Utils.uploadToCloud(true);
                    setPCList(window.Utils.getPCs());
                    setShowUploadPCModal(false);
                    alert(`Successfully uploaded ${count} PC records.`);
                };
                reader.readAsBinaryString(file);
            };

            const downloadNOSSample = () => {
                const headers = [['QualificationPackID', 'NOSID', 'NOS Name', 'PC No', 'PC Name', 'Theory Marks', 'Practical Marks', 'Viva Marks', 'Total Marks']];
                const data = [
                    ['QP001', 'NOS101', 'Introduction to IT', 'PC1', 'Understand Basic Concepts', '10', '20', '5', '35'],
                    ['QP001', 'NOS101', 'Introduction to IT', 'PC2', 'Demonstrate Skills', '15', '25', '10', '50']
                ];
                const ws = window.XLSX.utils.aoa_to_sheet([...headers, ...data]);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, "NOS_PC_Sample");
                window.XLSX.writeFile(wb, "NOS_PC_Upload_Sample.xlsx");
            };


            const filteredNOS = selectedQP ? nosList.filter(n => n.qpId === selectedQP.id) : nosList;

            return (
                <div className="animate-fade-in text-sm">
                    {selectedQP ? (
                        <div className="mb-6">
                            <div className="flex justify-between items-start mb-6">
                                <h2 className="text-xl font-bold text-gray-800">Sector Skill Council : {getSSCName(selectedQP.sscId)}</h2>
                                <div className="text-right">
                                    <h2 className="text-xl font-bold text-gray-800">Qualification Pack : {selectedQP.name}</h2>
                                    <button onClick={onBack} className="mt-2 text-indigo-600 hover:text-indigo-800 text-sm font-medium">? Back to QPs</button>
                                </div>
                            </div>

                            <div className="grid grid-cols-3 bg-gray-50 p-4 rounded-lg border border-gray-100 text-sm font-medium text-gray-600">
                                <div>Total Theory Marks : {Number(selectedQP.theoryMarks).toFixed(2)}</div>
                                <div className="text-center">Total Practical Marks : {Number(selectedQP.practicalMarks).toFixed(2)}</div>
                                <div className="text-right">Total Viva Marks : {Number(selectedQP.vivaMarks).toFixed(2)}</div>
                            </div>
                        </div>
                    ) : (
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">All NOS</h2>
                        </div>
                    )}

                    {!selectedQP && <div className="p-4 mb-4 bg-yellow-50 text-yellow-800 rounded border border-yellow-200">Please select a Qualification Pack to view NOS details.</div>}

                    {selectedQP && (
                        <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50 border-b">
                                    <tr>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-12 text-center">Sr.#</th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-10"></th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-32">NOS ID</th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r">NOS</th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-24">Theory Cutoff</th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-24">Practical Cutoff</th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-24">Viva Cutoff</th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-24">Overall Cutoff</th>
                                        <th className="p-3 text-center font-bold text-gray-600 w-48">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {filteredNOS.map((nos, idx) => (
                                        <React.Fragment key={nos.id}>
                                            <tr className="hover:bg-gray-50">
                                                <td className="p-3 border-r text-center">{idx + 1}</td>
                                                <td className="p-3 border-r text-center">
                                                    <button onClick={() => toggleExpand(nos.id)} className="text-gray-500 hover:text-indigo-600">
                                                        {expandedNOS.includes(nos.id) ? <Icons.MinusSquare /> : <Icons.PlusSquare />}
                                                    </button>
                                                </td>
                                                <td className="p-3 font-bold text-green-600 border-r">{nos.code}</td>
                                                <td className="p-3 border-r">{nos.name}</td>
                                                <td className="p-3 border-r">{nos.theoryCutoff || '0.00'}</td>
                                                <td className="p-3 border-r">{nos.practicalCutoff || '0.00'}</td>
                                                <td className="p-3 border-r">{nos.vivaCutoff || '0.00'}</td>
                                                <td className="p-3 border-r">{nos.overallCutoff || '0.00'}</td>
                                                <td className="p-3 text-center flex justify-center gap-2">
                                                    <button className="bg-cyan-700 text-white p-2 rounded hover:bg-cyan-800">
                                                        <Icons.Edit3 className="w-4 h-4" />
                                                    </button>
                                                    <button onClick={() => { if (confirm('Delete?')) { window.Utils.deleteNOS(nos.id); setNOSList(window.Utils.getNOS()); } }}
                                                        className="bg-cyan-700 text-white p-2 rounded hover:bg-cyan-800"><Icons.Trash2 className="w-4 h-4" /></button>
                                                    <button onClick={() => openPCModal(nos)} className="bg-red-500 text-white px-3 py-1 rounded flex items-center gap-1 hover:bg-red-600 text-xs font-bold">
                                                        <Icons.Plus className="w-3 h-3" /> PC's
                                                    </button>
                                                </td>
                                            </tr>
                                            {expandedNOS.includes(nos.id) && (
                                                <tr className="bg-gray-50/50">
                                                    <td colSpan="9" className="p-4 pl-12">
                                                        <div className="bg-white border rounded-lg overflow-hidden shadow-sm">
                                                            <table className="w-full text-sm">
                                                                <thead className="bg-gray-100 border-b">
                                                                    <tr>
                                                                        <th className="p-3 border-r w-12 text-center">Sr.#</th>
                                                                        <th className="p-3 border-r w-32 font-bold text-blue-600">PC ID</th>
                                                                        <th className="p-3 border-r">PC Name</th>
                                                                        <th className="p-3 border-r w-24">Total Marks</th>
                                                                        <th className="p-3 border-r w-32">Theory Marks</th>
                                                                        <th className="p-3 border-r w-32">Practical Marks</th>
                                                                        <th className="p-3 border-r w-32">Viva Marks</th>
                                                                        <th className="p-3 text-center w-24">Actions</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody className="divide-y">
                                                                    {pcList.filter(p => p.nosId === nos.id).map((pc, pcIdx) => (
                                                                        <tr key={pc.id}>
                                                                            <td className="p-3 border-r text-center">{pcIdx + 1}</td>
                                                                            <td className="p-3 border-r font-bold text-blue-600">{pc.code}</td>
                                                                            <td className="p-3 border-r">{pc.name}</td>
                                                                            <td className="p-3 border-r font-bold">{((parseFloat(pc.theoryMarks) || 0) + (parseFloat(pc.practicalMarks) || 0) + (parseFloat(pc.vivaMarks) || 0)).toFixed(2)}</td>
                                                                            <td className="p-3 border-r">
                                                                                <input type="number" className="w-full p-1 border rounded text-xs"
                                                                                    value={pc.theoryMarks} onChange={e => handlePCMarkChange(pc.id, 'theoryMarks', e.target.value)} />
                                                                            </td>
                                                                            <td className="p-3 border-r">
                                                                                <input type="number" className="w-full p-1 border rounded text-xs"
                                                                                    value={pc.practicalMarks} onChange={e => handlePCMarkChange(pc.id, 'practicalMarks', e.target.value)} />
                                                                            </td>
                                                                            <td className="p-3 border-r">
                                                                                <input type="number" className="w-full p-1 border rounded text-xs"
                                                                                    value={pc.vivaMarks} onChange={e => handlePCMarkChange(pc.id, 'vivaMarks', e.target.value)} />
                                                                            </td>
                                                                            <td className="p-3 text-center flex justify-center gap-1">
                                                                                <button onClick={() => { handleSavePC(pc.id); window.Utils.uploadToCloud(true); }} className="bg-green-600 text-white p-1 rounded hover:bg-green-700" title="Save Marks"><Icons.Save className="w-3 h-3" /></button>
                                                                                <button className="bg-cyan-700 text-white p-1 rounded hover:bg-cyan-800"><Icons.Edit3 className="w-3 h-3" /></button>
                                                                                <button onClick={() => { if (confirm('Delete PC?')) { window.Utils.deletePC(pc.id); setPCList(window.Utils.getPCs()); window.Utils.uploadToCloud(true); } }}
                                                                                    className="bg-cyan-700 text-white p-1 rounded hover:bg-cyan-800"><Icons.Trash2 className="w-3 h-3" /></button>
                                                                            </td>
                                                                        </tr>
                                                                    ))}
                                                                    <tr className="bg-gray-100 font-bold">
                                                                        <td colSpan="3" className="p-3 text-right border-r">Total :</td>
                                                                        <td className="p-3 border-r text-center">
                                                                            {pcList.filter(p => p.nosId === nos.id).reduce((sum, p) => sum + ((parseFloat(p.theoryMarks) || 0) + (parseFloat(p.practicalMarks) || 0) + (parseFloat(p.vivaMarks) || 0)), 0).toFixed(2)}
                                                                        </td>
                                                                        <td className="p-3 border-r text-center">
                                                                            {pcList.filter(p => p.nosId === nos.id).reduce((sum, p) => sum + (parseFloat(p.theoryMarks) || 0), 0).toFixed(2)}
                                                                        </td>
                                                                        <td className="p-3 border-r text-center">
                                                                            {pcList.filter(p => p.nosId === nos.id).reduce((sum, p) => sum + (parseFloat(p.practicalMarks) || 0), 0).toFixed(2)}
                                                                        </td>
                                                                        <td className="p-3 border-r text-center">
                                                                            {pcList.filter(p => p.nosId === nos.id).reduce((sum, p) => sum + (parseFloat(p.vivaMarks) || 0), 0).toFixed(2)}
                                                                        </td>
                                                                        <td></td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </td>
                                                </tr>
                                            )}
                                        </React.Fragment>
                                    ))}
                                    {filteredNOS.length === 0 && <tr><td colSpan="9" className="p-8 text-center text-gray-400">No NOS found for this QP</td></tr>}
                                </tbody>
                            </table>

                            {/* Data Recovery Helper: Only shows if data exists but isn't visible due to ID mismatch */}
                            {nosList.length > 0 && filteredNOS.length === 0 && (
                                <div className="p-4 bg-yellow-50 text-yellow-800 border-t border-yellow-100 flex items-start gap-3">
                                    <Icons.TriangleAlert className="w-5 h-5 flex-shrink-0 mt-0.5" />
                                    <div>
                                        <h4 className="font-bold text-sm">Missing Data?</h4>
                                        <p className="text-xs mt-1 mb-2">
                                            The system found {nosList.length} NOS records, but they aren't showing here.
                                            This usually happens if they were uploaded to a duplicate Qualification Pack.
                                        </p>
                                        <button onClick={() => {
                                            const ghostID = nosList[0]?.qpId;
                                            if (!ghostID) return;
                                            const allNOS = window.Utils.getNOS();
                                            let updatedCount = 0;
                                            const updatedNOS = allNOS.map(n => {
                                                if (n.qpId === ghostID) {
                                                    updatedCount++;
                                                    return { ...n, qpId: selectedQP.id };
                                                }
                                                return n;
                                            });
                                            localStorage.setItem('se_nos', JSON.stringify(updatedNOS));
                                            alert(`Fixed! Linked ${updatedCount} NOS records to this Qualification Pack. Refreshing...`);
                                            setNOSList(updatedNOS);
                                        }} className="bg-red-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-red-700 shadow-sm">
                                            Fix & Link Data to {selectedQP?.code}
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {selectedQP && (
                        <div className="mt-4 flex justify-end gap-2">
                            <button onClick={() => setShowUploadNOSModal(true)} className="bg-green-600 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-green-700">
                                <Icons.UploadCloud className="w-4 h-4" /> Upload NOS & PC
                            </button>
                            <button onClick={() => setShowNOSModal(true)} className="bg-red-500 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-red-600">
                                <Icons.Plus /> Add NOS
                            </button>
                        </div>
                    )}

                    {/* Upload NOS Modal */}
                    {showUploadNOSModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl p-8 w-full max-w-lg">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold">Upload NOS & PC (Excel)</h3>
                                    <button onClick={() => setShowUploadNOSModal(false)}><Icons.XCircle className="text-gray-400 hover:text-red-500" /></button>
                                </div>
                                <div className="space-y-4">
                                    <p className="text-sm text-gray-600">Please upload an Excel file with columns: <br /><b>QualificationPackID, NOSID, NOS Name, PC No, PC Name, Theory Marks, Practical Marks, Viva Marks, Total Marks</b></p>
                                    <button onClick={downloadNOSSample} className="text-green-600 text-sm hover:underline flex items-center gap-1"><Icons.Download className="w-3 h-3" /> Download Sample Format</button>
                                    <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center bg-gray-50 hover:bg-gray-100 transition-colors cursor-pointer relative">
                                        <input type="file" accept=".xlsx, .xls" onChange={handleUploadNOS} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                        <div className="pointer-events-none">
                                            <Icons.UploadCloud className="w-12 h-12 text-gray-400 mx-auto mb-3" />
                                            <p className="font-medium text-gray-600">Click to Upload NOS Excel</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Upload PC Modal */}
                    {showUploadPCModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl p-8 w-full max-w-lg">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold">Upload PC (Excel)</h3>
                                    <button onClick={() => setShowUploadPCModal(false)}><Icons.XCircle className="text-gray-400 hover:text-red-500" /></button>
                                </div>
                                <div className="space-y-4">
                                    <p className="text-sm text-gray-600">Please upload an Excel file with columns: <br /><b>NOS ID, PC ID, PC Name, Theory Marks, Practical Marks, Viva Marks</b></p>
                                    <button onClick={downloadPCSample} className="text-green-600 text-sm hover:underline flex items-center gap-1"><Icons.Download className="w-3 h-3" /> Download Sample Format</button>
                                    <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center bg-gray-50 hover:bg-gray-100 transition-colors cursor-pointer relative">
                                        <input type="file" accept=".xlsx, .xls" onChange={handleUploadPC} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                        <div className="pointer-events-none">
                                            <Icons.UploadCloud className="w-12 h-12 text-gray-400 mx-auto mb-3" />
                                            <p className="font-medium text-gray-600">Click to Upload PC Excel</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {showNOSModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                            <div className="bg-white rounded-xl p-8 w-full max-w-2xl">
                                <h3 className="text-xl font-bold mb-6">Add NOS</h3>
                                <form onSubmit={handleCreateNOS} className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="col-span-2">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">NOS Name</label>
                                            <input required className="w-full px-4 py-2 border rounded-lg" value={newNOS.name} onChange={e => setNewNOS({ ...newNOS, name: e.target.value })} />
                                        </div>
                                        <div className="col-span-2">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">NOS ID</label>
                                            <input required className="w-full px-4 py-2 border rounded-lg" value={newNOS.code} onChange={e => setNewNOS({ ...newNOS, code: e.target.value })} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Theory Cutoff</label>
                                            <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newNOS.theoryCutoff} onChange={e => setNewNOS({ ...newNOS, theoryCutoff: e.target.value })} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Practical Cutoff</label>
                                            <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newNOS.practicalCutoff} onChange={e => setNewNOS({ ...newNOS, practicalCutoff: e.target.value })} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Viva Cutoff</label>
                                            <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newNOS.vivaCutoff} onChange={e => setNewNOS({ ...newNOS, vivaCutoff: e.target.value })} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Overall Cutoff</label>
                                            <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newNOS.overallCutoff} onChange={e => setNewNOS({ ...newNOS, overallCutoff: e.target.value })} />
                                        </div>
                                    </div>
                                    <div className="flex gap-4 justify-end pt-4">
                                        <button type="button" onClick={() => setShowNOSModal(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                                        <button type="submit" className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Create</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {showPCModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl p-6 w-full max-w-lg">
                                <h3 className="text-xl font-bold mb-2">Manage PCs</h3>
                                <p className="text-sm text-gray-500 mb-4">For NOS: <span className="font-bold">{selectedNOS?.name}</span></p>

                                <div className="max-h-60 overflow-y-auto mb-4 border rounded p-2">
                                    <table className="w-full text-left text-sm">
                                        <thead>
                                            <tr className="bg-gray-50">
                                                <th className="p-2 border-b">Code</th>
                                                <th className="p-2 border-b">PC Name</th>
                                                <th className="p-2 border-b w-10"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {pcList.filter(p => p.nosId === selectedNOS?.id).map(pc => (
                                                <tr key={pc.id} className="border-b last:border-0 hover:bg-gray-50">
                                                    <td className="p-2 font-mono text-xs">{pc.code}</td>
                                                    <td className="p-2">{pc.name}</td>
                                                    <td className="p-2 text-center">
                                                        <button onClick={() => { window.Utils.deletePC(pc.id); setPCList(window.Utils.getPCs()); }} className="text-red-500 hover:text-red-700"><Icons.Trash2 className="w-4 h-4" /></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {pcList.filter(p => p.nosId === selectedNOS?.id).length === 0 && <p className="text-xs text-gray-400 text-center py-4">No PCs added yet</p>}
                                </div>

                                <form onSubmit={handleCreatePC} className="space-y-4 border-t pt-4">
                                    <div className="flex gap-4">
                                        <input placeholder="PC Code (e.g. PC1)" required className="w-1/3 px-4 py-2 border rounded-lg" value={newPC.code} onChange={e => setNewPC({ ...newPC, code: e.target.value })} />
                                        <input placeholder="PC Name" required className="flex-1 px-4 py-2 border rounded-lg" value={newPC.name} onChange={e => setNewPC({ ...newPC, name: e.target.value })} />
                                    </div>
                                    <div className="flex gap-2 justify-end">
                                        <button type="button" onClick={() => setShowPCModal(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Done</button>
                                        <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Add PC</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // QUESTION PAPERS TAB
        // QUESTION PAPERS TAB
        const QuestionPapersTab = () => {

            const [qpList, setQPList] = useState([]);
            const [allQPs, setAllQPs] = useState([]); // Store all QPs for filtering
            const [showUploadModal, setShowUploadModal] = useState(false);
            const [qpName, setQPName] = useState('');
            const [uploadPaperType, setUploadPaperType] = useState('THEORY'); // Default to Theory
            const [selectedQP, setSelectedQP] = useState(null);

            // New State for Filters
            const [sscList, setSSCList] = useState([]);
            const [masterQPList, setMasterQPList] = useState([]); // List of defined QPs from QP Tab
            const [selectedSSC, setSelectedSSC] = useState('');
            const [filterQPId, setFilterQPId] = useState('');

            useEffect(() => {
                setAllQPs(window.Utils.getQuestionPapers());
                setQPList(window.Utils.getQuestionPapers());
                setSSCList(window.Utils.getSSC());
                setMasterQPList(window.Utils.getQPs());
            }, []);

            // Apply Filters
            useEffect(() => {
                let filtered = allQPs;
                // Note: Currently uploaded QPs don't have explicit SSC link unless we infer or add manual mapping.
                // Assuming "Qualification Pack" filter refers to the QP Definition from QP Tab.
                // We might need to match by name or add a field during upload. 
                // The uploaded QP is independent currently. 
                // To make this functional as per mockup, we'll implement the UI. 
                // Real filtering would depend on data linkage. 
                // Let's filter by name match if possible or just show UI if no linkage exists.

                // If the intention is just to show the UI:
                // We will implement the UI. Filtering might be minimal if data is missing.

            }, [selectedSSC, filterQPId, allQPs]);

            const downloadSampleFormat = () => {
                const headers = [["BatchName", "Enrollment No", "Name of Training Agency", "Name of the Trainee", "Gender(M/F/T)"]];
                const ws = window.XLSX.utils.aoa_to_sheet(headers);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, "Students");
                window.XLSX.writeFile(wb, "Student_Import_Format.xlsx");
            };

            const handleDownloadSample = () => {
                const headers = [['Question', 'Option1', 'Option2', 'Option3', 'Option4', 'CorrectOption', 'NoofOptions', 'QuestionTypeID', 'PCIDsWithMarks']];
                let data = [];

                if (uploadPaperType === 'THEORY') {
                    data = [
                        ['What is the capital of France?', 'London', 'Berlin', 'Paris', 'Madrid', 'Paris', '4', 'MCQ', 'PC1:2'],
                        ['Which is a prime number?', '4', '6', '7', '9', '7', '4', 'MCQ', 'PC1:2']
                    ];
                } else if (uploadPaperType === 'PRACTICAL') {
                    data = [
                        ['Demonstrate safe handling of chemical tools.', '', '', '', '', '', '0', 'PRACTICAL', 'PC4:10'],
                        ['Write a function to calculate factorial.', '', '', '', '', '', '0', 'CODING', 'PC2:5']
                    ];
                } else if (uploadPaperType === 'VIVA') {
                    data = [
                        ['Explain the importance of hygiene.', '', '', '', '', '', '0', 'VIVA', 'PC1:2'],
                        ['Describe the steps of the procedure you performed.', '', '', '', '', '', '0', 'VIVA', 'PC2:3']
                    ];
                }

                const ws = window.XLSX.utils.aoa_to_sheet([...headers, ...data]);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, "Questions");
                window.XLSX.writeFile(wb, `Sample_${uploadPaperType}_Format.xlsx`);
            };

            const handleExcelUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet);

                    const questions = rows.map((row, idx) => {
                        const questionType = (row.QuestionTypeID || '').toString().toUpperCase();
                        const isCoding = questionType === 'CODING';
                        const isPractical = questionType === 'PRACTICAL';
                        const isViva = questionType === 'VIVA';
                        const noOfOptions = (isCoding || isPractical || isViva) ? 0 : parseInt(row.Noofoptions || 4);

                        // Parse PCIDsWithMarks (e.g., "PC1:5,PC2:3")
                        const pcMapping = {};
                        let calculatedMarks = 0;
                        if (row.PCIDsWithMarks) {
                            row.PCIDsWithMarks.toString().split(',').forEach(item => {
                                const parts = item.split(':');
                                if (parts.length === 2) {
                                    const pcId = parts[0].trim();
                                    const marks = parseFloat(parts[1]);
                                    if (!isNaN(marks)) {
                                        pcMapping[pcId] = marks;
                                        calculatedMarks += marks;
                                    }
                                }
                            });
                        }
                        return {
                            id: window.Utils.generateId(),
                            question: row.Question || row.question || '',
                            questionType: questionType || 'MCQ',
                            options: (isCoding || isPractical || isViva) ? [] : [row.Option1, row.Option2, row.Option3, row.Option4, row.Option5].filter((o, i) => i < noOfOptions && o),
                            correctAnswer: row.Solution || row.Answer || row.CorrectOption || '',
                            totalMarks: calculatedMarks > 0 ? calculatedMarks : parseFloat(row.Marks || 1),
                            pcMapping: pcMapping
                        };
                    });

                    // Validation: Check Total Theory Marks
                    const currentQPDef = masterQPList.find(q => q.id === filterQPId);
                    if (currentQPDef) {
                        // 1. Validate Total Theory Marks
                        const uploadedTheoryMarks = questions.reduce((sum, q) => {
                            if (q.questionType !== 'VIVA') {
                                return sum + q.totalMarks;
                            }
                            return sum;
                        }, 0);
                        const theoryMismatch = Math.abs(uploadedTheoryMarks - parseFloat(currentQPDef.theoryMarks || 0)) > 0.1;
                        if (theoryMismatch) {
                            alert(`Error: Uploaded Theory Marks (${uploadedTheoryMarks}) do not match QP Theory Marks (${currentQPDef.theoryMarks}).`);
                            return;
                        }

                        // 2. Validate PC Coverage (STRICT)
                        // Fetch all PCs for this QP
                        const allNOS = window.Utils.getNOS();
                        const qpNOS = allNOS.filter(n => n.qpId === filterQPId);
                        const allPCs = window.Utils.getPCs();
                        const requiredPCs = allPCs.filter(p => qpNOS.some(n => n.id === p.nosId));

                        // Collect PCs covered by questions
                        const coveredPCIds = new Set();
                        questions.forEach(q => {
                            if (q.pcMapping) {
                                Object.keys(q.pcMapping).forEach(key => coveredPCIds.add(key));
                            }
                        });

                        const missingPCs = requiredPCs.filter(p => !coveredPCIds.has(p.id));

                        if (missingPCs.length > 0) {
                            alert(`Validation Error: The uploaded Question Paper does not cover all Performance Criteria (PCs).\n\nMissing PCs:\n${missingPCs.map(p => p.code).join(', ')}\n\nPlease ensure every PC defined in the Qualification Pack is assessed.`);
                            return;
                        }
                    }

                    const qp = {
                        id: window.Utils.generateId(),
                        qpName: qpName || `${masterQPList.find(q => q.id === filterQPId)?.name || 'Question Paper'} - ${uploadPaperType}`,
                        questions: questions,
                        totalMarks: questions.reduce((sum, q) => sum + q.totalMarks, 0),
                        totalTime: 60,
                        createdAt: new Date().toISOString(),
                        sscId: selectedSSC,
                        qpId: filterQPId,
                        paperType: uploadPaperType
                    };
                    window.Utils.saveQuestionPaper(qp);
                    window.Utils.uploadToCloud(true);
                    setQPList(window.Utils.getQuestionPapers());
                    setShowUploadModal(false);
                    setQPName('');
                    alert('Question Paper uploaded successfully!');
                };
                reader.readAsArrayBuffer(file);
            };
            const handleAutoGenerate = () => {
                if (!selectedSSC || !filterQPId) return alert("Please select a Sector and Qualification Pack first.");

                const qpDef = masterQPList.find(q => q.id === filterQPId);
                if (!qpDef) return alert("Invalid QP selected.");

                if (!confirm(`Auto-Generate ${uploadPaperType} Questions for ${qpDef.code}?\nThis will create questions from all NOS/PCs.`)) return;

                // 1. Fetch Content
                const allNOS = window.Utils.getNOS();
                const allPCs = window.Utils.getPCs();
                const qpNOS = allNOS.filter(n => n.qpId === filterQPId);
                const qpPCs = allPCs.filter(p => qpNOS.some(n => n.id === p.nosId));

                if (qpPCs.length === 0) return alert("No PCs found for this Qualification Pack. Please add NOS and PCs first.");

                // 2. Generate Questions
                let generatedQuestions = [];
                let totalMarks = 0;

                qpPCs.forEach(pc => {
                    let questionText = "";
                    let marks = 0;
                    let type = uploadPaperType; // THEORY, PRACTICAL, VIVA

                    // Template Logic
                    if (type === 'THEORY') {
                        questionText = `Explain the following performance criteria: "${pc.name}"`;
                        marks = parseFloat(pc.theoryMarks) || 0;
                    } else if (type === 'PRACTICAL') {
                        questionText = `Demonstrate the following task: "${pc.name}"`;
                        marks = parseFloat(pc.practicalMarks) || 0;
                    } else if (type === 'VIVA') {
                        questionText = `Viva Question: What are the key aspects of "${pc.name}"?`;
                        marks = parseFloat(pc.vivaMarks) || 0;
                    }

                    // Only add if marks > 0 (optional, but good for cleanup)
                    if (marks > 0) {
                        generatedQuestions.push({
                            id: window.Utils.generateId(),
                            question: questionText,
                            questionType: type === 'THEORY' ? 'Subjective' : type, // Theory defaults to Subjective for auto-gen
                            options: [],
                            correctAnswer: '',
                            totalMarks: marks,
                            pcMapping: { [pc.id]: marks }
                        });
                        totalMarks += marks;
                    }
                });

                if (generatedQuestions.length === 0) return alert(`No ${uploadPaperType} marks defined in the NOS/PC for this QP.`);

                // 3. Save QP
                const newQP = {
                    id: window.Utils.generateId(),
                    qpName: `${qpDef.name} - ${uploadPaperType} (Auto-Generated)`,
                    questions: generatedQuestions,
                    totalMarks: totalMarks,
                    totalTime: 60,
                    createdAt: new Date().toISOString(),
                    sscId: selectedSSC,
                    qpId: filterQPId,
                    paperType: uploadPaperType
                };

                window.Utils.saveQuestionPaper(newQP);
                window.Utils.uploadToCloud(true);
                setQPList(window.Utils.getQuestionPapers());
                alert(`Success! Generated ${generatedQuestions.length} questions with Total Marks: ${totalMarks}`);
            };

            return (
                <div className="animate-fade-in text-sm">
                    {/* Breadcrumb */}
                    <div className="flex items-center gap-2 text-xs text-green-600 mb-2">
                        <span>Home</span>
                        <span>/</span>
                        <span className="text-gray-600">Question Papers</span>
                    </div>

                    <h3 className="text-2xl font-bold mb-6 text-gray-800">Question Papers</h3>

                    <div className="bg-white p-8 rounded-none shadow-sm border border-gray-100 mb-8 max-w-5xl">
                        <div className="grid grid-cols-[150px_1fr] gap-y-6 gap-x-8 items-center max-w-3xl">
                            <label className="font-bold text-gray-700">Select Sector :</label>
                            <select className="w-full p-2 border border-gray-300 rounded text-sm outline-none focus:border-blue-500 transition-all text-gray-600"
                                value={selectedSSC} onChange={e => { setSelectedSSC(e.target.value); setFilterQPId(''); }}>
                                <option value="">--Select Sector--</option>
                                {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>

                            <label className="font-bold text-gray-700">Qualification Pack:</label>
                            <select className="w-full p-2 border border-gray-300 rounded text-sm outline-none focus:border-blue-500 transition-all text-gray-600"
                                value={filterQPId} onChange={e => setFilterQPId(e.target.value)}
                                disabled={!selectedSSC}>
                                <option value="">Select QP</option>
                                {masterQPList.filter(q => selectedSSC && q.sscId == selectedSSC).map(q => (
                                    <option key={q.id} value={q.id}>{q.name}</option>
                                ))}
                            </select>
                        </div>
                    </div>

                    {/* Action Bar (Only visible if filters selected or if we want to allow upload always) */}
                    <div className="flex justify-between items-center mb-4">
                        <div className="text-gray-500 text-xs">

                        </div>
                        {selectedSSC && filterQPId && (
                            <div className="flex gap-2">
                                <button onClick={handleAutoGenerate}
                                    className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium shadow-sm transition-colors flex items-center gap-2">
                                    <Icons.Cpu className="w-4 h-4" /> Auto-Generate
                                </button>
                                <button onClick={() => setShowUploadModal(true)}
                                    className="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium shadow-sm transition-colors flex items-center gap-2">
                                    <Icons.Upload className="w-4 h-4" /> Upload Question Paper
                                </button>
                            </div>
                        )}
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
                        <table className="w-full text-left border-collapse">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="p-4 font-bold text-gray-600 border-r w-16 text-center">Sr.#</th>
                                    <th className="p-4 font-bold text-gray-600 border-r">Details</th>
                                    <th className="p-4 font-bold text-gray-600 border-r">Sector / QP</th>
                                    <th className="p-4 font-bold text-gray-600 border-r w-32 text-center">Marks</th>
                                    <th className="p-4 font-bold text-gray-600 border-r w-32 text-center">Questions</th>
                                    <th className="p-4 font-bold text-gray-600 w-24 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {qpList.filter(q => selectedSSC && filterQPId && q.sscId == selectedSSC && q.qpId == filterQPId).map((qp, idx) => (
                                    <tr key={qp.id} className="hover:bg-gray-50 transition-colors">
                                        <td className="p-4 border-r text-center text-gray-500">{idx + 1}</td>
                                        <td className="p-4 border-r">
                                            <div className="font-bold text-gray-800">{qp.qpName}</div>
                                            <div className="text-xs text-gray-400 mt-1">{new Date(qp.createdAt).toLocaleDateString()}</div>
                                        </td>
                                        <td className="p-4 border-r">
                                            <div className="text-xs font-semibold text-gray-600 mb-1">{sscList.find(s => s.id === qp.sscId)?.name || '-'}</div>
                                            <div className="text-xs text-gray-500">{masterQPList.find(q => q.id === qp.qpId)?.name || '-'}</div>
                                        </td>
                                        <td className="p-4 border-r text-center font-medium text-gray-700">{qp.totalMarks}</td>
                                        <td className="p-4 border-r text-center font-medium text-gray-700">{qp.questions.length}</td>
                                        <td className="p-4 text-center">
                                            <button onClick={() => { if (confirm('Delete?')) { window.Utils.deleteQuestionPaper(qp.id); setQPList(window.Utils.getQuestionPapers()); window.Utils.uploadToCloud(true); } }}
                                                className="text-red-500 hover:text-red-700 p-2 hover:bg-red-50 rounded-full transition-colors" title="Delete">
                                                <Icons.Trash2 className="w-4 h-4" />
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                                {qpList.filter(q => selectedSSC && filterQPId && q.sscId == selectedSSC && q.qpId == filterQPId).length === 0 && (
                                    <tr>
                                        <td colSpan="6" className="p-8 text-center text-gray-400">
                                            {(!selectedSSC || !filterQPId) ? 'Please select Sector and Qualification Pack to view Question Papers' : 'No question papers found for the selected criteria.'}
                                        </td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>

                    {showUploadModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white w-full max-w-4xl my-8 shadow-2xl rounded-xl overflow-hidden animate-scale-in">
                                <div className="bg-gray-50 px-8 py-5 flex justify-between items-center border-b">
                                    <h3 className="text-xl font-bold text-gray-800">Upload Question Paper</h3>
                                    <button onClick={() => setShowUploadModal(false)} className="text-gray-400 hover:text-red-500 transition-colors">
                                        <Icons.XCircle className="w-6 h-6" />
                                    </button>
                                </div>

                                <div className="p-8 max-h-[80vh] overflow-y-auto">
                                    <div className="grid grid-cols-[auto_1fr] gap-x-4 gap-y-2 mb-8 bg-blue-50 p-4 rounded-lg border border-blue-100">
                                        <div className="font-bold text-gray-700 text-right">Selected Sector:</div>
                                        <div className="text-gray-800">{sscList.find(s => s.id === selectedSSC)?.name || '-'}</div>
                                        <div className="font-bold text-gray-700 text-right">Selected QP:</div>
                                        <div className="text-gray-800">
                                            {masterQPList.find(q => q.id === filterQPId)?.name || '-'}
                                            <span className="text-xs text-gray-500 ml-2">(Total Marks: {masterQPList.find(q => q.id === filterQPId)?.totalMarks || 0}, Theory: {masterQPList.find(q => q.id === filterQPId)?.theoryMarks || 0})</span>
                                        </div>
                                        <div className="font-bold text-gray-700 text-right">Paper Type:</div>
                                        <div>
                                            <select value={uploadPaperType} onChange={e => setUploadPaperType(e.target.value)} className="p-1 border rounded bg-white text-sm">
                                                <option value="THEORY">Theory</option>
                                                <option value="PRACTICAL">Practical</option>
                                                <option value="VIVA">Viva</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="mb-6 space-y-3">
                                        <p className="text-gray-600 text-sm">
                                            <span className="font-bold text-red-500">Note:</span> Only Excel files (*.xls, *.xlsx) are accepted.
                                        </p>
                                        <div className="flex items-center gap-2 text-sm">
                                            <span>Use the standard format:</span>
                                            <button onClick={handleDownloadSample} className="text-green-600 font-medium hover:underline flex items-center gap-1">
                                                <Icons.Download className="w-4 h-4" /> Download Sample Format
                                            </button>
                                        </div>
                                    </div>

                                    <div className="border rounded-lg overflow-hidden mb-8 shadow-sm">
                                        <table className="w-full text-left text-xs">
                                            <thead className="bg-gray-100 text-gray-700">
                                                <tr>
                                                    {['Question', 'Option1', 'Option2', 'Option3', 'Option4', 'Solution', 'NoofOptions', 'QuestionTypeID', 'PCIDsWithMarks'].map(h => (
                                                        <th key={h} className="p-2 border-r last:border-r-0 font-bold">{h}</th>
                                                    ))}
                                                </tr>
                                            </thead>
                                            <tbody className="text-gray-500">
                                                <tr>
                                                    <td className="p-2 border-r">Sample Question?</td>
                                                    <td className="p-2 border-r">A</td>
                                                    <td className="p-2 border-r">B</td>
                                                    <td className="p-2 border-r">C</td>
                                                    <td className="p-2 border-r">D</td>
                                                    <td className="p-2 border-r">Option1</td>
                                                    <td className="p-2 border-r">4</td>
                                                    <td className="p-2 border-r">MCQ</td>
                                                    <td className="p-2">PC1:5,PC2:3</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center bg-gray-50 hover:bg-gray-100 transition-colors cursor-pointer relative">
                                        <input type="file" accept=".xlsx, .xls" onChange={handleExcelUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                        <div className="pointer-events-none">
                                            <Icons.UploadCloud className="w-12 h-12 text-gray-400 mx-auto mb-3" />
                                            <p className="font-medium text-gray-600">Drag & Drop or Click to Upload Excel File</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // LIVE VIVA CONSOLE (SIMULATOR -> REAL WEBRTC)
        const LiveVivaConsole = ({ batch, student, onClose, embedded = false }) => {
            const [stream, setStream] = useState(null);
            const [remoteStream, setRemoteStream] = useState(null);
            const [videoEnabled, setVideoEnabled] = useState(true);
            const [audioEnabled, setAudioEnabled] = useState(true);
            const [currentQIdx, setCurrentQIdx] = useState(0);
            const [marks, setMarks] = useState({});
            const [remarks, setRemarks] = useState('');
            const [genericScore, setGenericScore] = useState('');

            const videoRef = useRef(null);
            const mediaRecorderRef = useRef(null);
            const chunksRef = useRef([]);
            const recordingSessionRef = useRef(null);
            const segmentSequenceRef = useRef(0);
            const socketRef = useRef(null);
            const peerRef = useRef(null);

            // WebRTC Signaling Logic (Stubbed for now - requires Firebase RT Database or Firestore Signaling)
            useEffect(() => {
                const roomId = `${batch.id}_${student.id}`; // Define roomId for cleanup

                console.warn("Socket.io features (Viva Signaling) are currently disabled. Real-time signaling needs to be migrated to Firestore.");

                // Initialize PeerConnection (still needed for WebRTC, but signaling is manual/stubbed)
                peerRef.current = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                const pc = peerRef.current;

                // Handle Remote Stream (Student Video) - still relevant for receiving stream
                pc.ontrack = (event) => {
                    setRemoteStream(event.streams[0]);
                };

                // No socket.emit or socket.on calls here as per instruction.
                // Signaling will need to be implemented via Firestore/RTDB.

                return () => {
                    // Cleanup PeerConnection
                    if (peerRef.current) peerRef.current.close();
                    // No socket.disconnect() as socket is not initialized/used for signaling
                };
            }, [batch.id, student.id]);

            // Add Local Stream to Peer Connection
            useEffect(() => {
                if (stream && peerRef.current) {
                    stream.getTracks().forEach(track => {
                        // Check if track already added to avoid error
                        const senders = peerRef.current.getSenders();
                        const exists = senders.find(s => s.track === track);
                        if (!exists) peerRef.current.addTrack(track, stream);
                    });
                }
            }, [stream]);

            // Load QP (Viva or Practical)
            const allQPs = window.Utils.getQuestionPapers();
            // Prioritize Viva Paper, then Practical
            const qpId = batch.vivaPaperId || batch.practicalPaperId;
            const qp = allQPs.find(q => q.id === qpId);
            const questions = qp?.questions || [];
            const isGeneric = questions.length === 0;

            useEffect(() => {
                // Start Camera
                navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                    .then(s => {
                        setStream(s);
                        if (videoRef.current) videoRef.current.srcObject = s;
                    })
                    .catch(err => alert("Camera Error: " + err.message));

                return () => {
                    if (stream) stream.getTracks().forEach(t => t.stop());
                };
            }, []);

            // Record REMOTE STREAM (Student) when available
            useEffect(() => {
                if (!remoteStream) return;

                console.log("Starting Recording of Student Stream");
                let options = { mimeType: 'video/webm; codecs=vp8' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options = { mimeType: 'video/webm' };
                }

                try {
                    const recorder = new MediaRecorder(remoteStream, options);
                    mediaRecorderRef.current = recorder;
                    chunksRef.current = []; // Start fresh for student video

                    recorder.ondataavailable = (e) => {
                        if (e.data.size > 0) chunksRef.current.push(e.data);
                    };
                    recorder.start(1000);
                } catch (e) {
                    console.error("Failed to start recorder", e);
                }

                return () => {
                    if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
                        mediaRecorderRef.current.stop();
                    }
                };
            }, [remoteStream]);

            useEffect(() => {
                if (videoRef.current && stream) videoRef.current.srcObject = stream;
            }, [stream, videoRef.current]);

            const toggleVideo = () => {
                if (stream) {
                    stream.getVideoTracks().forEach(t => t.enabled = !videoEnabled);
                    setVideoEnabled(!videoEnabled);
                }
            };

            const toggleAudio = () => {
                if (stream) {
                    stream.getAudioTracks().forEach(t => t.enabled = !audioEnabled);
                    setAudioEnabled(!audioEnabled);
                }
            };

            const handleSave = async () => {
                // Stop Recording
                let videoKey = null;
                if (mediaRecorderRef.current) {
                    mediaRecorderRef.current.stop();
                    // Wait briefly for last chunk
                    await new Promise(r => setTimeout(r, 500));

                    if (chunksRef.current.length > 0) {
                        const blob = new Blob(chunksRef.current, { type: 'video/webm' });
                        videoKey = `viva_${batch.id}_${student.id}_${Date.now()}`;
                        try {
                            await VideoDB.saveVideo(videoKey, blob);
                            console.log("Viva Video Saved:", videoKey);
                        } catch (e) {
                            console.error("Failed to save video", e);
                            alert("Warning: Failed to save video recording. Marks will be saved.");
                        }
                    }
                }

                // Save marks to responses
                const finalScore = isGeneric ? parseFloat(genericScore || 0) : Object.values(marks).reduce((a, b) => a + parseFloat(b || 0), 0);
                const response = {
                    id: window.Utils.generateId(),
                    studentId: student.id,
                    batchId: batch.id,
                    examType: 'Viva',
                    videoKey: videoKey, // Link to recorded video
                    answers: {}, // Viva usually oral, no written answers stored here, maybe recordings
                    assessorMarks: isGeneric ? { 'Total Score': finalScore } : marks,
                    assessorRemarks: remarks,
                    totalScore: finalScore,
                    submittedAt: new Date().toISOString()
                };
                window.Utils.saveResponse(response);
                // Trigger background upload for marks
                window.Utils.uploadToCloud(true);
                alert("Viva Completed & Marks Saved! Video Recorded Successfully.");
                onClose();
            };



            return (
                <div className={`${embedded ? 'relative w-full h-full' : 'fixed inset-0 bg-gray-900 z-50'} flex text-white font-sans animate-fade-in`}>
                    {/* Left: Video Feed */}
                    {/* Left: Video Feed Area */}
                    <div className="w-3/5 relative bg-black flex items-center justify-center border-r border-gray-800 overflow-hidden group">

                        {/* 1. REAL REMOTE STUDENT FEED */}
                        <div className="absolute inset-0 flex flex-col items-center justify-center bg-gray-900">
                            {remoteStream ? (
                                <video
                                    ref={ref => { if (ref) ref.srcObject = remoteStream; }}
                                    autoPlay
                                    className="w-full h-full object-contain"
                                />
                            ) : (
                                <div className="text-center">
                                    <div className="w-32 h-32 rounded-full bg-gray-800 flex items-center justify-center mb-4 border-4 border-gray-700 shadow-xl relative mx-auto animate-pulse">
                                        <Icons.User className="w-16 h-16 text-gray-400" />
                                    </div>
                                    <h2 className="text-2xl font-bold text-white mb-1">Waiting for Student...</h2>
                                    <p className="text-xs text-gray-500">Ensure the student is online.</p>
                                </div>
                            )}

                            {/* 2. ASSESSOR SELF-VIEW (Picture-in-Picture) */}
                            <div className="absolute bottom-24 right-6 w-48 h-36 bg-gray-800 rounded-lg border-2 border-gray-700/50 shadow-2xl overflow-hidden hover:scale-105 transition-transform cursor-move z-20">
                                <video ref={videoRef} autoPlay muted className="w-full h-full object-cover transform scale-x-[-1]" />
                                <div className="absolute bottom-1 left-2 text-[10px] font-bold text-white/50">YOU</div>
                            </div>

                            {/* Recording Indicator */}
                            <div className="absolute top-6 left-6 bg-black/60 backdrop-blur-sm px-4 py-2 rounded-full text-sm font-bold flex items-center gap-2 border border-white/10 shadow-lg z-20">
                                <div className={`w-2.5 h-2.5 rounded-full ${remoteStream ? 'bg-red-500 animate-pulse' : 'bg-yellow-500'} shadow-[0_0_8px_rgba(239,68,68,0.6)]`}></div>
                                <span className="tracking-wide">REC � {remoteStream ? 'LIVE' : 'CONNECTING'}</span>
                            </div>

                            {/* Controls */}
                            <div className="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex gap-6 bg-black/40 backdrop-blur-md px-8 py-4 rounded-full border border-white/10 shadow-2xl z-30 hover:bg-black/60 transition-colors">
                                <button onClick={toggleAudio} className={`p-4 rounded-full ${audioEnabled ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-red-500 hover:bg-red-600 text-white'} transition-all shadow-lg transform hover:scale-105 active:scale-95`}>
                                    {audioEnabled ? <Icons.Microphone className="w-6 h-6" /> : <Icons.MicrophoneOff className="w-6 h-6" />}
                                </button>
                                <button onClick={toggleVideo} className={`p-4 rounded-full ${videoEnabled ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-red-500 hover:bg-red-600 text-white'} transition-all shadow-lg transform hover:scale-105 active:scale-95`}>
                                    {videoEnabled ? <Icons.Video className="w-6 h-6" /> : <Icons.VideoOff className="w-6 h-6" />}
                                </button>
                                <div className="w-px bg-white/20 mx-2"></div>
                                <button onClick={handleSave} className="p-4 rounded-full bg-red-600 hover:bg-red-700 transition-all text-white font-bold px-8 shadow-lg transform hover:scale-105 active:scale-95 flex items-center gap-2">
                                    <Icons.Square className="w-5 h-5 fill-current" /> Stop & Submit
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Right: Grading Panel */}
                    <div className="w-2/5 bg-gray-50 text-gray-800 flex flex-col h-full">
                        <div className="p-6 bg-white border-b border-gray-200 shadow-sm z-10">
                            <h2 className="text-xl font-bold flex items-center gap-2 text-gray-800"><Icons.Cpu className="w-6 h-6 text-indigo-600" /> Viva Grading</h2>
                            <div className="flex justify-between items-center mt-2">
                                <p className="text-gray-500 text-sm font-medium">{isGeneric ? 'Generic Assessment' : (qp?.qpName || 'General Viva')}</p>
                                <span className="bg-indigo-100 text-indigo-700 text-xs font-bold px-2 py-1 rounded-md border border-indigo-200">Ref: {student.enrollmentNo}</span>
                            </div>
                        </div>


                        <div className="flex-1 overflow-y-auto p-6 scrollbar-thin bg-gray-50/50">
                            {isGeneric ? (
                                <div className="space-y-6">
                                    <div className="p-8 border-2 border-dashed border-indigo-200 rounded-2xl bg-indigo-50/50 flex flex-col items-center justify-center text-center">
                                        <div className="bg-white p-4 rounded-full shadow-md mb-4">
                                            <Icons.Edit3 className="w-8 h-8 text-indigo-600" />
                                        </div>
                                        <h3 className="text-xl font-bold text-gray-800 mb-2">Manual Grading Mode</h3>
                                        <p className="text-gray-600 mb-6 max-w-xs">No specific question paper assigned. Please evaluate the candidate based on overall performance.</p>

                                        <div className="w-full max-w-sm">
                                            <label className="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Total Score Awarded</label>
                                            <input
                                                type="number"
                                                min="0"
                                                className="w-full p-4 border-2 border-indigo-300 rounded-xl font-extrabold text-4xl text-indigo-700 focus:border-indigo-600 focus:outline-none text-center shadow-inner"
                                                value={genericScore}
                                                onChange={e => setGenericScore(e.target.value)}
                                                placeholder="00"
                                                autoFocus
                                            />
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    {questions.map((q, idx) => (
                                        <div key={q.id} className={`p-5 rounded-xl border transition-all duration-200 ${currentQIdx === idx ? 'border-indigo-500 bg-white shadow-md ring-1 ring-indigo-200 transform scale-[1.01]' : 'border-gray-200 bg-white hover:border-gray-300'}`}>
                                            <div className="flex justify-between items-start mb-3">
                                                <span className="text-xs font-bold text-gray-400 uppercase tracking-widest">Question {idx + 1}</span>
                                                <span className="text-xs font-bold bg-gray-100 text-gray-600 px-2.5 py-1 rounded-full border border-gray-200">Max: {q.totalMarks}</span>
                                            </div>
                                            <p className="font-semibold text-lg mb-5 text-gray-800 leading-relaxed whitespace-pre-wrap">{q.question}</p>

                                            <div className="flex items-center gap-4 bg-gray-50 p-3 rounded-lg border border-gray-100">
                                                <label className="text-sm font-bold text-gray-600 uppercase tracking-wide">Score:</label>
                                                <input
                                                    type="number"
                                                    max={q.totalMarks}
                                                    min="0"
                                                    className="w-20 p-2 border-2 border-gray-300 rounded-lg text-center font-bold text-xl text-indigo-700 focus:border-indigo-500 focus:outline-none transition-all shadow-inner bg-white"
                                                    value={marks[idx] || ''}
                                                    onChange={e => {
                                                        const val = Math.min(parseFloat(e.target.value) || 0, q.totalMarks);
                                                        setMarks({ ...marks, [idx]: val });
                                                    }}
                                                    onFocus={() => setCurrentQIdx(idx)}
                                                />
                                                <span className="text-gray-400 font-medium text-sm">/ {q.totalMarks}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            <hr className="my-8 border-gray-200 border-dashed" />

                            <div className="mb-6 bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                                <label className="block text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide flex items-center gap-2"><Icons.Edit3 className="w-4 h-4" /> Overall Remarks</label>
                                <textarea
                                    className="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500/50 outline-none resize-none text-sm leading-relaxed"
                                    rows="4"
                                    placeholder="Enter detailed feedback for the student..."
                                    value={remarks}
                                    onChange={e => setRemarks(e.target.value)}
                                ></textarea>
                            </div>
                        </div>

                        <div className="p-6 border-t bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] flex justify-between items-center z-10">
                            <div>
                                <span className="text-gray-500 text-xs font-bold uppercase tracking-wide block mb-1">Total Score</span>
                                <div className="flex items-baseline">
                                    <strong className="text-3xl text-indigo-600 font-extrabold">{isGeneric ? (parseFloat(genericScore) || 0) : Object.values(marks).reduce((a, b) => a + parseFloat(b || 0), 0)}</strong>
                                    {!isGeneric && <span className="text-gray-400 mx-1 text-lg">/</span>}
                                    {!isGeneric && <span className="text-gray-500 font-bold text-xl">{qp.totalMarks}</span>}
                                </div>
                            </div>
                            <button onClick={handleSave} className="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-8 py-3.5 rounded-xl font-bold shadow-lg shadow-green-200 transform hover:-translate-y-0.5 transition-all flex items-center gap-2.5">
                                <Icons.Save className="w-5 h-5" /> Submit Evaluation
                            </button>
                        </div>
                    </div>
                </div >
            );
        };

        // VIVA LOBBY (ZOOM-STYLE WAITING ROOM)
        const VivaLobby = ({ batch, onClose }) => {
            const [students, setStudents] = useState([]);
            const [activeStudent, setActiveStudent] = useState(null);
            const [completedIds, setCompletedIds] = useState([]);

            useEffect(() => {
                refreshLobby();
            }, [batch]);

            const refreshLobby = () => {
                // RESOLVE REAL BATCH ID: The prop 'batch' might be a User session object ({batchId: '...' }) OR a real Batch ({id: '...' })
                const targetBatchId = batch.id || batch.batchId;

                // Fetch full batch details if we only have the ID (to get the Name)
                const fullBatch = window.Utils.getBatches().find(b => b.id === targetBatchId) || batch;

                // Debug: Handle string vs number mismatch
                const all = window.Utils.getStudents();
                const allStudents = all.filter(s => String(s.batchId) === String(targetBatchId));
                console.log("Lobby Debug:", { targetBatchId, totalStudents: all.length, matchedStudents: allStudents.length });

                // Force refresh responses from storage
                const responses = JSON.parse(localStorage.getItem('se_responses') || '[]');

                // Find students who have a VIVA response for this batch
                const completed = responses
                    .filter(r => r.batchId === targetBatchId && r.examType === 'VIVA')
                    .map(r => r.studentId);

                setStudents(allStudents);
                setCompletedIds(completed);

                // Update local state to show correct name in UI (hacky but works without refactoring props)
                if (fullBatch.name && fullBatch.name !== batch.name) {
                    batch.resolvedName = fullBatch.name;
                    batch.resolvedId = fullBatch.id;
                }
            };

            const waitingList = students.filter(s => !completedIds.includes(s.id));
            const doneList = students.filter(s => completedIds.includes(s.id));

            return (
                <div className="fixed inset-0 bg-gray-900 z-50 flex font-sans text-white animate-fade-in">
                    {/* Left Sidebar: Meeting Participants */}
                    <div className="w-1/4 bg-gray-800 border-r border-gray-700 flex flex-col shadow-xl z-20">
                        <div className="p-4 border-b border-gray-700 bg-gray-900/50">
                            <h2 className="text-lg font-bold flex items-center gap-2 text-indigo-400">
                                <Icons.Video className="w-5 h-5 text-green-400" /> Meeting Room
                            </h2>
                            <div className="mt-2 text-xs text-gray-400 font-mono bg-gray-900 p-2 rounded border border-gray-700">
                                <p>Batch: {batch.resolvedName || batch.name || batch.batchName || 'Unknown'}</p>
                                <p>ID: {batch.resolvedId || batch.id || 'N/A'}</p>
                                <p>Students Found: {students.length}</p>
                                <details className="mt-2 text-[10px] cursor-pointer">
                                    <summary>Raw Object</summary>
                                    <pre className="whitespace-pre-wrap">{JSON.stringify(batch, null, 2)}</pre>
                                </details>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 scrollbar-thin">
                            {/* Waiting Room Section */}
                            <div className="mb-6">
                                <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3 flex items-center justify-between sticky top-0 bg-gray-800 py-1 z-10">
                                    Waiting Room <span className="bg-indigo-600 text-white px-2 py-0.5 rounded-full text-[10px] shadow-sm">{waitingList.length}</span>
                                </h3>
                                <div className="space-y-2">
                                    {waitingList.map(s => (
                                        <div key={s.id} className="flex items-center justify-between p-3 bg-gray-700/30 rounded-lg hover:bg-gray-700 transition-colors border border-gray-700/50 hover:border-gray-600 group">
                                            <div className="flex items-center gap-3">
                                                <div className="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-xs font-bold shadow-sm">
                                                    {s.name.charAt(0)}
                                                </div>
                                                <div className="overflow-hidden">
                                                    <p className="text-sm font-medium text-gray-200 truncate group-hover:text-white transition-colors">{s.name}</p>
                                                    <p className="text-[10px] text-gray-500 truncate">{s.enrollmentNo}</p>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => {
                                                    setActiveStudent(s);
                                                    const bId = batch.resolvedId || batch.id || batch.batchId;
                                                    localStorage.setItem(`viva_active_${bId}`, s.id); // Signal student tab
                                                    console.log("Viva Signal Sent:", `viva_active_${bId}`, s.id);
                                                }}
                                                disabled={!!activeStudent}
                                                className="text-xs font-bold bg-green-600 hover:bg-green-500 text-white px-3 py-1.5 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:shadow-lg transform active:scale-95"
                                            >
                                                Admit
                                            </button>
                                        </div>
                                    ))}
                                    {waitingList.length === 0 && <p className="text-sm text-gray-500 italic text-center py-4 border-2 border-dashed border-gray-700 rounded-lg">No students waiting</p>}
                                </div>
                            </div>

                            {/* Joined/Completed Section */}
                            <div>
                                <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3 flex items-center justify-between sticky top-0 bg-gray-800 py-1 z-10">
                                    Completed <span className="bg-gray-700 text-green-400 px-2 py-0.5 rounded-full text-[10px]">{doneList.length}</span>
                                </h3>
                                <div className="space-y-2 opacity-60 hover:opacity-100 transition-opacity">
                                    {doneList.map(s => (
                                        <div key={s.id} className="p-3 bg-gray-900/50 rounded flex items-center gap-3 border border-gray-700">
                                            <div className="w-8 h-8 rounded-full bg-green-900/30 text-green-400 flex items-center justify-center text-xs font-bold border border-green-900">
                                                <Icons.Check className="w-4 h-4" />
                                            </div>
                                            <div className="overflow-hidden">
                                                <p className="font-bold truncate text-gray-400 line-through">{s.name}</p>
                                                <p className="text-[10px] text-gray-600">{s.enrollmentNo}</p>
                                            </div>
                                        </div>
                                    ))}
                                    {doneList.length === 0 && <p className="text-xs text-gray-600 italic text-center">No completed students yet.</p>}
                                </div>
                            </div>
                        </div>

                        <div className="p-4 border-t border-gray-700 bg-gray-900/50">
                            <button onClick={onClose} className="w-full py-3 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-bold transition-all shadow-lg hover:shadow-red-900/30 flex items-center justify-center gap-2">
                                <Icons.PhoneMissed className="w-4 h-4" /> End Meeting for All
                            </button>
                        </div>
                    </div>

                    {/* Main Stage */}
                    <div className="w-3/4 bg-black relative flex flex-col items-center justify-center overflow-hidden">
                        {/* Background Pattern */}
                        {!activeStudent && (
                            <div className="absolute inset-0 opacity-10 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-gray-700 via-gray-900 to-black"></div>
                        )}

                        {activeStudent ? (
                            <div className="w-full h-full relative z-10 animate-scale-in">
                                <LiveVivaConsole
                                    batch={{ ...batch, id: batch.resolvedId || batch.id || batch.batchId, name: batch.resolvedName || batch.name }}
                                    student={activeStudent}
                                    embedded={true}
                                    onClose={() => {
                                        setActiveStudent(null);
                                        const bId = batch.resolvedId || batch.id || batch.batchId;
                                        localStorage.removeItem(`viva_active_${bId}`); // Clear signal
                                        console.log("Viva Signal Cleared:", `viva_active_${bId}`);
                                        refreshLobby();
                                    }}
                                />
                            </div>
                        ) : (
                            <div className="text-center p-10 relative z-10 max-w-md animate-fade-in-up">
                                <div className="w-32 h-32 bg-gray-800/80 rounded-full flex items-center justify-center mx-auto mb-8 border-4 border-gray-700 shadow-2xl backdrop-blur-sm">
                                    <Icons.Video className="w-12 h-12 text-gray-500" />
                                </div>
                                <h2 className="text-3xl font-bold text-white mb-3 tracking-tight">The Meeting is Live</h2>
                                <p className="text-gray-400 text-lg">Waiting for you to admit a student from the sidebar.</p>
                                <div className="mt-8 flex gap-2 justify-center">
                                    <span className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce delay-0"></span>
                                    <span className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce delay-100"></span>
                                    <span className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce delay-200"></span>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const BatchesTab = () => {

            const [batches, setBatches] = useState([]);
            const [sscList, setSSCList] = useState([]);
            const [qpList, setQPList] = useState([]);
            const [filteredBatches, setFilteredBatches] = useState([]);

            const [showCreateModal, setShowCreateModal] = useState(false);
            const [showAssignModal, setShowAssignModal] = useState(false);
            const [showStudentModal, setShowStudentModal] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);

            const [selectedBatch, setSelectedBatch] = useState(null);
            const [assignmentType, setAssignmentType] = useState('Theory'); // 'Theory', 'Practical', 'Viva'
            const [selectedAssignQP, setSelectedAssignQP] = useState('');

            // Hierarchy Filters for Assign Modal
            const [assignSSC, setAssignSSC] = useState('');
            const [assignQPDef, setAssignQPDef] = useState('');
            const [vivaSession, setVivaSession] = useState(null); // {batch, student}

            // Filters
            const [filterSSC, setFilterSSC] = useState('');
            const [filterQP, setFilterQP] = useState('');
            const [filterStartDate, setFilterStartDate] = useState('');

            const [filterEndDate, setFilterEndDate] = useState('');
            const [searchQuery, setSearchQuery] = useState('');

            // Enhanced Batch State
            const [newBatch, setNewBatch] = useState({
                name: '',
                project: '',
                trainingCentre: '',
                state: '',
                spocContactNo: '',
                centerAddress: '',
                startDate: '',
                endDate: '',
                loginRestrictCount: '3',
                modeOfAssessment: '',
                batchSize: '',
                centerId: '',
                district: '',
                spocEmail: '',
                tpName: '',
                startTime: '',
                endTime: '',
                captureImage: true,
                cameraInterval: '60',
                sscId: '', // Added
                qpId: ''   // Added
            });

            const [showNewProjectInput, setShowNewProjectInput] = useState(false);

            // Mock Data for Dropdowns
            const projects = ['PMKVY', 'CMKVY', 'DDU-GKY', 'NULM', 'Corporate'];
            const trainingCentres = [
                { id: 'TC001', name: 'Alpha Tech Institute', state: 'Karnataka', district: 'Bangalore', centerId: 'C-BLR-01', address: '123 Tech Park, Bangalore', spoc: 'John Doe' },
                { id: 'TC002', name: 'Beta Skills Academy', state: 'Maharashtra', district: 'Pune', centerId: 'C-PUN-02', address: '456 Skill Ave, Pune', spoc: 'Jane Smith' },
                { id: 'TC003', name: 'Gamma Vocational Center', state: 'Delhi', district: 'New Delhi', centerId: 'C-DEL-03', address: '789 Edu Road, Delhi', spoc: 'Robert Brown' }
            ];

            const assessmentModes = ['Online', 'Offline', 'Hybrid'];

            const [allQPapers, setAllQPapers] = useState([]);

            useEffect(() => {
                const loadData = () => {
                    const b = window.Utils.getBatches();
                    setBatches(b);
                    setFilteredBatches(b);
                    setSSCList(window.Utils.getSSC());
                    setQPList(window.Utils.getQPs());
                    setAllQPapers(window.Utils.getQuestionPapers());
                };
                loadData();

                // Real-time listener
                window.addEventListener('cloud-sync-complete', loadData);
                return () => window.removeEventListener('cloud-sync-complete', loadData);
            }, []);

            const handleSearch = () => {
                let result = batches;
                if (searchQuery) {
                    result = result.filter(b => b.name.toLowerCase().includes(searchQuery.toLowerCase()));
                }

                // Filter by SSC and QP using Batch Metadata OR Resolved Papers
                result = result.filter(b => {
                    const tPaper = allQPapers.find(p => p.id === b.theoryPaperId);
                    const pPaper = allQPapers.find(p => p.id === b.practicalPaperId);

                    let matchesSSC = true;
                    if (filterSSC) {
                        const sscBatch = b.sscId && String(b.sscId) === String(filterSSC);
                        const sscT = tPaper && String(tPaper.sscId) === String(filterSSC);
                        const sscP = pPaper && String(pPaper.sscId) === String(filterSSC);
                        matchesSSC = sscBatch || sscT || sscP;
                    }

                    let matchesQP = true;
                    if (filterQP) {
                        const qpBatch = b.qpId && String(b.qpId) === String(filterQP);
                        const qpT = tPaper && String(tPaper.qpId) === String(filterQP);
                        const qpP = pPaper && String(pPaper.qpId) === String(filterQP);
                        matchesQP = qpBatch || qpT || qpP;
                    }

                    return matchesSSC && matchesQP;
                });

                if (filterStartDate) {
                    result = result.filter(b => b.startDate >= filterStartDate);
                }
                if (filterEndDate) {
                    result = result.filter(b => b.endDate <= filterEndDate);
                }

                setFilteredBatches(result);
            };

            // Auto-search when filters change (optional, but good for dropdowns)
            useEffect(() => {
                handleSearch();
            }, [filterSSC, filterQP, filterStartDate, filterEndDate, batches, searchQuery, allQPapers]);

            const handleTCSelection = (e) => {
                const tcName = e.target.value;
                const tc = trainingCentres.find(t => t.name === tcName);
                if (tc) {
                    setNewBatch({
                        ...newBatch,
                        trainingCentre: tcName,
                        state: tc.state,
                        district: tc.district, // Display only
                        centerId: tc.centerId, // Display only
                        centerAddress: tc.address,
                        spocName: tc.spoc
                    });
                } else {
                    setNewBatch({ ...newBatch, trainingCentre: tcName });
                }
            };

            const handleCreateBatch = (e) => {
                e.preventDefault();

                const isUpdate = !!newBatch.id;

                const batch = {
                    ...newBatch,
                    id: isUpdate ? newBatch.id : window.Utils.generateId(),
                    assessorUsername: isUpdate ? newBatch.assessorUsername : 'assessor_' + Math.random().toString(36).substr(2, 5),
                    assessorPassword: isUpdate ? newBatch.assessorPassword : Math.random().toString(36).substr(2, 6),
                    createdAt: isUpdate ? newBatch.createdAt : new Date().toISOString()
                };

                window.Utils.saveBatch(batch);
                // Atomic Sync handles upload now
                const updated = window.Utils.getBatches();
                setBatches(updated);
                setFilteredBatches(updated);
                setShowCreateModal(false);
                setNewBatch({
                    name: '', project: '', trainingCentre: '', state: '', spocContactNo: '', centerAddress: '',
                    startDate: '', endDate: '', loginRestrictCount: '3', modeOfAssessment: '',
                    batchSize: '', centerId: '', district: '', spocEmail: '', tpName: '', startTime: '', endTime: '',
                    captureImage: true, cameraInterval: '60', sscId: '', qpId: ''
                });
            };

            const handleEditBatch = (batch) => {
                setNewBatch(batch);
                setShowCreateModal(true);
            };

            const handleAssignQP = () => {
                if (!selectedBatch || !selectedAssignQP) return;

                // Find existing batch and update just that one
                const currentBatches = window.Utils.getBatches();
                const targetBatchIndex = currentBatches.findIndex(b => b.id === selectedBatch.id);

                if (targetBatchIndex >= 0) {
                    const field = assignmentType === 'Practical' ? 'practicalPaperId' : (assignmentType === 'Viva' ? 'vivaPaperId' : 'theoryPaperId');
                    const updatedBatch = { ...currentBatches[targetBatchIndex], [field]: selectedAssignQP };

                    // Use Atomic Save (which now supports Upsert & Sync)
                    window.Utils.saveBatch(updatedBatch);

                    // Refresh React State
                    const refreshed = window.Utils.getBatches();
                    setBatches(refreshed);
                    setFilteredBatches(refreshed);
                }

                setShowAssignModal(false);
                setSelectedBatch(null);
                setSelectedAssignQP('');
            };

            const handleStudentUpload = (e) => {
                const file = e.target.files[0];
                if (!file || !selectedBatch) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet);

                    let count = 0;
                    const existingStudents = window.Utils.getStudentsByBatch(selectedBatch.id);
                    let currentCount = existingStudents.length;

                    // DEBUG: Show detected keys
                    if (rows.length > 0) {
                        alert("Debug: Detected Excel Columns: " + Object.keys(rows[0]).join(", "));
                    }

                    rows.forEach(row => {
                        // Flexible matching for keys
                        const enrollmentNo = row['Enrollment No'] || row['EnrollmentNo'];
                        const studentName = row['Name of the Trainee'] || row['Trainee Name'] || row['Name'] || row['Student Name'] || row['StudentName'] || row['Candidate Name'] || row['CandidateName'] || row['Full Name'] || row['FullName'] || row['Trainee'];

                        if (studentName) {
                            const sequence = 100 + currentCount;

                            // Auto-increment name if it is just "U"
                            let finalName = studentName;
                            if (studentName.trim().toUpperCase() === 'U') {
                                finalName = `U${currentCount + 1}`;
                            }

                            const student = {
                                id: window.Utils.generateId(),
                                name: finalName,
                                username: sequence.toString(), // Sequential username: 100, 101...
                                enrollmentNo: enrollmentNo ? enrollmentNo.toString() : '',
                                password: enrollmentNo ? enrollmentNo.toString() : 'password',
                                batchId: selectedBatch.id,
                                role: 'student'
                            };
                            window.Utils.saveStudent(student);
                            currentCount++;
                            count++;
                        }
                    });

                    alert(`Uploaded ${count} students to ${selectedBatch.name}`);
                    setShowStudentModal(false);
                    // Force refresh by toggling selection or updating state if needed
                    // But setShowStudentModal(false) closes it, so next open will get fresh data.
                    setSelectedBatch(null);
                };
                reader.readAsArrayBuffer(file);
            };

            // NEW: Bulk Import with Batch Name Mapping
            const handleBulkStudentImport = (e) => {
                e.preventDefault();
                const fileInput = document.getElementById('bulkImportFile');
                const file = fileInput?.files[0];
                if (!file) { alert("Please select a file first."); return; }

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(sheet); // [{BatchName: '...', Enrollment No: '...', ...}]

                        // 1. INTROSPECTION: Check if sheet is empty or headers are weird
                        if (rows.length === 0) {
                            alert("Error: The uploaded sheet appears to be empty.");
                            return;
                        }

                        // Debug: Check first row keys
                        const firstRowKeys = Object.keys(rows[0]);
                        console.log("[Bulk Import] Detected Headers:", firstRowKeys);

                        let addedCount = 0;
                        let errors = [];
                        let skippedCount = 0;

                        // Get fresh batch list to ensure we match correctly
                        const currentBatches = window.Utils.getBatches();

                        // Pre-fetch student counts for involved batches to maintain sequence
                        const batchCounts = {};
                        const newStudentsToSave = [];

                        rows.forEach((row, index) => {
                            // FLEXIBLE HEADER MATCHING (Case-insensitive, trim)
                            const getVal = (keys) => {
                                for (let k of keys) {
                                    // Direct match
                                    if (row[k] !== undefined) return row[k];
                                    // Case-insensitive match in row keys
                                    const foundKey = Object.keys(row).find(rk => rk.trim().toLowerCase() === k.trim().toLowerCase());
                                    if (foundKey) return row[foundKey];
                                }
                                return null;
                            };

                            const batchName = getVal(['BatchName', 'Batch Name', 'Batch', 'Project']);
                            const enrollmentNo = getVal(['Enrollment No', 'EnrollmentNo', 'Enrollment', 'Reg No', 'Registration No']);
                            // Add 'Candidate Name' and other potential headers
                            const studentName = getVal(['Name of the Trainee', 'Trainee Name', 'Name', 'Student Name', 'StudentName', 'Candidate Name', 'CandidateName', 'Full Name', 'FullName', 'Trainee']);
                            const gender = getVal(['Gender', 'Gender(M/F/T)', 'Sex']);

                            // Debug log for specific rows if needed
                            // console.log(`Row ${index + 2}:`, { batchName, studentName, enrollmentNo });

                            if (!batchName) {
                                errors.push(`Row ${index + 2}: Skipped - Missing 'BatchName' (Found keys: ${Object.keys(row).join(', ')})`);
                                skippedCount++;
                                return;
                            }

                            // Find batch (Case-insensitive)
                            const targetBatch = currentBatches.find(b => b.name.trim().toLowerCase() === String(batchName).trim().toLowerCase());

                            if (!targetBatch) {
                                errors.push(`Row ${index + 2}: Skipped - Batch "${batchName}" not found in system.`);
                                skippedCount++;
                                return;
                            }

                            if (!studentName) {
                                errors.push(`Row ${index + 2}: Skipped - Missing Student Name`);
                                skippedCount++;
                                return;
                            }

                            // Initialize count for this batch if not done yet
                            if (batchCounts[targetBatch.id] === undefined) {
                                batchCounts[targetBatch.id] = window.Utils.getStudentsByBatch(targetBatch.id).length;
                            }

                            // DUPLICATE CHECK (Optional but recommended)
                            // const existing = window.Utils.getStudentsByBatch(targetBatch.id);
                            // if (enrollmentNo && existing.find(s => s.enrollmentNo === String(enrollmentNo))) { ... }

                            const sequence = 100 + batchCounts[targetBatch.id];

                            // Auto-increment name if it is just "U" (Legacy logic, kept for safety)
                            let finalName = studentName;
                            if (String(studentName).trim().toUpperCase() === 'U') {
                                finalName = `U${batchCounts[targetBatch.id] + 1}`;
                            }

                            // Generate ID with slight entry variance to avoid collision in fast loops
                            const uniqueId = window.Utils.generateId() + '_' + index;

                            const student = {
                                id: uniqueId,
                                name: finalName,
                                username: sequence.toString(), // Sequential username: 100, 101...
                                enrollmentNo: enrollmentNo ? String(enrollmentNo) : '',
                                password: enrollmentNo ? String(enrollmentNo) : 'password',
                                batchId: targetBatch.id,
                                role: 'student',
                                gender: gender || ''
                            };
                            newStudentsToSave.push(student);

                            batchCounts[targetBatch.id]++; // Increment local count
                            addedCount++;
                        });

                        // SAVE IN BULK (Fixes Race Condition)
                        if (newStudentsToSave.length > 0) {
                            window.Utils.saveStudentsBulk(newStudentsToSave);
                        }

                        // SUMMARY REPORT
                        let msg = `Processing Complete.\n\nTotal Rows Found: ${rows.length}\nSuccessfully Imported: ${addedCount}\nSkipped/Failed: ${skippedCount}`;

                        if (errors.length > 0) {
                            msg += `\n\n--- SKIP LOG (First 10) ---\n` + errors.slice(0, 10).join('\n');
                            if (errors.length > 10) msg += `\n...and ${errors.length - 10} more.`;
                        } else {
                            msg += `\n\nAll rows imported successfully!`;
                        }

                        // Copy log to clipboard for easier debugging?
                        console.log("Full Import Log:", errors);

                        alert(msg);
                        setShowImportModal(false);

                    } catch (err) {
                        console.error("Excel Parse Error", err);
                        alert("Critical Error parsing Excel file: " + err.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            const questionPapers = window.Utils.getQuestionPapers();
            const getQPName = (id) => questionPapers.find(q => q.id === id)?.qpName || '-';

            return (
                <div className="animate-fade-in text-sm">
                    <h2 className="text-2xl font-bold mb-6 text-gray-800">Add / View Batches</h2>

                    {/* Filters */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div className="space-y-1">
                            <label className="text-xs font-bold text-gray-700">Sector Skill Council :</label>
                            <select className="w-full p-2 border rounded-md bg-gray-50 text-sm" value={filterSSC} onChange={e => setFilterSSC(e.target.value)}>
                                <option value="">Select SSC</option>
                                {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                        </div>
                        <div className="space-y-1">
                            <label className="text-xs font-bold text-gray-700">Qualification Pack :</label>
                            <select
                                className="w-full p-2 border rounded-md text-sm bg-gray-50"
                                value={filterQP}
                                onChange={e => setFilterQP(e.target.value)}
                                disabled={!filterSSC}
                            >
                                <option value="">Select QP</option>
                                {filterSSC && (() => {
                                    const uniqueCodes = new Set();
                                    return qpList.filter(q => {
                                        if (q.sscId === filterSSC) {
                                            const code = (q.code || '').trim().toLowerCase();
                                            if (uniqueCodes.has(code)) return false;
                                            uniqueCodes.add(code);
                                            return true;
                                        }
                                        return false;
                                    }).map(q => <option key={q.id} value={q.id}>{q.name} ({q.code})</option>);
                                })()}
                            </select>
                        </div>
                        <div className="flex items-end gap-2">
                            <div className="flex-1">
                                <input type="text" placeholder="Search with batch name" className="w-full p-2 border rounded-md" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} />
                            </div>
                            <button onClick={handleSearch} className="bg-green-500 text-white px-4 py-2 rounded flex items-center gap-1 hover:bg-green-600">
                                <Icons.Grid className="w-4 h-4" /> Search
                            </button>
                        </div>
                        <div className="space-y-1">
                            <input type="date" className="w-full p-2 border rounded-md text-gray-500" value={filterStartDate} onChange={e => setFilterStartDate(e.target.value)} />
                        </div>
                        <div className="space-y-1">
                            <input type="date" className="w-full p-2 border rounded-md text-gray-500" value={filterEndDate} onChange={e => setFilterEndDate(e.target.value)} />
                        </div>
                        <div className="flex items-end">
                            <button onClick={handleSearch} className="bg-red-500 text-white px-6 py-2 rounded shadow hover:bg-red-600 font-medium">Search</button>
                        </div>
                    </div>

                    {/* Main Content Area - Only visible if QP is selected or Search is active */}
                    {(filterQP || searchQuery) && (
                        <>
                            {/* Toolbar */}
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-2 text-gray-700 font-medium">
                                    <Icons.Book className="w-5 h-5 text-orange-500" />
                                    <span>Total Records : {filteredBatches.length}</span>
                                </div>
                                <div className="flex gap-2">

                                    <button className="bg-gray-600 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-gray-700 text-xs shadow-md">
                                        Export To <Icons.ChevronDown className="w-4 h-4" />
                                    </button>
                                    <button onClick={() => setShowImportModal(true)} className="bg-purple-600 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-purple-700 text-xs shadow-md shadow-purple-200">
                                        <Icons.UserPlus className="w-4 h-4" /> Import Students
                                    </button>
                                    <button
                                        onClick={() => {
                                            setNewBatch({ ...newBatch, id: '', sscId: filterSSC, qpId: filterQP });
                                            setShowCreateModal(true);
                                        }}
                                        disabled={!filterSSC || !filterQP}
                                        title={(!filterSSC || !filterQP) ? "Please select SSC and QP first" : "Create New Batch"}
                                        className={`bg-red-500 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-red-600 text-xs shadow-md shadow-red-200 ${(!filterSSC || !filterQP) ? 'opacity-50 cursor-not-allowed grayscale' : ''}`}
                                    >
                                        <Icons.Plus className="w-4 h-4" /> Add New Batch
                                    </button>
                                </div>
                            </div>

                            {/* Batches Grid/Table */}
                            <div className="bg-white rounded-lg border shadow-sm overflow-hidden mb-8">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left">
                                        <thead className="bg-gray-50 border-b">
                                            <tr>
                                                <th className="p-3 text-left font-bold text-gray-600 border-r w-12">Sr.#</th>
                                                <th className="p-3 text-left font-bold text-gray-600 border-r w-32">Batch Name</th>
                                                <th className="p-3 text-left font-bold text-gray-600 border-r w-24">Center ID</th>
                                                <th className="p-3 text-left font-bold text-gray-600 border-r w-24">Total Students</th>
                                                <th className="p-3 text-left font-bold text-gray-600 border-r w-32">Start Date</th>
                                                <th className="p-3 text-left font-bold text-gray-600 border-r w-32">End Date</th>
                                                <th className="p-3 text-left font-bold text-gray-600 border-r w-24">State</th>
                                                <th className="p-3 text-left font-bold text-gray-600 border-r w-24">District</th>
                                                <th className="p-3 text-center font-bold text-gray-600 border-r w-16">Edit</th>
                                                <th className="p-3 text-center font-bold text-gray-600 border-r w-24">Students</th>
                                                <th className="p-3 text-center font-bold text-gray-600 border-r w-24">Assessor</th>
                                                <th className="p-3 text-center font-bold text-gray-600 border-r w-24">Theory QP</th>
                                                <th className="p-3 text-center font-bold text-gray-600 border-r w-24">Practical QP</th>
                                                <th className="p-3 text-center font-bold text-gray-600 border-r w-24">Viva QP</th>
                                                <th className="p-3 text-center font-bold text-gray-600 w-16">B</th>
                                            </tr>
                                        </thead >
                                        <tbody className="divide-y">
                                            {filteredBatches.map((batch, idx) => (
                                                <tr key={batch.id} className="hover:bg-gray-50">
                                                    <td className="p-3 border-r text-center">{idx + 1}</td>
                                                    <td className="p-3 border-r font-medium text-gray-700">{batch.name}</td>
                                                    <td className="p-3 border-r text-gray-600">{batch.centerId || '-'}</td>
                                                    <td className="p-3 border-r text-center">
                                                        {window.Utils.getStudentsByBatch(batch.id).length}
                                                    </td>
                                                    <td className="p-3 border-r text-xs text-gray-600">
                                                        {batch.startDate ? (batch.startDate.includes('T') ? batch.startDate.split('T')[0] : batch.startDate) : '-'}
                                                        {batch.startTime && <div className="text-[10px] font-bold text-indigo-600">{window.Utils.formatTime12h(batch.startTime)}</div>}
                                                    </td>
                                                    <td className="p-3 border-r text-xs text-gray-600">
                                                        {batch.endDate ? (batch.endDate.includes('T') ? batch.endDate.split('T')[0] : batch.endDate) : '-'}
                                                        {batch.endTime && <div className="text-[10px] font-bold text-red-600">{window.Utils.formatTime12h(batch.endTime)}</div>}
                                                    </td>
                                                    <td className="p-3 border-r text-gray-600">{batch.state || '-'}</td>
                                                    <td className="p-3 border-r text-gray-600">{batch.district || '-'}</td>
                                                    <td className="p-3 border-r text-center">
                                                        <button onClick={() => handleEditBatch(batch)} className="bg-cyan-700 text-white p-2 rounded hover:bg-cyan-800"><Icons.Edit3 className="w-4 h-4" /></button>
                                                    </td>
                                                    <td className="p-3 border-r text-center">
                                                        <button onClick={() => { setSelectedBatch(batch); setShowStudentModal(true); }}
                                                            className="bg-cyan-700 text-white px-3 py-1 rounded flex items-center justify-center gap-1 hover:bg-cyan-800 text-xs mx-auto">
                                                            <Icons.Eye className="w-3 h-3" /> View
                                                        </button>
                                                    </td>
                                                    <td className="p-3 border-r text-center text-xs">
                                                        {(() => {
                                                            const assessor = window.Utils.getAssessors().find(a => a.batchId === batch.id);
                                                            return assessor ? (
                                                                <div className="font-mono bg-yellow-50 px-2 py-1 rounded inline-block border border-yellow-200 text-yellow-800">
                                                                    <div className="font-bold">{assessor.username}</div>
                                                                    <div className="text-[10px] text-yellow-700">Pass: {assessor.password}</div>
                                                                </div>
                                                            ) : (
                                                                <button onClick={() => {
                                                                    alert('Please create an assessor for this batch from the Assessors tab');
                                                                }} className="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded text-xs border border-gray-300">
                                                                    Assign
                                                                </button>
                                                            );
                                                        })()}
                                                    </td>
                                                    <td className="p-3 border-r text-center">
                                                        {batch.theoryPaperId ? (
                                                            <div className="flex items-center justify-center gap-2">
                                                                <span className="bg-cyan-700 text-white px-2 py-1 rounded text-xs truncate max-w-[120px]" title={getQPName(batch.theoryPaperId)}>{getQPName(batch.theoryPaperId)}</span>
                                                                <button onClick={() => {
                                                                    const qp = questionPapers.find(q => q.id === batch.theoryPaperId);
                                                                    setSelectedBatch(batch); setAssignmentType('Theory'); setSelectedAssignQP(batch.theoryPaperId);
                                                                    setAssignSSC(qp ? qp.sscId : ''); setAssignQPDef(qp ? qp.qpId : '');
                                                                    setShowAssignModal(true);
                                                                }} className="bg-yellow-100 text-yellow-700 p-1.5 rounded hover:bg-yellow-200 transition-colors shadow-sm border border-yellow-200" title="Edit Theory QP">
                                                                    <Icons.Edit3 className="w-3.5 h-3.5" />
                                                                </button>
                                                            </div>
                                                        ) : (
                                                            <button onClick={() => {
                                                                setSelectedBatch(batch); setAssignmentType('Theory'); setSelectedAssignQP('');
                                                                setAssignSSC(''); setAssignQPDef('');
                                                                setShowAssignModal(true);
                                                            }} className="text-blue-600 underline text-xs font-bold hover:text-blue-800">Assign</button>
                                                        )}
                                                    </td>
                                                    <td className="p-3 border-r text-center">
                                                        {batch.practicalPaperId ? (
                                                            <div className="flex items-center justify-center gap-1">
                                                                <span className="bg-cyan-700 text-white px-2 py-1 rounded text-xs">{getQPName(batch.practicalPaperId)}</span>
                                                                <button onClick={() => {
                                                                    const qp = questionPapers.find(q => q.id === batch.practicalPaperId);
                                                                    setSelectedBatch(batch); setAssignmentType('Practical'); setSelectedAssignQP(batch.practicalPaperId);
                                                                    setAssignSSC(qp ? qp.sscId : ''); setAssignQPDef(qp ? qp.qpId : '');
                                                                    setShowAssignModal(true);
                                                                }} className="text-gray-500 hover:text-blue-600">
                                                                    <Icons.Edit3 className="w-3 h-3" />
                                                                </button>
                                                            </div>
                                                        ) : (
                                                            <button onClick={() => {
                                                                setSelectedBatch(batch); setAssignmentType('Practical'); setSelectedAssignQP('');
                                                                setAssignSSC(''); setAssignQPDef('');
                                                                setShowAssignModal(true);
                                                            }} className="text-blue-600 underline text-xs">Assign</button>
                                                        )}
                                                    </td>
                                                    <td className="p-3 border-r text-center">
                                                        {batch.vivaPaperId ? (
                                                            <div className="flex items-center justify-center gap-1">
                                                                <span className="bg-cyan-700 text-white px-2 py-1 rounded text-xs">{getQPName(batch.vivaPaperId)}</span>
                                                                <button onClick={() => {
                                                                    const qp = questionPapers.find(q => q.id === batch.vivaPaperId);
                                                                    setSelectedBatch(batch); setAssignmentType('Viva'); setSelectedAssignQP(batch.vivaPaperId);
                                                                    setAssignSSC(qp ? qp.sscId : ''); setAssignQPDef(qp ? qp.qpId : '');
                                                                    setShowAssignModal(true);
                                                                }} className="text-gray-500 hover:text-blue-600">
                                                                    <Icons.Edit3 className="w-3 h-3" />
                                                                </button>
                                                            </div>
                                                        ) : (
                                                            <button onClick={() => {
                                                                setSelectedBatch(batch); setAssignmentType('Viva'); setSelectedAssignQP('');
                                                                setAssignSSC(''); setAssignQPDef('');
                                                                setShowAssignModal(true);
                                                            }} className="text-blue-600 underline text-xs">Assign</button>
                                                        )}
                                                    </td>
                                                    <td className="p-3 text-center flex items-center justify-center gap-2">
                                                        <button onClick={() => setVivaSession({ batch })} className="bg-indigo-600 text-white p-2 rounded hover:bg-indigo-700 shadow-sm transition-colors" title="Start Viva Meeting"><Icons.Video className="w-4 h-4" /></button>
                                                        <button onClick={() => { if (confirm('Delete Batch?')) { window.Utils.deleteBatch(batch.id); setBatches(window.Utils.getBatches()); setFilteredBatches(window.Utils.getBatches()); window.Utils.uploadToCloud(true); } }}
                                                            className="bg-cyan-700 text-white p-2 rounded hover:bg-cyan-800"><Icons.Trash2 className="w-4 h-4" /></button>
                                                    </td>
                                                </tr>
                                            ))}
                                            {filteredBatches.length === 0 && <tr><td colSpan="14" className="p-8 text-center text-gray-400">No batches records found</td></tr>}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {filteredBatches.length === 0 && <div className="text-center text-gray-400 py-4">No batches found matching your criteria.</div>}
                        </>
                    )}

                    {/* New Import Students Modal */}
                    {
                        showImportModal && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto font-sans">
                                <div className="bg-gray-100 w-full max-w-4xl my-8 shadow-xl rounded-lg overflow-hidden">
                                    {/* Header */}
                                    <div className="bg-gray-200 px-6 py-4 flex justify-between items-center border-b border-gray-300">
                                        <h3 className="text-xl font-bold text-gray-800">Import Students</h3>
                                        <button onClick={() => setShowImportModal(false)} className="text-gray-500 hover:text-gray-700">
                                            <Icons.XCircle className="w-6 h-6" />
                                        </button>
                                    </div>

                                    <div className="p-8 bg-white m-4 rounded-lg shadow-sm">
                                        <div className="grid grid-cols-[200px_1fr] gap-4 mb-6">
                                            <div className="font-bold text-gray-700 text-right">Sector Skill Council :</div>
                                            <div className="text-gray-600">Beauty Wellness Sector Skill Council</div>

                                            <div className="font-bold text-gray-700 text-right">Qualification Pack :</div>
                                            <div className="text-gray-600">Assistant Hair Dresser & Stylist</div>
                                        </div>

                                        <div className="space-y-4">
                                            <p className="text-gray-700 font-medium">
                                                <span className="font-bold">Note :</span> It will accept only Excel files with *.xls extension only.
                                            </p>
                                            <p className="text-gray-700">
                                                Use the same format as given below : <span onClick={() => window.Utils.downloadSampleFormat()} className="text-green-600 hover:underline cursor-pointer">Download</span>
                                            </p>

                                            {/* Format Table */}
                                            <div className="border border-gray-200 rounded overflow-hidden mb-6">
                                                <table className="w-full text-left border-collapse">
                                                    <thead>
                                                        <tr className="bg-gray-50">
                                                            <th className="p-3 border border-gray-200 font-bold text-gray-700">BatchName</th>
                                                            <th className="p-3 border border-gray-200 font-bold text-gray-700">Enrollment No</th>
                                                            <th className="p-3 border border-gray-200 font-bold text-gray-700">Name of Training Agency</th>
                                                            <th className="p-3 border border-gray-200 font-bold text-gray-700">Name of the Trainee</th>
                                                            <th className="p-3 border border-gray-200 font-bold text-gray-700">Gender(M/F/T)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td className="p-8 border border-gray-200"></td>
                                                            <td className="p-8 border border-gray-200"></td>
                                                            <td className="p-8 border border-gray-200"></td>
                                                            <td className="p-8 border border-gray-200"></td>
                                                            <td className="p-8 border border-gray-200"></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>

                                            {/* File Input */}
                                            <div className="bg-gray-100 p-6 rounded border border-gray-200">
                                                <label className="block font-bold text-red-500 mb-2">* Select Excel File :</label>
                                                <div className="flex bg-white border border-gray-300 rounded p-1 max-w-md">
                                                    <input id="bulkImportFile" type="file" accept=".xlsx, .xls" className="w-full p-1" />
                                                </div>
                                            </div>

                                            <div className="pt-4">
                                                <button onClick={handleBulkStudentImport} className="bg-red-500 text-white px-6 py-3 rounded shadow hover:bg-red-600 font-medium">
                                                    Validate Sheet
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )
                    }

                    {
                        showCreateModal && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto font-sans">
                                <div className="bg-white rounded-xl p-8 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                                    <h3 className="text-2xl font-bold mb-6 text-gray-800">{newBatch.id ? 'Edit Batch' : 'Add New Batch'}</h3>
                                    <form onSubmit={handleCreateBatch} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        <div className="col-span-1 md:col-span-2 lg:col-span-3 pb-4 border-b mb-2">
                                            <h4 className="font-bold text-gray-500 uppercase text-xs tracking-wider mb-4">Project Details</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                                <div>
                                                    <label className="block text-sm font-bold text-gray-700 mb-1">Project Name</label>
                                                    {showNewProjectInput ? (
                                                        <div className="flex gap-2">
                                                            <input type="text" className="w-full p-3 border rounded-lg bg-gray-50 focus:bg-white transition-colors outline-none focus:ring-2 focus:ring-blue-500"
                                                                placeholder="Enter new project name"
                                                                value={newBatch.project} onChange={e => setNewBatch({ ...newBatch, project: e.target.value })} autoFocus />
                                                            <button type="button" onClick={() => setShowNewProjectInput(false)} className="text-gray-500 hover:text-red-500"><Icons.XCircle /></button>
                                                        </div>
                                                    ) : (
                                                        <select className="w-full p-3 border rounded-lg bg-gray-50 focus:bg-white transition-colors outline-none focus:ring-2 focus:ring-blue-500"
                                                            value={newBatch.project} onChange={e => {
                                                                if (e.target.value === 'NEW') setShowNewProjectInput(true);
                                                                else setNewBatch({ ...newBatch, project: e.target.value });
                                                            }}>
                                                            <option value="">Select Project</option>
                                                            {projects.map(p => <option key={p} value={p}>{p}</option>)}
                                                            <option value="NEW" className="font-bold text-blue-600">+ Add New Project</option>
                                                        </select>
                                                    )}
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold text-gray-700 mb-1">Batch Name</label>
                                                    <input type="text" required className="w-full p-3 border rounded-lg bg-gray-50 focus:bg-white transition-colors outline-none focus:ring-2 focus:ring-blue-500"
                                                        value={newBatch.name} onChange={e => setNewBatch({ ...newBatch, name: e.target.value })} />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold text-gray-700 mb-1">Training Partner Name</label>
                                                    <input type="text" required className="w-full p-3 border rounded-lg bg-gray-50 focus:bg-white transition-colors outline-none focus:ring-2 focus:ring-blue-500"
                                                        value={newBatch.tpName} onChange={e => setNewBatch({ ...newBatch, tpName: e.target.value })} />
                                                </div>
                                            </div>
                                        </div>
                                        {/* Left Column */}
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-700 mb-1">Sector Skill Council</label>
                                                    <select className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100"
                                                        value={newBatch.sscId} onChange={e => setNewBatch({ ...newBatch, sscId: e.target.value, qpId: '' })}>
                                                        <option value="">Select Sector</option>
                                                        {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-700 mb-1">Qualification Pack</label>
                                                    <select className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100"
                                                        value={newBatch.qpId} onChange={e => setNewBatch({ ...newBatch, qpId: e.target.value })}
                                                        disabled={!newBatch.sscId}>
                                                        <option value="">Select QP</option>
                                                        {qpList.filter(q => q.sscId == newBatch.sscId).map(q => <option key={q.id} value={q.id}>{q.name}</option>)}
                                                    </select>
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-xs font-bold text-gray-700 mb-1">Project Name <span className="text-red-500">*</span></label>
                                                <div className="flex gap-2">
                                                    {showNewProjectInput ? (
                                                        <input className="w-full p-2 border border-gray-300 rounded text-sm"
                                                            placeholder="Enter Project Name"
                                                            value={newBatch.project} onChange={e => setNewBatch({ ...newBatch, project: e.target.value })}
                                                            onBlur={() => !newBatch.project && setShowNewProjectInput(false)}
                                                            autoFocus
                                                        />
                                                    ) : (
                                                        <select className="flex-1 p-2 border border-gray-300 rounded text-sm bg-white"
                                                            value={newBatch.project} onChange={e => setNewBatch({ ...newBatch, project: e.target.value })}
                                                        >
                                                            <option value="">Select Project</option>
                                                            {projects.map(p => <option key={p} value={p}>{p}</option>)}
                                                        </select>
                                                    )}

                                                    {!showNewProjectInput && (
                                                        <button type="button" onClick={() => setShowNewProjectInput(true)}
                                                            className="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600 whitespace-nowrap flex items-center gap-1">
                                                            <Icons.Plus className="w-3 h-3" /> New Project
                                                        </button>
                                                    )}
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Training Centre :</label>
                                                <div className="col-span-2">
                                                    <select className="w-full p-2 border border-gray-300 rounded text-sm bg-white"
                                                        value={newBatch.trainingCentre} onChange={handleTCSelection}
                                                    >
                                                        <option value="">Select Training Centre</option>
                                                        {trainingCentres.map(tc => <option key={tc.id} value={tc.name}>{tc.name}</option>)}
                                                    </select>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">State:</label>
                                                <div className="col-span-2">
                                                    <input readOnly className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 text-gray-500"
                                                        value={newBatch.state}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Spoc Contact No:</label>
                                                <div className="col-span-2">
                                                    <input className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 placeholder-gray-400"
                                                        placeholder="Center Contact No"
                                                        value={newBatch.spocContactNo} onChange={e => setNewBatch({ ...newBatch, spocContactNo: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-start pt-2">
                                                <label className="text-xs font-bold text-gray-700 mt-1">Center Address:</label>
                                                <div className="col-span-2">
                                                    <textarea rows="3" className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 placeholder-gray-400 resize-none"
                                                        placeholder="Center Address"
                                                        value={newBatch.centerAddress} onChange={e => setNewBatch({ ...newBatch, centerAddress: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Assessment Start Date :</label>
                                                <div className="col-span-2 relative">
                                                    <input type="date" required className="w-full p-2 border border-gray-300 rounded text-sm text-gray-500"
                                                        value={newBatch.startDate ? newBatch.startDate.split('T')[0] : ''}
                                                        onChange={e => setNewBatch({ ...newBatch, startDate: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Assessment End Date :</label>
                                                <div className="col-span-2 relative">
                                                    <input type="date" required className="w-full p-2 border border-gray-300 rounded text-sm text-gray-500"
                                                        value={newBatch.endDate}
                                                        onChange={e => setNewBatch({ ...newBatch, endDate: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Login Restrict Count:</label>
                                                <div className="col-span-2">
                                                    <input type="number" className="w-full p-2 border border-gray-300 rounded text-sm"
                                                        value={newBatch.loginRestrictCount} onChange={e => setNewBatch({ ...newBatch, loginRestrictCount: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Mode Of Assessment :</label>
                                                <div className="col-span-2">
                                                    <select className="w-full p-2 border border-gray-300 rounded text-sm bg-white"
                                                        value={newBatch.modeOfAssessment} onChange={e => setNewBatch({ ...newBatch, modeOfAssessment: e.target.value })}
                                                    >
                                                        <option value="">--Select--</option>
                                                        {assessmentModes.map(m => <option key={m} value={m}>{m}</option>)}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Right Column */}
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Batch Size:</label>
                                                <div className="col-span-2">
                                                    <input className="w-full p-2 border border-gray-300 rounded text-sm placeholder-gray-400"
                                                        placeholder="Batch Size"
                                                        value={newBatch.batchSize} onChange={e => setNewBatch({ ...newBatch, batchSize: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Center ID :</label>
                                                <div className="col-span-2">
                                                    <input readOnly className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 text-gray-500 placeholder-gray-400"
                                                        placeholder="Center ID"
                                                        value={newBatch.centerId}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">District:</label>
                                                <div className="col-span-2">
                                                    <input readOnly className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 text-gray-500"
                                                        value={newBatch.district}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Spoc EmailID:</label>
                                                <div className="col-span-2">
                                                    <input className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 placeholder-gray-400"
                                                        placeholder="Center EmailID"
                                                        value={newBatch.spocEmail} onChange={e => setNewBatch({ ...newBatch, spocEmail: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">T.P Name:</label>
                                                <div className="col-span-2">
                                                    <input className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 placeholder-gray-400"
                                                        placeholder="Training Partner Name"
                                                        value={newBatch.tpName} onChange={e => setNewBatch({ ...newBatch, tpName: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Start Time:</label>
                                                <div className="col-span-2">
                                                    <input type="time" className="w-full p-2 border border-gray-300 rounded text-sm text-gray-700"
                                                        value={newBatch.startTime} onChange={e => setNewBatch({ ...newBatch, startTime: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">End Time:</label>
                                                <div className="col-span-2">
                                                    <input type="time" className="w-full p-2 border border-gray-300 rounded text-sm text-gray-700"
                                                        value={newBatch.endTime} onChange={e => setNewBatch({ ...newBatch, endTime: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="flex items-center gap-2 text-xs font-bold text-gray-700 cursor-pointer select-none">
                                                    <input type="checkbox" className="w-4 h-4 text-blue-600 rounded"
                                                        checked={newBatch.captureImage} onChange={e => setNewBatch({ ...newBatch, captureImage: e.target.checked })}
                                                    />
                                                    Capture Image
                                                </label>
                                                <div className="col-span-2">
                                                    <input className="w-full p-2 border border-gray-300 rounded text-sm placeholder-gray-400"
                                                        placeholder="Camera Interval in Seconds."
                                                        value={newBatch.cameraInterval} onChange={e => setNewBatch({ ...newBatch, cameraInterval: e.target.value })}
                                                        disabled={!newBatch.captureImage}
                                                    />
                                                </div>
                                            </div>
                                        </div>


                                        {/* Footer */}
                                        <div className="flex gap-4 justify-start pt-8 mt-4">
                                            <button type="submit" className="px-8 py-2 bg-green-500 text-white rounded text-sm font-medium hover:bg-green-600 shadow-sm">
                                                {newBatch.id ? 'Update Batch' : 'Create Batch'}
                                            </button>
                                            <button type="button" onClick={() => setShowCreateModal(false)} className="px-6 py-2 bg-white text-gray-600 hover:bg-gray-50 rounded text-sm font-medium border border-gray-300">Cancel</button>
                                        </div>
                                    </form>
                                </div>
                            </div >
                        )
                    }

                    {
                        showAssignModal && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                                <div className="bg-white rounded-xl p-6 w-full max-w-md">
                                    <h3 className="text-xl font-bold mb-4">Assign {assignmentType} QP</h3>
                                    <div className="space-y-4">
                                        <p className="text-gray-600">Assigning to batch: <span className="font-bold">{selectedBatch?.name}</span></p>

                                        {/* Modal Filters */}
                                        <div className="space-y-4 mb-4 bg-gray-50 p-3 rounded">

                                            <div>
                                                <label className="text-xs font-bold text-gray-700 block mb-1">Sector Skill Council</label>
                                                <select className="w-full p-2 border rounded text-sm" value={assignSSC} onChange={e => { setAssignSSC(e.target.value); setAssignQPDef(''); setSelectedAssignQP(''); }}>
                                                    <option value="">Select SSC</option>
                                                    {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-xs font-bold text-gray-700 block mb-1">Qualification Pack</label>
                                                <select className="w-full p-2 border rounded text-sm"
                                                    value={assignQPDef}
                                                    onChange={e => { setAssignQPDef(e.target.value); setSelectedAssignQP(''); }}
                                                    disabled={!assignSSC}>
                                                    <option value="">Select QP</option>
                                                    {assignSSC && (() => {
                                                        const uniqueCodes = new Set();
                                                        return qpList.filter(q => q.sscId == assignSSC).map(q => { // Relaxed Filter: Match SSC
                                                            const code = (q.code || '').trim().toLowerCase();
                                                            if (uniqueCodes.has(code)) return null;
                                                            uniqueCodes.add(code);
                                                            return <option key={q.id} value={q.id}>{q.name} ({q.code})</option>;
                                                        });
                                                    })()}
                                                </select>
                                            </div>
                                        </div>

                                        <label className="text-xs font-bold text-gray-700 block mb-1">Select Question Paper</label>
                                        <select className="w-full px-4 py-2 border rounded mb-4"
                                            value={selectedAssignQP}
                                            onChange={e => setSelectedAssignQP(e.target.value)}
                                            disabled={!assignQPDef}>
                                            <option value="">Select Question Paper</option>
                                            {assignQPDef && questionPapers.filter(qp => qp.qpId == assignQPDef).map(qp => <option key={qp.id} value={qp.id}>{qp.qpName}</option>)}
                                        </select>
                                        <div className="flex gap-2">
                                            <button onClick={handleAssignQP} className="flex-1 bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">Assign</button>
                                            <button onClick={() => setShowAssignModal(false)} className="flex-1 bg-gray-100 text-gray-600 py-2 rounded hover:bg-gray-200">Cancel</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )
                    }

                    {
                        showStudentModal && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-5xl my-8">
                                    <div className="bg-gray-100 px-6 py-4 flex justify-between items-center border-b">
                                        <h3 className="text-xl font-bold text-gray-800">Students</h3>
                                        <button onClick={() => setShowStudentModal(false)} className="text-gray-500 hover:text-red-500">
                                            <Icons.XCircle className="w-6 h-6" />
                                        </button>
                                    </div>

                                    <div className="p-8">
                                        <div className="grid grid-cols-[200px_1fr] gap-4 mb-6">
                                            <div className="font-bold text-gray-700 text-right">Sector Skill Council :</div>
                                            <div className="text-gray-600">{sscList.find(s => s.id === selectedBatch?.sscId)?.name || 'Apparel'}</div>

                                            <div className="font-bold text-gray-700 text-right">Qualification Pack :</div>
                                            <div className="text-gray-600">{qpList.find(q => q.id === selectedBatch?.theoryPaperId)?.name || 'Advanced Course for Stylist'}</div>
                                        </div>

                                        <div className="flex justify-between items-center mb-4">
                                            <div className="flex items-center gap-2 text-gray-700 font-medium">
                                                <Icons.Users className="w-5 h-5 text-blue-500" />
                                                <span>Total Records : {selectedBatch ? window.Utils.getStudentsByBatch(selectedBatch.id).length : 0}</span>
                                            </div>
                                            <div className="bg-gray-100 p-2 rounded border border-dashed border-gray-300 flex items-center gap-2">
                                                <span className="text-xs font-bold text-gray-500">Add Students:</span>
                                                <input type="file" accept=".xlsx, .xls" onChange={handleStudentUpload} className="text-xs" />
                                            </div>
                                        </div>

                                        <div className="bg-white border rounded shadow-sm overflow-hidden">
                                            <table className="w-full text-left">
                                                <thead className="bg-gray-50 border-b">
                                                    <tr>
                                                        <th className="p-3 font-bold text-gray-700 border-r w-24">Photo</th>
                                                        <th className="p-3 font-bold text-gray-700 border-r">Enrollment No</th>
                                                        <th className="p-3 font-bold text-gray-700 border-r">User Name</th>
                                                        <th className="p-3 font-bold text-gray-700 border-r">Student Name</th>
                                                        <th className="p-3 font-bold text-gray-700 w-24 text-center">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y">
                                                    {selectedBatch && window.Utils.getStudentsByBatch(selectedBatch.id).map((student, idx) => (
                                                        <tr key={student.id} className="hover:bg-gray-50">
                                                            <td className="p-3 border-r text-center">
                                                                <div className="w-12 h-12 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-500 mx-auto">
                                                                    No Image
                                                                </div>
                                                            </td>
                                                            <td className="p-3 border-r text-gray-700">{student.enrollmentNo || student.username}</td>
                                                            <td className="p-3 border-r text-gray-700">{student.username}</td>
                                                            <td className="p-3 border-r text-gray-700">{student.name}</td>
                                                            <td className="p-3 text-center">
                                                                <button onClick={() => { if (confirm('Delete?')) { window.Utils.deleteStudent(student.id); setSelectedBatch({ ...selectedBatch }); window.Utils.uploadToCloud(true); } }}
                                                                    className="text-red-500 hover:text-red-700 p-2 hover:bg-red-50 rounded-full transition-colors" title="Delete Student">
                                                                    <Icons.Trash2 className="w-4 h-4" />
                                                                </button>
                                                                <button onClick={() => setVivaSession({ batch: selectedBatch, student: student })}
                                                                    className="ml-2 bg-green-50 text-green-600 hover:bg-green-100 hover:text-green-700 px-3 py-1 rounded-full text-xs font-bold border border-green-200 transition-colors flex items-center gap-1" title="Start Live Viva">
                                                                    <Icons.Video className="w-3 h-3" /> Live Viva
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                    {(!selectedBatch || window.Utils.getStudentsByBatch(selectedBatch.id).length === 0) && (
                                                        <tr>
                                                            <td colSpan="5" className="p-8 text-center text-gray-400">No students found in this batch.</td>
                                                        </tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div className="mt-6 flex justify-end">
                                            <button onClick={() => setShowStudentModal(false)} className="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600 font-medium shadow-sm transition-colors">
                                                Close
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )
                    }
                    {vivaSession && <VivaLobby batch={vivaSession.batch} onClose={() => setVivaSession(null)} />}
                </div >
            );
        };

        // Helper Component: Video from IndexedDB or Cloud
        const VideoPlayerDB = ({ videoKey, url: cloudUrl }) => {
            const [url, setUrl] = useState(null);
            const [status, setStatus] = useState('loading');

            useEffect(() => {
                if (cloudUrl) {
                    setUrl(cloudUrl);
                    setStatus('ready');
                    return;
                }

                VideoDB.getVideo(videoKey).then(blob => {
                    if (blob) {
                        setUrl(URL.createObjectURL(blob));
                        setStatus('ready');
                    } else {
                        setStatus('error');
                    }
                }).catch((e) => {
                    console.error("VideoPlayerDB Error", e);
                    setStatus('error');
                });
            }, [videoKey, cloudUrl]);

            if (status === 'loading') return <div className="p-4 text-gray-500 text-center text-xs">Loading Video...</div>;
            if (status === 'error') return (
                <div className="p-4 text-red-500 text-center text-xs bg-red-50 border border-red-100 rounded">
                    <p className="font-bold">Video File Not Found</p>
                    <p className="font-mono mt-1 text-[10px] text-gray-400">Key: {videoKey}</p>
                </div>
            );

            return (
                <div className="relative">
                    <video src={url} controls className="w-full h-32 object-cover bg-black" />
                    <a href={url} download={`exam_video_${videoKey}.webm`} className="absolute bottom-2 right-2 bg-white/80 p-1 rounded text-xs hover:bg-white flex items-center shadow">
                        <Icons.Save className="w-3 h-3 mr-1" /> Download
                    </a>
                </div>
            );
        };




        // ASSESSORS TAB
        const AssessorsTab = () => {
            const [assessors, setAssessors] = useState([]);
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [sscList, setSSCList] = useState([]);
            const [qpList, setQPList] = useState([]);
            const [batches, setBatches] = useState([]);

            // Filter state
            const [filterSSC, setFilterSSC] = useState('');
            const [filterQP, setFilterQP] = useState('');
            const [filterBatch, setFilterBatch] = useState('');

            const [newAssessor, setNewAssessor] = useState({
                name: '',
                username: '',
                password: '',
                sscId: '',
                qpId: '',
                batchId: '',
                status: 'active'
            });

            useEffect(() => {
                let unsubscribe = () => { };

                const setupRealtimeListener = () => {
                    if (db) { // Check global db instance
                        try {
                            unsubscribe = db.collection('assessors').onSnapshot((snapshot) => {
                                const list = snapshot.docs.map(doc => doc.data());
                                // 1. Update State (Visual)
                                setAssessors(list);
                                // 2. Update Local Storage (Persistence)
                                localStorage.setItem('se_assessors', JSON.stringify(list));
                            }, (error) => {
                                console.error("Realtime Assessor Sync Error:", error);
                            });
                        } catch (e) {
                            console.error("Setup Listener Failed", e);
                        }
                    } else {
                        // Retry if DB not ready yet (race condition on load)
                        setTimeout(setupRealtimeListener, 500);
                    }
                };

                // Initial Load from LocalStorage (Instant UI)
                const localData = window.Utils.getAssessors();
                setAssessors(localData);

                // Start Listening
                setupRealtimeListener();

                // Other lists that don't need realtime usually (refreshed on mount)
                setSSCList(window.Utils.getSSC());
                setQPList(window.Utils.getQPs());
                setBatches(window.Utils.getBatches());

                return () => unsubscribe();
            }, []);

            const handleSaveAssessor = () => {
                if (!newAssessor.name || !newAssessor.username || !newAssessor.password || !newAssessor.batchId) {
                    alert('Please fill all required fields');
                    return;
                }

                // 1. Save Assessor to Assessors List
                window.Utils.saveAssessor(newAssessor);

                // 2. Sync Credentials to Linked Batch (for Backward Compatibility & Batches Tab)
                const linkedBatch = batches.find(b => b.id === newAssessor.batchId);
                if (linkedBatch) {
                    linkedBatch.assessorUsername = newAssessor.username;
                    linkedBatch.assessorPassword = newAssessor.password;
                    window.Utils.saveBatch(linkedBatch);
                }

                setAssessors(window.Utils.getAssessors());
                setShowCreateModal(false);
                setNewAssessor({ name: '', username: '', password: '', sscId: '', qpId: '', batchId: '', status: 'active' });
                window.Utils.uploadToCloud(true);
            };

            const handleDelete = (id) => {
                if (confirm('Delete this assessor?')) {
                    window.Utils.deleteAssessor(id);
                    setAssessors(window.Utils.getAssessors());
                    window.Utils.uploadToCloud(true);
                }
            };

            const generateCredentials = () => {
                const username = `assessor_${Date.now().toString(36).substr(-5)}`;
                const password = Math.random().toString(36).substr(2, 8);
                setNewAssessor({ ...newAssessor, username, password });
            };

            const filteredQPs = qpList.filter(q => !newAssessor.sscId || q.sscId === newAssessor.sscId);
            const filteredBatches = batches.filter(b => !newAssessor.qpId || b.qpId === newAssessor.qpId);

            return (
                <div className="animate-fade-in">
                    <div className="flex items-center gap-2 text-xs text-green-600 mb-2">
                        <span>Home</span>
                        <span>/</span>
                        <span className="text-gray-600">Assessors</span>
                    </div>

                    <h3 className="text-2xl font-bold mb-6 text-gray-800">Assessors Management</h3>

                    {/* Filters */}
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <div className="grid grid-cols-3 gap-4">
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">Sector Skill Council :</label>
                                <select className="w-full p-3 border border-gray-300 rounded-lg text-sm"
                                    value={filterSSC} onChange={e => {
                                        setFilterSSC(e.target.value);
                                        setFilterQP('');
                                        setFilterBatch('');
                                    }}>
                                    <option value="">Select SSC</option>
                                    {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">Qualification Pack :</label>
                                <select className="w-full p-3 border border-gray-300 rounded-lg text-sm"
                                    value={filterQP} onChange={e => {
                                        setFilterQP(e.target.value);
                                        setFilterBatch('');
                                    }}
                                    disabled={!filterSSC}>
                                    <option value="">Select QP</option>
                                    {qpList.filter(q => q.sscId === filterSSC).map(q => <option key={q.id} value={q.id}>{q.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">Batch :</label>
                                <select className="w-full p-3 border border-gray-300 rounded-lg text-sm"
                                    value={filterBatch} onChange={e => setFilterBatch(e.target.value)}
                                    disabled={!filterQP}>
                                    <option value="">Select Batch</option>
                                    {batches.filter(b => b.qpId === filterQP).map(b => <option key={b.id} value={b.id}>{b.name}</option>)}
                                </select>
                            </div>
                        </div>
                    </div>


                    {filterSSC && filterQP && filterBatch && (
                        <>
                            <div className="flex justify-between items-center mb-4">
                                <div className="text-gray-500 text-sm">Total Assessors: {assessors.length}</div>
                                <button onClick={() => {
                                    setNewAssessor({
                                        name: '',
                                        username: '',
                                        password: '',
                                        sscId: filterSSC,
                                        qpId: filterQP,
                                        batchId: filterBatch,
                                        status: 'active'
                                    });
                                    setShowCreateModal(true);
                                }}
                                    disabled={!filterSSC || !filterQP || !filterBatch}
                                    className={`px-6 py-2 rounded-lg font-medium shadow-sm transition-colors flex items-center gap-2 ${!filterSSC || !filterQP || !filterBatch
                                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        : 'bg-red-500 hover:bg-red-600 text-white'
                                        }`}>
                                    <Icons.UserPlus className="w-4 h-4" /> Create New Assessor
                                </button>
                            </div>

                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
                                <table className="w-full text-left border-collapse">
                                    <thead className="bg-gray-50 border-b">
                                        <tr>
                                            <th className="p-4 font-bold text-gray-600 border-r w-16 text-center">Sr.#</th>
                                            <th className="p-4 font-bold text-gray-600 border-r">Name</th>
                                            <th className="p-4 font-bold text-gray-600 border-r">Username</th>
                                            <th className="p-4 font-bold text-gray-600 border-r">Password</th>
                                            <th className="p-4 font-bold text-gray-600 border-r">Batch</th>
                                            <th className="p-4 font-bold text-gray-600 border-r">SSC</th>
                                            <th className="p-4 font-bold text-gray-600 border-r">QP</th>
                                            <th className="p-4 font-bold text-gray-600 border-r">Status</th>
                                            <th className="p-4 font-bold text-gray-600">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {assessors.map((assessor, idx) => {
                                            const batch = batches.find(b => b.id === assessor.batchId);
                                            const ssc = sscList.find(s => s.id === assessor.sscId);
                                            const qp = qpList.find(q => q.id === assessor.qpId);
                                            return (
                                                <tr key={assessor.id} className="hover:bg-gray-50 transition-colors">
                                                    <td className="p-4 border-r text-center text-gray-600">{idx + 1}</td>
                                                    <td className="p-4 border-r">
                                                        <div className="font-bold text-gray-800">{assessor.name}</div>
                                                        <div className="text-xs text-gray-400">{new Date(assessor.createdAt).toLocaleDateString()}</div>
                                                    </td>
                                                    <td className="p-4 border-r text-gray-700">{assessor.username}</td>
                                                    <td className="p-4 border-r font-mono text-xs text-gray-500 relative group">
                                                        <span className="blur-sm group-hover:blur-none transition-all cursor-pointer select-all">{assessor.password || '****'}</span>
                                                    </td>
                                                    <td className="p-4 border-r text-blue-600 font-medium">{batch?.name || '-'}</td>
                                                    <td className="p-4 border-r text-gray-600">{ssc?.name || '-'}</td>
                                                    <td className="p-4 border-r text-gray-600">{qp?.name || '-'}</td>
                                                    <td className="p-4 border-r text-center">
                                                        <span className={`px-2 py-1 rounded text-xs font-bold ${assessor.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}`}>
                                                            {assessor.status}
                                                        </span>
                                                    </td>
                                                    <td className="p-4 text-center">
                                                        <button onClick={() => handleDelete(assessor.id)}
                                                            className="text-red-500 hover:text-red-700 p-2 hover:bg-red-50 rounded-full transition-colors" title="Delete">
                                                            <Icons.Trash2 className="w-4 h-4" />
                                                        </button>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                        {assessors.length === 0 && (
                                            <tr>
                                                <td colSpan="8" className="p-8 text-center text-gray-400">No assessors found. Click "Create New Assessor" to add one.</td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </>
                    )}

                    {showCreateModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white w-full max-w-2xl shadow-2xl rounded-xl overflow-hidden animate-scale-in">
                                <div className="bg-gray-50 px-8 py-5 flex justify-between items-center border-b">
                                    <h3 className="text-xl font-bold text-gray-800">Create New Assessor</h3>
                                    <button onClick={() => setShowCreateModal(false)} className="text-gray-400 hover:text-red-500 transition-colors">
                                        <Icons.XCircle className="w-6 h-6" />
                                    </button>
                                </div>
                                <div className="p-8 space-y-6">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-2">Sector Skill Council :</label>
                                            <select className="w-full p-3 border border-gray-300 rounded-lg text-sm"
                                                value={newAssessor.sscId} onChange={e => setNewAssessor({ ...newAssessor, sscId: e.target.value, qpId: '', batchId: '' })}>
                                                <option value="">Select SSC</option>
                                                {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-2">Qualification Pack :</label>
                                            <select className="w-full p-3 border border-gray-300 rounded-lg text-sm"
                                                value={newAssessor.qpId} onChange={e => setNewAssessor({ ...newAssessor, qpId: e.target.value, batchId: '' })}
                                                disabled={!newAssessor.sscId}>
                                                <option value="">Select QP</option>
                                                {filteredQPs.map(q => <option key={q.id} value={q.id}>{q.name}</option>)}
                                            </select>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-2">Batch :</label>
                                        <select className="w-full p-3 border border-gray-300 rounded-lg text-sm"
                                            value={newAssessor.batchId} onChange={e => setNewAssessor({ ...newAssessor, batchId: e.target.value })}
                                            disabled={!newAssessor.qpId}>
                                            <option value="">Select Batch</option>
                                            {filteredBatches.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}
                                        </select>
                                    </div>

                                    <div className="border-t pt-6">
                                        <h4 className="text-sm font-bold text-gray-700 mb-4">Step 4: Assessor Details & Credentials</h4>

                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                                                <input type="text" className="w-full p-3 border border-gray-300 rounded-lg text-sm"
                                                    placeholder="Enter assessor name"
                                                    value={newAssessor.name} onChange={e => setNewAssessor({ ...newAssessor, name: e.target.value })} />
                                            </div>

                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Username *</label>
                                                    <input type="text" className="w-full p-3 border border-gray-300 rounded-lg text-sm font-mono"
                                                        placeholder="assessor_xxxxx"
                                                        value={newAssessor.username} onChange={e => setNewAssessor({ ...newAssessor, username: e.target.value })} />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                                                    <input type="text" className="w-full p-3 border border-gray-300 rounded-lg text-sm font-mono"
                                                        placeholder="password"
                                                        value={newAssessor.password} onChange={e => setNewAssessor({ ...newAssessor, password: e.target.value })} />
                                                </div>
                                            </div>

                                            <button onClick={generateCredentials} type="button"
                                                className="bg-indigo-50 hover:bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 border border-indigo-200">
                                                <Icons.RefreshCw className="w-4 h-4" /> Auto-Generate Credentials
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-gray-50 px-8 py-4 flex justify-end gap-3 border-t">
                                    <button onClick={() => setShowCreateModal(false)}
                                        className="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                                        Cancel
                                    </button>
                                    <button onClick={handleSaveAssessor}
                                        className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-bold">
                                        Create Assessor
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // RESULTS TAB


        const ResultsTab = (props) => {
            const [batches, setBatches] = useState([]);
            const [selectedBatch, setSelectedBatch] = useState(null);
            const [examType, setExamType] = useState(null);
            const [students, setStudents] = useState([]);
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [allResponses, setAllResponses] = useState([]); // State for reliable updates

            // Filters & Data
            const [sscList, setSscList] = useState([]);
            const [qpList, setQpList] = useState([]);
            const [filterSSC, setFilterSSC] = useState('');
            const [filterQP, setFilterQP] = useState('');
            const [allQPapers, setAllQPapers] = useState([]);


            useEffect(() => {
                setBatches(window.Utils.getBatches());
                setSscList(window.Utils.getSSC());
                setQpList(window.Utils.getQPs());
                setAllQPapers(window.Utils.getQuestionPapers());
                setAllResponses(window.Utils.getResponses()); // Load initially
            }, []);

            const loadResults = (type) => {
                setExamType(type);
                setStudents(window.Utils.getStudentsByBatch(selectedBatch.id));
            };

            const viewEvidence = (student) => {
                setSelectedStudent(student);
            };




            if (!selectedBatch) return (
                <div>
                    <div className="grid grid-cols-2 gap-4 mb-6 bg-white p-4 rounded shadow-sm">
                        <div>
                            <label className="text-xs font-bold text-gray-500 block mb-1">Filter by Sector (SSC)</label>
                            <select className="w-full p-2 border rounded" value={filterSSC} onChange={e => { setFilterSSC(e.target.value); setFilterQP(''); }}>
                                <option value="">Select Sector Skill Council</option>
                                {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="text-xs font-bold text-gray-500 block mb-1">Filter by Qualification Pack (QP)</label>
                            <select className="w-full p-2 border rounded" value={filterQP} onChange={e => setFilterQP(e.target.value)}>
                                <option value="">All QPs</option>
                                {qpList.filter(q => filterSSC && q.sscId === filterSSC).map(q => <option key={q.id} value={q.id}>{q.name}</option>)}
                            </select>
                        </div>
                    </div>

                    <div className="grid gap-4 md:grid-cols-2">
                        {batches.filter(b => {
                            // Resolve the actual Question Papers assigned to this batch
                            const tPaper = allQPapers.find(p => p.id === b.theoryPaperId);
                            const pPaper = allQPapers.find(p => p.id === b.practicalPaperId);
                            const vPaper = allQPapers.find(p => p.id === b.vivaPaperId);

                            // 1. If SSC Filter is set, check if any paper belongs to that SSC
                            if (filterSSC) {
                                const matchesSSC = (tPaper && tPaper.sscId === filterSSC) ||
                                    (pPaper && pPaper.sscId === filterSSC) ||
                                    (vPaper && vPaper.sscId === filterSSC);
                                if (!matchesSSC) return false;
                            }

                            // 2. If QP Filter is set, check if any paper belongs to that QP ID
                            if (filterQP) {
                                const matchesQP = (tPaper && String(tPaper.qpId) === String(filterQP)) ||
                                    (pPaper && String(pPaper.qpId) === String(filterQP)) ||
                                    (vPaper && String(vPaper.qpId) === String(filterQP));
                                if (!matchesQP) return false;
                            }

                            // 3. Show by default if no filters block it
                            return true;
                        }).map(b => (
                            <div key={b.id} onClick={() => setSelectedBatch(b)} className="bg-white p-6 rounded shadow cursor-pointer hover:shadow-lg border-l-4 border-indigo-500 group relative">
                                <button
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        if (confirm('Are you sure you want to delete this batch? All associated students and data will be removed.')) {
                                            window.Utils.deleteBatch(b.id);
                                            setBatches(window.Utils.getBatches());
                                        }
                                    }}
                                    className="absolute top-4 right-4 text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity p-2 hover:bg-red-50 rounded-full"
                                    title="Delete Batch"
                                >
                                    <Icons.Trash2 className="w-5 h-5" />
                                </button>
                                <h3 className="font-bold text-lg">{b.name}</h3>
                                <p className="text-gray-500 text-sm mb-2">{b.startDate} - {b.endDate}</p>
                                <div className="text-xs text-gray-400">
                                    QP: {qpList.find(q => q.id === (allQPapers.find(p => p.id === (b.theoryPaperId || b.practicalPaperId || b.vivaPaperId))?.qpId))?.name || 'N/A'}
                                </div>
                            </div>

                        ))}
                        {batches.length === 0 && <div className="text-gray-400 col-span-2 text-center py-8">No Batches Found</div>}
                    </div>
                </div>
            );

            if (!examType) return (
                <div>
                    <button onClick={() => setSelectedBatch(null)} className="mb-4 text-indigo-600 font-medium flex items-center gap-1"><Icons.ChevronDown className="rotate-90" /> Back to Batches</button>
                    <h3 className="text-xl font-bold mb-4">Select Exam Type</h3>
                    <div className="flex gap-4">
                        {['Theory', 'Practical', 'Viva', 'Photo'].map(t => (
                            <button key={t} onClick={() => loadResults(t)} className="flex-1 bg-white p-8 rounded shadow text-xl font-bold hover:shadow-lg border border-gray-100">{t}</button>
                        ))}
                    </div>
                </div>
            );

            if (!selectedStudent) return (
                <div>
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={() => setExamType(null)} className="text-indigo-600 font-medium flex items-center gap-1"><Icons.ChevronDown className="rotate-90" /> Back</button>
                    </div>
                    <h3 className="text-xl font-bold mb-4">{selectedBatch.name} - {examType} Results</h3>
                    <div className="bg-white rounded overflow-hidden shadow">
                        {students.map((s, i) => {
                            let hasResponse = false;

                            if (examType === 'Photo') {
                                // For Photo tab, check if ANY response has MANUAL evidence
                                const studentResponses = allResponses.filter(r => r.studentId === s.id);
                                hasResponse = studentResponses.some(r => r.evidence && r.evidence.some(e => e.type && e.type.includes('MANUAL')));
                            } else {
                                // For T/P/V, check if response exists AND if evidence (if any) is NOT purely manual
                                // Actually, for T/P/V, we usually check attendance.
                                // But to be strict: if it's purely manual, it shouldn't count as "Present" in Theory tab?
                                // Let's keep it simple: matches ExamType.
                                hasResponse = allResponses.some(r => r.studentId === s.id && r.examType === examType);
                            }
                            return (
                                <div key={s.id} className={`p-4 border-b flex justify-between items-center hover:opacity-90 transition-opacity ${hasResponse ? 'bg-green-50 border-green-100 text-green-900' : 'bg-red-50 border-red-100 text-red-900'}`}>
                                    <div className="flex items-center gap-2">
                                        <span className={`w-2 h-2 rounded-full ${hasResponse ? 'bg-green-500' : 'bg-red-500'}`}></span>
                                        <span className="font-medium">{i + 1}. {s.name} ({s.username})</span>
                                        <span className={`text-xs px-2 py-0.5 rounded border ${hasResponse ? 'bg-green-100 border-green-200 text-green-700' : 'bg-red-100 border-red-200 text-red-700'}`}>
                                            {hasResponse ? 'Present' : 'Absent'}
                                        </span>
                                    </div>
                                    <button onClick={() => viewEvidence(s)} className={`font-medium hover:underline flex items-center gap-1 ${hasResponse ? 'text-green-700' : 'text-red-700'}`}>
                                        View Evidence (All) <Icons.ChevronRight className="w-4 h-4" />
                                    </button>
                                </div>
                            );
                        })}
                        {students.length === 0 && <div className="p-8 text-center text-gray-500">No students found</div>}
                    </div>
                </div>
            );

            if (selectedStudent) {
                return (
                    <StudentGradingView
                        student={selectedStudent}
                        batch={selectedBatch}
                        examType={examType}
                        allQPapers={allQPapers}
                        onBack={() => setSelectedStudent(null)}
                        role={props.role} // Pass role
                    />
                );
            }
        };

        // New StudentGradingView Component
        // SESSION PLAYER COMPONENT
        const EvidenceImage = ({ item }) => {
            const [src, setSrc] = React.useState(null);
            const [isLocal, setIsLocal] = React.useState(false);

            React.useEffect(() => {
                let active = true;
                const load = async () => {
                    // 1. Try Local IndexedDB (Priority)
                    const key = (item.storage === 'indexeddb' || !item.url) ? item.img : null;
                    if (key && !key.startsWith('data:') && !key.startsWith('blob:')) {
                        try {
                            const blob = await VideoDB.getVideo(key);
                            if (blob && active) {
                                setSrc(URL.createObjectURL(blob));
                                setIsLocal(true);
                                return;
                            }
                        } catch (e) { }
                    }

                    // 2. Logic for Cloud URLs
                    if (active) {
                        let finalUrl = item.img || item.url;

                        // SECURE PROXY LOGIC (v18.3 Robust)
                        // If it's an S3 URL, route through our server proxy to avoid 403 Forbidden
                        if (finalUrl && finalUrl.includes('amazonaws.com') && !finalUrl.includes('media-stream')) {
                            try {
                                const urlObj = new URL(finalUrl);
                                let s3Key = urlObj.pathname.startsWith('/') ? urlObj.pathname.substring(1) : urlObj.pathname;
                                s3Key = decodeURIComponent(s3Key);
                                console.log(`[Proxy] Photo Key: ${s3Key}`);
                                finalUrl = `${API_BASE}/media-stream?key=${encodeURIComponent(s3Key)}&apiKey=portel_secure_key_2025`;
                            } catch (e) {
                                console.error("Proxy URL Parse Error", e);
                            }
                        }

                        setSrc(finalUrl);
                        setIsLocal(!item.url || (item.img && item.img.startsWith('data:')));
                    }
                };
                load();
                return () => { active = false; };
            }, [item]);

            if (!src) return <div className="w-full h-32 bg-gray-200 animate-pulse flex items-center justify-center"><Icons.Loader className="animate-spin" /></div>;

            return (
                <div className="relative group overflow-hidden h-32 bg-gray-100">
                    <img
                        src={src}
                        className="w-full h-full object-cover transition-transform group-hover:scale-105 cursor-pointer"
                        onClick={() => {
                            const w = window.open("");
                            w.document.write(`<img src="${src}" style="max-width:100%"/>`);
                        }}
                        onError={(e) => {
                            // If it's not a valid data/blob URL, it will fail
                            if (!src.startsWith('data:') && !src.startsWith('blob:') && !src.startsWith('http')) {
                                e.target.style.display = 'none';
                                e.target.nextSibling.style.display = 'flex';
                            }
                        }}
                    />

                    {/* Delete Button */}
                    <button
                        onClick={(e) => { e.stopPropagation(); if (confirm('Delete this photo?')) onRemove(item); }}
                        className="absolute top-1 left-1 bg-red-600 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-20 shadow-lg hover:bg-red-700"
                        title="Delete Evidence"
                    >
                        <Icons.Trash2 className="w-3 h-3" />
                    </button>

                    <div className="absolute inset-0 hidden flex-col items-center justify-center bg-gray-200 text-gray-500 p-2 text-center">
                        <Icons.XCircle className="w-8 h-8 mb-1" />
                        <span className="text-[10px] font-bold">Media Not Found</span>
                        <p className="text-[8px]">Device Mismatch or Not Synced</p>
                    </div>
                    {isLocal && (
                        <div className="absolute top-0 right-0 bg-amber-500 text-white text-[10px] px-2 py-1 font-bold flex items-center gap-1 shadow-sm">
                            <Icons.Smartphone className="w-3 h-3" /> {src && src.startsWith('blob:') ? 'Local' : 'Stored on Source'}
                        </div>
                    )}
                    {!isLocal && src && src.startsWith('http') && (
                        <div className="absolute top-0 right-0 bg-green-600 text-white text-[10px] px-2 py-1 font-bold flex items-center gap-1 shadow-sm">
                            <Icons.Cloud className="w-3 h-3" /> Synced
                        </div>
                    )}
                </div>
            );
        };

        const SessionPlayer = ({ parts, onRemove }) => {
            const [index, setIndex] = React.useState(0);
            const [src, setSrc] = React.useState(null);
            const [sourceType, setSourceType] = React.useState(null); // 'Local' | 'Cloud'
            const [isLoading, setIsLoading] = React.useState(true);
            const [isError, setIsError] = React.useState(false);

            React.useEffect(() => {
                let active = true;
                const load = async () => {
                    setIsLoading(true);
                    setIsError(false);
                    setSrc(null);
                    setSourceType(null);

                    // Safety timeout (5 seconds)
                    const timeout = setTimeout(() => {
                        if (active && isLoading) {
                            console.warn("SessionPlayer load timeout for index", index);
                            setIsLoading(false);
                            setIsError(true);
                        }
                    }, 5000);

                    try {
                        const part = parts[index];
                        let blob = null;

                        let key = part.key || part.originalKey;
                        if (!key && part.storage === 'indexeddb' && part.img && !part.img.startsWith('data:') && !part.img.startsWith('blob:')) {
                            key = part.img;
                        }

                        if (key) {
                            try { blob = await VideoDB.getVideo(key); } catch (e) { }
                        }

                        if (blob) {
                            if (active) {
                                setSrc(URL.createObjectURL(blob));
                                setSourceType('Local');
                                setIsLoading(false);
                            }
                        } else if (part.img && (typeof part.img === 'string') && (part.img.startsWith('data:') || part.img.startsWith('blob:'))) {
                            if (active) {
                                setSrc(part.img);
                                setSourceType('Local');
                                setIsLoading(false);
                            }
                        } else if (part.downloadUrl || part.url) {
                            if (active) {
                                let finalUrl = part.downloadUrl || part.url;

                                // SECURE PROXY LOGIC (v18.3 Robust)
                                if (finalUrl && finalUrl.includes('amazonaws.com') && !finalUrl.includes('media-stream')) {
                                    try {
                                        const urlObj = new URL(finalUrl);
                                        // Robust Key Extraction: Handle both /bucket/key and /key styles
                                        // We assume the part after the last / is the filename, but we need the full key.
                                        // Standard AWS URL: https://bucket.s3.region.amazonaws.com/FOLDER/FILE
                                        // Pathname: /FOLDER/FILE
                                        // Key: FOLDER/FILE
                                        let s3Key = urlObj.pathname.startsWith('/') ? urlObj.pathname.substring(1) : urlObj.pathname;

                                        // Decoding is critical for spaces/symbols
                                        s3Key = decodeURIComponent(s3Key);

                                        console.log(`[Proxy] Converting ${finalUrl} -> Key: ${s3Key}`);
                                        finalUrl = `${API_BASE}/media-stream?key=${encodeURIComponent(s3Key)}&apiKey=portel_secure_key_2025`;
                                    } catch (e) {
                                        console.error("Proxy URL Parse Error", e);
                                    }
                                }

                                setSrc(finalUrl);
                                setSourceType('Cloud');
                                setIsLoading(false);
                            }
                        } else {
                            if (active) {
                                // DETECT CROSS-DEVICE GHOST (Local Key but missing Blob)
                                if (key && !key.startsWith('http')) {
                                    setSourceType('Local');
                                }
                                setIsLoading(false);
                                setIsError(true);
                            }
                        }
                    } catch (e) {
                        console.error(e);
                        if (active) { setIsLoading(false); setIsError(true); }
                    }
                    clearTimeout(timeout);
                };
                load();
                return () => { active = false; };
            }, [index, parts]);

            return (
                <div className="relative bg-black w-full h-32 group-hover:h-auto min-h-[128px]">
                    {src ? (
                        <video
                            src={src}
                            controls
                            autoPlay
                            className="w-full h-full object-contain"
                            onEnded={() => {
                                if (index < parts.length - 1) setIndex(index + 1);
                            }}
                            onError={() => setIsError(true)}
                        />
                    ) : (
                        <div className="flex flex-col items-center justify-center h-full text-white text-xs p-4 text-center">
                            {isLoading ? (
                                <>
                                    <Icons.Loader className="w-6 h-6 animate-spin mb-2 text-indigo-400" />
                                    <span>Loading Part {index + 1}...</span>
                                </>
                            ) : (
                                <>
                                    <Icons.XCircle className="w-8 h-8 mb-2 text-red-500" />
                                    <span className="font-bold">Media Not Found</span>
                                    <p className="text-[10px] opacity-60">Not Synced or Local Storage Missing</p>
                                </>
                            )}
                        </div>
                    )}
                    <div className="absolute top-0 right-0 flex gap-1">
                        {sourceType === 'Local' && (
                            <div className="bg-amber-500 text-white text-[10px] px-2 py-1 font-bold z-10 flex items-center gap-1 shadow-sm">
                                <Icons.Smartphone className="w-3 h-3" /> {src && src.startsWith('blob:') ? 'Local' : 'Stored on Source'}
                            </div>
                        )}
                        {sourceType === 'Cloud' && (
                            <div className="bg-green-600 text-white text-[10px] px-2 py-1 font-bold z-10 flex items-center gap-1 shadow-sm">
                                <Icons.Cloud className="w-3 h-3" /> Synced
                            </div>
                        )}
                        <div className="bg-indigo-600 text-white text-[10px] px-2 py-1 font-bold z-10 backdrop-blur-sm bg-opacity-80">
                            Part {index + 1}/{parts.length}
                        </div>

                        {/* Delete Session Button */}
                        <button
                            onClick={(e) => { e.stopPropagation(); if (confirm('Delete this entire video session?')) onRemove(parts[0].sessionId ? { isGroup: true, parts } : parts[0]); }}
                            className="bg-red-600 text-white p-1 opacity-0 group-hover:opacity-100 transition-opacity z-20 shadow-lg hover:bg-red-700"
                            title="Delete Session"
                        >
                            <Icons.Trash2 className="w-3 h-3" />
                        </button>
                    </div>
                </div>
            );
        };

        const StudentGradingView = ({ student, batch, examType, allQPapers, onBack, captureOnly = false, role = 'assessor' }) => {
            const [evidence, setEvidence] = useState([]);
            const [answers, setAnswers] = useState({});
            const [grades, setGrades] = useState({});
            const [evidenceFilter, setEvidenceFilter] = useState('ALL');
            const [facingMode, setFacingMode] = useState('environment');
            const [showGallery, setShowGallery] = useState(false); // Default hidden as per user request
            const [verificationInfo, setVerificationInfo] = useState(null); // v30.4: Father Name & Aadhar

            // Camera State
            const [isCamActive, setIsCamActive] = useState(false);
            const [isRecording, setIsRecording] = useState(false);


            const mediaStreamRef = useRef(null);
            const videoRef = useRef(null);
            const mediaRecorderRef = useRef(null);
            const chunksRef = useRef([]);
            const recordingSessionRef = useRef(null);
            const segmentSequenceRef = useRef(0);

            useEffect(() => {
                loadStudentResponse(student);
                return () => stopCam(); // Cleanup on unmount
            }, [student, examType]);

            // Fix: Attach stream to video element when it becomes active (Ref is available)
            useEffect(() => {
                if (isCamActive && videoRef.current && mediaStreamRef.current) {
                    videoRef.current.srcObject = mediaStreamRef.current;
                }
            }, [isCamActive]); // Depend on isCamActive

            const loadStudentResponse = async (s) => {
                const responses = window.Utils.getResponses();
                let evList = [];
                let targetResp = null;

                // AGGREGATE VIEW: Fetch ALL evidence (Manual + Auto) for this student
                // We want to show proctoring evidence for Theory/Practical/Viva as well.
                const allStudentResponses = responses.filter(r => r.studentId === s.id);

                // 1. Find the specific response for this exam type (for answers/grades)
                targetResp = allStudentResponses.find(r => r.examType === examType);

                // 2. Gather Evidence:
                // If it's the specific exam, get its evidence.
                // ALSO, include any 'MANUAL' or 'AUTO' evidence captured during this session timeframe (simplified: just show all evidence for now or specific types)

                // Current Requirement: Show "system recorded video and photos" (likely MANUAL/AUTO type) for Writing (Theory) Exam.
                // So we should NOT filter out MANUAL types for Theory.

                if (targetResp && targetResp.evidence) {
                    evList = [...targetResp.evidence];
                }

                // If no specific response found (e.g. absent but maybe has evidence?), keep evList empty or check others.

                // Optional: If 'Photo' tab is selected, maybe ONLY show Manual? 
                // But user wants to see it IN Theory tab.
                // So let's just show whatever evidence exists in the targetResponse.

                // NOTE: If the auto-captures are stored in a SEPARATE response object (e.g. strict 'Photo' type response),
                // we might need to merge them. But usually, they are attached to the current exam response or a generic one.
                // Let's assume they are attached to the actual exam response or we look for ANY evidence.

                // STRICT SEPARATION: Only load evidence for the specific Exam Type
                // STRICT SEPARATION: Only load evidence for the specific Exam Type
                if (targetResp && targetResp.evidence) {
                    evList = [...targetResp.evidence];
                }

                // v30.4 FIX: Always include VERIFICATION evidence (Selfie/ID) if it exists
                const verifResp = allStudentResponses.find(r => r.examType === 'VERIFICATION');
                if (verifResp) {
                    if (verifResp.answers) setVerificationInfo(verifResp.answers); // Load Father/Aadhar
                    if (verifResp.evidence) {
                        console.log("Found Verification Evidence:", verifResp.evidence.length);
                        // Prepend verification evidence so it appears first
                        evList = [...verifResp.evidence, ...evList];
                    }
                }

                // RESOLVE INDEXEDDB IMAGES
                const resolvedEvidence = await Promise.all(evList.map(async (e) => {
                    if (e.storage === 'indexeddb' && e.img) {
                        try {
                            const blob = await VideoDB.getVideo(e.img);
                            if (blob) {
                                return { ...e, img: URL.createObjectURL(blob), originalKey: e.img };
                            }
                        } catch (err) { console.error("Failed to load evidence image", err); }
                    }
                    return e;
                }));

                setEvidence(resolvedEvidence);
                setAnswers(targetResp?.answers || {});
                setGrades(targetResp?.assessorMarks || {});
            };

            // Camera Functions
            const startCam = async () => {
                stopCam(); // Cleanup

                // Wait 500ms for hardware to fully release
                await new Promise(r => setTimeout(r, 500));

                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert("Camera Error: Secure Context (HTTPS) required.");
                    return;
                }

                try {
                    // Force Back Camera with Standard Resolution (Fixes NotReadableError on high-res cams)
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: { ideal: "environment" },
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: true
                    });
                    mediaStreamRef.current = stream;
                    setIsCamActive(true);
                } catch (err) {
                    console.warn(`Camera failed`, err);
                    alert(`Back Camera Error: ${err.name}.\n${err.message}\nPlease close other tabs/apps.`);
                }
            };

            const stopCam = () => {
                if (mediaStreamRef.current) {
                    mediaStreamRef.current.getTracks().forEach(track => track.stop());
                    mediaStreamRef.current = null;
                }
                setIsCamActive(false);
                setIsRecording(false);
            };

            const capturePhoto = () => {
                if (!videoRef.current) return;
                const canvas = document.createElement('canvas');
                canvas.width = 640;
                canvas.height = 480;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(videoRef.current, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg');
                addEvidence(dataUrl, 'MANUAL_CAPTURE_PHOTO');
            };

            // Helper to add evidence with correct ExamType context
            const addEvidence = (data, type) => {
                // When capturing, we must ensure it is saved under the CURRENT examType (e.g. 'Viva', 'Practical', 'Theory')
                // However, if the user explicitly selected 'Photo' mode, then it saves as 'Photo'.
                // The AssessorPortal flow sets 'examType' correctly based on user selection.

                const newEvidence = { img: data, time: new Date().toISOString(), type };
                // Correctly delegate to the utility function which handles IndexedDB offloading and merging
                // We pass a partial object with just the new evidence.
                const partialResponse = {
                    studentId: student.id,
                    batchId: batch.id,
                    examType: examType,
                    evidence: [newEvidence],
                    // Ensure status is tracked if new
                    status: 'draft'
                };

                window.Utils.saveResponse(partialResponse);

                // Update local state (UI)
                setEvidence(prev => [...prev, newEvidence]);
            };

            const toggleRecording = () => {
                if (isRecording) {
                    // STOP MANUAL
                    if (mediaRecorderRef.current) mediaRecorderRef.current.stop();
                    setIsRecording(false);
                    if (window.recordingInterval) clearInterval(window.recordingInterval);
                    recordingSessionRef.current = null; // Reset Session
                } else {
                    // START
                    if (!mediaStreamRef.current) return;

                    // Initialize New Session
                    recordingSessionRef.current = `session_${Date.now()}`;
                    segmentSequenceRef.current = 1;

                    const startSegment = () => {
                        let localChunks = [];
                        const recorder = new MediaRecorder(mediaStreamRef.current);
                        recorder.ondataavailable = e => { if (e.data.size > 0) localChunks.push(e.data); };
                        recorder.onstop = async () => {
                            const blob = new Blob(localChunks, { type: 'video/webm' });
                            const key = `vid_${student.id}_${Date.now()}`;
                            const currentSeq = segmentSequenceRef.current; // Capture current seq

                            try {
                                await VideoDB.saveVideo(key, blob);
                                const newEvidence = {
                                    img: null,
                                    key: key,
                                    time: new Date().toISOString(),
                                    type: 'VIDEO_INDEXED_DB',
                                    storage: 'indexeddb',
                                    // METADATA FOR GROUPING
                                    sessionId: recordingSessionRef.current,
                                    sequence: currentSeq,
                                    isSegment: true
                                };

                                const partialResponse = {
                                    studentId: student.id,
                                    batchId: batch.id,
                                    examType: examType,
                                    evidence: [newEvidence],
                                    status: 'draft'
                                };
                                window.Utils.saveResponse(partialResponse);
                                setEvidence(prev => [...prev, newEvidence]);

                                // AUTO SYNC
                                const statusBtn = document.getElementById('sync-status-text');
                                if (statusBtn) statusBtn.innerText = `Uploading Part ${currentSeq}...`;
                                window.Utils.uploadToCloud(true).then(() => {
                                    if (statusBtn) statusBtn.innerText = "Synced";
                                });

                            } catch (err) {
                                console.error("Failed to save video to DB", err);
                            }
                        };
                        recorder.start(1000); // 1s chunks to keep `ondataavailable` firing
                        mediaRecorderRef.current = recorder;
                    };

                    startSegment();
                    setIsRecording(true);

                    startSegment();
                    setIsRecording(true);

                    // v30.4 FIX: User requested "Full Video". Disabled Auto-Splitting.
                    // Recording will continue until manually stopped or max size reached.
                    console.log("Recording started (Single Session Mode)");
                    if (window.recordingInterval) clearInterval(window.recordingInterval); // Safety clear
                }
            };




            const saveGrades = () => {
                const responses = window.Utils.getResponses();
                let idx = responses.findIndex(r => r.studentId === student.id && r.examType === examType);

                if (idx === -1) {
                    // Create if not exists (e.g. starting fresh manual grade)
                    const newResp = {
                        id: window.Utils.generateId(),
                        studentId: student.id,
                        examType,
                        evidence,
                        answers, // might be empty for manual
                        assessorMarks: grades
                    };
                    responses.push(newResp);
                } else {
                    if (!responses[idx].id) responses[idx].id = window.Utils.generateId(); // backfill
                    responses[idx].assessorMarks = grades;
                    responses[idx].evidence = evidence; // Ensure evidence is synced

                    // Calculate Total
                    const total = Object.values(grades).reduce((a, b) => parseFloat(a || 0) + parseFloat(b || 0), 0);
                    responses[idx].totalScore = total;
                }

                try {
                    localStorage.setItem(DB_KEYS.RESPONSES, JSON.stringify(responses));
                } catch (e) {
                    console.error("Storage Full", e);
                }

                // DIRECT SYNC
                const currentResp = idx === -1 ? responses[responses.length - 1] : responses[idx];
                window.Utils.saveToCloud('responses', currentResp).catch(console.error);

                // alert("Grades Saved Successfully! (Synced)");
            };

            const deleteEvidence = async () => {
                if (!confirm("Are you sure you want to DELETE ALL evidence for this student? This action cannot be undone.")) return;

                // 1. Delete Videos/Images from IndexedDB
                for (let e of evidence) {
                    const key = (e.type === 'VIDEO_INDEXED_DB' && e.key) ? e.key :
                        (e.storage === 'indexeddb' && (e.originalKey || e.img)) ? (e.originalKey || e.img) : null;

                    if (key && typeof key === 'string') {
                        try {
                            const db = await VideoDB.init();
                            const tx = db.transaction(VideoDB.storeName, 'readwrite');
                            tx.objectStore(VideoDB.storeName).delete(key);
                        } catch (err) { console.error("Failed to delete media", err); }
                    }
                }

                // 2. Update LocalStorage (Remove evidence array)
                const responses = window.Utils.getResponses();
                const idx = responses.findIndex(r => r.studentId === student.id && r.examType === examType);
                if (idx >= 0) {
                    if (!responses[idx].id) responses[idx].id = window.Utils.generateId(); // backfill
                    responses[idx].evidence = []; // Clear evidence

                    try {
                        localStorage.setItem(DB_KEYS.RESPONSES, JSON.stringify(responses));
                    } catch (e) {
                        console.error("Storage Full", e);
                    }

                    // DIRECT SYNC
                    window.Utils.saveToCloud('responses', responses[idx]).catch(console.error);
                }

                setEvidence([]); // Clear UI
                // alert("Evidence Deleted Successfully. (Synced)");
            };

            // Helper to download all evidence
            const downloadAllEvidence = async () => {
                // ... existing implementation if needed or kept minimal
                // alert("Download implementation preserved but hidden for brevity. Use original if restored.");
            };

            // Force Camera to be visible ONLY for Assessor (who has captureOnly=true)
            const showCamera = captureOnly;

            return (
                <div>
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={onBack} className="text-indigo-600 font-medium flex items-center gap-1"><Icons.ChevronDown className="rotate-90" /> Back</button>
                        <h3 className="text-xl font-bold">{captureOnly ? 'Capture Evidence: ' : 'Evidence: '}{student.name}</h3>
                        <div className="flex gap-2">

                            <button onClick={() => setShowGallery(!showGallery)} className="bg-gray-200 text-gray-700 px-4 py-2 rounded shadow hover:bg-gray-300 flex items-center gap-2 font-bold">
                                {showGallery ? <Icons.EyeOff className="w-4 h-4" /> : <Icons.Eye className="w-4 h-4" />} {showGallery ? 'Hide Gallery' : 'View Gallery'}
                            </button>
                            {!captureOnly && (
                                <>
                                    <button onClick={saveGrades} className="bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 flex items-center gap-2 font-bold transition-transform hover:scale-105">
                                        <Icons.Check className="w-4 h-4" /> Save Grades
                                    </button>
                                    <button onClick={deleteEvidence} className="text-red-600 hover:text-red-700 p-2" title="Reset Evidence">
                                        <Icons.Trash2 className="w-5 h-5" />
                                    </button>
                                </>
                            )}
                        </div>
                    </div>

                    {/* v30.4: Verification Details Display */}
                    {!captureOnly && verificationInfo && (
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 flex flex-wrap gap-8 items-center shadow-sm">
                            <div>
                                <h4 className="text-xs font-bold text-blue-500 uppercase tracking-wider">Candidate Name</h4>
                                <p className="text-lg font-bold text-gray-800">{student.name}</p>
                            </div>
                            <div>
                                <h4 className="text-xs font-bold text-blue-500 uppercase tracking-wider">Father's Name</h4>
                                <p className="text-lg font-bold text-gray-800">{verificationInfo.fatherName || 'N/A'}</p>
                            </div>
                            <div>
                                <h4 className="text-xs font-bold text-blue-500 uppercase tracking-wider">Aadhar Number</h4>
                                <p className="text-lg font-bold text-gray-800 font-mono tracking-wide">{verificationInfo.aadharNumber || 'N/A'}</p>
                            </div>
                            <div>
                                <h4 className="text-xs font-bold text-blue-500 uppercase tracking-wider">Status</h4>
                                <p className="text-lg font-bold text-green-600 flex items-center gap-1"><Icons.CheckCircle className="w-5 h-5" /> Verified</p>
                            </div>
                        </div>
                    )}

                    {/* Assessor Camera Section - ALWAYS VISIBLE */}
                    {showCamera && (
                        <div className="bg-slate-900 p-4 rounded shadow mb-6 text-white text-center">
                            {!isCamActive ? (
                                <div className="py-8">
                                    <Icons.Camera className="w-16 h-16 mx-auto text-slate-700 mb-4" />
                                    <h4 className="text-xl font-bold mb-2">Ready to Capture</h4>
                                    <p className="text-gray-400 mb-6">Take photos or record videos for {examType} evidence.</p>
                                    <button onClick={startCam} className="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-full font-bold shadow-lg transform hover:scale-105 transition-all text-lg">
                                        <Icons.Camera className="w-5 h-5 inline mr-2" /> Start Camera
                                    </button>
                                </div>
                            ) : (
                                <div>
                                    <div className="grid md:grid-cols-2 gap-4">
                                        <div className="relative bg-black rounded overflow-hidden aspect-video shadow-2xl border border-gray-700">
                                            <video ref={videoRef} autoPlay muted playsInline className="w-full h-full object-cover"></video>
                                            {isRecording && (
                                                <div className="absolute top-4 right-4 animate-pulse flex items-center gap-2 bg-red-600/90 backdrop-blur text-white px-3 py-1 rounded-full text-xs font-bold ring-2 ring-red-500/50">
                                                    <span className="w-2 h-2 rounded-full bg-white"></span> RECORDING
                                                </div>
                                            )}
                                        </div>
                                        <div className="flex flex-col justify-center gap-4 px-8">
                                            <button onClick={capturePhoto} className="bg-white text-slate-900 hover:bg-indigo-50 py-4 rounded-xl font-bold flex items-center justify-center gap-3 shadow-xl transition-all hover:-translate-y-1 active:scale-95 border-b-4 border-gray-200">
                                                <Icons.Camera className="w-6 h-6 text-indigo-600" /> Capture Photo
                                            </button>
                                            <button onClick={toggleRecording} className={`py-4 rounded-xl font-bold flex items-center justify-center gap-3 shadow-xl transition-all hover:-translate-y-1 active:scale-95 border-b-4 ${isRecording ? 'bg-red-500 hover:bg-red-600 text-white border-red-700' : 'bg-slate-700 hover:bg-slate-600 text-white border-slate-900'}`}>
                                                {isRecording ? <><Icons.Square className="w-5 h-5" /> Stop Recording</> : <><Icons.Video className="w-6 h-6" /> Start Video Recording</>}
                                            </button>
                                            <button onClick={stopCam} className="mt-4 text-gray-500 hover:text-white text-sm font-medium w-full">Cancel / Turn Off Camera</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Evidence Gallery (Categorized) */}
                    {showGallery && (
                        <div className="bg-white rounded shadow animate-fade-in mb-6 border-l-4 border-indigo-500 overflow-hidden">
                            <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                                {['All', 'Photos', 'Videos', 'Logs'].map(tab => (
                                    <button
                                        key={tab}
                                        onClick={() => setEvidenceFilter(tab)}
                                        className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${evidenceFilter === tab ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                                    >
                                        {tab}
                                    </button>
                                ))}
                            </div>

                            {(() => {
                                // SMART FILTER (v19.0.27): If Full Video exists, HIDE segments
                                const hasFullVideo = evidence.some(e => e.type === 'VIDEO_FULL_MERGED' || e.isFullVideo);
                                console.log("[UI] Has Full Video?", hasFullVideo);

                                let filtered = evidence.filter(e => {
                                    // 1. Hide segments if full video exists (Clean View)
                                    if (hasFullVideo && (e.type === 'VIDEO_INDEXED_DB' || e.isSegment)) return false;

                                    // 2. Apply tab-specific filters
                                    if (evidenceFilter === 'Photos') {
                                        return (
                                            e.img ||
                                            e.type?.includes('PHOTO') ||
                                            e.type?.includes('IMG') ||
                                            e.type?.includes('SNAPSHOT') ||
                                            e.type?.includes('PERSONS')
                                        );
                                    }
                                    if (evidenceFilter === 'Videos') return e.type?.includes('VIDEO');
                                    if (evidenceFilter === 'Logs') return !e.img && !e.type?.includes('VIDEO');

                                    return true; // 'All'
                                });

                                if (filtered.length === 0) return <p className="text-gray-400 text-sm text-center py-8">No records found for {evidenceFilter}</p>;

                                if (evidenceFilter === 'LOGS') {
                                    return (
                                        <div className="space-y-2">
                                            {filtered.map((e, i) => (
                                                <div key={i} className="flex items-center justify-between p-3 bg-gray-50 rounded border-l-4 border-amber-400">
                                                    <div className="flex items-center gap-3">
                                                        <Icons.TriangleAlert className="w-5 h-5 text-amber-500" />
                                                        <div>
                                                            <p className="font-bold text-sm text-gray-800">{(e.type || 'UNKNOWN').replace(/_/g, ' ')}</p>
                                                            <p className="text-xs text-gray-500">System Flag</p>
                                                        </div>
                                                    </div>
                                                    <span className="text-xs font-mono bg-white px-2 py-1 rounded border">{new Date(e.time).toLocaleString()}</span>
                                                </div>
                                            ))}
                                        </div>
                                    );
                                }

                                // GROUPING LOGIC
                                const grouped = [];
                                const sessions = {};

                                filtered.forEach(e => {
                                    if (e.sessionId) {
                                        if (!sessions[e.sessionId]) {
                                            sessions[e.sessionId] = {
                                                ...e,
                                                isGroup: true,
                                                parts: [],
                                                type: 'VIDEO_SESSION'
                                            };
                                            grouped.push(sessions[e.sessionId]);
                                        }
                                        sessions[e.sessionId].parts.push(e);
                                    } else {
                                        grouped.push(e);
                                    }
                                });

                                // Sort parts
                                Object.values(sessions).forEach(s => s.parts.sort((a, b) => a.sequence - b.sequence));

                                return (
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        {grouped.map((e, i) => (
                                            <div key={i} className="relative group bg-gray-100 rounded overflow-hidden border">
                                                {e.isGroup ? (
                                                    <SessionPlayer parts={e.parts} onRemove={async (item) => {
                                                        const success = await window.Utils.deleteEvidence(student.id, examType, item);
                                                        if (success) loadStudentResponse(student);
                                                    }} />
                                                ) : (
                                                    <>
                                                        {e.type.includes('VIDEO') ? (
                                                            <SessionPlayer parts={[e]} onRemove={async (item) => {
                                                                const success = await window.Utils.deleteEvidence(student.id, examType, item);
                                                                if (success) loadStudentResponse(student);
                                                            }} />
                                                        ) : (
                                                            <EvidenceImage item={e} onRemove={async (item) => {
                                                                const success = await window.Utils.deleteEvidence(student.id, examType, item);
                                                                if (success) loadStudentResponse(student);
                                                            }} />
                                                        )}
                                                    </>
                                                )}

                                                {/* Fallback for Error */}
                                                <div className="absolute inset-0 hidden flex-col items-center justify-center bg-gray-200 text-gray-500 p-2 text-center">
                                                    <Icons.XCircle className="w-8 h-8 mb-1" />
                                                    <span className="text-[10px] font-bold">Media Not Found</span>
                                                </div>

                                                <div className="absolute top-0 left-0 bg-black/60 text-white text-[10px] px-2 py-1 rounded-br">
                                                    {new Date(e.time).toLocaleTimeString()}
                                                </div>
                                                <div className="absolute inset-x-0 bottom-0 bg-white/90 p-2 text-xs font-bold truncate text-center border-t">
                                                    {e.isGroup ? `Exam Recording (${e.parts.length} Parts)` : e.type.replace(/_/g, ' ')}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                );
                            })()}
                        </div>
                    )}

                    {
                        !captureOnly && (
                            <div className="bg-white p-6 rounded shadow">
                                {(() => {
                                    const currentQPId = examType === 'Theory' ? batch?.theoryPaperId : (examType === 'Viva' ? batch?.vivaPaperId : batch?.practicalPaperId);
                                    const currentQP = allQPapers.find(q => q.id === currentQPId);

                                    return (
                                        <>
                                            <h4 className="font-bold mb-4 flex items-center justify-between">
                                                <span>Grading: {currentQP?.name || 'Manual Grade'}</span>
                                                <span className="text-sm font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded">QP: {currentQP?.code || 'N/A'}</span>
                                            </h4>
                                            <div className="space-y-4">
                                                {currentQP?.questions?.map((question, index) => {
                                                    const qIdx = String(index);
                                                    const ans = answers[qIdx];
                                                    return (
                                                        <div key={qIdx} className="bg-gray-50 p-4 rounded border flex items-center justify-between">
                                                            <div className="flex-1 pr-4">
                                                                <span className="font-bold text-gray-700 block mb-1">Q{index + 1}: {question?.question}</span>
                                                                {/* Tiny Answer preview */}
                                                                {typeof ans === 'string' && (
                                                                    <div className="mt-1">
                                                                        <p className={`text-xs font-medium truncate max-w-md ${question?.correctAnswer && String(ans).toLowerCase() === String(question.correctAnswer).toLowerCase() ? 'text-green-600' : 'text-gray-600'}`}>
                                                                            Student Answer: {ans}
                                                                        </p>
                                                                        {question?.correctAnswer && (
                                                                            <p className="text-xs text-green-700 font-bold truncate max-w-md">
                                                                                Correct Answer: {question.correctAnswer}
                                                                            </p>
                                                                        )}
                                                                    </div>
                                                                )}
                                                            </div>
                                                            <div className="flex items-center gap-3">
                                                                <div className="flex items-center gap-2 bg-white p-2 rounded border shadow-sm">
                                                                    <span className="text-xs font-bold text-gray-500 uppercase">Score</span>
                                                                    <input type="number"
                                                                        className="w-16 p-1 border-b-2 border-indigo-200 text-center font-bold text-indigo-700 outline-none focus:border-indigo-600"
                                                                        placeholder="0"
                                                                        max={question?.totalMarks}
                                                                        value={grades[qIdx] !== undefined ? grades[qIdx] : 0}
                                                                        onChange={e => setGrades({ ...grades, [qIdx]: e.target.value })}
                                                                    />
                                                                    <span className="text-xs text-gray-400">/ {question?.totalMarks}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                                {(!currentQP || !currentQP.questions || currentQP.questions.length === 0) && (
                                                    <div className="p-8 text-center border-2 border-dashed rounded bg-gray-50">
                                                        <p className="text-gray-500 mb-4">No Question Paper assigned for {examType}.</p>
                                                        <label className="block text-sm font-bold text-gray-700 mb-1">Enter Total Score Manually</label>
                                                        <input type="number" className="p-2 border rounded w-32 text-center font-bold text-xl" placeholder="0"
                                                            onChange={e => setGrades({ 'MANUAL_TOTAL': e.target.value })}
                                                        />
                                                    </div>
                                                )}
                                            </div>
                                        </>
                                    );
                                })()}
                            </div>
                        )
                    }
                </div >
            );
        };

        const CalendarTab = () => {
            const [date, setDate] = useState(new Date());
            const [events, setEvents] = useState([]);
            const [selectedDateEvents, setSelectedDateEvents] = useState([]);

            useEffect(() => {
                const loadEvents = () => {
                    const batches = window.Utils.getBatches();
                    // Map batches to events
                    const evts = [];
                    batches.forEach(b => {
                        if (b.startDate) {
                            const d = new Date(b.startDate);
                            if (!isNaN(d.getTime())) {
                                evts.push({
                                    date: d,
                                    title: `Start: ${b.name}`,
                                    type: 'start',
                                    data: b
                                });
                            }
                        }
                        if (b.endDate) {
                            const d = new Date(b.endDate);
                            if (!isNaN(d.getTime())) {
                                evts.push({
                                    date: d,
                                    title: `End: ${b.name}`,
                                    type: 'end',
                                    data: b
                                });
                            }
                        }
                    });
                    setEvents(evts);
                };
                loadEvents();
                window.addEventListener('cloud-sync-complete', loadEvents);
                return () => window.removeEventListener('cloud-sync-complete', loadEvents);
            }, []);

            const daysInMonth = (month, year) => new Date(year, month + 1, 0).getDate();
            const firstDayOfMonth = (month, year) => new Date(year, month, 1).getDay();

            const renderCalendar = () => {
                const month = date.getMonth();
                const year = date.getFullYear();
                const totalDays = daysInMonth(month, year);
                const startDay = firstDayOfMonth(month, year);
                const days = [];

                // Empty slots for days before start of month
                for (let i = 0; i < startDay; i++) {
                    days.push(<div key={`empty-${i}`} className="h-24 bg-gray-50 border border-gray-100"></div>);
                }

                // Days of month
                for (let d = 1; d <= totalDays; d++) {
                    const currentDay = new Date(year, month, d);
                    const dayEvents = events.filter(e =>
                        e.date.getDate() === d &&
                        e.date.getMonth() === month &&
                        e.date.getFullYear() === year
                    );

                    days.push(
                        <div key={d}
                            onClick={() => setSelectedDateEvents(dayEvents)}
                            className={`h-24 border border-gray-100 p-2 cursor-pointer transition hover:bg-blue-50 ${dayEvents.length > 0 ? 'bg-blue-50/30' : 'bg-white'}`}>
                            <div className="flex justify-between items-start">
                                <span className={`text-sm font-bold ${dayEvents.length > 0 ? 'text-blue-600' : 'text-gray-700'}`}>{d}</span>
                                {dayEvents.length > 0 && <span className="w-2 h-2 rounded-full bg-blue-500"></span>}
                            </div>
                            <div className="mt-1 space-y-1 overflow-hidden h-14">
                                {dayEvents.map((ev, i) => (
                                    <div key={i} className={`text-[10px] truncate px-1 rounded ${ev.type === 'start' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                        {ev.title}
                                    </div>
                                ))}
                            </div>
                        </div>
                    );
                }
                return days;
            };

            const changeMonth = (offset) => {
                setDate(new Date(date.getFullYear(), date.getMonth() + offset, 1));
            };

            return (
                <div className="animate-fade-in grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="md:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-gray-800">{date.toLocaleString('default', { month: 'long', year: 'numeric' })}</h2>
                            <div className="flex gap-2">
                                <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-gray-100 rounded-full"><Icons.ChevronLeft /></button>
                                <button onClick={() => changeMonth(1)} className="p-2 hover:bg-gray-100 rounded-full"><Icons.ChevronRight /></button>
                            </div>
                        </div>
                        <div className="grid grid-cols-7 gap-px mb-2 text-center text-xs font-bold text-gray-500 uppercase">
                            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                        </div>
                        <div className="grid grid-cols-7 border border-gray-100 rounded-lg overflow-hidden">
                            {renderCalendar()}
                        </div>
                    </div>

                    {/* Event Details Sidebar */}
                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <h3 className="text-lg font-bold text-gray-800 mb-4">Events</h3>
                        {selectedDateEvents.length > 0 ? (
                            <div className="space-y-4">
                                {selectedDateEvents.map((evt, idx) => (
                                    <div key={idx} className="p-4 rounded-lg bg-gray-50 border border-gray-200">
                                        <div className={`text-xs font-bold uppercase mb-1 ${evt.type === 'start' ? 'text-green-600' : 'text-red-600'}`}>
                                            {evt.type === 'start' ? 'Batch Starting' : 'Batch Ending'}
                                        </div>
                                        <h4 className="font-bold text-gray-800">{evt.data.name}</h4>
                                        <p className="text-xs text-gray-500 mt-1">{evt.data.qpName || 'No QP Assigned'}</p>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="text-center text-gray-400 py-10">
                                <Icons.Calendar className="w-12 h-12 mx-auto mb-2 opacity-50" />
                                <p>Select a date with dots to see details</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const LocationTab = () => {
            const [centers, setCenters] = useState([]);

            useEffect(() => {
                const loadCenters = () => {
                    const batches = window.Utils.getBatches();
                    // Extract unique centers from batches
                    // Assuming batch has 'trainingCentre', 'district', 'state', 'centerId', 'centerAddress'
                    const centerMap = new Map();
                    batches.forEach(b => {
                        if (b.trainingCentre) {
                            if (!centerMap.has(b.trainingCentre)) {
                                centerMap.set(b.trainingCentre, {
                                    name: b.trainingCentre,
                                    id: b.centerId || 'N/A',
                                    district: b.district || 'Unknown',
                                    state: b.state || 'Unknown',
                                    spoc: b.spocName || 'N/A', // Assuming spocName exists or strictly spocEmail
                                    address: b.centerAddress || '',
                                    activeBatches: 0
                                });
                            }
                            centerMap.get(b.trainingCentre).activeBatches += 1;
                        }
                    });
                    setCenters(Array.from(centerMap.values()));
                };
                loadCenters();
                window.addEventListener('cloud-sync-complete', loadCenters);
                return () => window.removeEventListener('cloud-sync-complete', loadCenters);
            }, []);

            return (
                <div className="animate-fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">Assessment Locations</h2>
                        <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-bold">{centers.length} Centers Active</span>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {centers.map((center, idx) => (
                            <div key={idx} className="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition">
                                <div className="flex items-start justify-between mb-4">
                                    <div className="p-3 bg-indigo-50 text-indigo-600 rounded-lg">
                                        <Icons.MapPin className="w-6 h-6" />
                                    </div>
                                    <span className="text-xs font-bold bg-green-100 text-green-700 px-2 py-1 rounded-full">
                                        {center.activeBatches} Active batches
                                    </span>
                                </div>
                                <h3 className="text-lg font-bold text-gray-800 mb-1">{center.name}</h3>
                                <p className="text-sm text-gray-500 mb-4">{center.id}</p>

                                <div className="space-y-2 text-sm text-gray-600">
                                    <div className="flex items-center gap-2">
                                        <Icons.Map className="w-4 h-4 opacity-70" />
                                        <span>{center.district}, {center.state}</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <Icons.Home className="w-4 h-4 opacity-70" />
                                        <span className="truncate" title={center.address}>{center.address || 'No Address Provided'}</span>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    {centers.length === 0 && (
                        <div className="text-center py-20 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                            <Icons.MapPin className="w-16 h-16 mx-auto text-gray-300 mb-4" />
                            <h3 className="text-xl font-bold text-gray-400">No Training Centers Found</h3>
                            <p className="text-gray-500">Create Batches with Center details to populate this map.</p>
                        </div>
                    )}
                </div>
            );
        };

        const DashboardTab = () => {
            const [stats, setStats] = useState({ batches: 0, students: 0, qps: 0, assessors: 0 });
            const [recentBatches, setRecentBatches] = useState([]);

            useEffect(() => {
                const loadStats = () => {
                    const batches = window.Utils.getBatches();
                    const students = window.Utils.getStudents();
                    const qps = window.Utils.getQuestionPapers();
                    // Assessor count estimated from batches (unique usernames) or just hardcode for demo
                    // A better way: Count unique assessors assigned to batches
                    const assessors = new Set(batches.map(b => b.assessorUsername).filter(u => u)).size;

                    setStats({
                        batches: batches.length,
                        students: students.length,
                        qps: qps.length,
                        assessors: assessors
                    });
                    setRecentBatches(batches.slice(-5).reverse());
                };
                loadStats();
                window.addEventListener('cloud-sync-complete', loadStats);
                return () => window.removeEventListener('cloud-sync-complete', loadStats);
            }, []);

            return (
                <div className="animate-fade-in">
                    <h2 className="text-2xl font-bold mb-6 text-gray-800">Administrator Dashboard</h2>

                    {/* System Management (Debugging Position) */}
                    <div className="mb-8 bg-red-50 rounded-xl shadow-sm border border-red-200 p-6">
                        <h3 className="text-lg font-bold text-red-800 mb-4 flex items-center gap-2">
                            <Icons.TriangleAlert className="w-5 h-5 text-red-600" /> System Management
                        </h3>
                        <div className="flex items-center justify-between">
                            <div>
                                <h4 className="font-bold text-gray-800">Factory Reset</h4>
                                <p className="text-sm text-gray-600 max-w-xl">
                                    This will permanently delete ALL data (Batches, Students, QPs, Responses) from both this device and the Cloud.
                                    This action cannot be undone. Use with extreme caution.
                                </p>
                            </div>
                            <button
                                onClick={window.Utils.factoryReset}
                                className="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg flex items-center gap-2 transition-transform hover:scale-105"
                            >
                                <Icons.Trash2 className="w-5 h-5" />
                                Reset App & Clear Cloud
                            </button>
                        </div>

                        {/* Cloud Verification Tool */}
                        <div className="mt-4 pt-4 border-t border-red-200 flex justify-end">
                            <button
                                onClick={async () => {
                                    const btn = document.getElementById('btn-check-cloud');
                                    if (btn) btn.innerText = "Scanning S3...";

                                    // 1. LOCAL DATA CHECK
                                    let localReport = "LOCAL DATA:\n";
                                    const localResponses = window.Utils.getResponses();
                                    let localPhotos = 0, localVideos = 0;
                                    localResponses.forEach(r => {
                                        if (r.evidence) r.evidence.forEach(e => {
                                            if (e.type === 'VIDEO_WEBM' || e.type === 'VIDEO_INDEXED_DB') localVideos++;
                                            else localPhotos++;
                                        });
                                    });
                                    localReport += `Responses: ${localResponses.length}\nPhotos: ${localPhotos}, Videos: ${localVideos}\n-------------------\n`;

                                    // 2. CLOUD DATA CHECK
                                    const routes = ['batches', 'students', 'responses', 'assessors'];
                                    let cloudReport = "CLOUD DATA (REST/S3):\n";

                                    try {
                                        const headers = { 'x-api-key': 'portel_secure_key_2025' };

                                        // Fetch all in parallel
                                        const results = await Promise.all(routes.map(r =>
                                            fetch(`${API_BASE}/${r}`, { headers }).then(res => res.ok ? res.json() : [])
                                        ));

                                        const [batches, students, responses, assessors] = results;

                                        let cloudPhotos = 0, cloudVideos = 0;
                                        responses.forEach(r => {
                                            if (r.evidence) r.evidence.forEach(e => {
                                                if (e.type === 'VIDEO_WEBM' || e.type === 'VIDEO_INDEXED_DB') cloudVideos++;
                                                else cloudPhotos++;
                                            });
                                        });

                                        cloudReport += `Responses: ${responses.length}\nPhotos: ${cloudPhotos}, Videos: ${cloudVideos}\n`;
                                        cloudReport += `Batches: ${batches.length}\n`;
                                        cloudReport += `Students: ${students.length}\n`;
                                        cloudReport += `Assessors: ${assessors.length}\n`;

                                    } catch (e) {
                                        cloudReport += `Error: ${e.message}`;
                                    }

                                    if (btn) btn.innerText = "Check Cloud Data";
                                    alert(localReport + "\n" + cloudReport + "\n(Verify that Cloud counts match your expectations!)");
                                }}
                                id="btn-check-cloud"
                                className="text-xs text-red-600 hover:text-red-800 underline font-medium flex items-center gap-1"
                            >
                                <Icons.Database className="w-3 h-3" /> Check Cloud Data
                            </button>
                        </div>
                    </div>

                    {/* Stats Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
                            <div className="p-3 bg-blue-50 text-blue-600 rounded-lg"><Icons.Users className="w-8 h-8" /></div>
                            <div>
                                <h3 className="text-2xl font-bold text-gray-800">{stats.batches}</h3>
                                <p className="text-sm text-gray-500">Total Batches</p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
                            <div className="p-3 bg-green-50 text-green-600 rounded-lg"><Icons.User className="w-8 h-8" /></div>
                            <div>
                                <h3 className="text-2xl font-bold text-gray-800">{stats.students}</h3>
                                <p className="text-sm text-gray-500">Total Candidates</p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
                            <div className="p-3 bg-purple-50 text-purple-600 rounded-lg"><Icons.FileText className="w-8 h-8" /></div>
                            <div>
                                <h3 className="text-2xl font-bold text-gray-800">{stats.qps}</h3>
                                <p className="text-sm text-gray-500">Question Papers</p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
                            <div className="p-3 bg-orange-50 text-orange-600 rounded-lg"><Icons.Eye className="w-8 h-8" /></div>
                            <div>
                                <h3 className="text-2xl font-bold text-gray-800">{stats.assessors}</h3>
                                <p className="text-sm text-gray-500">Active Assessors</p>
                            </div>
                        </div>
                    </div>

                    {/* Recent Activity */}
                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <h3 className="text-lg font-bold text-gray-700 mb-4">Recent Batches</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="bg-gray-50 text-xs uppercase text-gray-500">
                                    <tr>
                                        <th className="p-3 rounded-l-lg">Batch Name</th>
                                        <th className="p-3">Training Centre</th>
                                        <th className="p-3">Start Date</th>
                                        <th className="p-3">Status</th>
                                        <th className="p-3 rounded-r-lg text-right">Candidates</th>
                                    </tr>
                                </thead>
                                <tbody className="text-sm">
                                    {recentBatches.map(b => (
                                        <tr key={b.id} className="border-b last:border-0 hover:bg-gray-50">
                                            <td className="p-3 font-medium text-gray-800">{b.name}</td>
                                            <td className="p-3 text-gray-600">{b.trainingCentre || '-'}</td>
                                            <td className="p-3 text-gray-600">{b.startDate}</td>
                                            <td className="p-3"><span className="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-bold">Active</span></td>
                                            <td className="p-3 text-right font-bold text-indigo-600">{window.Utils.getStudentsByBatch(b.id).length}</td>
                                        </tr>
                                    ))}
                                    {recentBatches.length === 0 && <tr><td colSpan="5" className="p-4 text-center text-gray-400">No recent activity</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div >
            );
        };

        // ADMIN DASHBOARD
        const AdminDashboard = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [selectedQPForNOS, setSelectedQPForNOS] = useState(null);
            const [allQPapers, setAllQPapers] = useState([]); // Added allQPapers state

            useEffect(() => {
                const loadQPs = () => setAllQPapers(window.Utils.getQuestionPapers());
                loadQPs();
                window.addEventListener('cloud-sync-complete', loadQPs);

                return () => {
                    window.removeEventListener('cloud-sync-complete', loadQPs);
                };
            }, []);

            const handleNavigateToNOS = (qp) => {
                setSelectedQPForNOS(qp);
                setActiveTab('nos');
            };

            return (
                <div className="flex bg-gray-100 min-h-screen">
                    <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} />
                    <div className="flex-1 overflow-auto h-screen">
                        {/* Header */}
                        <header className="bg-white shadow-sm p-4 flex justify-between items-center sticky top-0 z-10">
                            <div className="flex items-center text-sm text-gray-500">
                                <span className="hover:text-gray-700 cursor-pointer">Home</span>
                                <Icons.ChevronRight />
                                <span className="font-medium text-gray-900 capitalize">{activeTab.replace(/([A-Z])/g, ' $1')}</span>
                            </div>
                            <div className="flex items-center gap-4">
                                {/* CLOUD SYNC CONTROLS */}
                                <div className="flex items-center gap-3 mr-2 border-r pr-4">
                                    <button
                                        onClick={() => {
                                            if (confirm("Force full backup of all local data to Cloud? This will overwrite cloud data with your current local state.")) {
                                                window.Utils.uploadToCloud(false, null, null, true);
                                            }
                                        }}
                                        className="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-100 transition-colors font-bold uppercase tracking-wider"
                                        title="Force Full Cloud Backup"
                                    >
                                        Force Backup
                                    </button>
                                    <span
                                        id="sync-status-text"
                                        className="text-xs text-indigo-400 cursor-help hover:text-indigo-600 transition-colors hidden md:inline-block italic font-medium"
                                        title="Click for Cloud Diagnostics"
                                        onClick={async () => {
                                            try {
                                                const res = await fetch(`${API_BASE}/diagnostics`, {
                                                    headers: { 'x-api-key': 'portel_secure_key_2025' }
                                                });
                                                if (res.ok) {
                                                    const data = await res.json();
                                                    alert(`?? CLOUD DIAGNOSTICS ??\n\n` +
                                                        `? Storage Type: ${data.storage_type.toUpperCase()}\n` +
                                                        `? S3 Enabled: ${data.s3_enabled ? '? YES' : '? NO'}\n` +
                                                        `? Bucket: ${data.bucket_name}\n` +
                                                        `? Region: ${data.region}\n` +
                                                        `? Server Time: ${new Date(data.time).toLocaleString()}\n\n` +
                                                        (data.s3_enabled ? "Data is safely stored in AWS S3." : "WARNING: Data is on temporary server disk!"));
                                                } else {
                                                    alert("Diagnostics Failed: Could not reach server.");
                                                }
                                            } catch (e) { alert("Error: " + e.message); }
                                        }}
                                    >
                                        Auto-Sync On
                                    </span>
                                </div>

                                <div className="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold">A</div>
                                <span className="text-sm font-medium">Administrator</span>
                            </div>
                        </header>

                        <div className="p-8">
                            {activeTab === 'dashboard' && <DashboardTab />}
                            {activeTab === 'calendar' && <CalendarTab />}
                            {activeTab === 'location' && <LocationTab />}

                            {activeTab === 'subjects' && <SubjectsTab />}
                            {activeTab === 'marks' && <MarksTab />}
                            {activeTab === 'qps' && <QPsTab onNavigateToNOS={handleNavigateToNOS} />}
                            {activeTab === 'nos' && <NOSPC_Tab selectedQP={selectedQPForNOS} onBack={() => { setSelectedQPForNOS(null); setActiveTab('qps'); }} />}
                            {activeTab === 'questionPapers' && <QuestionPapersTab />}
                            {activeTab === 'batches' && <BatchesTab />}
                            {activeTab === 'results' && <ResultsTab />}
                            {activeTab === 'assessors' && <AssessorsTab />}
                        </div>
                    </div>
                </div >
            );
        };




        // Code Runner Component
        const CodeRunner = ({ code, onChange }) => {
            const [language, setLanguage] = useState('python');
            const [output, setOutput] = useState('');
            const [isRunning, setIsRunning] = useState(false);

            const LANGUAGES = {
                python: { version: '3.10.0', name: 'Python 3' },
                javascript: { version: '18.15.0', name: 'Node.js' },
                c: { version: '10.2.0', name: 'C (GCC)' },
                cpp: { version: '10.2.0', name: 'C++ (GCC)' },
                java: { version: '15.0.2', name: 'Java ' }
            };

            const runCode = async () => {
                if (!code || !code.trim()) {
                    setOutput("Please type some code first.");
                    return;
                }
                setIsRunning(true);
                setOutput("Running...");

                try {
                    const response = await fetch('https://emkc.org/api/v2/piston/execute', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            language: language,
                            version: LANGUAGES[language].version,
                            files: [{ content: code }]
                        })
                    });
                    const data = await response.json();
                    if (data.run) {
                        setOutput(data.run.output || "No Output");
                    } else {
                        setOutput("Error: " + (data.message || "Unknown API Error"));
                    }
                } catch (e) {
                    setOutput("Network Error: Could not reach compiler API. Check internet connection.\n" + e.message);
                } finally {
                    setIsRunning(false);
                }
            };

            return (
                <div className="flex flex-col h-full border rounded-lg overflow-hidden bg-gray-900 text-white">
                    <div className="flex items-center justify-between p-2 bg-gray-800 border-b border-gray-700">
                        <div className="flex items-center gap-2">
                            <select value={language} onChange={e => setLanguage(e.target.value)}
                                className="bg-gray-700 text-white text-sm p-1 rounded border border-gray-600 focus:ring-1 focus:ring-indigo-500">
                                {Object.entries(LANGUAGES).map(([key, info]) => (
                                    <option key={key} value={key}>{info.name}</option>
                                ))}
                            </select>
                            <span className="text-xs text-gray-400">Powered by Piston</span>
                        </div>
                        <button onClick={runCode} disabled={isRunning}
                            className={`flex items-center gap-1 px-3 py-1 rounded text-sm font-bold transition-all ${isRunning ? 'bg-gray-600 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 text-white'}`}>
                            {isRunning ? <Icons.Loader className="w-4 h-4 animate-spin" /> : <Icons.Play className="w-4 h-4" />}
                            {isRunning ? 'Running...' : 'Run Code'}
                        </button>
                    </div>

                    <div className="grid grid-rows-2 h-[450px]">
                        {/* Editor Area */}
                        <textarea
                            value={code || ''}
                            onChange={e => onChange(e.target.value)}
                            spellCheck="false"
                            className="w-full h-full p-4 bg-gray-900 text-gray-100 font-mono text-sm resize-none focus:outline-none border-b border-gray-800"
                            placeholder={`Type your ${LANGUAGES[language].name} code here...`}
                        ></textarea>

                        {/* Output Area */}
                        <div className="bg-black p-4 overflow-auto font-mono text-sm">
                            <div className="text-gray-500 mb-2 border-b border-gray-800 pb-1 text-xs">CONSOLE OUTPUT</div>
                            <pre className={`${output.includes('Error') ? 'text-red-400' : 'text-green-400'} whitespace-pre-wrap`}>
                                {output || 'Result will appear here...'}
                            </pre>
                        </div>
                    </div>
                </div>
            );
        };

        // PRACTICAL QUESTION RUNNER
        const PracticalQuestionRunner = ({ question, answer, onAnswer }) => {
            const [isRecording, setIsRecording] = useState(false);
            const [mediaRecorder, setMediaRecorder] = useState(null);
            const [videoChunks, setVideoChunks] = useState([]);
            const [previewUrl, setPreviewUrl] = useState(answer?.video || null);
            const [photoUrl, setPhotoUrl] = useState(answer?.photo || null);
            const videoRef = useRef(null);
            const streamRef = useRef(null);

            // Cleanup stream on unmount
            useEffect(() => {
                // Initialize camera on mount if no preview
                if (!previewUrl) startCamera();
                return () => {
                    if (streamRef.current) {
                        streamRef.current.getTracks().forEach(track => track.stop());
                    }
                };
            }, []);

            const startCamera = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    streamRef.current = stream;
                    if (videoRef.current) videoRef.current.srcObject = stream;
                } catch (e) {
                    console.error("Camera Error", e);
                    // alert("Camera Error: " + e.message); // Suppress alert to avoid spam if permission denied
                }
            };

            const startRecording = async () => {
                if (!streamRef.current) await startCamera();
                if (!streamRef.current) return;

                const stream = streamRef.current;
                let options = { mimeType: 'video/webm;codecs=vp9' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/webm' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/mp4' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) options = {};
                const recorder = new MediaRecorder(stream, options);
                const chunks = [];
                recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
                recorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    setPreviewUrl(url);

                    // Save to IndexedDB
                    const key = `practical_q_${Date.now()}`;
                    try {
                        await VideoDB.saveVideo(key, blob);
                        onAnswer({ ...answer, videoKey: key, photo: answer?.photo });
                    } catch (e) {
                        console.error("Failed to save practical video", e);
                        alert("Video save failed. check storage.");
                    }
                };
                recorder.start();
                setMediaRecorder(recorder);
                setIsRecording(true);
            };

            const stopRecording = () => {
                if (mediaRecorder) mediaRecorder.stop();
                setIsRecording(false);
            };

            const capturePhoto = () => {
                if ((!streamRef.current && !videoRef.current) || (videoRef.current && videoRef.current.readyState < 2)) {
                    console.warn("CapturePhoto: Stream/Video not ready. ReadyState:", videoRef.current?.readyState);
                    startCamera();
                    return;
                }
                const canvas = document.createElement('canvas');
                canvas.width = 640; canvas.height = 480;
                canvas.getContext('2d').drawImage(videoRef.current, 0, 0, canvas.width, canvas.height);
                const data = canvas.toDataURL('image/jpeg', 0.7);
                setPhotoUrl(data);
                onAnswer({ ...answer, photo: data });
            };

            return (
                <div className="border rounded-xl p-4 bg-gray-50 h-[500px]">
                    <div className="flex gap-4 mb-4 h-full">
                        {/* Camera / Preview Area */}
                        <div className="flex-1 bg-black rounded-lg overflow-hidden relative group">
                            {previewUrl && !isRecording ? (
                                <div className="relative h-full">
                                    <video src={previewUrl} controls className="w-full h-full object-contain" />
                                    <button onClick={() => { setPreviewUrl(null); startCamera(); }} className="absolute top-2 right-2 bg-gray-800 text-white p-2 rounded-full opacity-70 hover:opacity-100 transition-opacity">
                                        <Icons.XCircle className="w-6 h-6" />
                                    </button>
                                </div>
                            ) : (
                                <video ref={videoRef} autoPlay muted playsInline className="w-full h-full object-cover" />
                            )}

                            {/* Recording Indicator */}
                            {isRecording && (
                                <div className="absolute top-4 right-4 flex items-center gap-2 bg-red-600 text-white px-3 py-1 rounded-full animate-pulse z-10">
                                    <div className="w-3 h-3 bg-white rounded-full"></div> REC
                                </div>
                            )}
                        </div>

                        {/* Controls & Instructions */}
                        <div className="w-64 flex flex-col gap-4">
                            <div className="bg-white p-4 rounded-lg shadow-sm border text-sm">
                                <h4 className="font-bold text-gray-700 mb-2">Instructions</h4>
                                <ul className="list-disc pl-4 space-y-1 text-gray-600">
                                    <li>Ensure good lighting.</li>
                                    <li>Keep your face/hands visible.</li>
                                    <li>Description: {question.question}</li>
                                </ul>
                            </div>

                            {!isRecording ? (
                                <button onClick={startRecording} className="bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 shadow-sm transition-all">
                                    <div className="w-4 h-4 bg-white rounded-full"></div> Start Rec
                                </button>
                            ) : (
                                <button onClick={stopRecording} className="bg-gray-800 hover:bg-gray-900 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 shadow-sm animate-pulse">
                                    <div className="w-4 h-4 bg-red-500 rounded-sm"></div> Stop Rec
                                </button>
                            )}

                            <button onClick={capturePhoto} className="bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 shadow-sm transition-all">
                                <Icons.Camera /> Capture Photo
                            </button>

                            {/* Photo Preview */}
                            {photoUrl && (
                                <div className="mt-auto border-2 border-dashed border-gray-300 rounded-lg p-2 relative bg-white">
                                    <img src={photoUrl} className="w-full h-32 object-cover rounded" />
                                    <button onClick={() => { setPhotoUrl(null); onAnswer({ ...answer, photo: null }); }} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow hover:bg-red-600">
                                        <Icons.XCircle className="w-4 h-4" />
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // STUDENT PORTAL
        const StudentPortal = ({ user }) => {


            useEffect(() => {
                if (!window.VideoDB) alert("CRITICAL: Video Storage System Missing!");
                else window.VideoDB.init().catch(e => alert("CRITICAL: Video Storage Init Failed: " + e.message));
            }, []);
            const [examMode, setExamMode] = useState(null); // 'Theory', 'Practical', 'VivaWait'
            const [questions, setQuestions] = useState([]);
            const [currentQ, setCurrentQ] = useState(0);
            const [answers, setAnswers] = useState({});

            // Poll for Assessor "Admit" signal (Replaced by Socket.io in VivaWait)
            // useEffect(() => { ... }, []);



            const [timeLeft, setTimeLeft] = useState(0);
            const [webcamActive, setWebcamActive] = useState(false);
            const [mediaStream, setMediaStream] = useState(null); // NEW: Track stream state
            const mediaRecorderRef = useRef(null);
            const videoRef = useRef(null);
            const [warnings, setWarnings] = useState(0);
            const [isLocked, setIsLocked] = useState(false);
            const [proctoringModel, setProctoringModel] = useState(null);
            const [proctoringLogs, setProctoringLogs] = useState([]);
            const [lastWarning, setLastWarning] = useState(null); // State for Visual Alert

            // v26: Student Verification State
            const [verificationStep, setVerificationStep] = useState(null); // null, 'SELFIE', 'ID_CARD'
            const [verificationEvidence, setVerificationEvidence] = useState([]);
            const [pendingExamMode, setPendingExamMode] = useState(null);
            const [verificationDetails, setVerificationDetails] = useState({ fatherName: '', aadharNumber: '' }); // v30.4: New Details State

            // State for Visual Alert
            const detectionInterval = useRef(null);
            const autoCaptureInterval = useRef(null);

            const recordingSessionRef = useRef(null);
            const segmentSequenceRef = useRef(0); // v19.0.19: Sequence Tracker
            const pendingChunkWrites = useRef(0); // v24: Track Active DB Writes
            const videoChunksRef = useRef([]);
            const recordingExamType = useRef(null); // Persist exam type for the recording session
            const [isRecording, setIsRecording] = useState(false); // UI Indicator
            const [isSubmitting, setIsSubmitting] = useState(false);
            const isSubmittingRef = useRef(false);
            useEffect(() => { isSubmittingRef.current = isSubmitting; }, [isSubmitting]);

            const [streamActive, setStreamActive] = useState(false);
            const compositeReqRef = useRef(null); // Reference for Canvas Animation Frame

            const startCameraManual = async () => {
                try {
                    console.log("Requesting Camera...");
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    const video = videoRef.current;
                    if (video) {
                        video.srcObject = stream;
                        video.play().catch(e => console.error("Play Error", e));
                        setStreamActive(true);
                        setWebcamActive(true);
                        setMediaStream(stream); // Fix: Prevent useEffect loop
                        console.log("Camera Started Successfully");
                    } else {
                        alert("Error: Video element not found. Please refresh.");
                    }
                } catch (err) {
                    console.error("Camera Error", err);
                    alert("Camera Failed: " + err.message + "\nPlease check permissions and try again.");
                }
            };




            /* useEffect(() => {
                if (examMode && !streamActive) {
                    setTimeout(startCameraManual, 1000);
                }
            }, [examMode]); */


            // WEBRTC STATE FOR VIVA LIVE
            const [remoteStream, setRemoteStream] = useState(null);
            const peerRef = useRef(null);
            const signalingRef = useRef(null);

            useEffect(() => {
                if (examMode !== 'VivaLive') return;

                const initViva = async () => {
                    console.log("Initializing Viva Connection...");

                    // 1. Signaling
                    const signaling = new VivaSignaling(user.batchId, user.id, 'student');
                    signalingRef.current = signaling;

                    try {
                        await signaling.joinRoom();
                    } catch (e) {
                        alert(e.message);
                        setExamMode('VivaWait');
                        return;
                    }

                    // 2. PeerConnection
                    const pc = new RTCPeerConnection({
                        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                    });
                    peerRef.current = pc;

                    // 3. Local Stream
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                        const video = document.getElementById('student-cam-viva');
                        if (video) video.srcObject = stream;
                        stream.getTracks().forEach(track => pc.addTrack(track, stream));
                    } catch (e) {
                        console.error("Viva Camera Error", e);
                    }

                    // 4. Remote Stream
                    pc.ontrack = (event) => {
                        console.log("Remote Stream Received");
                        setRemoteStream(event.streams[0]);
                        const remoteVid = document.getElementById('remote-assessor-video');
                        if (remoteVid) remoteVid.srcObject = event.streams[0];
                    };

                    // 5. ICE Candidates
                    pc.onicecandidate = (event) => {
                        if (event.candidate) signaling.sendIceCandidate(event.candidate);
                    };
                    signaling.onIceCandidate(candidate => {
                        pc.addIceCandidate(new RTCIceCandidate(candidate));
                    });

                    // 6. Listen for Offer
                    signaling.onRemoteDescription(async (offer) => {
                        console.log("Received Offer");
                        await pc.setRemoteDescription(new RTCSessionDescription(offer));
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        await signaling.sendAnswer(answer);
                    });
                };

                initViva();

                return () => {
                    if (peerRef.current) peerRef.current.close();
                    // Stop local tracks? Maybe keep them if we want fast reconnect
                };
            }, [examMode]);
            // Poll for Assessor "Admit" signal
            // (Socket logic handled separately)

            // Dynamic Update Listener (For Exam Start Times etc)
            const [forceUpdate, setForceUpdate] = useState(0);
            useEffect(() => {
                const refresh = () => setForceUpdate(n => n + 1);
                window.addEventListener('cloud-sync-complete', refresh);
                return () => window.removeEventListener('cloud-sync-complete', refresh);
            }, []);

            // Cleanup Polling (Deleted)


            // No need for syncing effect that clears on null

            // Load Model
            useEffect(() => {
                if (window.cocoSsd) {
                    window.cocoSsd.load().then(model => {
                        console.log("Proctoring Model Loaded");
                        setProctoringModel(model);
                    });
                }
            }, []);

            // Check Lock Status on Load
            useEffect(() => {
                const checkLock = () => {
                    const status = JSON.parse(localStorage.getItem('se_student_lock_' + user.id) || 'null');
                    if (status) {
                        setIsLocked(false); // MODIFIED: Never restore lock state
                        setWarnings(status.warnings);
                    }
                };
                checkLock();
                const interval = setInterval(checkLock, 2000); // Poll for unlock
                return () => clearInterval(interval);
            }, [user.id]);

            // Save Lock Status
            const updateLockStatus = (newWarnings, locked) => {
                setWarnings(newWarnings);
                if (locked) setIsLocked(true);
                localStorage.setItem('se_student_lock_' + user.id, JSON.stringify({ isLocked: locked, warnings: newWarnings }));
            };

            // Log Violation
            const logViolation = (msg) => {
                if (isLocked) return;
                const newWarnings = warnings + 1;
                const log = `${new Date().toLocaleTimeString()}: ${msg} (Strike ${newWarnings}/5)`;
                setProctoringLogs(prev => [log, ...prev]);

                // Show Visual Warning
                setLastWarning(`${msg} (Strike ${newWarnings}/5)`);
                setTimeout(() => setLastWarning(null), 4000); // Hide after 4s

                // SAVE VIOLATION AS EVIDENCE
                window.Utils.saveResponse({
                    studentId: user.id,
                    examType: examMode,
                    evidence: [{ img: null, time: new Date().toISOString(), type: 'VIOLATION_LOG', message: msg }]
                });

                // MODIFIED: Never Lock Exam, just count warnings
                updateLockStatus(newWarnings, false);
                if (newWarnings >= 5) {
                    alert(`Warning: You have reached ${newWarnings} violations! The proctor has been notified.`);
                }
            };

            // 60-Second Auto-Capture Loop (Photos)
            useEffect(() => {
                if (!examMode || isLocked) {
                    if (autoCaptureInterval.current) clearInterval(autoCaptureInterval.current);
                    return;
                }

                autoCaptureInterval.current = setInterval(() => {
                    const video = videoRef.current;
                    if (video && video.readyState >= 2) {
                        console.log("AutoCapture: Success");
                        const c = document.createElement('canvas'); c.width = 320; c.height = 240;
                        c.getContext('2d').drawImage(video, 0, 0, c.width, c.height);
                        const img = c.toDataURL('image/jpeg', 0.5);

                        window.Utils.saveResponse({
                            studentId: user.id,
                            examType: examMode,
                            evidence: [{ img, time: new Date().toISOString(), type: 'AUTO_CAPTURE_PHOTO' }]
                        });
                    }
                }, 60000); // v19.0.21: Every 60 Seconds (As requested)

                return () => clearInterval(autoCaptureInterval.current);
            }, [examMode, isLocked, user.id]);

            // SEGMENTED RECORDING LOGIC (StudentPortal)
            useEffect(() => {
                const shouldRecord = examMode && !isLocked && !isSubmitting && (webcamActive || examMode === 'VivaLive' || examMode === 'VivaWait');

                if (!shouldRecord) {
                    if (mediaRecorderRef.current && mediaRecorderRef.current.state === 'recording') {
                        mediaRecorderRef.current.stop();
                        setIsRecording(false);
                        if (window.studentRecordingInterval) clearInterval(window.studentRecordingInterval);
                        recordingSessionRef.current = null;
                    }
                    return;
                }

                // Initialize Session if needed
                if (!recordingSessionRef.current) {
                    recordingSessionRef.current = `session_${user.id}_${Date.now()}`;
                    segmentSequenceRef.current = 1;
                }

                // v23: CONTINUOUS RECORDING (One File, Many Chunks)
                const startSegment = () => {
                    const stream = mediaStream;
                    if (!stream) return;

                    // v19.0.19 Options
                    let options = { mimeType: 'video/webm;codecs=vp8', videoBitsPerSecond: 300000 };
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/mp4' };
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) options = {};

                    const recorder = new MediaRecorder(stream, options);

                    // v25: RAM-Buffered Single Recording (No Parts in DB)
                    recorder.ondataavailable = (e) => {
                        if (e.data.size > 0) {
                            videoChunksRef.current.push(e.data);
                        }
                    };

                    recorder.onstop = async () => {
                        console.log("Recorder Stopped. Saving Full Video...");
                        const fullBlob = new Blob(videoChunksRef.current, { type: options.mimeType || 'video/webm' });
                        const fullKey = `vid_full_${user.id}_${Date.now()}`;

                        if (fullBlob.size < 100000) { // < 100KB is likely a junk/cleanup fragment
                            console.log("Video too small (" + fullBlob.size + " bytes). Discarding.");
                            videoChunksRef.current = [];
                            return;
                        }

                        try {
                            // Save ONE Single File
                            await window.VideoDB.saveVideo(fullKey, fullBlob);

                            const fullEvidence = {
                                img: fullKey, key: fullKey, time: new Date().toISOString(),
                                type: 'VIDEO_FULL_MERGED', storage: 'indexeddb',
                                isFullVideo: true
                            };

                            await window.Utils.saveResponse({
                                studentId: user.id, examType: examMode, evidence: [fullEvidence]
                            });

                            // Trigger Upload
                            window.Utils.uploadToCloud(true, 'responses');
                            // Alert removed here - Success is handled by submitExam
                            // alert("Exam Video Saved Successfully!");

                        } catch (err) {
                            console.error("Final Save Error", err);
                            // Only alert on ACTUAL errors if it was a real video
                            // alert("Error saving final video: " + err.message);
                        }

                        // Clear RAM
                        videoChunksRef.current = [];
                    };

                    // Start ONCE with 5s slice
                    recorder.start(5000);
                    mediaRecorderRef.current = recorder;
                    setIsRecording(true);
                };

                // Entry Point
                if (!mediaRecorderRef.current || mediaRecorderRef.current.state === 'inactive') {
                    if (mediaStream) {
                        startSegment();
                        // No more setInterval loop!
                    }
                }

                return () => {
                    if (window.studentRecordingInterval) clearInterval(window.studentRecordingInterval);
                    if (mediaRecorderRef.current && mediaRecorderRef.current.state === 'recording') {
                        console.log("Stopping recorder on unmount...");
                        mediaRecorderRef.current.stop();
                    }
                };
            }, [examMode, isLocked, webcamActive, user.id, mediaStream, isSubmitting]); // Added isSubmitting dep
            // Ensure Camera Stream is Attached to Video Element
            useEffect(() => {
                if (webcamActive && examMode && examMode !== 'VivaLive') {
                    // Check if we already have a stream
                    if (mediaStream) {
                        const video = videoRef.current;
                        if (video && !video.srcObject) video.srcObject = mediaStream;
                        return;
                    }

                    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(rawStream => {
                        // v26: Add Timestamp Overlay for Theory Mode
                        const canvas = document.createElement('canvas');
                        canvas.width = 1280;
                        canvas.height = 720;
                        const ctx = canvas.getContext('2d');

                        // Hidden Source Video
                        const srcVid = document.createElement('video');
                        srcVid.srcObject = rawStream;
                        srcVid.muted = true;

                        const draw = () => {
                            if (srcVid.readyState === 4) {
                                ctx.drawImage(srcVid, 0, 0, canvas.width, canvas.height);

                                // Draw Timestamp
                                const now = new Date();
                                const timeStr = now.toLocaleString('en-US', {
                                    weekday: 'short', year: 'numeric', month: 'short', day: 'numeric',
                                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                                });

                                ctx.font = "bold 24px monospace";
                                ctx.fillStyle = "white";
                                ctx.strokeStyle = "black";
                                ctx.lineWidth = 3;
                                ctx.strokeText(timeStr, 20, 40);
                                ctx.fillText(timeStr, 20, 40);
                            }
                            compositeReqRef.current = requestAnimationFrame(draw);
                        };

                        srcVid.oncanplay = () => {
                            console.log("Theory Cam Ready. Starting Canvas Stream.");
                            srcVid.play();
                            draw();

                            // Create Canvas Stream
                            const finalStream = canvas.captureStream(30);
                            // Add Audio Tracks from Mic
                            rawStream.getAudioTracks().forEach(t => finalStream.addTrack(t));

                            const video = videoRef.current;
                            if (video) video.srcObject = finalStream;
                            setMediaStream(finalStream); // Trigger recorder only when data is flowing
                            setStreamActive(true); // AUTO-START UI: Hide 'Start Camera' button
                        };
                    }).catch(e => {
                        console.error("Camera Error", e);
                        alert("Camera/Audio Access Denied! Please allow access to proceed.");
                    });
                }
            }, [webcamActive, examMode, mediaStream]);

            // Security: Block Right Click, Copy, Paste
            useEffect(() => {
                if (!examMode || isLocked) return;

                const preventDefault = (e) => {
                    e.preventDefault();
                    // Optional: logViolation("Action Blocked"); // Can be too noisy
                };

                const blockCopyPaste = (e) => {
                    e.preventDefault();
                    // logViolation("Copy/Paste Attempted");
                    alert("Copy/Paste is disabled during the exam!");
                };

                document.addEventListener('contextmenu', preventDefault);
                document.addEventListener('copy', blockCopyPaste);
                document.addEventListener('cut', blockCopyPaste);
                document.addEventListener('paste', blockCopyPaste);
                document.addEventListener('selectstart', preventDefault); // Block Selection

                return () => {
                    document.removeEventListener('contextmenu', preventDefault);
                    document.removeEventListener('copy', blockCopyPaste);
                    document.removeEventListener('cut', blockCopyPaste);
                    document.removeEventListener('paste', blockCopyPaste);
                    document.removeEventListener('selectstart', preventDefault);
                };
            }, [examMode, isLocked]);

            useEffect(() => {
                if (examMode === 'VivaLive') {
                    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                        const v = document.getElementById('student-cam-viva');
                        if (v) v.srcObject = stream;
                    });
                }
            }, [examMode]);
            useEffect(() => {
                if (!examMode || isLocked) return;

                // DISABLE PROCTORING FOR VIVA (To allow 2-tab simulation)
                if (examMode === 'VivaWait' || examMode === 'VivaLive') return;

                const handleVisibility = () => {
                    if (document.hidden) {
                        logViolation("Tab Switch / Minimized Browser");
                    }
                };

                document.addEventListener('visibilitychange', handleVisibility);
                return () => document.removeEventListener('visibilitychange', handleVisibility);
            }, [examMode, isLocked, warnings]);

            // Object Detection Loop
            useEffect(() => {
                if (!examMode || !webcamActive || isLocked || !proctoringModel) {
                    if (detectionInterval.current) clearInterval(detectionInterval.current);
                    return;
                }

                let tick = 0;
                detectionInterval.current = setInterval(async () => {
                    tick++;
                    const video = videoRef.current;
                    if (video && video.readyState >= 2) {
                        const predictions = await proctoringModel.detect(video);

                        // Check for Mobile Phone
                        const hasPhone = predictions.some(p => p.class === 'cell phone' || p.class === 'remote'); // cell phone usually
                        if (hasPhone) {
                            logViolation("Mobile Device Detected");
                            // Capture Violation Evidence
                            const c = document.createElement('canvas'); c.width = 300; c.height = 200;
                            c.getContext('2d').drawImage(video, 0, 0, 300, 200);
                            window.Utils.saveResponse({
                                studentId: user.id, examType: examMode,
                                evidence: [{ img: c.toDataURL(), time: new Date().toISOString(), type: 'VIOLATION_PHONE' }]
                            });
                        }

                        // Check for Person Count
                        const personCount = predictions.filter(p => p.class === 'person').length;
                        if (personCount > 1) {
                            logViolation("Multiple Persons Detected");
                            // Capture Violation Evidence
                            const c = document.createElement('canvas'); c.width = 300; c.height = 200;
                            c.getContext('2d').drawImage(video, 0, 0, 300, 200);
                            window.Utils.saveResponse({
                                studentId: user.id, examType: examMode,
                                evidence: [{ img: c.toDataURL(), time: new Date().toISOString(), type: 'VIOLATION_MULTIPLE_PERSONS' }]
                            });
                        }

                        // PERIODIC SNAPSHOT REMOVED (Moved to independent loop)
                    }
                }, 3000); // Check every 3 seconds

                return () => clearInterval(detectionInterval.current);
            }, [examMode, webcamActive, isLocked, proctoringModel, warnings]);

            // INDEPENDENT PHOTO CAPTURE LOOP (Decoupled from AI Model)
            useEffect(() => {
                if (!examMode || isLocked || !webcamActive || examMode === 'VivaLive' || examMode === 'VivaWait') return;

                const capturePhoto = () => {
                    const video = videoRef.current;
                    if (video && video.readyState >= 2) {
                        const c = document.createElement('canvas'); c.width = 300; c.height = 200;
                        c.getContext('2d').drawImage(video, 0, 0, 300, 200);
                        console.log("Auto-Snapshot Taken (Independent Loop)");
                        window.Utils.saveResponse({
                            studentId: user.id, examType: examMode,
                            evidence: [{ img: c.toDataURL(), time: new Date().toISOString(), type: 'AUTO_SNAPSHOT' }]
                        });
                    }
                };

                // Capture immediately on start (optional)
                // capturePhoto();

                const interval = setInterval(capturePhoto, 60000); // v19.0.21: Every 60 Seconds
                return () => clearInterval(interval);
            }, [examMode, webcamActive, isLocked]);

            useEffect(() => {
                let interval;
                if (examMode && timeLeft > 0 && !isSubmitting) interval = setInterval(() => setTimeLeft(t => t - 1), 1000);
                return () => clearInterval(interval);
            }, [examMode, timeLeft, isSubmitting]);

            const startExam = async (mode) => {
                // v26: Intercept for Verification
                if (mode !== 'VERIFIED_START') {
                    console.log("[Verification] Intercepting Exam Start:", mode);
                    setPendingExamMode(mode);
                    setVerificationStep('SELFIE'); // v30.4: Reordered: Photo First
                    return;
                }
                console.log("[Verification] Starting Verified Exam");

                const startMode = pendingExamMode || mode; // Fallback

                let batch = window.Utils.getBatches().find(b => String(b.id || '').trim() === String(user.batchId || '').trim());

                // AUTO-HEAL: If batch not found locally, try one-time sync before erroring
                if (!batch && user.batchId) {
                    console.log(`[Auto-Heal] Batch ${user.batchId} missing locally. Syncing...`);
                    const statusText = document.getElementById('sync-status-text');
                    if (statusText) statusText.innerText = "Checking Cloud for Batch...";

                    try {
                        // Force a non-destructive download
                        const ok = await window.Utils.downloadFromCloud(true);
                        batch = window.Utils.getBatches().find(b => String(b.id || '').trim() === String(user.batchId || '').trim());
                        if (statusText) statusText.innerText = batch ? "Batch Found!" : "Sync Complete";
                    } catch (e) {
                        console.error("Auto-heal batch sync failed", e);
                    }
                }

                // v19.0.10: Enhanced Diagnostic Logger
                console.log("[Diagnostic] Current Batch Lookup:", {
                    assignedId: user.batchId,
                    assignedIdTrimmed: String(user.batchId || '').trim(),
                    foundLocally: !!batch,
                    localBatchCount: window.Utils.getBatches().length,
                    localIds: window.Utils.getBatches().map(b => b.id)
                });

                if (!batch) {
                    const errorMsg = `Exam Error: Your assigned Batch (ID: ${user.batchId || 'NONE'}) was not found locally even after sync.\n\n` +
                        `1. Ensure you have an internet connection.\n` +
                        `2. Ask Admin to ensure the Batch is "Synced" to Cloud.\n` +
                        `3. Click OK to try Syncing one more time.`;

                    if (confirm(errorMsg)) {
                        await window.Utils.downloadFromCloud(false); // Manual sync if they confirm
                    }
                    return;
                }

                // Helper to parse potential DD-MM-YYYY, DD/MM/YYYY or YYYY-MM-DD
                const parseDateTime = (dateStr, timeStr) => {
                    if (!dateStr || !timeStr) return null;
                    // Remove ISO T part if accidentally included
                    const pureDate = dateStr.split('T')[0];

                    // Try direct parse (works for YYYY-MM-DD)
                    let d = new Date(`${pureDate}T${timeStr}`);

                    if (isNaN(d.getTime())) {
                        // Handle DD-MM-YYYY or DD/MM/YYYY
                        const sep = pureDate.includes('-') ? '-' : (pureDate.includes('/') ? '/' : null);
                        if (sep) {
                            const parts = pureDate.split(sep);
                            if (parts.length === 3) {
                                // If first part is 4 digits, assume YYYY-MM-DD (already tried but for safety)
                                if (parts[0].length === 4) d = new Date(`${parts[0]}-${parts[1]}-${parts[2]}T${timeStr}`);
                                else d = new Date(`${parts[2]}-${parts[1]}-${parts[0]}T${timeStr}`);
                            }
                        }
                    }
                    return d;
                };

                const checkExpiry = (b) => {
                    if (!b.startDate || !b.startTime || !b.endDate || !b.endTime) return 'OK';
                    const now = new Date();
                    const start = parseDateTime(b.startDate, b.startTime);
                    const end = parseDateTime(b.endDate, b.endTime);
                    if (!start || !end) return 'ERROR';
                    if (now < start) return { status: 'FUTURE', time: start };
                    if (now > end) return { status: 'EXPIRED', time: end };
                    return 'OK';
                };

                let status = checkExpiry(batch);

                // AUTO-HEAL: If expired, try syncing once in case it's stale data
                if (status && status.status === 'EXPIRED') {
                    const btn = document.getElementById('sync-status-text');
                    if (btn) btn.innerText = "Verifying Date...";

                    try {
                        await window.Utils.downloadFromCloud(true);
                        // Re-fetch batch
                        batch = window.Utils.getBatches().find(b => b.id === user.batchId);
                        status = checkExpiry(batch);

                        console.log(`Auto-Sync Completed.\nNew End Date: ${batch.endDate} ${batch.endTime}\nStatus: ${status === 'OK' ? 'Active' : status.status}`);

                    } catch (e) {
                        console.error("Auto-heal sync failed", e);
                        // alert(`Auto-Sync Failed: ${e.message}\nPlease check internet connection.`);
                    }
                }

                if (status === 'ERROR') {
                    alert("Date Error: Invalid Date Format in Batch settings.");
                    return;
                }
                if (status && status.status === 'FUTURE') {
                    alert(`Exam has not started yet.\nStart Time: ${status.time.toLocaleString()}`);
                    return;
                }
                if (status && status.status === 'EXPIRED') {
                    alert(`Exam has expired.\nEnd Time: ${status.time.toLocaleString()}`);
                    return;
                }

                const pid = startMode === 'Theory' ? batch.theoryPaperId : batch.practicalPaperId;
                console.log(`Starting ${startMode}: Batch=${batch.name}, AssignedID=${pid}, AvailableQPs=${window.Utils.getQuestionPapers().length}`);

                let qp = window.Utils.getQuestionPapers().find(q => String(q.id) === String(pid));

                // AUTO-HEAL 2: QP Missing? Try Syncing.
                if (!qp) {
                    console.warn(`[Auto-Heal] QP ${pid} not found locally. Keys:`, window.Utils.getQuestionPapers().map(q => q.id));
                    const btn = document.getElementById('sync-status-text');
                    if (btn) btn.innerText = "Fetching Exam Paper...";
                    try {
                        const syncResult = await window.Utils.downloadFromCloud(true);
                        console.log(`[Auto-Heal] Sync Result: ${syncResult}`);
                        qp = window.Utils.getQuestionPapers().find(q => String(q.id) === String(pid));
                        console.log(`[Auto-Heal] Post-Sync Search for ${pid}:`, qp ? "FOUND" : "NOT FOUND");
                    } catch (e) {
                        console.error("Auto-heal QP sync failed", e);
                    }
                }

                if (qp) {
                    setQuestions(qp.questions);
                    setTimeLeft(qp.totalTime * 60);
                    setExamMode(startMode);

                    if (startMode === 'Practical') {
                        // COMPOSITE RECORDING: Screen + Webcam
                        try {
                            const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: "always" }, audio: true });
                            const camStream = await navigator.mediaDevices.getUserMedia({ video: { width: 320, height: 240, facingMode: "user" }, audio: true });

                            // Hidden Video Elements for Source
                            const screenVid = document.createElement('video');
                            screenVid.srcObject = screenStream;
                            screenVid.muted = true;
                            screenVid.play();

                            const camVid = document.createElement('video');
                            camVid.srcObject = camStream;
                            camVid.muted = true;
                            camVid.play();

                            // Canvas for Compositing
                            const canvas = document.createElement('canvas');
                            canvas.width = 1280; // Standard HD
                            canvas.height = 720;
                            const ctx = canvas.getContext('2d');

                            // Animation Loop
                            const drawComposite = () => {
                                if (!screenVid.paused && !screenVid.ended) {
                                    // 1. Draw Screen (Background)
                                    ctx.drawImage(screenVid, 0, 0, canvas.width, canvas.height);

                                    // 2. Draw Webcam (Bottom Right Overlay)
                                    if (!camVid.paused && !camVid.ended) {
                                        const camW = 240; // 20% width approx
                                        const camH = 180;
                                        const margin = 20;
                                        ctx.strokeStyle = "red";
                                        ctx.lineWidth = 2;
                                        ctx.drawImage(camVid, canvas.width - camW - margin, canvas.height - camH - margin, camW, camH);
                                        ctx.strokeRect(canvas.width - camW - margin, canvas.height - camH - margin, camW, camH);
                                    }

                                    // 3. Draw Date/Time Timestamp
                                    const now = new Date();
                                    const timeStr = now.toLocaleString('en-US', {
                                        weekday: 'short', year: 'numeric', month: 'short', day: 'numeric',
                                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                                    });

                                    ctx.font = "bold 24px monospace";
                                    ctx.fillStyle = "white";
                                    ctx.strokeStyle = "black";
                                    ctx.lineWidth = 3;
                                    ctx.strokeText(timeStr, 20, 40);
                                    ctx.fillText(timeStr, 20, 40);
                                }
                                compositeReqRef.current = requestAnimationFrame(drawComposite);
                            };

                            // Wait for video load
                            screenVid.onloadedmetadata = () => {
                                drawComposite();
                            };

                            // Merge Audio Tracks (Sys Audio + Mic)
                            const audioTracks = [...screenStream.getAudioTracks(), ...camStream.getAudioTracks()];
                            const compositeStream = canvas.captureStream(30); // 30 FPS
                            if (audioTracks.length > 0) {
                                audioTracks.forEach(t => compositeStream.addTrack(t));
                            }

                            setMediaStream(compositeStream);
                            setWebcamActive(true);
                            setStreamActive(true);

                            // Handle Stop (Stop both source streams)
                            compositeStream.getVideoTracks()[0].onended = () => {
                                screenStream.getTracks().forEach(t => t.stop());
                                camStream.getTracks().forEach(t => t.stop());
                                if (compositeReqRef.current) cancelAnimationFrame(compositeReqRef.current);
                            };

                        } catch (err) {
                            console.error("Composite Setup Failed", err);
                            alert("Error: You MUST allow BOTH Screen Share and Camera permissions for Practical Exams.\nPlease reload and try again.");
                            setExamMode(null);
                        }
                    } else {
                        setWebcamActive(true);
                        // stream useEffect will handle getUserMedia for Theory (Webcam)
                    }
                } else {
                    alert(`Exam Error: The Question Paper (ID: ${pid}) assigned to this batch was not found.\nPlease contact Admin to Assign QP and Sync.`);
                }
            };



            const endExam = () => {
                // STOP MEDIA
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                }
                if (compositeReqRef.current) {
                    cancelAnimationFrame(compositeReqRef.current);
                    compositeReqRef.current = null;
                }
                // RESET STATE
                setMediaStream(null);
                setWebcamActive(false);
                setStreamActive(false);
                setExamMode(null);
                setIsSubmitting(false);
            };

            const submitExam = async () => {
                if (isSubmitting) return;
                setIsSubmitting(true);

                // Capture final image (Safe Mode)
                let finalPhoto = null;
                try {
                    const v = videoRef.current;
                    if (v && v.readyState === 4) { // HAVE_ENOUGH_DATA
                        const c = document.createElement('canvas'); c.width = 300; c.height = 200;
                        c.getContext('2d').drawImage(v, 0, 0, 300, 200);
                        finalPhoto = { img: c.toDataURL(), time: new Date().toISOString(), type: 'SUBMISSION' };
                    }
                } catch (e) {
                    console.error("Final Capture Failed", e);
                }

                // STOP RECORDING EXPLICITLY & WAIT
                if (mediaRecorderRef.current && mediaRecorderRef.current.state === 'recording') {
                    // DEBUG v22: Visible Alerts for Tracing
                    alert("DEBUG 1/4: Stopping Recorder... Please wait.");
                    console.log("Stopping Recorder for Submission...");

                    // CRITICAL FIX: Preserve original onstop to ensure last segment is saved
                    const originalOnStop = mediaRecorderRef.current.onstop;
                    const stopPromise = new Promise(resolve => {
                        mediaRecorderRef.current.onstop = async (e) => {
                            console.log("Final Segment Saving...");
                            if (originalOnStop) await originalOnStop(e);
                            resolve();
                        };
                    });

                    mediaRecorderRef.current.stop();
                    setIsRecording(false);
                    await stopPromise;

                    // v25: No more waiting for chunk writes, as we write at onstop
                    // Safety Buffer
                    await new Promise(r => setTimeout(r, 1000));
                }

                // v25: REMOVED MERGE LOGIC (Video is already saved in onstop)
                /*
                try {
                   // ... merge logic removed ...
                }
                */


                // v25: MERGE LOGIC REMOVED (Video saved at onstop)
                /*
                // NEW: Full Video Merge (Stitch segments for User Convenience)
                try {
                    console.log("Generating Full Video from Segments...");
                    alert("DEBUG 2/4: Starting Merge Check...");
    
                    const currentResp = window.Utils.getResponses().find(r => r.studentId === user.id && r.examType === examMode);
                    if (currentResp && currentResp.evidence) {
                        // Filter and Sort Segments by Time (v23: Support Chunks)
                        const segments = currentResp.evidence
                            .filter(e => (e.isSegment || e.type === 'VIDEO_INDEXED_DB' || e.type === 'VIDEO_CHUNK') && e.key)
                            .sort((a, b) => new Date(a.time) - new Date(b.time));
    
                        // alert(`DEBUG 3/4: Found ${segments.length} segments.`);
                        console.log(`[v23 Debug] Found ${segments.length} chunks/segments to merge.`);
    
                        if (segments.length > 0) {
                            const blobPromises = segments.map(s => window.VideoDB.getVideo(s.key));
                            const blobs = await Promise.all(blobPromises);
                            const validBlobs = blobs.filter(b => b);
    
                            if (validBlobs.length > 0) {
                                const fullBlob = new Blob(validBlobs, { type: 'video/webm' });
                                const fullKey = `vid_full_${user.id}_${Date.now()}`;
                                await window.VideoDB.saveVideo(fullKey, fullBlob);
    
                                // Add Full Video to Evidence
                                const fullEvidence = {
                                    img: fullKey, key: fullKey, time: new Date().toISOString(),
                                    type: 'VIDEO_FULL_MERGED', storage: 'indexeddb',
                                    isFullVideo: true
                                };
                                currentResp.evidence.push(fullEvidence);
                                await window.Utils.saveResponse(currentResp);
    
                                // DEBUG ALERTS (v23)
                                console.log(`Full Video Generated: ${fullKey}`);
                                alert(`DEBUG 4/4: Merge Success! Size: ${(fullBlob.size / 1024 / 1024).toFixed(2)} MB`);
    
                                // AUTO-CLEANUP (v23): Delete Chunks & Segments
                                // The user wants ONLY the full video. We must delete the loose parts.
                                console.log(`[Cleanup] Deleting ${segments.length} segments to keep only Full Video.`);
    
                                // 1. Remove from Evidence Array (Metadata) to hide from UI immediately
                                currentResp.evidence = currentResp.evidence.filter(e => !e.isSegment);
                                currentResp.evidence.push(fullEvidence); // Ensure full video is there
                                await window.Utils.saveResponse(currentResp);
    
                                // 2. Background Delete (Storage & Cloud)
                                segments.forEach(async (seg) => {
                                    // Delete Local Blob
                                    try {
                                        if (seg.key) await window.VideoDB.deleteVideo(seg.key);
                                    } catch (e) {
                                        console.warn("Local delete failed for " + seg.key, e);
                                    }
    
                                    // Delete Cloud Object (if uploaded)
                                    if (seg.url && seg.url.includes('amazonaws.com')) {
                                        try {
                                            const urlObj = new URL(seg.url);
                                            let s3Key = urlObj.pathname.startsWith('/') ? urlObj.pathname.substring(1) : urlObj.pathname;
                                            s3Key = decodeURIComponent(s3Key);
                                            fetch(`${API_BASE}/media?key=${encodeURIComponent(s3Key)}&apiKey=portel_secure_key_2025`, { method: 'DELETE' });
                                        } catch (e) {
                                            console.warn("Cloud delete failed for " + seg.key, e);
                                        }
                                    }
                                });
                            }
                        }
                    }
                } catch (mergeErr) {
                    console.error("Full Video Merge Failed", mergeErr);
                    alert("DEBUG ERROR: Merge crashed! " + mergeErr.message);
                }
                */
                if (window.studentRecordingInterval) clearInterval(window.studentRecordingInterval);

                // RE-FETCH EVIDENCE (Includes the just-saved video)
                // We need to re-fetch because saveResponse updates LocalStorage
                const updatedRespForUpload = window.Utils.getResponses().find(r => r.studentId === user.id && r.examType === examMode);
                const finalEvidence = updatedRespForUpload?.evidence || []; // Use updated evidence list

                // Add Final Photo
                if (finalPhoto) finalEvidence.push(finalPhoto);

                // Calculate Auto-Grades (Initial System Grading)
                const autoGrades = {};
                questions.forEach((q, idx) => {
                    if (q.questionType !== 'CODING' && q.questionType !== 'PRACTICAL' && q.questionType !== 'VIVA') {
                        // Exact String Match (Case-Insensitive Trimmed)
                        const studentAns = String(answers[idx] || '').trim().toLowerCase();
                        const correctAns = String(q.correctAnswer || '').trim().toLowerCase();
                        if (studentAns && studentAns === correctAns) {
                            autoGrades[idx] = q.totalMarks;
                        } else {
                            autoGrades[idx] = 0;
                        }
                    } else {
                        // For Coding/Practical, leave as 0 or undefined for Manual Grading
                        autoGrades[idx] = 0;
                    }
                });

                const respObj = {
                    studentId: user.id,
                    examType: examMode,
                    answers,
                    assessorMarks: autoGrades, // Pre-fill with system grades
                    evidence: finalEvidence
                };

                // AUTO-UPLOAD: Attempt to sync immediately (Scoped to Current Student)
                try {
                    const statusBtn = document.getElementById('sync-status-text');
                    if (statusBtn) statusBtn.innerText = "Uploading Answer...";

                    await window.Utils.saveResponse(respObj);

                    // Wait for local video save (give it a moment to finish async IndexedDB writes)
                    await new Promise(r => setTimeout(r, 1000));

                    // Trigger Visible Sync (Only Responses & Only This Student)
                    // Robust Check: String convert and Force Full Sync (Visible Errors) to ensure evidence is safely in cloud
                    // Pass 'false' for silent to enable alerts if something goes wrong
                    const filterByStudent = (item) => String(item.studentId || '').trim() === String(user.id || '').trim();
                    await window.Utils.uploadToCloud(false, 'responses', filterByStudent);

                    // SUMMARY POPUP (User Request)
                    const totalPhotos = finalEvidence.filter(e => e.type && (e.type.includes('PHOTO') || e.type.includes('MANUAL'))).length;

                    // Improved Video Calculation: Count segments * 30s + any remaining manual clips
                    // Since we use 30s fixed segments now, count filtering by 'VIDEO' or 'SEGMENT'
                    const videoSegments = finalEvidence.filter(e => e.type && (e.type.includes('VIDEO') || e.isSegment)).length;
                    const totalVideoSec = videoSegments * 30;

                    alert(`Exam Submitted Successfully!\n\nSummary:\n- Video Uploaded: ~${totalVideoSec} Seconds\n- Photos Uploaded: ${totalPhotos}`);

                    endExam();

                } catch (e) {
                    console.error("Submit Sync Failed", e);
                    alert("Submitted to LOCAL STORAGE. Cloud Sync Failed (" + e.message + "). The system will retry automatically when online.");
                    endExam();
                }
            };


            if (examMode) {
                if (isLocked) return (
                    <div className="flex h-screen fixed inset-0 z-50 bg-red-50 flex-col items-center justify-center text-center p-8 box-border">
                        <Icons.Lock className="w-24 h-24 text-red-600 mb-6" />
                        <h1 className="text-4xl font-bold text-red-700 mb-4">Exam Locked</h1>
                        <p className="text-xl text-gray-700 mb-8">You have exceeded the maximum number of warnings (5/5).<br />Please contact your Assessor to unlock your exam.</p>
                        <div className="bg-white p-6 rounded shadow max-w-md w-full text-left">
                            <h3 className="font-bold mb-2">Violation Log:</h3>
                            <ul className="text-sm text-red-600 list-disc pl-5 max-h-48 overflow-y-auto">
                                {proctoringLogs.map((l, i) => <li key={i}>{l}</li>)}
                            </ul>
                        </div>
                    </div>
                );

                if (examMode === 'VivaWait') return (
                    <div className="flex h-screen fixed inset-0 z-50 bg-gray-900 flex-col items-center justify-center text-center p-8 box-border text-white animate-fade-in">
                        <div className="w-32 h-32 bg-gray-800 rounded-full flex items-center justify-center mb-8 border-4 border-indigo-500 shadow-[0_0_20px_rgba(99,102,241,0.5)] animate-pulse">
                            <Icons.Video className="w-16 h-16 text-indigo-400" />
                        </div>
                        <h1 className="text-4xl font-bold mb-4 tracking-tight">Waiting for Host</h1>
                        <p className="text-xl text-gray-400 mb-8 max-w-md">Please wait here. The assessor will admit you to the Viva session shortly.</p>
                        <div className="bg-gray-800 p-2 rounded text-xs px-4 mb-4 font-mono text-gray-500">
                            Room: {`${user.batchId}_${user.id}`}
                        </div>
                        <div className="flex gap-2 justify-center mb-12">
                            <div className="w-3 h-3 bg-white rounded-full animate-bounce delay-0"></div>
                            <div className="w-3 h-3 bg-white rounded-full animate-bounce delay-100"></div>
                            <div className="w-3 h-3 bg-white rounded-full animate-bounce delay-200"></div>
                        </div>
                        <div className="flex gap-4">
                            <button onClick={() => setExamMode('VivaLive')} className="px-6 py-2 bg-indigo-600 rounded-lg text-white hover:bg-indigo-700 transition-colors text-sm font-bold">
                                Join Now (Force)
                            </button>
                            <button onClick={endExam} className="px-6 py-2 border border-gray-600 rounded-lg text-gray-400 hover:text-white hover:border-gray-400 transition-colors text-sm">
                                Leave Waiting Room
                            </button>
                        </div>
                    </div>
                );

                if (examMode === 'VivaLive') return (
                    <div className="flex h-screen fixed inset-0 z-50 bg-black flex-col animate-fade-in">
                        <div className="flex-1 relative">
                            {/* Assessor Feed (Center) */}
                            {
                                remoteStream ? (
                                    <video
                                        id="remote-assessor-video"
                                        ref={ref => { if (ref && remoteStream) ref.srcObject = remoteStream }}
                                        autoPlay
                                        className="absolute inset-0 w-full h-full object-contain bg-black"
                                    />
                                ) : (
                                    <div className="absolute inset-0 flex items-center justify-center">
                                        <div className="text-center text-gray-500">
                                            <div className="w-24 h-24 mx-auto mb-4 rounded-full bg-gray-800 flex items-center justify-center animate-pulse">
                                                <Icons.Video className="w-12 h-12 text-gray-600" />
                                            </div>
                                            <h2 className="text-2xl font-bold text-gray-400">Connecting to Assessor...</h2>
                                            <p className="text-sm">Please wait for the video stream.</p>
                                        </div>
                                    </div>
                                )
                            }

                            {/* Student Self-View (Bottom Right) */}
                            <div className="absolute bottom-6 right-6 w-48 h-36 bg-gray-900 rounded-lg border-2 border-gray-700 shadow-xl overflow-hidden">
                                <video id="student-cam-viva" autoPlay muted className="w-full h-full object-cover transform scale-x-[-1]" />
                            </div>

                            {/* Controls */}
                            <div className="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex gap-6 bg-gray-900/80 backdrop-blur-md px-8 py-3 rounded-full border border-gray-700">
                                <div className="p-3 rounded-full bg-gray-700 text-white"><Icons.Microphone className="w-6 h-6" /></div>
                                <div className="p-3 rounded-full bg-gray-700 text-white"><Icons.Video className="w-6 h-6" /></div>
                                <button onClick={endExam} className="p-3 rounded-full bg-red-600 text-white hover:bg-red-700"><Icons.PhoneMissed className="w-6 h-6" /></button>
                            </div>
                        </div >
                    </div >
                );

                return (
                    <div className="flex h-screen fixed inset-0 z-50 bg-white">
                        <div className="w-3/4 p-8 overflow-y-auto">
                            <div className="flex justify-between mb-4">
                                <h2 className="font-bold text-xl">Exam: {examMode}</h2>
                                <div className="flex items-center gap-4">
                                    <div className={`px-4 py-1 rounded font-bold ${warnings > 2 ? 'bg-red-100 text-red-700' : (warnings > 0 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700')}`}>
                                        Warnings: {warnings}/5
                                    </div>
                                    <div className="font-mono text-xl">{Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}</div>
                                </div>
                            </div>
                            {lastWarning && (
                                <div className="bg-red-600 text-white p-4 rounded shadow-lg mb-6 text-center font-bold text-lg animate-pulse flex items-center justify-center">
                                    <Icons.TriangleAlert className="inline w-8 h-8 mr-3" />
                                    <span>WARNING: {lastWarning}</span>
                                </div>
                            )}
                            {questions[currentQ] && (
                                <div>
                                    <h3 className="text-lg font-medium mb-4">Q{currentQ + 1}: {questions[currentQ].question}</h3>
                                    {questions[currentQ].questionType === 'CODING' ? (
                                        <div className="h-[500px] mb-4">
                                            <CodeRunner
                                                code={answers[currentQ] || ''}
                                                onChange={val => setAnswers({ ...answers, [currentQ]: val })}
                                            />
                                        </div>
                                    ) : (questions[currentQ].questionType === 'PRACTICAL' || questions[currentQ].questionType === 'VIVA') ? (
                                        <PracticalQuestionRunner
                                            question={questions[currentQ]}
                                            answer={answers[currentQ] || {}}
                                            onAnswer={val => setAnswers({ ...answers, [currentQ]: val })}
                                        />
                                    ) : (
                                        <div className="space-y-2">
                                            {questions[currentQ].options.map(o => (
                                                <button key={o} onClick={() => setAnswers({ ...answers, [currentQ]: o })}
                                                    className={`w-full text-left p-3 border rounded ${answers[currentQ] === o ? 'bg-indigo-100 border-indigo-500' : ''}`}>{o}</button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                            <div className="mt-6 flex justify-between">
                                <button disabled={currentQ === 0} onClick={() => setCurrentQ(c => c - 1)} className="px-4 py-2 border rounded">Prev</button>
                                {currentQ < questions.length - 1 ?
                                    <button onClick={() => setCurrentQ(c => c + 1)} className="px-4 py-2 bg-indigo-600 text-white rounded">Next</button> :
                                    <button onClick={submitExam} disabled={isSubmitting} className={`px-4 py-2 text-white rounded flex items-center gap-2 ${isSubmitting ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'}`}>
                                        {isSubmitting && <Icons.Loader className="w-4 h-4 animate-spin" />}
                                        {isSubmitting ? 'Submitting...' : 'Submit Exam'}
                                    </button>
                                }
                            </div>
                        </div>
                        <div className="w-1/4 bg-gray-100 p-4 border-l">
                            <div className="relative">
                                <div className="relative bg-black rounded mb-2 h-48 flex items-center justify-center overflow-hidden">
                                    <video ref={videoRef} id="student-cam" autoPlay muted playsInline className={`w-full h-full object-cover transform ${examMode === 'Practical' ? '' : 'scale-x-[-1]'} ${streamActive ? 'block' : 'hidden'}`}></video>
                                    {!streamActive && (
                                        <div className="absolute inset-0 flex flex-col items-center justify-center z-20">
                                            <p className="text-white text-xs mb-2">Camera Off</p>
                                            <button onClick={startCameraManual} className="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-full font-bold shadow text-sm">
                                                Start Camera
                                            </button>
                                        </div>
                                    )}
                                    {isRecording && (
                                        <div className="absolute top-2 right-2 flex items-center gap-1 bg-red-600/90 text-white text-[10px] px-2 py-1 rounded-full animate-pulse shadow-lg z-10">
                                            <div className="w-2 h-2 bg-white rounded-full"></div> REC
                                        </div>
                                    )}
                                </div>
                                <div className="grid grid-cols-4 gap-2">
                                    {questions.map((_, i) => <div key={i} onClick={() => setCurrentQ(i)} className={`h-8 flex items-center justify-center cursor-pointer rounded ${answers[i] ? 'bg-green-200' : 'bg-white'}`}>{i + 1}</div>)}
                                </div>
                            </div>
                        </div>
                    </div>

                );
            }

            return (
                <div className="p-8">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold">Student Portal</h2>
                        <button onClick={async () => {
                            const batches = window.Utils.getBatches();
                            const statusText = document.getElementById('sync-status-text');
                            if (statusText) statusText.innerText = "Running Deep Diag...";

                            let cloudBatches = [];
                            let cloudStudent = null;
                            let apiOk = false;
                            try {
                                const [bRes, sRes] = await Promise.all([
                                    fetch(`${API_BASE}/batches`, { headers: { 'x-api-key': 'portel_secure_key_2025' } }),
                                    fetch(`${API_BASE}/students`, { headers: { 'x-api-key': 'portel_secure_key_2025' } })
                                ]);
                                if (bRes.ok) cloudBatches = await bRes.json();
                                if (sRes.ok) {
                                    const allS = await sRes.json();
                                    cloudStudent = allS.find(s => s.id === user.id);
                                }
                                apiOk = true;
                            } catch (e) { console.error("Cloud fetch failed", e); }

                            const targetId = String(user.batchId || '').trim();
                            const foundInCloud = cloudBatches.some(b => String(b.id || '').trim() === targetId);

                            const diag = {
                                "My User ID": user.id,
                                "Record Found in Cloud?": cloudStudent ? "YES ✅" : "NO ❌",
                                "Target Batch ID": targetId,
                                "Found in Cloud Batches?": foundInCloud ? "YES ✅" : "NO ❌",
                                "API Connectivity": apiOk ? "Connected ✅" : "Failed ❌",
                                "--- CLOUD INVENTORY ---": "---",
                                "Cloud Batch IDs": cloudBatches.map(b => b.id).join(", "),
                                "Cloud Student's BatchID": cloudStudent ? cloudStudent.batchId : "N/A",
                                "Browser Online": navigator.onLine,
                                "App Version": "v30.0.0"
                            };
                            console.table(diag);
                            const msg = "--- STUDENT DIAGNOSTICS (v30.0.0) ---\n\n" +
                                Object.entries(diag).map(([k, v]) => `${k}: ${JSON.stringify(v)}`).join("\n") +
                                "\n\nActions:\n1. If Target Batch Found is NO -> Admin must Save it.\n2. If Cloud Student ID is different -> Mismatch!";
                            if (confirm(msg)) {
                                if (statusText) statusText.innerText = "Force Syncing...";
                                await window.Utils.downloadFromCloud(false);
                                location.reload();
                            }
                        }} className="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                            <Icons.TriangleAlert className="w-4 h-4 text-orange-500" /> Troubleshoot
                        </button>
                    </div>
                    <div className="grid gap-6 md:grid-cols-2">
                        <div onClick={() => startExam('Theory')} className="bg-white p-8 rounded shadow cursor-pointer hover:shadow-lg border-l-4 border-indigo-600">
                            <h3 className="text-xl font-bold text-indigo-900">Theory Exam</h3>
                            <p className="text-gray-500">Multiple choice questions</p>
                            <button className="mt-4 bg-indigo-600 text-white px-4 py-2 rounded">Start</button>
                        </div>
                        <div onClick={() => startExam('Practical')} className="bg-white p-8 rounded shadow cursor-pointer hover:shadow-lg border-l-4 border-purple-600">
                            <h3 className="text-xl font-bold text-purple-900">Practical Exam</h3>
                            <p className="text-gray-500">Coding challenges</p>
                            <button className="mt-4 bg-purple-600 text-white px-4 py-2 rounded">Start</button>
                        </div>

                        <div onClick={() => setExamMode('VivaWait')} className="bg-white p-8 rounded shadow cursor-pointer hover:shadow-lg border-l-4 border-green-500">
                            <h3 className="text-xl font-bold text-green-700">Live Viva</h3>
                            <p className="text-gray-500">Join the live video assessment</p>
                            <button className="mt-4 bg-green-600 text-white px-4 py-2 rounded flex items-center gap-2"><Icons.Video className="w-4 h-4" /> Join Session</button>
                        </div>
                    </div>

                    {/* v26: Verification Modal */}
                    {


                        verificationStep && (
                            <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
                                <div className="bg-white rounded-xl overflow-hidden max-w-2xl w-full flex flex-col max-h-[90vh]">
                                    <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                                        <h3 className="font-bold text-lg">
                                            {verificationStep === 'SELFIE' ? "Step 1: Student Photo" :
                                                verificationStep === 'ID_CARD' ? "Step 2: ID Verification" :
                                                    verificationStep === 'DETAILS' ? "Step 3: Candidate Details" :
                                                        "Step 4: Exam Instructions"}
                                        </h3>
                                        <button onClick={() => { setVerificationStep(null); setPendingExamMode(null); }} className="text-gray-500 hover:text-red-500">
                                            <Icons.XCircle className="w-6 h-6" />
                                        </button>
                                    </div>

                                    {/* CAMERA STEPS */}
                                    {(verificationStep === 'SELFIE' || verificationStep === 'ID_CARD') && (
                                        <div className="flex-1 bg-black relative aspect-video">
                                            <VideoPreview
                                                onCapture={(img) => {
                                                    const type = verificationStep === 'SELFIE' ? 'VERIFICATION_SELFIE' : 'VERIFICATION_ID';
                                                    const newEvidence = [...verificationEvidence, {
                                                        img, type, time: new Date().toISOString(),
                                                        studentId: user.id, batchId: user.batchId
                                                    }];
                                                    setVerificationEvidence(newEvidence);

                                                    if (verificationStep === 'SELFIE') {
                                                        setVerificationStep('ID_CARD');
                                                    } else {
                                                        setVerificationStep('DETAILS');
                                                    }
                                                }}
                                                instructions={verificationStep === 'SELFIE' ?
                                                    "Align your face clearly in the frame." :
                                                    "Hold your Aadhar/ID Card next to your face."}
                                            />
                                        </div>
                                    )}

                                    {/* DETAILS STEP */}
                                    {verificationStep === 'DETAILS' && (
                                        <div className="p-8 space-y-6 overflow-y-auto">
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-2">Father's Name</label>
                                                <input
                                                    type="text"
                                                    className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                                                    value={verificationDetails.fatherName}
                                                    onChange={e => setVerificationDetails({ ...verificationDetails, fatherName: e.target.value })}
                                                    placeholder="Enter Father's Name"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-2">Aadhar Number</label>
                                                <input
                                                    type="text"
                                                    className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                                                    value={verificationDetails.aadharNumber}
                                                    onChange={e => setVerificationDetails({ ...verificationDetails, aadharNumber: e.target.value })}
                                                    placeholder="Enter 12-digit Aadhar Number"
                                                    maxLength={12}
                                                />
                                            </div>
                                            <button
                                                onClick={() => {
                                                    if (!verificationDetails.fatherName.trim() || !verificationDetails.aadharNumber.trim()) {
                                                        alert("Please fill all required fields."); return;
                                                    }
                                                    if (verificationDetails.aadharNumber.length < 12) {
                                                        alert("Please enter a valid 12-digit Aadhar Number."); return;
                                                    }
                                                    setVerificationStep('INSTRUCTIONS');
                                                }}
                                                className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold shadow-lg transition-transform hover:scale-105"
                                            >
                                                Next: Instructions &rarr;
                                            </button>
                                        </div>
                                    )}

                                    {/* INSTRUCTIONS STEP */}
                                    {verificationStep === 'INSTRUCTIONS' && (
                                        <div className="p-8 space-y-6 overflow-y-auto bg-gray-50 flex-1">
                                            <div className="text-center mb-6">
                                                <div className="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                                    <Icons.FileText className="w-8 h-8 text-indigo-600" />
                                                </div>
                                                <h3 className="text-2xl font-bold text-gray-800">Exam Instructions</h3>
                                                <p className="text-gray-500">Please read carefully before starting.</p>
                                            </div>

                                            <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm space-y-3 text-sm text-gray-700">
                                                <p className="flex gap-3"><Icons.CheckCircle className="w-5 h-5 text-green-500 flex-shrink-0" /> Ensure you are in a quiet, well-lit room.</p>
                                                <p className="flex gap-3"><Icons.CheckCircle className="w-5 h-5 text-green-500 flex-shrink-0" /> Continuous face visibility is required.</p>
                                                <p className="flex gap-3"><Icons.AlertTriangle className="w-5 h-5 text-orange-500 flex-shrink-0" /> Do not switch tabs or minimize the browser.</p>
                                                <p className="flex gap-3"><Icons.AlertTriangle className="w-5 h-5 text-orange-500 flex-shrink-0" /> Copy/Paste and Right-Click are disabled.</p>
                                                <p className="flex gap-3"><Icons.Shield className="w-5 h-5 text-red-500 flex-shrink-0" /> Multiple people or mobile phones detected will be flagged.</p>
                                            </div>

                                            <button
                                                onClick={() => {
                                                    // FINISHED - Save Metadata & Evidence
                                                    window.Utils.saveResponse({
                                                        studentId: user.id, examType: 'VERIFICATION',
                                                        evidence: verificationEvidence,
                                                        answers: verificationDetails // v30.4: Save Father/Aadhar
                                                    }).then(() => {
                                                        console.log("Verification Saved with Details");
                                                    });

                                                    setVerificationStep(null);
                                                    startExam('VERIFIED_START');
                                                }}
                                                className="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-lg shadow-xl transition-all hover:scale-105 flex items-center justify-center gap-2"
                                            >
                                                Start Exam <Icons.ArrowRight className="w-5 h-5" />
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )
                    }

                </div>
            );
        };

        // ASSESSOR PORTAL
        const AssessorPortal = ({ user }) => {
            const [view, setView] = useState('dashboard'); // dashboard, batches, students, exam_type, capture
            const [flowMode, setFlowMode] = useState('MANUAL'); // 'MANUAL' or 'VIVA'

            // Workflow State
            const [selectedBatch, setSelectedBatch] = useState(null);
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [selectedExamType, setSelectedExamType] = useState(null);

            // Data
            const [batches, setBatches] = useState([]);
            const [batchStudents, setBatchStudents] = useState([]);
            const [allQPapers, setAllQPapers] = useState([]);
            const [showVivaLobby, setShowVivaLobby] = useState(false);

            useEffect(() => {
                // Initialize Data
                setBatches(window.Utils.getBatches());
                setAllQPapers(window.Utils.getQuestionPapers());
            }, []);

            // Effect to load students when batch changes
            useEffect(() => {
                if (selectedBatch) {
                    setBatchStudents(window.Utils.getStudentsByBatch(selectedBatch.id));
                }
            }, [selectedBatch]);

            if (showVivaLobby) return <VivaLobby batch={selectedBatch || user} onClose={() => setShowVivaLobby(false)} />;

            // VIEW 1: DASHBOARD
            if (view === 'dashboard') {
                return (
                    <div className="p-8">
                        <h2 className="text-2xl font-bold mb-6">Assessor Dashboard</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <button onClick={() => { setFlowMode('MANUAL'); setView('batches'); }} className="h-48 bg-white rounded shadow hover:shadow-xl transition-all border-l-8 border-indigo-600 flex flex-col items-center justify-center gap-4 group">
                                <div className="bg-indigo-100 p-4 rounded-full group-hover:bg-indigo-200 transition-colors">
                                    <Icons.FileText className="w-12 h-12 text-indigo-700" />
                                </div>
                                <div className="text-center">
                                    <h3 className="text-xl font-bold text-gray-800">Capture Evidence</h3>
                                    <p className="text-gray-500">Capture photos & videos</p>
                                </div>
                            </button>

                            <button onClick={() => { setFlowMode('VIVA'); setView('batches'); }} className="h-48 bg-white rounded shadow hover:shadow-xl transition-all border-l-8 border-green-600 flex flex-col items-center justify-center gap-4 group">
                                <div className="bg-green-100 p-4 rounded-full group-hover:bg-green-200 transition-colors">
                                    <Icons.Video className="w-12 h-12 text-green-700" />
                                </div>
                                <div className="text-center">
                                    <h3 className="text-xl font-bold text-gray-800">Live Viva Lobby</h3>
                                    <p className="text-gray-500">Join virtual assessment room</p>
                                </div>
                            </button>
                        </div>



                    </div>
                );
            };


            // VIEW 2: SELECT BATCH (Common for both flows)
            if (view === 'batches') {
                return (
                    <div className="p-8">
                        <button onClick={() => setView('dashboard')} className="mb-6 text-gray-500 hover:text-gray-800 flex items-center gap-1 font-bold text-lg">&larr; Back to Dashboard</button>
                        <h2 className="text-2xl font-bold mb-6">Select Batch for {flowMode === 'MANUAL' ? 'Capture Evidence' : 'Viva'}</h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            {batches.map(batch => (
                                <div key={batch.id} onClick={() => {
                                    setSelectedBatch(batch);
                                    if (flowMode === 'MANUAL') setView('exam_type'); // Manual: Batch -> Exam Type
                                    else { setShowVivaLobby(true); } // Viva: Batch -> Lobby (Zoom)
                                }}
                                    className="bg-white p-6 rounded shadow cursor-pointer hover:border-indigo-500 border-2 border-transparent transition-all">
                                    <h3 className="font-bold text-lg mb-1">{String(batch.name)}</h3>
                                    <p className="text-xs text-gray-500 mb-4">ID: {String(batch.batchId || batch.id)}</p>
                                    <div className="flex items-center gap-2 text-sm text-gray-600">
                                        <span>{window.Utils.getStudentsByBatch(batch.id).length} Students</span>
                                    </div>
                                </div>
                            ))}
                            {batches.length === 0 && <p className="text-gray-500">No batches found.</p>}
                        </div>
                    </div>
                );
            }

            // VIEW 3: SELECT STUDENT (Moved before Exam Type as requested)
            if (view === 'students') {
                return (
                    <div className="p-8">
                        <button onClick={() => setView('exam_type')} className="mb-6 text-gray-500 hover:text-gray-800 flex items-center gap-1 font-bold text-lg">&larr; Back to Exam Type</button>
                        <h2 className="text-2xl font-bold mb-2">Select Student for {selectedExamType}</h2>
                        <div className="flex gap-2 mb-6 text-sm">
                            <span className="bg-gray-200 px-2 py-1 rounded text-gray-700">{selectedBatch.name}</span>
                            <span className="bg-indigo-100 text-indigo-700 px-2 py-1 rounded font-bold">{selectedExamType}</span>
                        </div>

                        <div className="bg-white rounded shadow text-sm">
                            <div className="p-4 border-b font-bold bg-gray-50 flex justify-between">
                                <span>Student Name</span>
                                <span>Action</span>
                            </div>
                            {batchStudents.map(s => (
                                <div key={s.id} onClick={() => { setSelectedStudent(s); setView('capture'); }}
                                    className="p-4 border-b hover:bg-indigo-50 cursor-pointer flex justify-between items-center group transition-colors">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center font-bold group-hover:bg-indigo-200 group-hover:text-indigo-700 transition-colors">
                                            {s.name.charAt(0)}
                                        </div>
                                        <div>
                                            <p className="font-medium">{s.name}</p>
                                            <p className="text-xs text-gray-400">{s.username}</p>
                                        </div>
                                    </div>
                                    <span className="text-indigo-600 font-bold opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">
                                        <Icons.ChevronRight className="w-4 h-4" /> Select
                                    </span>
                                </div>
                            ))}
                            {batchStudents.length === 0 && <p className="p-8 text-center text-gray-500">No students found in this batch.</p>}
                        </div>
                    </div>
                );
            }

            // VIEW 4: SELECT EXAM TYPE (Moved after Student as requested)
            if (view === 'exam_type') {
                return (
                    <div className="p-8">
                        <button onClick={() => setView('batches')} className="mb-6 text-gray-500 hover:text-gray-800 flex items-center gap-1 font-bold text-lg">&larr; Back to Batches</button>
                        <h2 className="text-2xl font-bold mb-2">Select Assessment Type</h2>
                        <div className="flex gap-2 mb-6 text-sm">
                            <span className="bg-gray-200 px-2 py-1 rounded text-gray-700">{selectedBatch.name}</span>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            {['Theory', 'Practical', 'Viva'].map(type => (
                                <button key={type} onClick={() => { setSelectedExamType(type); setView('students'); }}
                                    className="bg-white p-8 rounded shadow hover:shadow-lg transition-all text-left group border-t-4 border-indigo-500">
                                    <h3 className="text-xl font-bold group-hover:text-indigo-600 transition-colors mb-2">{type}</h3>
                                    <p className="text-sm text-gray-500">Capture evidence for {type}.</p>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            // VIEW 5: CAPTURE INTERFACE (StudentGradingView)
            if (view === 'capture') {
                return (
                    <div className="p-8">
                        <StudentGradingView
                            student={selectedStudent}
                            batch={selectedBatch}
                            examType={selectedExamType}
                            allQPapers={allQPapers}
                            onBack={() => setView('students')}
                            captureOnly={true} // Hide grading controls
                        />
                    </div>
                );
            }

            return <div>Unknown View</div>;
        };


        // SYNC STATUS HUD COMPONENT (v17.15)
        const SyncStatusHUD = () => {
            React.useEffect(() => {
                const el = document.getElementById('sync-status-text');
                if (!el) return;

                // Watch for text changes
                const observer = new MutationObserver(() => {
                    const text = el.innerText;
                    if (text && text.trim().length > 0) {
                        el.classList.remove('translate-y-24', 'opacity-0');
                        // Auto-hide after success
                        if (text.includes('Synced') || text.includes('Complete')) {
                            setTimeout(() => {
                                el.classList.add('translate-y-24', 'opacity-0');
                                // Optional: clear text after animation
                                setTimeout(() => el.innerText = '', 500);
                            }, 3000);
                        }
                    } else {
                        el.classList.add('translate-y-24', 'opacity-0');
                    }
                });

                observer.observe(el, { characterData: true, childList: true, subtree: true });
                return () => observer.disconnect();
            }, []);

            return (
                <div id="sync-status-text"
                    className="fixed bottom-6 right-6 bg-slate-900 text-white px-6 py-4 rounded-xl shadow-2xl z-[9999] font-bold transition-all duration-500 transform translate-y-24 opacity-0 flex items-center gap-3 border border-slate-700">
                </div>
            );
        };

        // MAIN APP
        const App = () => {
            const [user, setUser] = React.useState(null);

            React.useEffect(() => {
                try {
                    const saved = localStorage.getItem('se_user');
                    if (saved) setUser(JSON.parse(saved));
                } catch (e) { console.error(e); }
            }, []);

            React.useEffect(() => {
                if (!user) return;

                // Initial Sync on Load (Safe v17.12)
                console.log("[Auto-Sync] Re-syncing on Load...");
                window.Utils.downloadFromCloud(true);

                // GLOBAL AUTO-SYNC: Throttled to 60s to prevent race conditions
                const intervalId = setInterval(() => {
                    if (navigator.onLine && user) {
                        console.log("[Auto-Sync] Triggering global sync...");
                        window.Utils.uploadToCloud(true);
                        setTimeout(() => window.Utils.downloadFromCloud(true), 2000); // Wait 2s for upload to settle
                    }
                }, 15000);

                return () => clearInterval(intervalId);
            }, [user]);

            const handleLogin = (u) => {
                localStorage.setItem('se_user', JSON.stringify(u));
                setUser(u);
            };

            const handleLogout = () => {
                localStorage.removeItem('se_user');
                setUser(null);
            };

            return (
                <React.Fragment>
                    {!user ? (
                        <LoginScreen onLogin={handleLogin} />
                    ) : (
                        <React.Fragment>
                            {user.role === 'admin' && <AdminDashboard />}
                            {user.role === 'student' && <StudentPortal user={user} />}
                            {user.role === 'assessor' && <AssessorPortal user={user} />}

                            {/* Global Logout for Safety */}
                            <button
                                onClick={handleLogout}
                                className="fixed bottom-4 left-4 z-[100] bg-red-600 text-white px-4 py-2 rounded-full shadow-lg text-xs font-bold opacity-50 hover:opacity-100 transition-opacity"
                                title="Logout"
                            >
                                <Icons.Lock className="w-4 h-4 inline mr-1" /> Logout
                            </button>

                            <SyncStatusHUD />
                        </React.Fragment>
                    )}
                </React.Fragment>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>

</html>