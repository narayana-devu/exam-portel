<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSXpertise - Assessment Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }

        .glass {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script>
        // DATA LAYER
        const DB_KEYS = {
            SSC: 'se_ssc', QP: 'se_qp', NOS: 'se_nos', PC: 'se_pc',
            BATCHES: 'se_batches', STUDENTS: 'se_students',
            QUESTION_PAPERS: 'se_question_papers',
            RESPONSES: 'se_responses', MANUAL_CAPTURES: 'se_manual_captures'
        };

        // CONFIGURATION
        // For Production (Vercel), replace this with your deployed backend URL
        const SERVER_URL = 'https://portel-backend.onrender.com';
        const API_KEY = 'portel_secure_key_2025'; // Must match server

        // Global Socket Initialization for Real-Time Sync
        const socket = io(SERVER_URL);


        // IndexedDB for Large Video Storage
        window.VideoDB = {
            dbName: 'ProctoringDB',
            storeName: 'videos',
            init: async () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(VideoDB.dbName, 1);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(VideoDB.storeName)) {
                            db.createObjectStore(VideoDB.storeName);
                        }
                    };
                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },
            saveVideo: async (key, blob) => {
                const db = await VideoDB.init();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(VideoDB.storeName, 'readwrite');
                    tx.oncomplete = () => resolve();
                    tx.onerror = (e) => reject(e.target.error);
                    tx.objectStore(VideoDB.storeName).put(blob, key);
                });
            },
            getVideo: async (key) => {
                const db = await VideoDB.init();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(VideoDB.storeName, 'readonly');
                    const store = tx.objectStore(VideoDB.storeName);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            }
        };

        window.Utils = {
            generateId: () => 'id_' + Math.random().toString(36).substr(2, 9) + Date.now(),

            // HELPER: Delete from Cloud
            deleteFromCloud: async (route, id) => {
                if (!id) return;
                try {
                    await fetch(`${SERVER_URL}/api/${route}/${id}`, {
                        method: 'DELETE',
                        headers: { 'x-api-key': API_KEY }
                    }).catch(e => console.error(`Failed to delete ${route}/${id}`, e));
                } catch (e) { console.error("Delete setup failed", e); }
            },

            // NEW: Atomic Save to Cloud


            // CLOUD SYNC FUNCTIONS
            uploadToCloud: async (silent = false) => {
                const MAPPING = {
                    'batches': DB_KEYS.BATCHES, 'students': DB_KEYS.STUDENTS,
                    'qps': DB_KEYS.QP, 'nos': DB_KEYS.NOS, 'pcs': DB_KEYS.PC,
                    'ssc': DB_KEYS.SSC, 'responses': DB_KEYS.RESPONSES,
                    'question_papers': DB_KEYS.QUESTION_PAPERS
                };
                let success = 0;
                const statusBtn = document.getElementById('sync-status-text');
                if (statusBtn) statusBtn.innerText = "Uploading...";

                const errors = [];
                for (const [route, key] of Object.entries(MAPPING)) {
                    try {
                        const dataStr = localStorage.getItem(key);
                        if (dataStr && dataStr !== '[]') {
                            let items = JSON.parse(dataStr);
                            let modified = false;

                            if (Array.isArray(items)) {
                                items = items.map(item => {
                                    if (!item.id) {
                                        item.id = window.Utils.generateId ? window.Utils.generateId() : (Date.now().toString(36) + Math.random().toString(36).substr(2));
                                        modified = true;
                                    }
                                    return item;
                                });

                                // FIX: Save generated IDs IMMEDIATELY before upload to prevent race conditions
                                if (modified) {
                                    localStorage.setItem(key, JSON.stringify(items));
                                    console.log(`Auto-assigned IDs for ${key} (Pre-Upload)`);
                                }

                                // REHYDRATION: Check for offloaded images in IndexedDB
                                if (route === 'responses' || route === 'manual_captures') {
                                    for (let i = 0; i < items.length; i++) {
                                        const item = items[i];
                                        if (item.evidence && Array.isArray(item.evidence)) {
                                            for (let j = 0; j < item.evidence.length; j++) {
                                                const ev = item.evidence[j];
                                                if (ev.storage === 'indexeddb' && ev.img) {
                                                    try {
                                                        const blob = await VideoDB.getVideo(ev.img);
                                                        if (blob) {
                                                            const base64 = await new Promise((resolve) => {
                                                                const reader = new FileReader();
                                                                reader.onloadend = () => resolve(reader.result);
                                                                reader.readAsDataURL(blob);
                                                            });
                                                            // Replace key with full data for upload
                                                            items[i].evidence[j] = { ...ev, img: base64 };
                                                            /* Note: We do NOT delete from IndexedDB here until we confirm upload success.
                                                               Actually, we keep it in IndexedDB for local viewing too. */
                                                        }
                                                    } catch (err) {
                                                        console.error("Failed to rehydrate image", err);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                // Perform upload
                                const res = await fetch(`${SERVER_URL}/api/sync/${route}`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'x-api-key': API_KEY
                                    },
                                    body: JSON.stringify(items)
                                });

                                // (Double check local storage didn't change? No, we trust the merge logic else where)
                                // If successful, we are good.

                                if (!res.ok) {
                                    const errText = await res.text();
                                    throw new Error(`${res.status} ${res.statusText}: ${errText}`);
                                }
                                success++;
                            }
                        }
                    } catch (e) {
                        console.error(`Upload error ${route}`, e);
                        if (!silent) errors.push(`${route}: ${e.message}`);
                    }
                }

                if (!silent) {
                    if (errors.length > 0) {
                        alert(`Upload Finished with Errors:\n${errors.join('\n')}\n\nSuccess: ${success} categories.`);
                    } else {
                        alert(`Successfully Uploaded ${success} categories to Cloud!`);
                    }
                } else {
                    console.log(`Auto-Sync Complete: ${success} categories uploaded.`);
                }
                if (statusBtn) statusBtn.innerText = "Synced";
            },

            downloadFromCloud: async (silent = false) => {
                const MAPPING = {
                    'batches': DB_KEYS.BATCHES, 'students': DB_KEYS.STUDENTS,
                    'qps': DB_KEYS.QP, 'nos': DB_KEYS.NOS, 'pcs': DB_KEYS.PC,
                    'ssc': DB_KEYS.SSC, 'responses': DB_KEYS.RESPONSES,
                    'question_papers': DB_KEYS.QUESTION_PAPERS
                };
                let success = 0;
                const statusBtn = document.getElementById('sync-status-text');
                if (statusBtn) statusBtn.innerText = "Downloading...";

                for (const [route, key] of Object.entries(MAPPING)) {
                    try {
                        if (!navigator.onLine) continue;
                        const res = await fetch(`${SERVER_URL}/api/${route}`, {
                            headers: { 'x-api-key': API_KEY }
                        });

                        if (res.ok) {
                            const data = await res.json();

                            // HYDRATION CHECK: If Server is Empty but Local has Data -> Restore Server
                            const localData = JSON.parse(localStorage.getItem(key) || '[]');
                            if (Array.isArray(data) && data.length === 0 && localData.length > 0) {
                                console.warn(`[Hydration] Server missing data for ${key}. Restoring from Local...`);
                                // We don't overwrite local with empty server data
                                // Instead, we trigger an upload in background
                                setTimeout(() => window.Utils.uploadToCloud(true), 1000);
                                continue;
                            }

                            if (Array.isArray(data)) {
                                if (key === DB_KEYS.RESPONSES) {
                                    // SPECIAL MERGE FOR RESPONSES to prevent data loss on single-device testing

                                    // PRE-PROCESS: Offload incoming images to IndexedDB
                                    // This prevents QuotaExceededError when pulling large history
                                    for (let i = 0; i < data.length; i++) {
                                        const item = data[i];
                                        if (item.evidence && Array.isArray(item.evidence)) {
                                            for (let j = 0; j < item.evidence.length; j++) {
                                                const ev = item.evidence[j];
                                                if (ev.img && ev.img.startsWith('data:image')) {
                                                    try {
                                                        const blob = window.Utils.base64ToBlob(ev.img);
                                                        const key = `ev_dl_${item.id}_${j}_${Date.now()}`;
                                                        await VideoDB.saveVideo(key, blob);
                                                        data[i].evidence[j] = { ...ev, img: key, storage: 'indexeddb' };
                                                    } catch (e) {
                                                        console.error("Failed to offload downloaded image", e);
                                                    }
                                                }
                                            }
                                        }
                                    }

                                    const local = JSON.parse(localStorage.getItem(key) || '[]');
                                    // Create Map by ID
                                    const map = new Map();
                                    // 1. Start with Server Data (Source of Truth for Download)
                                    data.forEach(item => map.set(item.id, item));

                                    // 2. Smart Merge with Local Data (Preserve Unsynced Work)
                                    local.forEach(localItem => {
                                        const serverItem = map.get(localItem.id);
                                        if (!serverItem) {
                                            // Item exists only locally (Unsynced work) -> Keep it
                                            map.set(localItem.id, localItem);
                                        } else {
                                            // Conflict: Both have data. Choose the "More Complete" one.
                                            const sEv = serverItem.evidence?.length || 0;
                                            const lEv = localItem.evidence?.length || 0;
                                            const sAns = Object.keys(serverItem.answers || {}).length;
                                            const lAns = Object.keys(localItem.answers || {}).length;

                                            // Scoring: Evidence (100 pts) > Answers (1 pt)
                                            // If Local has MORE data, keep Local. Otherwise, accept Server update.
                                            const sScore = (sEv * 100) + sAns;
                                            const lScore = (lEv * 100) + lAns;

                                            if (lScore > sScore) {
                                                map.set(localItem.id, localItem);
                                            }
                                        }
                                    });

                                    // Convert back
                                    const merged = Array.from(map.values());
                                    localStorage.setItem(key, JSON.stringify(merged));

                                    // If Local had items not in Server, validation-upload might be needed.
                                    // We can trigger background sync if counts differ significantly?
                                    // For now, safe merge is enough.
                                    success++;
                                } else {
                                    localStorage.setItem(key, JSON.stringify(data));
                                    success++;
                                }
                            }
                        }
                    } catch (e) {
                        console.error(`Download error ${route}`, e);
                    }
                }

                // TRIGGER UI UPDATES
                window.dispatchEvent(new Event('cloud-sync-complete'));

                if (!silent) alert(`Downloaded ${success} categories from Cloud.`);
                console.log(`Cloud Sync (Download): ${success} categories updated.`);
                if (statusBtn) statusBtn.innerText = "Synced";
            },

            getSSC: () => JSON.parse(localStorage.getItem(DB_KEYS.SSC) || '[]'),
            saveSSC: (ssc) => {
                const list = window.Utils.getSSC();
                // Assign ID if missing (Critical for Sync)
                if (!ssc.id) ssc.id = Date.now().toString(36) + Math.random().toString(36).substr(2);

                list.push(ssc);
                localStorage.setItem(DB_KEYS.SSC, JSON.stringify(list));

                // Atomic Sync
                window.Utils.saveToCloud('ssc', ssc);
            },
            deleteSSC: (id) => {
                window.Utils.deleteFromCloud('ssc', id);
                // 1. Get SSC List and remove target
                let list = window.Utils.getSSC().filter(s => s.id !== id);
                localStorage.setItem(DB_KEYS.SSC, JSON.stringify(list));

                // 2. Cascading Delete: Find all QPs for this SSC
                const allQPs = window.Utils.getQPs();
                const sscQPs = allQPs.filter(q => q.sscId === id);
                const sscQPIds = sscQPs.map(q => q.id);

                if (sscQPIds.length > 0) {
                    sscQPIds.forEach(qpId => window.Utils.deleteFromCloud('qps', qpId));
                    // Remove QPs
                    const remainingQPs = allQPs.filter(q => q.sscId !== id);
                    localStorage.setItem(DB_KEYS.QP, JSON.stringify(remainingQPs));

                    // 3. Find NOS for these QPs
                    const allNOS = window.Utils.getNOS();
                    const qpNOS = allNOS.filter(n => sscQPIds.includes(n.qpId));
                    const qpNOSIds = qpNOS.map(n => n.id);

                    if (qpNOSIds.length > 0) {
                        qpNOSIds.forEach(nId => window.Utils.deleteFromCloud('nos', nId));
                        // Remove NOS
                        const remainingNOS = allNOS.filter(n => !sscQPIds.includes(n.qpId));
                        localStorage.setItem(DB_KEYS.NOS, JSON.stringify(remainingNOS));

                        // 4. Remove PCs for these NOS
                        const allPCs = window.Utils.getPCs();
                        // Fix for filter:
                        const pcsToDelete = allPCs.filter(p => qpNOSIds.includes(p.nosId));
                        pcsToDelete.forEach(p => window.Utils.deleteFromCloud('pcs', p.id));

                        const remainingPCs = allPCs.filter(p => !qpNOSIds.includes(p.nosId));
                        localStorage.setItem(DB_KEYS.PC, JSON.stringify(remainingPCs));
                    }

                    // 5. Remove Batches logic
                    // Remove Question Papers linked to this SSC
                    const allPapers = window.Utils.getQuestionPapers();
                    const sscPapers = allPapers.filter(p => p.sscId === id);
                    if (sscPapers.length > 0) {
                        sscPapers.forEach(p => window.Utils.deleteFromCloud('question_papers', p.id));

                        const sscPaperIds = sscPapers.map(p => p.id);
                        const remainingPapers = allPapers.filter(p => p.sscId !== id);
                        localStorage.setItem(DB_KEYS.QUESTION_PAPERS, JSON.stringify(remainingPapers));

                        // Remove Batches linked to these Papers
                        const allBatches = window.Utils.getBatches();
                        const batchesToDelete = allBatches.filter(b => sscPaperIds.includes(b.theoryPaperId) || sscPaperIds.includes(b.practicalPaperId));

                        if (batchesToDelete.length > 0) {
                            batchesToDelete.forEach(b => window.Utils.deleteFromCloud('batches', b.id));

                            const batchIdsToDelete = batchesToDelete.map(b => b.id);
                            const remainingBatches = allBatches.filter(b => !batchIdsToDelete.includes(b.id));
                            localStorage.setItem(DB_KEYS.BATCHES, JSON.stringify(remainingBatches));

                            // Remove Students in these Batches
                            const allStudents = window.Utils.getStudents();
                            const studentsToDelete = allStudents.filter(s => batchIdsToDelete.includes(s.batchId));
                            studentsToDelete.forEach(s => window.Utils.deleteFromCloud('students', s.id));

                            const remainingStudents = allStudents.filter(s => !batchIdsToDelete.includes(s.batchId));
                            localStorage.setItem(DB_KEYS.STUDENTS, JSON.stringify(remainingStudents));
                        }
                    }
                }
            },
            getQPs: () => JSON.parse(localStorage.getItem(DB_KEYS.QP) || '[]'),
            getQPsBySSC: (sscId) => window.Utils.getQPs().filter(q => q.sscId === sscId),
            saveQP: (qp) => {
                const list = window.Utils.getQPs();
                if (!qp.id) qp.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                list.push(qp);
                localStorage.setItem(DB_KEYS.QP, JSON.stringify(list));
                window.Utils.saveToCloud('qps', qp);
            },
            deleteQP: (id) => {
                window.Utils.deleteFromCloud('qps', id);
                let list = window.Utils.getQPs().filter(q => q.id !== id);
                localStorage.setItem(DB_KEYS.QP, JSON.stringify(list));
            },
            getNOS: () => JSON.parse(localStorage.getItem(DB_KEYS.NOS) || '[]'),
            getNOSByQP: (qpId) => window.Utils.getNOS().filter(n => n.qpId === qpId),
            saveNOS: (nos) => {
                const list = window.Utils.getNOS();
                if (!nos.id) nos.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                list.push(nos);
                localStorage.setItem(DB_KEYS.NOS, JSON.stringify(list));
                window.Utils.saveToCloud('nos', nos);
            },
            deleteNOS: (id) => {
                window.Utils.deleteFromCloud('nos', id);
                let list = window.Utils.getNOS().filter(n => n.id !== id);
                localStorage.setItem(DB_KEYS.NOS, JSON.stringify(list));
            },
            getPCs: () => JSON.parse(localStorage.getItem(DB_KEYS.PC) || '[]'),
            getPCsByNOS: (nosId) => window.Utils.getPCs().filter(p => p.nosId === nosId),
            savePC: (pc) => {
                const list = window.Utils.getPCs();
                if (!pc.id) pc.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                list.push(pc);
                localStorage.setItem(DB_KEYS.PC, JSON.stringify(list));
                window.Utils.saveToCloud('pcs', pc);
            },
            deletePC: (id) => {
                window.Utils.deleteFromCloud('pcs', id);
                let list = window.Utils.getPCs().filter(p => p.id !== id);
                localStorage.setItem(DB_KEYS.PC, JSON.stringify(list));
            },
            getBatches: () => JSON.parse(localStorage.getItem(DB_KEYS.BATCHES) || '[]'),
            saveToCloud: async (route, item) => {
                try {
                    if (!navigator.onLine) return false;
                    const res = await fetch(`${SERVER_URL}/api/${route}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'x-api-key': API_KEY },
                        body: JSON.stringify(item)
                    });
                    return res.ok;
                } catch (e) {
                    console.error(`Save ${route} failed`, e);
                    return false;
                }
            },

            // ... (Other functions) ...

            saveBatch: async (batch) => {
                let list = window.Utils.getBatches();
                if (!batch.id) batch.id = Date.now().toString(36) + Math.random().toString(36).substr(2);

                const existingIndex = list.findIndex(b => b.id === batch.id);
                if (existingIndex >= 0) {
                    list[existingIndex] = batch; // Update
                } else {
                    list.push(batch); // Insert
                }

                localStorage.setItem(DB_KEYS.BATCHES, JSON.stringify(list));

                // Explicit Feedback for Admin
                const saved = await window.Utils.saveToCloud('batches', batch);
                if (saved) {
                    alert("Batch Saved & Synced to Cloud Successfully!");
                } else {
                    alert("Batch Saved Locally but Cloud Sync FAILED.\nPlease check connection and try again.");
                }
            },
            updateBatches: (batches) => localStorage.setItem(DB_KEYS.BATCHES, JSON.stringify(batches)),
            deleteBatch: (id) => {
                window.Utils.deleteFromCloud('batches', id);
                let list = window.Utils.getBatches().filter(b => b.id !== id);
                localStorage.setItem(DB_KEYS.BATCHES, JSON.stringify(list));

                let allStudents = window.Utils.getStudents();
                let studentsToDelete = allStudents.filter(s => s.batchId === id);
                studentsToDelete.forEach(s => window.Utils.deleteFromCloud('students', s.id));

                let students = allStudents.filter(s => s.batchId !== id);
                localStorage.setItem(DB_KEYS.STUDENTS, JSON.stringify(students));
            },
            getStudents: () => JSON.parse(localStorage.getItem(DB_KEYS.STUDENTS) || '[]'),
            getStudentsByBatch: (batchId) => window.Utils.getStudents().filter(s => s.batchId === batchId),
            saveStudent: (student) => {
                const list = window.Utils.getStudents();
                if (!student.id) student.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                list.push(student);
                localStorage.setItem(DB_KEYS.STUDENTS, JSON.stringify(list));
                window.Utils.saveToCloud('students', student);
            },
            deleteStudent: (id) => {
                window.Utils.deleteFromCloud('students', id);
                let list = window.Utils.getStudents().filter(s => s.id !== id);
                localStorage.setItem(DB_KEYS.STUDENTS, JSON.stringify(list));
            },
            authenticateStudent: (username, password) => window.Utils.getStudents().find(s => String(s.username).trim().toLowerCase() === String(username).trim().toLowerCase() && String(s.password).trim() === String(password).trim()),
            getQuestionPapers: () => JSON.parse(localStorage.getItem(DB_KEYS.QUESTION_PAPERS) || '[]'),
            saveQuestionPaper: (qp) => {
                const list = window.Utils.getQuestionPapers();
                if (!qp.id) qp.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                list.push(qp);
                localStorage.setItem(DB_KEYS.QUESTION_PAPERS, JSON.stringify(list));
                window.Utils.saveToCloud('question_papers', qp);
            },
            deleteQuestionPaper: (id) => {
                window.Utils.deleteFromCloud('question_papers', id);
                let list = window.Utils.getQuestionPapers().filter(q => q.id !== id);
                localStorage.setItem(DB_KEYS.QUESTION_PAPERS, JSON.stringify(list));
            },
            getResponses: () => JSON.parse(localStorage.getItem(DB_KEYS.RESPONSES) || '[]'),
            base64ToBlob: (base64) => {
                const parts = base64.split(';base64,');
                const contentType = parts[0].split(':')[1];
                const raw = window.atob(parts[1]);
                const rawLength = raw.length;
                const uInt8Array = new Uint8Array(rawLength);
                for (let i = 0; i < rawLength; ++i) {
                    uInt8Array[i] = raw.charCodeAt(i);
                }
                return new Blob([uInt8Array], { type: contentType });
            },

            saveResponse: async (response) => {
                try {
                    // MIGRATION TO INDEXEDDB FOR IMAGES
                    if (response.evidence && Array.isArray(response.evidence)) {
                        for (let i = 0; i < response.evidence.length; i++) {
                            const ev = response.evidence[i];
                            // If it's a base64 string (starts with data:image), offload it
                            if (ev.img && ev.img.startsWith('data:image')) {
                                const blob = window.Utils.base64ToBlob(ev.img);
                                const key = `ev_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                                await VideoDB.saveVideo(key, blob); // reusing generic Method
                                response.evidence[i] = { ...ev, img: key, storage: 'indexeddb' };
                            }
                        }
                    }

                    const list = window.Utils.getResponses();
                    const existing = list.findIndex(r => r.studentId === response.studentId && r.examType === response.examType);
                    if (existing >= 0) {
                        const old = list[existing];
                        let newEvidence = old.evidence || [];
                        if (response.evidence) {
                            newEvidence = [...newEvidence, ...response.evidence];
                        }
                        list[existing] = { ...old, ...response, evidence: newEvidence };
                    }
                    else list.push(response);

                    localStorage.setItem(DB_KEYS.RESPONSES, JSON.stringify(list));

                } catch (e) {
                    console.error("Storage Error", e);
                    // Fallback to alert if IndexedDB fails or something else is wrong
                    if (e.name === 'QuotaExceededError') {
                        alert("Storage Full! Please contact support.");
                    }
                }
            },
            authenticateAssessor: (username, password) => {
                // Strict production auth: Match against loaded Batches (which come from Cloud)
                return window.Utils.getBatches().find(b =>
                    String(b.assessorUsername).trim() === String(username).trim() &&
                    String(b.assessorPassword).trim() === String(password).trim()
                );
            }
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // Safe Icon Component
        const LucideIcon = ({ name, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    // Convert kebab-case (download, file-text) to PascalCase (Download, FileText) for lookup
                    const iconKey = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                    const iconDef = window.lucide.icons[iconKey];

                    if (iconDef) {
                        window.lucide.createIcons({
                            attrs: { class: className },
                            nameAttr: 'data-lucide',
                            icons: { [name]: iconDef }, // Map 'download' -> Download definition
                            root: ref.current.parentNode
                        });
                    } else {
                        console.warn(`Icon not found: ${name} (Key: ${iconKey})`);
                    }
                    // Actually createIcons replaces elements with data-lucide.
                    // We need to render <i data-lucide={name} /> and let lucide replace it.
                    // BUT we want to scope it.
                    window.lucide.createIcons({
                        root: ref.current,
                        icons: window.lucide.icons,
                        attrs: { class: className }
                    });
                }
            }, [name, className]);

            return <span ref={ref}><i data-lucide={name} className={className}></i></span>;
        };

        const Icons = {
            User: () => <LucideIcon name="user" className="w-5 h-5" />,
            Users: () => <LucideIcon name="users" className="w-5 h-5" />,
            LogOut: () => <LucideIcon name="log-out" className="w-5 h-5" />,
            Camera: () => <LucideIcon name="camera" className="w-5 h-5" />,
            Plus: () => <LucideIcon name="plus" className="w-5 h-5" />,
            Trash2: () => <LucideIcon name="trash-2" className="w-4 h-4" />,
            Eye: () => <LucideIcon name="eye" className="w-5 h-5" />,
            EyeOff: () => <LucideIcon name="eye-off" className="w-5 h-5" />,
            Upload: () => <LucideIcon name="upload" className="w-5 h-5" />,
            Download: () => <LucideIcon name="download" className="w-5 h-5" />,
            FileText: () => <LucideIcon name="file-text" className="w-5 h-5" />,
            Book: () => <LucideIcon name="book" className="w-5 h-5" />,
            Cpu: () => <LucideIcon name="cpu" className="w-5 h-5" />,
            Edit3: () => <LucideIcon name="edit-3" className="w-4 h-4" />,
            UserPlus: () => <LucideIcon name="user-plus" className="w-5 h-5" />,
            ChevronDown: () => <LucideIcon name="chevron-down" className="w-4 h-4" />,
            ChevronLeft: () => <LucideIcon name="chevron-left" className="w-4 h-4" />,
            ChevronRight: () => <LucideIcon name="chevron-right" className="w-4 h-4" />,
            Map: () => <LucideIcon name="map" className="w-4 h-4" />,
            Home: () => <LucideIcon name="home" className="w-4 h-4" />,
            Grid: () => <LucideIcon name="grid" className="w-5 h-5" />,
            Calendar: () => <LucideIcon name="calendar" className="w-5 h-5" />,
            MapPin: () => <LucideIcon name="map-pin" className="w-5 h-5" />,
            Layers: () => <LucideIcon name="layers" className="w-5 h-5" />,
            List: () => <LucideIcon name="list" className="w-5 h-5" />,
            PlusSquare: () => <LucideIcon name="plus-square" className="w-5 h-5" />,
            MinusSquare: () => <LucideIcon name="minus-square" className="w-5 h-5" />,
            Lock: ({ className }) => <LucideIcon name="lock" className={className || "w-5 h-5"} />,
            Unlock: ({ className }) => <LucideIcon name="unlock" className={className || "w-5 h-5"} />,
            Video: () => <LucideIcon name="video" className="w-5 h-5" />,
            Square: () => <LucideIcon name="square" className="w-5 h-5" />,
            BarChart2: () => <LucideIcon name="bar-chart-2" className="w-5 h-5" />,
            XCircle: () => <LucideIcon name="x-circle" className="w-5 h-5" />,
            UploadCloud: () => <LucideIcon name="upload-cloud" className="w-12 h-12" />,
            Save: () => <LucideIcon name="save" className="w-4 h-4" />,
            TriangleAlert: () => <LucideIcon name="triangle-alert" className="w-6 h-6" />,
            Loader: ({ className }) => <LucideIcon name="loader" className={className || "w-4 h-4"} />,
            Play: ({ className }) => <LucideIcon name="play" className={className || "w-4 h-4"} />,
            CheckCircle: ({ className }) => <LucideIcon name="check-circle" className={className || "w-5 h-5"} />,
            Microphone: ({ className }) => <LucideIcon name="mic" className={className || "w-5 h-5"} />,
            MicrophoneOff: ({ className }) => <LucideIcon name="mic-off" className={className || "w-5 h-5"} />,
            VideoOff: ({ className }) => <LucideIcon name="video-off" className={className || "w-5 h-5"} />,
            PhoneMissed: ({ className }) => <LucideIcon name="phone-missed" className={className || "w-5 h-5"} />,
            Check: ({ className }) => <LucideIcon name="check" className={className || "w-5 h-5"} />,
            Square: ({ className }) => <LucideIcon name="square" className={className || "w-5 h-5"} />,
            RefreshCw: ({ className }) => <LucideIcon name="refresh-cw" className={className || "w-4 h-4"} />
        };
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error('ErrorBoundary caught:', error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-8 text-red-600 bg-white min-h-screen">
                            <h1 className="text-3xl font-bold mb-4">Something went wrong.</h1>
                            <div className="bg-red-50 p-6 rounded-lg border border-red-200 shadow-sm">
                                <h2 className="font-bold text-lg mb-2">Error Details:</h2>
                                <pre className="whitespace-pre-wrap font-mono text-sm">{this.state.error?.toString()}</pre>
                                <p className="mt-4 text-sm text-gray-600">Check the console for more details.</p>
                            </div>
                            <button onClick={() => window.location.reload()} className="mt-6 px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">reload Page</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // LOGIN
        const LoginScreen = ({ onLogin }) => {
            const [role, setRole] = useState('admin');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [debugInfo, setDebugInfo] = useState({ studentCount: 0, serverStatus: 'Checking...' });

            useEffect(() => {
                // Initial Load Check
                const count = window.Utils.getStudents().length;
                setDebugInfo(prev => ({ ...prev, studentCount: count }));

                // Server Check
                fetch(`${SERVER_URL}/health`) // Public endpoint
                    .then(res => setDebugInfo(prev => ({ ...prev, serverStatus: res.ok ? 'Online' : 'Error' })))
                    .catch(() => setDebugInfo(prev => ({ ...prev, serverStatus: 'Unreachable' })));
            }, []);

            const handleLogin = (e) => {
                e.preventDefault();
                setError('');
                if (role === 'admin' && username === 'admin' && password === 'admin') {
                    onLogin({ role: 'admin', name: 'Administrator' });
                } else if (role === 'student') {
                    const student = window.Utils.authenticateStudent(username, password);
                    if (student) onLogin({ role: 'student', ...student });
                    else setError('Invalid student credentials');
                } else if (role === 'assessor') {
                    // Default/Master Login for Assessor
                    if (username === 'abc' && password === 'abc') {
                        onLogin({ role: 'assessor', name: 'Default Assessor', id: 'master_assessor', batchId: 'master' });
                        return;
                    }
                    const batch = window.Utils.authenticateAssessor(username, password);
                    if (batch) onLogin({ role: 'assessor', name: 'Assessor', batchId: batch.id });
                    else setError('Invalid assessor credentials');
                } else setError('Invalid credentials');
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 p-4">
                    <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md glass">
                        <h1 className="text-3xl font-bold text-center text-gray-800 mb-2">NSXpertise</h1>
                        <p className="text-center text-gray-500 mb-8">Assessment Management System</p>
                        <div className="flex justify-center gap-4 mb-6">
                            {['admin', 'student', 'assessor'].map(r => (
                                <button key={r} onClick={() => setRole(r)}
                                    className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${role === r ? 'bg-indigo-600 text-white shadow-lg' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                        }`}>
                                    {r.charAt(0).toUpperCase() + r.slice(1)}
                                </button>
                            ))}
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input type="text" required className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                                    value={username} onChange={e => setUsername(e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" required className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                                    value={password} onChange={e => setPassword(e.target.value)} />
                            </div>
                            <div className="flex justify-between items-center text-xs text-gray-500 mt-2">
                                <span className={navigator.onLine ? "text-green-600 font-bold flex items-center gap-1" : "text-red-500 font-bold flex items-center gap-1"}>
                                    <div className={`w-2 h-2 rounded-full ${navigator.onLine ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                    {navigator.onLine ? "Cloud Connected" : "Offline Mode"}
                                </span>
                                <span>v5.0 (Production)</span>
                            </div>
                            {error && <p className="text-red-500 text-sm text-center bg-red-50 p-2 rounded">{error}</p>}
                            <div className="flex gap-2">
                                <button type="submit" className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transform hover:scale-[1.02] transition-all">
                                    Login as {role.charAt(0).toUpperCase() + role.slice(1)}
                                </button>
                                <button type="button" onClick={async () => {
                                    if (confirm("Force Upload Local Data to Cloud? (Use this if other devices are missing data)")) {
                                        await window.Utils.uploadToCloud();
                                    }
                                }} className="px-4 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-colors" title="Force Upload to Cloud">
                                    <Icons.Upload className="w-5 h-5" />
                                </button>
                                <button type="button" onClick={async () => {
                                    await window.Utils.downloadFromCloud();
                                    setDebugInfo(prev => ({ ...prev, studentCount: window.Utils.getStudents().length }));
                                }} className="px-4 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-colors" title="Sync Latest Data">
                                    <Icons.Download className="w-5 h-5" />
                                </button>
                            </div>
                            <div className="text-center text-xs text-gray-400 mt-4 space-y-1">
                                <p>Demo: admin/admin</p>
                                <p className="text-gray-400 text-[10px] mt-2">v5.2 (Production)</p>
                            </div>
                        </form>
                    </div >
                </div >
            );
        };

        // SIDEBAR COMPONENT
        const Sidebar = ({ activeTab, setActiveTab }) => {
            const [isQpsOpen, setIsQpsOpen] = useState(true);

            const menuItems = [
                { id: 'dashboard', label: 'Dashboard', icon: <Icons.Grid /> },
                { id: 'calendar', label: 'Calendar', icon: <Icons.Calendar /> }, // Placeholder
                { id: 'location', label: 'Assessment Location', icon: <Icons.MapPin /> }, // Placeholder
                { id: 'subjects', label: 'Sector Skill Councils', icon: <Icons.Layers /> },
            ];

            return (
                <div className="w-64 bg-slate-800 text-white min-h-screen flex flex-col">
                    <div className="p-6 border-b border-slate-700">
                        <h1 className="text-xl font-bold">NSXpertise</h1>
                    </div>
                    <nav className="flex-1 p-4 space-y-1">
                        {menuItems.map(item => (
                            <button key={item.id} onClick={() => setActiveTab(item.id)}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${activeTab === item.id ? 'bg-indigo-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>
                                {item.icon}
                                <span className="text-sm font-medium">{item.label}</span>
                            </button>
                        ))}

                        {/* QPS & NOS Dropdown */}
                        <div className="space-y-1">
                            <button onClick={() => setIsQpsOpen(!isQpsOpen)}
                                className={`w-full flex items-center justify-between px-4 py-3 rounded-lg text-slate-300 hover:bg-slate-700 transition-colors`}>
                                <div className="flex items-center gap-3">
                                    <Icons.Book />
                                    <span className="text-sm font-medium">QPS & NOS</span>
                                </div>
                                {isQpsOpen ? <Icons.ChevronDown /> : <Icons.ChevronRight />}
                            </button>

                            {isQpsOpen && (
                                <div className="pl-12 space-y-1">
                                    <button onClick={() => setActiveTab('qps')}
                                        className={`w-full text-left px-4 py-2 rounded-lg text-sm transition-colors ${activeTab === 'qps' ? 'text-white font-medium' : 'text-slate-400 hover:text-white'}`}>
                                        Qualification Pack
                                    </button>
                                    <button onClick={() => setActiveTab('nos')}
                                        className={`w-full text-left px-4 py-2 rounded-lg text-sm transition-colors ${activeTab === 'nos' ? 'text-white font-medium' : 'text-slate-400 hover:text-white'}`}>
                                        NOS & PC
                                    </button>
                                </div>
                            )}
                        </div>

                        {/* Legacy Tabs moved to bottom or hidden if unused, keeping for now as direct links */}
                        <div className="pt-4 mt-4 border-t border-slate-700">
                            <p className="px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Assessment</p>
                            <button onClick={() => setActiveTab('questionPapers')}
                                className={`w-full flex items-center gap-3 px-4 py-2 rounded-lg transition-colors ${activeTab === 'questionPapers' ? 'bg-indigo-600' : 'text-slate-300 hover:bg-slate-700'}`}>
                                <Icons.FileText /> <span className="text-sm">Question Papers</span>
                            </button>
                            <button onClick={() => setActiveTab('batches')}
                                className={`w-full flex items-center gap-3 px-4 py-2 rounded-lg transition-colors ${activeTab === 'batches' ? 'bg-indigo-600' : 'text-slate-300 hover:bg-slate-700'}`}>
                                <Icons.Users /> <span className="text-sm">Batches</span>
                            </button>
                            <button onClick={() => setActiveTab('results')}
                                className={`w-full flex items-center gap-3 px-4 py-2 rounded-lg transition-colors ${activeTab === 'results' ? 'bg-indigo-600' : 'text-slate-300 hover:bg-slate-700'}`}>
                                <Icons.Cpu /> <span className="text-sm">Results</span>
                            </button>
                        </div>

                    </nav>
                </div>
            );
        };



        // SUBJECTS TAB
        const SubjectsTab = () => {
            const [sscList, setSSCList] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [newSSC, setNewSSC] = useState({ name: '', code: '' });

            useEffect(() => setSSCList(window.Utils.getSSC()), []);

            const handleCreate = (e) => {
                e.preventDefault();
                const ssc = { ...newSSC, id: window.Utils.generateId(), createdAt: new Date().toISOString() };
                window.Utils.saveSSC(ssc);
                setSSCList(window.Utils.getSSC());
                setShowModal(false);
                setNewSSC({ name: '', code: '' });
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-bold">Sector Skill Councils (SSC)</h3>
                        <button onClick={() => setShowModal(true)} className="bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-indigo-700">
                            <Icons.Plus /> Add SSC
                        </button>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-x-auto">
                        <table className="w-full">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="p-4 text-left font-bold text-gray-600">#</th>
                                    <th className="p-4 text-left font-bold text-gray-600">Name</th>
                                    <th className="p-4 text-left font-bold text-gray-600">Code</th>
                                    <th className="p-4 text-center font-bold text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {sscList.map((ssc, idx) => (
                                    <tr key={ssc.id} className="hover:bg-gray-50">
                                        <td className="p-4">{idx + 1}</td>
                                        <td className="p-4 font-medium">{ssc.name}</td>
                                        <td className="p-4">{ssc.code}</td>
                                        <td className="p-4 text-center">
                                            <button onClick={() => { if (confirm('Delete?')) { window.Utils.deleteSSC(ssc.id); setSSCList(window.Utils.getSSC()); } }}
                                                className="text-red-600 hover:text-red-800"><Icons.Trash2 /></button>
                                        </td>
                                    </tr>
                                ))}
                                {sscList.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-gray-400">No SSCs found</td></tr>}
                            </tbody>
                        </table>
                    </div>
                    {showModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl p-6 w-full max-w-md">
                                <h3 className="text-xl font-bold mb-4">Add New SSC</h3>
                                <form onSubmit={handleCreate} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Name</label>
                                        <input type="text" required className="w-full px-4 py-2 border rounded-lg"
                                            value={newSSC.name} onChange={e => setNewSSC({ ...newSSC, name: e.target.value })} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Code</label>
                                        <input type="text" required className="w-full px-4 py-2 border rounded-lg"
                                            value={newSSC.code} onChange={e => setNewSSC({ ...newSSC, code: e.target.value })} />
                                    </div>
                                    <div className="flex gap-2 justify-end">
                                        <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                                        <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Create</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        // UPLOAD NOS & PC COMPONENT
        const UploadNOSPC = ({ onBack, selectedSSC, sscList }) => {
            const [file, setFile] = useState(null);

            const downloadSample = () => {
                const ws = XLSX.utils.aoa_to_sheet([
                    ["QualificationPackID", "NOSID", "NOSName", "PC No", "PC Name", "Theory Marks", "Practical Marks", "Viva Marks", "Total Marks"],
                    ["QP001", "NOS001", "Intro to Farming", "PC1", "Identify seeds", "10", "20", "5", "35"]
                ]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                XLSX.writeFile(wb, "NOS_PC_Sample.xlsx");
            };

            const handleValidate = () => {
                if (!file) return alert("Please select a file");
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet);

                        if (json.length === 0) return alert("File appears to be empty.");

                        // Flexible Column Matcher
                        const findKey = (obj, ...candidates) => {
                            const keys = Object.keys(obj);
                            for (let cand of candidates) {
                                const normCand = cand.toLowerCase().replace(/[^a-z0-9]/g, '');
                                const found = keys.find(k => k.toLowerCase().replace(/[^a-z0-9]/g, '') === normCand);
                                if (found) return found;
                            }
                            return null;
                        };

                        // Detect Keys from first row
                        const sample = json[0];
                        const keyQP = findKey(sample, 'QualificationPackID', 'QPID', 'QP Code', 'Qualification Pack ID');
                        const keyNOS = findKey(sample, 'NOSID', 'NOS ID', 'NOS Code');
                        const keyNOSName = findKey(sample, 'NOSName', 'NOS Name');
                        const keyPC = findKey(sample, 'PCNo', 'PC No', 'PC ID', 'PC Code');
                        const keyPCName = findKey(sample, 'PCName', 'PC Name');
                        const keyTheory = findKey(sample, 'TheoryMarks', 'Theory Marks', 'Theory');
                        const keyPractical = findKey(sample, 'PracticalMarks', 'Practical Marks', 'Practical');
                        const keyViva = findKey(sample, 'VivaMarks', 'Viva Marks', 'Viva');
                        const keyTotal = findKey(sample, 'TotalMarks', 'Total Marks', 'Total');

                        if (!keyQP) {
                            alert("Critical Error: Could not find 'QualificationPackID' column.\nFound headers: " + Object.keys(sample).join(', '));
                            return;
                        }

                        const qps = window.Utils.getQPs();
                        let currentNOS = window.Utils.getNOS();
                        let currentPCs = window.Utils.getPCs();

                        let addedNOS = 0;
                        let addedPCs = 0;
                        let skippedNOS = 0;
                        let skippedPCs = 0;
                        let errors = [];
                        let processedNOS = new Set(); // Track NOSs processed in this file

                        json.forEach((row, idx) => {
                            const r = idx + 2;
                            const qpCode = row[keyQP];
                            const nosCode = row[keyNOS];

                            if (!qpCode) return; // Skip empty rows

                            const qp = qps.find(q => q.code === String(qpCode).trim());
                            if (!qp) {
                                const msg = `Row ${r}: QP '${qpCode}' not found in system.`;
                                if (!errors.includes(msg)) errors.push(msg);
                                return;
                            }

                            if (nosCode) {
                                const cleanNOS = String(nosCode).trim();
                                let nos = currentNOS.find(n => n.code === cleanNOS && n.qpId === qp.id);

                                if (!nos) {
                                    nos = {
                                        id: window.Utils.generateId(),
                                        qpId: qp.id,
                                        code: cleanNOS,
                                        name: row[keyNOSName] || cleanNOS,
                                        createdAt: new Date().toISOString()
                                    };
                                    currentNOS.push(nos);
                                    window.Utils.saveNOS(nos);

                                    if (!processedNOS.has(cleanNOS)) {
                                        addedNOS++;
                                        processedNOS.add(cleanNOS);
                                    }
                                } else {
                                    if (!processedNOS.has(cleanNOS)) {
                                        skippedNOS++;
                                        processedNOS.add(cleanNOS);
                                    }
                                }

                                const pcCode = row[keyPC];
                                if (pcCode) {
                                    const cleanPC = String(pcCode).trim();
                                    const exists = currentPCs.find(p => p.nosId === nos.id && p.code === cleanPC);
                                    if (!exists) {
                                        const pc = {
                                            id: window.Utils.generateId(),
                                            nosId: nos.id,
                                            code: cleanPC,
                                            name: row[keyPCName] || cleanPC,
                                            theoryMarks: row[keyTheory] || 0,
                                            practicalMarks: row[keyPractical] || 0,
                                            vivaMarks: row[keyViva] || 0,
                                            totalMarks: row[keyTotal] || 0
                                        };
                                        currentPCs.push(pc);
                                        window.Utils.savePC(pc);
                                        addedPCs++;
                                    } else {
                                        skippedPCs++;
                                    }
                                }
                            }
                        });

                        const summary = `Import Results:\n• Added: ${addedNOS} NOS, ${addedPCs} PCs\n• Skipped (Duplicates): ${skippedNOS} NOS, ${skippedPCs} PCs`;

                        if (errors.length > 0) {
                            alert(`${summary}\n\nWarnings/Errors:\n${errors.slice(0, 10).join('\n')}`);
                        } else {
                            alert(`Success!\n${summary}`);
                        }
                        // Navigate back even if duplicates (so user can see the list)
                        if (addedNOS > 0 || addedPCs > 0 || skippedNOS > 0 || skippedPCs > 0) onBack();

                    } catch (err) {
                        alert("Error parsing file: " + err.message);
                        console.error(err);
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            return (
                <div className="animate-fade-in text-sm">
                    <div className="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 className="text-2xl font-bold text-gray-800">Upload NOS & PC</h2>
                        <button onClick={onBack} className="bg-white border hover:bg-gray-50 text-gray-700 px-4 py-2 rounded shadow-sm">Back</button>
                    </div>

                    <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-100 mb-6">
                        <div className="flex items-center gap-8 mb-8">
                            <span className="font-bold text-gray-700">Sector Skill Council :</span>
                            <span className="text-gray-600 font-medium text-lg">{sscList.find(s => s.id === selectedSSC)?.name || 'All'}</span>
                        </div>

                        <div className="space-y-4 mb-8">
                            <p className="font-medium text-gray-600">Note : It will accept only Excel files with *.xls or *.xlsx extension only.</p>
                            <div className="flex items-center gap-4">
                                <button onClick={downloadSample} className="flex items-center gap-2 text-green-600 border border-green-600 px-4 py-2 rounded hover:bg-green-50">
                                    <Icons.Download className="w-4 h-4" /> Download Sample Format
                                </button>
                            </div>
                        </div>

                        <div className="border-t pt-8">
                            <div className="max-w-xl mx-auto text-center">
                                <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 hover:border-indigo-500 transition-colors">
                                    <Icons.Upload className="w-12 h-12 text-gray-400 mx-auto mb-4" />
                                    <p className="text-gray-600 mb-4">Drag and drop your Excel file here, or click to browse</p>
                                    <input type="file" accept=".xlsx,.xls" onChange={e => setFile(e.target.files[0])} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
                                </div>
                                <button onClick={handleValidate} className="mt-6 w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 shadow-md">
                                    Upload & Process
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // QPs STRUCTURE TAB
        const QPsTab = ({ onNavigateToNOS }) => {
            const [qpList, setQPList] = useState([]);
            const [sscList, setSSCList] = useState([]);
            const [selectedSSC, setSelectedSSC] = useState('');
            const [showModal, setShowModal] = useState(false);
            const [viewMode, setViewMode] = useState('list'); // 'list' | 'upload'

            // Enhanced QP State
            const [newQP, setNewQP] = useState({
                sscId: '', name: '', code: '', qpLevel: '',
                theoryMarks: '', vivaMarks: '', practicalMarks: '', totalMarks: '',
                theoryCutoff: '', vivaCutoff: '', practicalCutoff: '', overallCutoff: '',
                isTheoryCutoff: false, isVivaCutoff: false, isPracticalCutoff: false, isOverallCutoff: false
            });

            useEffect(() => {
                setQPList(window.Utils.getQPs());
                setSSCList(window.Utils.getSSC());
            }, []);

            // Auto-calculate Total Marks
            useEffect(() => {
                const total = (parseFloat(newQP.theoryMarks) || 0) + (parseFloat(newQP.vivaMarks) || 0) + (parseFloat(newQP.practicalMarks) || 0);
                setNewQP(prev => ({ ...prev, totalMarks: total || '' }));
            }, [newQP.theoryMarks, newQP.vivaMarks, newQP.practicalMarks]);

            const handleCreate = (e) => {
                e.preventDefault();
                const qp = { ...newQP, id: window.Utils.generateId(), createdAt: new Date().toISOString() };
                window.Utils.saveQP(qp);
                window.Utils.uploadToCloud(true);
                setQPList(window.Utils.getQPs());
                setShowModal(false);
                setNewQP({
                    sscId: '', name: '', code: '', qpLevel: '',
                    theoryMarks: '', vivaMarks: '', practicalMarks: '', totalMarks: '',
                    isTheoryCutoff: false, isVivaCutoff: false, isPracticalCutoff: false, isOverallCutoff: false
                });
            };

            const filteredQPs = selectedSSC ? qpList.filter(q => q.sscId === selectedSSC) : [];
            const getSSCName = (id) => sscList.find(s => s.id === id)?.name || id;

            if (viewMode === 'upload') {
                return <UploadNOSPC onBack={() => {
                    setViewMode('list');
                    // Refresh all lists
                    setQPList(window.Utils.getQPs());
                    // Note: NOS/PC lists are managed in NOSPC_Tab if this component is QPSTab, 
                    // but looking at context this seems to be QPSTab. 
                    // However, UploadNOSPC imports NOS/PCs.
                    // If we are in QPSTab, we might not have setNOSList here. 
                    // Let's check where NOSPC_Tab is. 
                    // Actually, looking at the file view above, this component seems to be 'QPSTab' or similar (line 629 in full file?).
                    // Wait, the previous search result showed 'NOSPC_Tab' at line 862. 
                    // The line 690 block is inside 'QPSTab' (based on 'handleCreate' for QPs).
                    // If the user is uploading NOS/PC from QPSTab, we need to ensure *that* tab refreshes if it displays them.
                    // But QPSTab mainly shows QPs. 
                    // Let's look at where the user saw the issue. "not coming and another one is i am not uploading 20 noses".
                    // The user is likely in 'NOSPC_Tab' (line 862) OR accessing upload from there.
                    // Let's re-read the code snippet for 672-691. It has `handleCreate` for QPs. So this IS QPSTab.

                    // If the user clicks "Upload NOS & PC" from QPSTab (line 720?), and then goes back, 
                    // they are still in QPSTab. They would need to go to "NOS & PC" tab to see them.
                    // The "not coming" might be because they expect to see them *here* or when they switch tabs.
                    // But wait, there is a `NOSPC_Tab` component later. 

                    // Let's assume for now we just want to return to list. 
                    // BUT, I need to check if UploadNOSPC is used in NOSPC_Tab too.
                }} selectedSSC={selectedSSC} sscList={sscList} />;
            }

            return (
                <div className="animate-fade-in text-sm">
                    <h2 className="text-2xl font-bold mb-6 text-gray-800">Qualification Packs</h2>

                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center gap-4 w-1/3">
                                <label className="text-sm font-bold text-gray-700 whitespace-nowrap">Sector Skill Council:</label>
                                <select className="w-full p-2 border rounded-md bg-gray-50" value={selectedSSC} onChange={e => setSelectedSSC(e.target.value)}>
                                    <option value="">Select SSC</option>
                                    {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>

                            <div className="flex items-center gap-2">
                                <div className="flex items-center gap-2 text-gray-600 font-medium mr-4">
                                    <Icons.Book />
                                    <span>Total Records : {filteredQPs.length}</span>
                                </div>
                                {selectedSSC && (
                                    <>
                                        <button onClick={() => {
                                            if (!confirm("This will find duplicate Qualification Packs (same code) and merge them into one. Proceed?")) return;

                                            // 1. Group QPs by Code
                                            const allQPs = window.Utils.getQPs();
                                            const groups = {};
                                            allQPs.forEach(q => {
                                                const code = (q.code || '').trim().toLowerCase();
                                                if (!code) return;
                                                if (!groups[code]) groups[code] = [];
                                                groups[code].push(q);
                                            });

                                            let fixedGroupsStr = "";
                                            let totalFixed = 0;

                                            // 2. Process groups with > 1 QP
                                            Object.keys(groups).forEach(code => {
                                                const duplicates = groups[code];
                                                if (duplicates.length > 1) {
                                                    // Keep the FIRST one as master (or the one with most data? safely just first for now)
                                                    const master = duplicates[0];
                                                    const ghosts = duplicates.slice(1);

                                                    // 3. Re-link Data

                                                    // NOS
                                                    const allNOS = window.Utils.getNOS();
                                                    let nosUpdates = 0;
                                                    const updatedNOS = allNOS.map(n => {
                                                        if (ghosts.some(g => g.id === n.qpId)) {
                                                            nosUpdates++;
                                                            return { ...n, qpId: master.id };
                                                        }
                                                        return n;
                                                    });
                                                    if (nosUpdates > 0) window.Utils.saveNOSList ? window.Utils.saveNOSList(updatedNOS) : localStorage.setItem('se_nos', JSON.stringify(updatedNOS));

                                                    // Batches (theoryPaperId, practicalPaperId might link to QP? No, batches link to Question Papers usually, but let's check Batch schema in BatchesTab)
                                                    // Checking BatchesTab filter logic: tPaper.sscId... batches link to papers. 
                                                    // But wait, the user's screenshot showed "Qualification Pack" dropdown in "Add Batch".
                                                    // That dropdown sets 'assignment' or similar. 
                                                    // Let's re-read Add Batch logic if possible, or just be safe.
                                                    // If batches have 'qpId' directly? 
                                                    // Looking at lines 3220, it filters by papers. 
                                                    // However, line 2940 showing "Select QP" implies batches might save QP selection.
                                                    // Let's check 'assignQPDef' or 'selectedAssignQP' usage in 'handleAddBatch'.
                                                    // It seems batches might store 'qpId' if configured. 
                                                    // Let's update Batches just in case they hold direct references. 
                                                    const allBatches = window.Utils.getBatches();
                                                    const updatedBatches = allBatches.map(b => {
                                                        if (ghosts.some(g => g.id === b.qpId)) return { ...b, qpId: master.id }; // Future proofing
                                                        return b;
                                                    });
                                                    window.Utils.updateBatches(updatedBatches);

                                                    // 4. Delete Ghosts
                                                    const ghostIDs = ghosts.map(g => g.id);
                                                    const newQPList = window.Utils.getQPs().filter(q => !ghostIDs.includes(q.id));
                                                    localStorage.setItem('se_qp', JSON.stringify(newQPList));

                                                    fixedGroupsStr += `\n- ${master.code} (Merged ${duplicates.length} records)`;
                                                    totalFixed++;
                                                }
                                            });

                                            if (totalFixed > 0) {
                                                alert(`Success! Merged duplicates for:${fixedGroupsStr}\n\nRefreshed page.`);
                                                setQPList(window.Utils.getQPs());
                                            } else {
                                                alert("No duplicate Qualification Packs found.");
                                            }

                                        }} className="bg-orange-500 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-orange-600 shadow-sm" title="Fix Duplicate Codes">
                                            <Icons.Layers /> Cleanup Duplicates
                                        </button>

                                        <button className="bg-gray-600 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-gray-700">
                                            Export To <Icons.ChevronDown />
                                        </button>
                                        <button onClick={() => { setNewQP(prev => ({ ...prev, sscId: selectedSSC })); setShowModal(true); }} className="bg-red-500 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-red-600">
                                            <Icons.Plus /> Add New
                                        </button>
                                        <button onClick={() => setViewMode('upload')} className="bg-red-500 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-red-600">
                                            <Icons.Upload /> Upload NOS & PC
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>



                    {selectedSSC && (
                        <div className="bg-white rounded shadow border overflow-x-auto">
                            <table className="w-full min-w-[1200px]">
                                <thead className="bg-gray-50 border-b">
                                    <tr>
                                        <th className="p-3 text-left font-bold text-gray-700 border-r">Qualification Pack ID</th>
                                        <th className="p-3 text-left font-bold text-gray-700 border-r">Name</th>
                                        <th className="p-3 text-left font-bold text-gray-700 border-r">Level</th>
                                        <th className="p-3 text-left font-bold text-gray-700 border-r">Total Marks</th>
                                        <th className="p-3 text-left font-bold text-gray-700 border-r">Total Theory Marks</th>
                                        <th className="p-3 text-left font-bold text-gray-700 border-r">Total Practical Marks</th>
                                        <th className="p-3 text-left font-bold text-gray-700 border-r">Total Viva Marks</th>
                                        <th className="p-3 text-left font-bold text-gray-700 border-r">Theory Cutoff</th>
                                        <th className="p-3 text-left font-bold text-gray-700 border-r">Practical Cutoff</th>
                                        <th className="p-3 text-left font-bold text-gray-700 border-r">Viva Cutoff</th>
                                        <th className="p-3 text-left font-bold text-gray-700 border-r">Overall Cutoff</th>
                                        <th className="p-3 text-center font-bold text-gray-700">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {filteredQPs.map((qp) => (
                                        <tr key={qp.id} className="hover:bg-gray-50">
                                            <td className="p-3 font-bold text-red-500 border-r">{qp.code}</td>
                                            <td className="p-3 border-r max-w-xs truncate" title={qp.name}>{qp.name}</td>
                                            <td className="p-3 border-r">{qp.qpLevel || 'N/A'}</td>
                                            <td className="p-3 border-r">{Number(qp.totalMarks).toFixed(2)}</td>
                                            <td className="p-3 border-r">{Number(qp.theoryMarks).toFixed(2)}</td>
                                            <td className="p-3 border-r">{Number(qp.practicalMarks).toFixed(2)}</td>
                                            <td className="p-3 border-r">{Number(qp.vivaMarks).toFixed(2)}</td>
                                            <td className="p-3 border-r">{qp.isTheoryCutoff ? (qp.theoryCutoff || '0.00') : 'N/A'}</td>
                                            <td className="p-3 border-r">{qp.isPracticalCutoff ? (qp.practicalCutoff || '0.00') : 'N/A'}</td>
                                            <td className="p-3 border-r">{qp.isVivaCutoff ? (qp.vivaCutoff || '0.00') : 'N/A'}</td>
                                            <td className="p-3 border-r">{qp.isOverallCutoff ? (qp.overallCutoff || '0.00') : 'N/A'}</td>
                                            <td className="p-3 text-center flex justify-center gap-2">
                                                <button onClick={() => onNavigateToNOS(qp)} className="bg-cyan-700 text-white px-3 py-1 rounded text-xs flex items-center gap-1 hover:bg-cyan-800">
                                                    <Icons.Eye /> NOS
                                                </button>
                                                <button className="bg-cyan-700 text-white p-1 rounded hover:bg-cyan-800">
                                                    <Icons.Edit3 />
                                                </button>
                                                <button onClick={() => { if (confirm('Delete?')) { window.Utils.deleteQP(qp.id); setQPList(window.Utils.getQPs()); } }}
                                                    className="text-red-600 p-1 hover:bg-red-50 rounded"><Icons.Trash2 /></button>
                                            </td>
                                        </tr>
                                    ))}
                                    {filteredQPs.length === 0 && <tr><td colSpan="12" className="p-8 text-center text-gray-400">No records found</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    )}
                    {showModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                            <div className="bg-white rounded-xl p-8 w-full max-w-4xl my-8">
                                <h3 className="text-2xl font-bold mb-6 text-gray-800">Add Qualification Pack</h3>
                                <form onSubmit={handleCreate} className="space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">

                                        {/* Row 1 */}
                                        <div className="space-y-1">
                                            <label className="font-semibold text-gray-700">SSC</label>
                                            <select required className="w-full px-4 py-2 border rounded-lg" value={newQP.sscId} onChange={e => setNewQP({ ...newQP, sscId: e.target.value })}>
                                                <option value="">Select SSC</option>
                                                {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                            </select>
                                        </div>
                                        <div className="space-y-1">
                                            <label className="font-semibold text-gray-700">Qualification Pack Name</label>
                                            <input required className="w-full px-4 py-2 border rounded-lg" value={newQP.name} onChange={e => setNewQP({ ...newQP, name: e.target.value })} />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="font-semibold text-gray-700">Qualification Pack ID</label>
                                            <input required className="w-full px-4 py-2 border rounded-lg" value={newQP.code} onChange={e => setNewQP({ ...newQP, code: e.target.value })} />
                                        </div>

                                        {/* Row 2 */}
                                        <div className="space-y-1">
                                            <label className="font-semibold text-gray-700">Qualification Pack Level</label>
                                            <input className="w-full px-4 py-2 border rounded-lg" value={newQP.qpLevel} onChange={e => setNewQP({ ...newQP, qpLevel: e.target.value })} />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="font-semibold text-gray-700">Total Theory Marks</label>
                                            <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newQP.theoryMarks} onChange={e => setNewQP({ ...newQP, theoryMarks: e.target.value })} />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="font-semibold text-gray-700">Total Viva Marks</label>
                                            <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newQP.vivaMarks} onChange={e => setNewQP({ ...newQP, vivaMarks: e.target.value })} />
                                        </div>

                                        {/* Row 3 */}
                                        <div className="space-y-1">
                                            <label className="font-semibold text-gray-700">Total Practical Marks</label>
                                            <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newQP.practicalMarks} onChange={e => setNewQP({ ...newQP, practicalMarks: e.target.value })} />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="font-semibold text-gray-700">Total Marks</label>
                                            <input readOnly className="w-full px-4 py-2 border rounded-lg bg-gray-100" value={newQP.totalMarks} />
                                        </div>
                                    </div>

                                    {/* Checkboxes */}
                                    <div className="space-y-4 pt-4 border-t">
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" className="w-5 h-5 rounded" checked={newQP.isTheoryCutoff} onChange={e => setNewQP({ ...newQP, isTheoryCutoff: e.target.checked })} />
                                            <span className="font-medium text-gray-700">Is theory cutoff available</span>
                                        </label>
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" className="w-5 h-5 rounded" checked={newQP.isVivaCutoff} onChange={e => setNewQP({ ...newQP, isVivaCutoff: e.target.checked })} />
                                            <span className="font-medium text-gray-700">Is Viva cutoff available</span>
                                        </label>
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" className="w-5 h-5 rounded" checked={newQP.isPracticalCutoff} onChange={e => setNewQP({ ...newQP, isPracticalCutoff: e.target.checked })} />
                                            <span className="font-medium text-gray-700">Is practical cutoff available</span>
                                        </label>
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" className="w-5 h-5 rounded" checked={newQP.isOverallCutoff} onChange={e => setNewQP({ ...newQP, isOverallCutoff: e.target.checked })} />
                                            <span className="font-medium text-gray-700">Is overall cutoff available</span>
                                        </label>
                                    </div>

                                    <div className="flex gap-4 justify-end pt-6 border-t">
                                        <button type="button" onClick={() => setShowModal(false)} className="px-6 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium border border-gray-300">Cancel</button>
                                        <button type="submit" className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium shadow-md">Create</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // NOS & PC TAB
        const NOSPC_Tab = ({ selectedQP, onBack }) => {
            const [nosList, setNOSList] = useState([]);
            const [qpList, setQPList] = useState([]);
            const [pcList, setPCList] = useState([]);
            const [sscList, setSSCList] = useState([]);
            const [showNOSModal, setShowNOSModal] = useState(false);
            const [showPCModal, setShowPCModal] = useState(false);
            const [selectedNOS, setSelectedNOS] = useState(null);
            const [expandedNOS, setExpandedNOS] = useState([]);

            const [newNOS, setNewNOS] = useState({
                name: '', code: '', qpId: selectedQP?.id || '',
                theoryCutoff: '', vivaCutoff: '', practicalCutoff: '', overallCutoff: ''
            });
            const [newPC, setNewPC] = useState({ name: '', code: '' });

            useEffect(() => {
                const load = () => {
                    setSSCList(window.Utils.getSSC());
                    setQPList(window.Utils.getQPs()); // Updates QP list too
                    setNOSList(window.Utils.getNOS());
                    setPCList(window.Utils.getPCs());
                };
                load();
                window.addEventListener('cloud-sync-complete', load);
                return () => window.removeEventListener('cloud-sync-complete', load);
            }, []);

            // Auto-Heal: Silently bring in data from Duplicate QPs
            useEffect(() => {
                if (!selectedQP) return;

                const allNOS = window.Utils.getNOS();
                const allQPs = window.Utils.getQPs();

                // Find "ghost" QPs (same code, diff ID)
                const ghosts = allQPs.filter(q => q.code === selectedQP.code && q.id !== selectedQP.id);
                if (ghosts.length === 0) return;

                const ghostIDs = ghosts.map(g => g.id);

                // Check if any NOS belongs to a ghost
                const orphans = allNOS.filter(n => ghostIDs.includes(n.qpId));

                if (orphans.length > 0) {
                    // Move them to current QP
                    const updatedNOS = allNOS.map(n => {
                        if (ghostIDs.includes(n.qpId)) {
                            return { ...n, qpId: selectedQP.id };
                        }
                        return n;
                    });

                    window.Utils.saveNOSList ? window.Utils.saveNOSList(updatedNOS) : localStorage.setItem('se_nos', JSON.stringify(updatedNOS));
                    console.log(`Auto-Healed ${orphans.length} NOS records from duplicate QPs.`);
                    setNOSList(updatedNOS);
                }
            }, [selectedQP]);

            const handleCreateNOS = (e) => {
                e.preventDefault();
                const nos = { ...newNOS, id: window.Utils.generateId(), createdAt: new Date().toISOString() };
                window.Utils.saveNOS(nos);
                window.Utils.uploadToCloud(true);
                setNOSList(window.Utils.getNOS());
                setShowNOSModal(false);
                setNewNOS({ name: '', code: '', qpId: selectedQP?.id || '', theoryCutoff: '', vivaCutoff: '', practicalCutoff: '', overallCutoff: '' });
            };

            const handleCreatePC = (e) => {
                e.preventDefault();
                if (!selectedNOS) return;
                const pc = {
                    ...newPC,
                    id: window.Utils.generateId(),
                    nosId: selectedNOS.id,
                    createdAt: new Date().toISOString(),
                    theoryMarks: 0, practicalMarks: 0, vivaMarks: 0, totalMarks: 0
                };
                window.Utils.savePC(pc);
                window.Utils.uploadToCloud(true);
                setPCList(window.Utils.getPCs());
                setShowPCModal(false);
                setNewPC({ name: '', code: '' });
            };

            const openPCModal = (nos) => {
                setSelectedNOS(nos);
                setShowPCModal(true);
            };

            const toggleExpand = (nosId) => {
                setExpandedNOS(prev => prev.includes(nosId) ? prev.filter(id => id !== nosId) : [...prev, nosId]);
            };

            const handlePCMarkChange = (pcId, field, value) => {
                const updatedPCs = pcList.map(pc => {
                    if (pc.id === pcId) {
                        const updatedPC = { ...pc, [field]: parseFloat(value) || 0 };
                        updatedPC.totalMarks = (updatedPC.theoryMarks || 0) + (updatedPC.practicalMarks || 0) + (updatedPC.vivaMarks || 0);
                        // Removed auto-save: window.Utils.savePC(updatedPC);
                        return updatedPC;
                    }
                    return pc;
                });
                setPCList(updatedPCs);
            };

            const handleSavePC = (pcId) => {
                const pcToSave = pcList.find(p => p.id === pcId);
                if (pcToSave) {
                    window.Utils.savePC(pcToSave);
                    alert("Marks saved successfully!");
                }
            };

            const getQPName = (id) => qpList.find(q => q.id === id)?.name || id;
            const getSSCName = (id) => sscList.find(s => s.id === id)?.name || id;

            const filteredNOS = selectedQP ? nosList.filter(n => n.qpId === selectedQP.id) : nosList;

            return (
                <div className="animate-fade-in text-sm">
                    {selectedQP ? (
                        <div className="mb-6">
                            <div className="flex justify-between items-start mb-6">
                                <h2 className="text-xl font-bold text-gray-800">Sector Skill Council : {getSSCName(selectedQP.sscId)}</h2>
                                <div className="text-right">
                                    <h2 className="text-xl font-bold text-gray-800">Qualification Pack : {selectedQP.name}</h2>
                                    <button onClick={onBack} className="mt-2 text-indigo-600 hover:text-indigo-800 text-sm font-medium">← Back to QPs</button>
                                </div>
                            </div>

                            <div className="grid grid-cols-3 bg-gray-50 p-4 rounded-lg border border-gray-100 text-sm font-medium text-gray-600">
                                <div>Total Theory Marks : {Number(selectedQP.theoryMarks).toFixed(2)}</div>
                                <div className="text-center">Total Practical Marks : {Number(selectedQP.practicalMarks).toFixed(2)}</div>
                                <div className="text-right">Total Viva Marks : {Number(selectedQP.vivaMarks).toFixed(2)}</div>
                            </div>
                        </div>
                    ) : (
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">All NOS</h2>
                        </div>
                    )}

                    {!selectedQP && <div className="p-4 mb-4 bg-yellow-50 text-yellow-800 rounded border border-yellow-200">Please select a Qualification Pack to view NOS details.</div>}

                    {selectedQP && (
                        <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50 border-b">
                                    <tr>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-12 text-center">Sr.#</th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-10"></th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-32">NOS ID</th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r">NOS</th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-24">Theory Cutoff</th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-24">Practical Cutoff</th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-24">Viva Cutoff</th>
                                        <th className="p-3 text-left font-bold text-gray-600 border-r w-24">Overall Cutoff</th>
                                        <th className="p-3 text-center font-bold text-gray-600 w-48">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {filteredNOS.map((nos, idx) => (
                                        <React.Fragment key={nos.id}>
                                            <tr className="hover:bg-gray-50">
                                                <td className="p-3 border-r text-center">{idx + 1}</td>
                                                <td className="p-3 border-r text-center">
                                                    <button onClick={() => toggleExpand(nos.id)} className="text-gray-500 hover:text-indigo-600">
                                                        {expandedNOS.includes(nos.id) ? <Icons.MinusSquare /> : <Icons.PlusSquare />}
                                                    </button>
                                                </td>
                                                <td className="p-3 font-bold text-green-600 border-r">{nos.code}</td>
                                                <td className="p-3 border-r">{nos.name}</td>
                                                <td className="p-3 border-r">{nos.theoryCutoff || '0.00'}</td>
                                                <td className="p-3 border-r">{nos.practicalCutoff || '0.00'}</td>
                                                <td className="p-3 border-r">{nos.vivaCutoff || '0.00'}</td>
                                                <td className="p-3 border-r">{nos.overallCutoff || '0.00'}</td>
                                                <td className="p-3 text-center flex justify-center gap-2">
                                                    <button className="bg-cyan-700 text-white p-2 rounded hover:bg-cyan-800">
                                                        <Icons.Edit3 className="w-4 h-4" />
                                                    </button>
                                                    <button onClick={() => { if (confirm('Delete?')) { window.Utils.deleteNOS(nos.id); setNOSList(window.Utils.getNOS()); } }}
                                                        className="bg-cyan-700 text-white p-2 rounded hover:bg-cyan-800"><Icons.Trash2 className="w-4 h-4" /></button>
                                                    <button onClick={() => openPCModal(nos)} className="bg-red-500 text-white px-3 py-1 rounded flex items-center gap-1 hover:bg-red-600 text-xs font-bold">
                                                        <Icons.Plus className="w-3 h-3" /> PC's
                                                    </button>
                                                </td>
                                            </tr>
                                            {expandedNOS.includes(nos.id) && (
                                                <tr className="bg-gray-50/50">
                                                    <td colSpan="9" className="p-4 pl-12">
                                                        <div className="bg-white border rounded-lg overflow-hidden shadow-sm">
                                                            <table className="w-full text-sm">
                                                                <thead className="bg-gray-100 border-b">
                                                                    <tr>
                                                                        <th className="p-3 border-r w-12 text-center">Sr.#</th>
                                                                        <th className="p-3 border-r w-32 font-bold text-blue-600">PC ID</th>
                                                                        <th className="p-3 border-r">PC Name</th>
                                                                        <th className="p-3 border-r w-24">Total Marks</th>
                                                                        <th className="p-3 border-r w-32">Theory Marks</th>
                                                                        <th className="p-3 border-r w-32">Practical Marks</th>
                                                                        <th className="p-3 border-r w-32">Viva Marks</th>
                                                                        <th className="p-3 text-center w-24">Actions</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody className="divide-y">
                                                                    {pcList.filter(p => p.nosId === nos.id).map((pc, pcIdx) => (
                                                                        <tr key={pc.id}>
                                                                            <td className="p-3 border-r text-center">{pcIdx + 1}</td>
                                                                            <td className="p-3 border-r font-bold text-blue-600">{pc.code}</td>
                                                                            <td className="p-3 border-r">{pc.name}</td>
                                                                            <td className="p-3 border-r font-bold">{((parseFloat(pc.theoryMarks) || 0) + (parseFloat(pc.practicalMarks) || 0) + (parseFloat(pc.vivaMarks) || 0)).toFixed(2)}</td>
                                                                            <td className="p-3 border-r">
                                                                                <input type="number" className="w-full p-1 border rounded text-xs"
                                                                                    value={pc.theoryMarks} onChange={e => handlePCMarkChange(pc.id, 'theoryMarks', e.target.value)} />
                                                                            </td>
                                                                            <td className="p-3 border-r">
                                                                                <input type="number" className="w-full p-1 border rounded text-xs"
                                                                                    value={pc.practicalMarks} onChange={e => handlePCMarkChange(pc.id, 'practicalMarks', e.target.value)} />
                                                                            </td>
                                                                            <td className="p-3 border-r">
                                                                                <input type="number" className="w-full p-1 border rounded text-xs"
                                                                                    value={pc.vivaMarks} onChange={e => handlePCMarkChange(pc.id, 'vivaMarks', e.target.value)} />
                                                                            </td>
                                                                            <td className="p-3 text-center flex justify-center gap-1">
                                                                                <button onClick={() => { handleSavePC(pc.id); window.Utils.uploadToCloud(true); }} className="bg-green-600 text-white p-1 rounded hover:bg-green-700" title="Save Marks"><Icons.Save className="w-3 h-3" /></button>
                                                                                <button className="bg-cyan-700 text-white p-1 rounded hover:bg-cyan-800"><Icons.Edit3 className="w-3 h-3" /></button>
                                                                                <button onClick={() => { if (confirm('Delete PC?')) { window.Utils.deletePC(pc.id); setPCList(window.Utils.getPCs()); window.Utils.uploadToCloud(true); } }}
                                                                                    className="bg-cyan-700 text-white p-1 rounded hover:bg-cyan-800"><Icons.Trash2 className="w-3 h-3" /></button>
                                                                            </td>
                                                                        </tr>
                                                                    ))}
                                                                    <tr className="bg-gray-100 font-bold">
                                                                        <td colSpan="3" className="p-3 text-right border-r">Total :</td>
                                                                        <td className="p-3 border-r text-center">
                                                                            {pcList.filter(p => p.nosId === nos.id).reduce((sum, p) => sum + ((parseFloat(p.theoryMarks) || 0) + (parseFloat(p.practicalMarks) || 0) + (parseFloat(p.vivaMarks) || 0)), 0).toFixed(2)}
                                                                        </td>
                                                                        <td className="p-3 border-r text-center">
                                                                            {pcList.filter(p => p.nosId === nos.id).reduce((sum, p) => sum + (parseFloat(p.theoryMarks) || 0), 0).toFixed(2)}
                                                                        </td>
                                                                        <td className="p-3 border-r text-center">
                                                                            {pcList.filter(p => p.nosId === nos.id).reduce((sum, p) => sum + (parseFloat(p.practicalMarks) || 0), 0).toFixed(2)}
                                                                        </td>
                                                                        <td className="p-3 border-r text-center">
                                                                            {pcList.filter(p => p.nosId === nos.id).reduce((sum, p) => sum + (parseFloat(p.vivaMarks) || 0), 0).toFixed(2)}
                                                                        </td>
                                                                        <td></td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </td>
                                                </tr>
                                            )}
                                        </React.Fragment>
                                    ))}
                                    {filteredNOS.length === 0 && <tr><td colSpan="9" className="p-8 text-center text-gray-400">No NOS found for this QP</td></tr>}
                                </tbody>
                            </table>

                            {/* Data Recovery Helper: Only shows if data exists but isn't visible due to ID mismatch */}
                            {nosList.length > 0 && filteredNOS.length === 0 && (
                                <div className="p-4 bg-yellow-50 text-yellow-800 border-t border-yellow-100 flex items-start gap-3">
                                    <Icons.TriangleAlert className="w-5 h-5 flex-shrink-0 mt-0.5" />
                                    <div>
                                        <h4 className="font-bold text-sm">Missing Data?</h4>
                                        <p className="text-xs mt-1 mb-2">
                                            The system found {nosList.length} NOS records, but they aren't showing here.
                                            This usually happens if they were uploaded to a duplicate Qualification Pack.
                                        </p>
                                        <button onClick={() => {
                                            const ghostID = nosList[0]?.qpId;
                                            if (!ghostID) return;
                                            const allNOS = window.Utils.getNOS();
                                            let updatedCount = 0;
                                            const updatedNOS = allNOS.map(n => {
                                                if (n.qpId === ghostID) {
                                                    updatedCount++;
                                                    return { ...n, qpId: selectedQP.id };
                                                }
                                                return n;
                                            });
                                            localStorage.setItem('se_nos', JSON.stringify(updatedNOS));
                                            alert(`Fixed! Linked ${updatedCount} NOS records to this Qualification Pack. Refreshing...`);
                                            setNOSList(updatedNOS);
                                        }} className="bg-red-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-red-700 shadow-sm">
                                            Fix & Link Data to {selectedQP?.code}
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {selectedQP && (
                        <div className="mt-4 flex justify-end">
                            <button onClick={() => setShowNOSModal(true)} className="bg-red-500 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-red-600">
                                <Icons.Plus /> Add NOS
                            </button>
                        </div>
                    )}

                    {showNOSModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                            <div className="bg-white rounded-xl p-8 w-full max-w-2xl">
                                <h3 className="text-xl font-bold mb-6">Add NOS</h3>
                                <form onSubmit={handleCreateNOS} className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="col-span-2">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">NOS Name</label>
                                            <input required className="w-full px-4 py-2 border rounded-lg" value={newNOS.name} onChange={e => setNewNOS({ ...newNOS, name: e.target.value })} />
                                        </div>
                                        <div className="col-span-2">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">NOS ID</label>
                                            <input required className="w-full px-4 py-2 border rounded-lg" value={newNOS.code} onChange={e => setNewNOS({ ...newNOS, code: e.target.value })} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Theory Cutoff</label>
                                            <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newNOS.theoryCutoff} onChange={e => setNewNOS({ ...newNOS, theoryCutoff: e.target.value })} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Practical Cutoff</label>
                                            <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newNOS.practicalCutoff} onChange={e => setNewNOS({ ...newNOS, practicalCutoff: e.target.value })} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Viva Cutoff</label>
                                            <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newNOS.vivaCutoff} onChange={e => setNewNOS({ ...newNOS, vivaCutoff: e.target.value })} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Overall Cutoff</label>
                                            <input type="number" className="w-full px-4 py-2 border rounded-lg" value={newNOS.overallCutoff} onChange={e => setNewNOS({ ...newNOS, overallCutoff: e.target.value })} />
                                        </div>
                                    </div>
                                    <div className="flex gap-4 justify-end pt-4">
                                        <button type="button" onClick={() => setShowNOSModal(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                                        <button type="submit" className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Create</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {showPCModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl p-6 w-full max-w-lg">
                                <h3 className="text-xl font-bold mb-2">Manage PCs</h3>
                                <p className="text-sm text-gray-500 mb-4">For NOS: <span className="font-bold">{selectedNOS?.name}</span></p>

                                <div className="max-h-60 overflow-y-auto mb-4 border rounded p-2">
                                    <table className="w-full text-left text-sm">
                                        <thead>
                                            <tr className="bg-gray-50">
                                                <th className="p-2 border-b">Code</th>
                                                <th className="p-2 border-b">PC Name</th>
                                                <th className="p-2 border-b w-10"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {pcList.filter(p => p.nosId === selectedNOS?.id).map(pc => (
                                                <tr key={pc.id} className="border-b last:border-0 hover:bg-gray-50">
                                                    <td className="p-2 font-mono text-xs">{pc.code}</td>
                                                    <td className="p-2">{pc.name}</td>
                                                    <td className="p-2 text-center">
                                                        <button onClick={() => { window.Utils.deletePC(pc.id); setPCList(window.Utils.getPCs()); }} className="text-red-500 hover:text-red-700"><Icons.Trash2 className="w-4 h-4" /></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {pcList.filter(p => p.nosId === selectedNOS?.id).length === 0 && <p className="text-xs text-gray-400 text-center py-4">No PCs added yet</p>}
                                </div>

                                <form onSubmit={handleCreatePC} className="space-y-4 border-t pt-4">
                                    <div className="flex gap-4">
                                        <input placeholder="PC Code (e.g. PC1)" required className="w-1/3 px-4 py-2 border rounded-lg" value={newPC.code} onChange={e => setNewPC({ ...newPC, code: e.target.value })} />
                                        <input placeholder="PC Name" required className="flex-1 px-4 py-2 border rounded-lg" value={newPC.name} onChange={e => setNewPC({ ...newPC, name: e.target.value })} />
                                    </div>
                                    <div className="flex gap-2 justify-end">
                                        <button type="button" onClick={() => setShowPCModal(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Done</button>
                                        <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Add PC</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // QUESTION PAPERS TAB
        // QUESTION PAPERS TAB
        const QuestionPapersTab = () => {

            const [qpList, setQPList] = useState([]);
            const [allQPs, setAllQPs] = useState([]); // Store all QPs for filtering
            const [showUploadModal, setShowUploadModal] = useState(false);
            const [qpName, setQPName] = useState('');
            const [uploadPaperType, setUploadPaperType] = useState('THEORY'); // Default to Theory
            const [selectedQP, setSelectedQP] = useState(null);

            // New State for Filters
            const [sscList, setSSCList] = useState([]);
            const [masterQPList, setMasterQPList] = useState([]); // List of defined QPs from QP Tab
            const [selectedSSC, setSelectedSSC] = useState('');
            const [filterQPId, setFilterQPId] = useState('');

            useEffect(() => {
                setAllQPs(window.Utils.getQuestionPapers());
                setQPList(window.Utils.getQuestionPapers());
                setSSCList(window.Utils.getSSC());
                setMasterQPList(window.Utils.getQPs());
            }, []);

            // Apply Filters
            useEffect(() => {
                let filtered = allQPs;
                // Note: Currently uploaded QPs don't have explicit SSC link unless we infer or add manual mapping.
                // Assuming "Qualification Pack" filter refers to the QP Definition from QP Tab.
                // We might need to match by name or add a field during upload. 
                // The uploaded QP is independent currently. 
                // To make this functional as per mockup, we'll implement the UI. 
                // Real filtering would depend on data linkage. 
                // Let's filter by name match if possible or just show UI if no linkage exists.

                // If the intention is just to show the UI:
                // We will implement the UI. Filtering might be minimal if data is missing.

            }, [selectedSSC, filterQPId, allQPs]);

            const handleDownloadSample = () => {
                const headers = [['Question', 'Option1', 'Option2', 'Option3', 'Option4', 'CorrectOption', 'NoofOptions', 'QuestionTypeID', 'PCIDsWithMarks']];
                let data = [];

                if (uploadPaperType === 'THEORY') {
                    data = [
                        ['What is the capital of France?', 'London', 'Berlin', 'Paris', 'Madrid', 'Paris', '4', 'MCQ', 'PC1:2'],
                        ['Which is a prime number?', '4', '6', '7', '9', '7', '4', 'MCQ', 'PC1:2']
                    ];
                } else if (uploadPaperType === 'PRACTICAL') {
                    data = [
                        ['Demonstrate safe handling of chemical tools.', '', '', '', '', '', '0', 'PRACTICAL', 'PC4:10'],
                        ['Write a function to calculate factorial.', '', '', '', '', '', '0', 'CODING', 'PC2:5']
                    ];
                } else if (uploadPaperType === 'VIVA') {
                    data = [
                        ['Explain the importance of hygiene.', '', '', '', '', '', '0', 'VIVA', 'PC1:2'],
                        ['Describe the steps of the procedure you performed.', '', '', '', '', '', '0', 'VIVA', 'PC2:3']
                    ];
                }

                const ws = window.XLSX.utils.aoa_to_sheet([...headers, ...data]);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, "Questions");
                window.XLSX.writeFile(wb, `Sample_${uploadPaperType}_Format.xlsx`);
            };

            const handleExcelUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet);

                    const questions = rows.map((row, idx) => {
                        const questionType = (row.QuestionTypeID || '').toString().toUpperCase();
                        const isCoding = questionType === 'CODING';
                        const isPractical = questionType === 'PRACTICAL';
                        const isViva = questionType === 'VIVA';
                        const noOfOptions = (isCoding || isPractical || isViva) ? 0 : parseInt(row.Noofoptions || 4);

                        // Parse PCIDsWithMarks (e.g., "PC1:5,PC2:3")
                        const pcMapping = {};
                        let calculatedMarks = 0;
                        if (row.PCIDsWithMarks) {
                            row.PCIDsWithMarks.toString().split(',').forEach(item => {
                                const parts = item.split(':');
                                if (parts.length === 2) {
                                    const pcId = parts[0].trim();
                                    const marks = parseFloat(parts[1]);
                                    if (!isNaN(marks)) {
                                        pcMapping[pcId] = marks;
                                        calculatedMarks += marks;
                                    }
                                }
                            });
                        }
                        return {
                            id: window.Utils.generateId(),
                            question: row.Question || row.question || '',
                            questionType: questionType || 'MCQ',
                            options: (isCoding || isPractical || isViva) ? [] : [row.Option1, row.Option2, row.Option3, row.Option4, row.Option5].filter((o, i) => i < noOfOptions && o),
                            correctAnswer: row.Solution || row.Answer || row.CorrectOption || '',
                            totalMarks: calculatedMarks > 0 ? calculatedMarks : parseFloat(row.Marks || 1),
                            pcMapping: pcMapping
                        };
                    });

                    // Validation: Check Total Theory Marks
                    const currentQPDef = masterQPList.find(q => q.id === filterQPId);
                    if (currentQPDef) {
                        const uploadedTheoryMarks = questions.reduce((sum, q) => {
                            if (q.questionType !== 'VIVA') {
                                return sum + q.totalMarks;
                            }
                            return sum;
                        }, 0);
                        const theoryMismatch = Math.abs(uploadedTheoryMarks - parseFloat(currentQPDef.theoryMarks || 0)) > 0.1;
                        if (theoryMismatch) {
                            alert(`Error: Uploaded Theory Marks (${uploadedTheoryMarks}) do not match QP Theory Marks (${currentQPDef.theoryMarks}).`);
                            return;
                        }
                    }

                    const qp = {
                        id: window.Utils.generateId(),
                        qpName: qpName || `${masterQPList.find(q => q.id === filterQPId)?.name || 'Question Paper'} - ${uploadPaperType}`,
                        questions: questions,
                        totalMarks: questions.reduce((sum, q) => sum + q.totalMarks, 0),
                        totalTime: 60,
                        createdAt: new Date().toISOString(),
                        sscId: selectedSSC,
                        qpId: filterQPId,
                        paperType: uploadPaperType
                    };
                    window.Utils.saveQuestionPaper(qp);
                    window.Utils.uploadToCloud(true);
                    setQPList(window.Utils.getQuestionPapers());
                    setShowUploadModal(false);
                    setQPName('');
                    alert('Question Paper uploaded successfully!');
                };
                reader.readAsArrayBuffer(file);
            };

            return (
                <div className="animate-fade-in text-sm">
                    {/* Breadcrumb */}
                    <div className="flex items-center gap-2 text-xs text-green-600 mb-2">
                        <span>Home</span>
                        <span>/</span>
                        <span className="text-gray-600">Question Papers</span>
                    </div>

                    <h3 className="text-2xl font-bold mb-6 text-gray-800">Question Papers</h3>

                    <div className="bg-white p-8 rounded-none shadow-sm border border-gray-100 mb-8 max-w-5xl">
                        <div className="grid grid-cols-[150px_1fr] gap-y-6 gap-x-8 items-center max-w-3xl">
                            <label className="font-bold text-gray-700">Select Sector :</label>
                            <select className="w-full p-2 border border-gray-300 rounded text-sm outline-none focus:border-blue-500 transition-all text-gray-600"
                                value={selectedSSC} onChange={e => setSelectedSSC(e.target.value)}>
                                <option value="">--Select Sector--</option>
                                {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>

                            <label className="font-bold text-gray-700">Qualification Pack:</label>
                            <select className="w-full p-2 border border-gray-300 rounded text-sm outline-none focus:border-blue-500 transition-all text-gray-600"
                                value={filterQPId} onChange={e => setFilterQPId(e.target.value)}>
                                <option value="">Select QP</option>
                                {masterQPList.filter(q => !selectedSSC || q.sscId === selectedSSC).map(q => (
                                    <option key={q.id} value={q.id}>{q.name}</option>
                                ))}
                            </select>
                        </div>
                    </div>

                    {/* Action Bar (Only visible if filters selected or if we want to allow upload always) */}
                    <div className="flex justify-between items-center mb-4">
                        <div className="text-gray-500 text-xs">

                        </div>
                        <button onClick={() => setShowUploadModal(true)}
                            className="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium shadow-sm transition-colors flex items-center gap-2">
                            <Icons.Upload className="w-4 h-4" /> Upload Question Paper
                        </button>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
                        <table className="w-full text-left border-collapse">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="p-4 font-bold text-gray-600 border-r w-16 text-center">Sr.#</th>
                                    <th className="p-4 font-bold text-gray-600 border-r">Details</th>
                                    <th className="p-4 font-bold text-gray-600 border-r">Sector / QP</th>
                                    <th className="p-4 font-bold text-gray-600 border-r w-32 text-center">Marks</th>
                                    <th className="p-4 font-bold text-gray-600 border-r w-32 text-center">Questions</th>
                                    <th className="p-4 font-bold text-gray-600 w-24 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {qpList.filter(q => selectedSSC && filterQPId && q.sscId === selectedSSC && q.qpId === filterQPId).map((qp, idx) => (
                                    <tr key={qp.id} className="hover:bg-gray-50 transition-colors">
                                        <td className="p-4 border-r text-center text-gray-500">{idx + 1}</td>
                                        <td className="p-4 border-r">
                                            <div className="font-bold text-gray-800">{qp.qpName}</div>
                                            <div className="text-xs text-gray-400 mt-1">{new Date(qp.createdAt).toLocaleDateString()}</div>
                                        </td>
                                        <td className="p-4 border-r">
                                            <div className="text-xs font-semibold text-gray-600 mb-1">{sscList.find(s => s.id === qp.sscId)?.name || '-'}</div>
                                            <div className="text-xs text-gray-500">{masterQPList.find(q => q.id === qp.qpId)?.name || '-'}</div>
                                        </td>
                                        <td className="p-4 border-r text-center font-medium text-gray-700">{qp.totalMarks}</td>
                                        <td className="p-4 border-r text-center font-medium text-gray-700">{qp.questions.length}</td>
                                        <td className="p-4 text-center">
                                            <button onClick={() => { if (confirm('Delete?')) { window.Utils.deleteQuestionPaper(qp.id); setQPList(window.Utils.getQuestionPapers()); window.Utils.uploadToCloud(true); } }}
                                                className="text-red-500 hover:text-red-700 p-2 hover:bg-red-50 rounded-full transition-colors" title="Delete">
                                                <Icons.Trash2 className="w-4 h-4" />
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                                {qpList.length === 0 && (
                                    <tr>
                                        <td colSpan="6" className="p-8 text-center text-gray-400">No question papers found.</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>

                    {showUploadModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white w-full max-w-4xl my-8 shadow-2xl rounded-xl overflow-hidden animate-scale-in">
                                <div className="bg-gray-50 px-8 py-5 flex justify-between items-center border-b">
                                    <h3 className="text-xl font-bold text-gray-800">Upload Question Paper</h3>
                                    <button onClick={() => setShowUploadModal(false)} className="text-gray-400 hover:text-red-500 transition-colors">
                                        <Icons.XCircle className="w-6 h-6" />
                                    </button>
                                </div>

                                <div className="p-8 max-h-[80vh] overflow-y-auto">
                                    <div className="grid grid-cols-[auto_1fr] gap-x-4 gap-y-2 mb-8 bg-blue-50 p-4 rounded-lg border border-blue-100">
                                        <div className="font-bold text-gray-700 text-right">Selected Sector:</div>
                                        <div className="text-gray-800">{sscList.find(s => s.id === selectedSSC)?.name || '-'}</div>
                                        <div className="font-bold text-gray-700 text-right">Selected QP:</div>
                                        <div className="text-gray-800">
                                            {masterQPList.find(q => q.id === filterQPId)?.name || '-'}
                                            <span className="text-xs text-gray-500 ml-2">(Total Marks: {masterQPList.find(q => q.id === filterQPId)?.totalMarks || 0}, Theory: {masterQPList.find(q => q.id === filterQPId)?.theoryMarks || 0})</span>
                                        </div>
                                        <div className="font-bold text-gray-700 text-right">Paper Type:</div>
                                        <div>
                                            <select value={uploadPaperType} onChange={e => setUploadPaperType(e.target.value)} className="p-1 border rounded bg-white text-sm">
                                                <option value="THEORY">Theory</option>
                                                <option value="PRACTICAL">Practical</option>
                                                <option value="VIVA">Viva</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="mb-6 space-y-3">
                                        <p className="text-gray-600 text-sm">
                                            <span className="font-bold text-red-500">Note:</span> Only Excel files (*.xls, *.xlsx) are accepted.
                                        </p>
                                        <div className="flex items-center gap-2 text-sm">
                                            <span>Use the standard format:</span>
                                            <button onClick={handleDownloadSample} className="text-green-600 font-medium hover:underline flex items-center gap-1">
                                                <Icons.Download className="w-4 h-4" /> Download Sample Format
                                            </button>
                                        </div>
                                    </div>

                                    <div className="border rounded-lg overflow-hidden mb-8 shadow-sm">
                                        <table className="w-full text-left text-xs">
                                            <thead className="bg-gray-100 text-gray-700">
                                                <tr>
                                                    {['Question', 'Option1', 'Option2', 'Option3', 'Option4', 'Solution', 'NoofOptions', 'QuestionTypeID', 'PCIDsWithMarks'].map(h => (
                                                        <th key={h} className="p-2 border-r last:border-r-0 font-bold">{h}</th>
                                                    ))}
                                                </tr>
                                            </thead>
                                            <tbody className="text-gray-500">
                                                <tr>
                                                    <td className="p-2 border-r">Sample Question?</td>
                                                    <td className="p-2 border-r">A</td>
                                                    <td className="p-2 border-r">B</td>
                                                    <td className="p-2 border-r">C</td>
                                                    <td className="p-2 border-r">D</td>
                                                    <td className="p-2 border-r">Option1</td>
                                                    <td className="p-2 border-r">4</td>
                                                    <td className="p-2 border-r">MCQ</td>
                                                    <td className="p-2">PC1:5,PC2:3</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center bg-gray-50 hover:bg-gray-100 transition-colors cursor-pointer relative">
                                        <input type="file" accept=".xlsx, .xls" onChange={handleExcelUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                        <div className="pointer-events-none">
                                            <Icons.UploadCloud className="w-12 h-12 text-gray-400 mx-auto mb-3" />
                                            <p className="font-medium text-gray-600">Drag & Drop or Click to Upload Excel File</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // LIVE VIVA CONSOLE (SIMULATOR -> REAL WEBRTC)
        const LiveVivaConsole = ({ batch, student, onClose, embedded = false }) => {
            const [stream, setStream] = useState(null);
            const [remoteStream, setRemoteStream] = useState(null);
            const [videoEnabled, setVideoEnabled] = useState(true);
            const [audioEnabled, setAudioEnabled] = useState(true);
            const [currentQIdx, setCurrentQIdx] = useState(0);
            const [marks, setMarks] = useState({});
            const [remarks, setRemarks] = useState('');
            const [genericScore, setGenericScore] = useState('');

            const videoRef = useRef(null);
            const mediaRecorderRef = useRef(null);
            const chunksRef = useRef([]);
            const socketRef = useRef(null);
            const peerRef = useRef(null);

            // WebRTC Signaling Logic
            useEffect(() => {
                // Initialize Socket
                socketRef.current = io(SERVER_URL);
                const socket = socketRef.current;
                // Fix: Join the specific student's room, not just the batch room
                const roomId = `${batch.id}_${student.id}`;

                socket.emit('join-room', roomId, 'assessor');

                // Initialize PeerConnection
                peerRef.current = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                const pc = peerRef.current;

                // Handle ICE Candidates
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.emit('signal', { roomId, signal: { type: 'candidate', candidate: event.candidate } });
                    }
                };

                // Handle Remote Stream (Student Video)
                pc.ontrack = (event) => {
                    setRemoteStream(event.streams[0]);
                };

                // Signaling Handlers
                socket.on('user-connected', async (userId) => {
                    console.log('User Connected:', userId);
                    // Create Offer (Assessor initiates as they are the host)
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    socket.emit('signal', { roomId, signal: { type: 'offer', sdp: offer } });
                });

                socket.on('signal', async (data) => {
                    if (!data.signal) return;

                    if (data.signal.type === 'answer') {
                        await pc.setRemoteDescription(new RTCSessionDescription(data.signal.sdp));
                    } else if (data.signal.type === 'candidate') {
                        await pc.addIceCandidate(new RTCIceCandidate(data.signal.candidate));
                    } else if (data.signal.type === 'offer') {
                        // If student initiated (reconnect?), handle offer
                        await pc.setRemoteDescription(new RTCSessionDescription(data.signal.sdp));
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        socket.emit('signal', { roomId, signal: { type: 'answer', sdp: answer } });
                    }
                });

                return () => {
                    socket.disconnect();
                    if (peerRef.current) peerRef.current.close();
                };
            }, [batch.id, student.id]);

            // Add Local Stream to Peer Connection
            useEffect(() => {
                if (stream && peerRef.current) {
                    stream.getTracks().forEach(track => {
                        // Check if track already added to avoid error
                        const senders = peerRef.current.getSenders();
                        const exists = senders.find(s => s.track === track);
                        if (!exists) peerRef.current.addTrack(track, stream);
                    });
                }
            }, [stream]);

            // Load QP (Viva or Practical)
            const allQPs = window.Utils.getQuestionPapers();
            // Prioritize Viva Paper, then Practical
            const qpId = batch.vivaPaperId || batch.practicalPaperId;
            const qp = allQPs.find(q => q.id === qpId);
            const questions = qp?.questions || [];
            const isGeneric = questions.length === 0;

            useEffect(() => {
                // Start Camera
                navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                    .then(s => {
                        setStream(s);
                        if (videoRef.current) videoRef.current.srcObject = s;
                    })
                    .catch(err => alert("Camera Error: " + err.message));

                return () => {
                    if (stream) stream.getTracks().forEach(t => t.stop());
                };
            }, []);

            // Record REMOTE STREAM (Student) when available
            useEffect(() => {
                if (!remoteStream) return;

                console.log("Starting Recording of Student Stream");
                let options = { mimeType: 'video/webm; codecs=vp8' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options = { mimeType: 'video/webm' };
                }

                try {
                    const recorder = new MediaRecorder(remoteStream, options);
                    mediaRecorderRef.current = recorder;
                    chunksRef.current = []; // Start fresh for student video

                    recorder.ondataavailable = (e) => {
                        if (e.data.size > 0) chunksRef.current.push(e.data);
                    };
                    recorder.start(1000);
                } catch (e) {
                    console.error("Failed to start recorder", e);
                }

                return () => {
                    if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
                        mediaRecorderRef.current.stop();
                    }
                };
            }, [remoteStream]);

            useEffect(() => {
                if (videoRef.current && stream) videoRef.current.srcObject = stream;
            }, [stream, videoRef.current]);

            const toggleVideo = () => {
                if (stream) {
                    stream.getVideoTracks().forEach(t => t.enabled = !videoEnabled);
                    setVideoEnabled(!videoEnabled);
                }
            };

            const toggleAudio = () => {
                if (stream) {
                    stream.getAudioTracks().forEach(t => t.enabled = !audioEnabled);
                    setAudioEnabled(!audioEnabled);
                }
            };

            const handleSave = async () => {
                // Stop Recording
                let videoKey = null;
                if (mediaRecorderRef.current) {
                    mediaRecorderRef.current.stop();
                    // Wait briefly for last chunk
                    await new Promise(r => setTimeout(r, 500));

                    if (chunksRef.current.length > 0) {
                        const blob = new Blob(chunksRef.current, { type: 'video/webm' });
                        videoKey = `viva_${batch.id}_${student.id}_${Date.now()}`;
                        try {
                            await VideoDB.saveVideo(videoKey, blob);
                            console.log("Viva Video Saved:", videoKey);
                        } catch (e) {
                            console.error("Failed to save video", e);
                            alert("Warning: Failed to save video recording. Marks will be saved.");
                        }
                    }
                }

                // Save marks to responses
                const finalScore = isGeneric ? parseFloat(genericScore || 0) : Object.values(marks).reduce((a, b) => a + parseFloat(b || 0), 0);
                const response = {
                    id: window.Utils.generateId(),
                    studentId: student.id,
                    batchId: batch.id,
                    examType: 'Viva',
                    videoKey: videoKey, // Link to recorded video
                    answers: {}, // Viva usually oral, no written answers stored here, maybe recordings
                    assessorMarks: isGeneric ? { 'Total Score': finalScore } : marks,
                    assessorRemarks: remarks,
                    totalScore: finalScore,
                    submittedAt: new Date().toISOString()
                };
                window.Utils.saveResponse(response);
                // Trigger background upload for marks
                window.Utils.uploadToCloud(true);
                alert("Viva Completed & Marks Saved! Video Recorded Successfully.");
                onClose();
            };



            return (
                <div className={`${embedded ? 'relative w-full h-full' : 'fixed inset-0 bg-gray-900 z-50'} flex text-white font-sans animate-fade-in`}>
                    {/* Left: Video Feed */}
                    {/* Left: Video Feed Area */}
                    <div className="w-3/5 relative bg-black flex items-center justify-center border-r border-gray-800 overflow-hidden group">

                        {/* 1. REAL REMOTE STUDENT FEED */}
                        <div className="absolute inset-0 flex flex-col items-center justify-center bg-gray-900">
                            {remoteStream ? (
                                <video
                                    ref={ref => { if (ref) ref.srcObject = remoteStream; }}
                                    autoPlay
                                    className="w-full h-full object-contain"
                                />
                            ) : (
                                <div className="text-center">
                                    <div className="w-32 h-32 rounded-full bg-gray-800 flex items-center justify-center mb-4 border-4 border-gray-700 shadow-xl relative mx-auto animate-pulse">
                                        <Icons.User className="w-16 h-16 text-gray-400" />
                                    </div>
                                    <h2 className="text-2xl font-bold text-white mb-1">Waiting for Student...</h2>
                                    <p className="text-xs text-gray-500">Ensure the student is online.</p>
                                </div>
                            )}

                            {/* 2. ASSESSOR SELF-VIEW (Picture-in-Picture) */}
                            <div className="absolute bottom-24 right-6 w-48 h-36 bg-gray-800 rounded-lg border-2 border-gray-700/50 shadow-2xl overflow-hidden hover:scale-105 transition-transform cursor-move z-20">
                                <video ref={videoRef} autoPlay muted className="w-full h-full object-cover transform scale-x-[-1]" />
                                <div className="absolute bottom-1 left-2 text-[10px] font-bold text-white/50">YOU</div>
                            </div>

                            {/* Recording Indicator */}
                            <div className="absolute top-6 left-6 bg-black/60 backdrop-blur-sm px-4 py-2 rounded-full text-sm font-bold flex items-center gap-2 border border-white/10 shadow-lg z-20">
                                <div className={`w-2.5 h-2.5 rounded-full ${remoteStream ? 'bg-red-500 animate-pulse' : 'bg-yellow-500'} shadow-[0_0_8px_rgba(239,68,68,0.6)]`}></div>
                                <span className="tracking-wide">REC • {remoteStream ? 'LIVE' : 'CONNECTING'}</span>
                            </div>

                            {/* Controls */}
                            <div className="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex gap-6 bg-black/40 backdrop-blur-md px-8 py-4 rounded-full border border-white/10 shadow-2xl z-30 hover:bg-black/60 transition-colors">
                                <button onClick={toggleAudio} className={`p-4 rounded-full ${audioEnabled ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-red-500 hover:bg-red-600 text-white'} transition-all shadow-lg transform hover:scale-105 active:scale-95`}>
                                    {audioEnabled ? <Icons.Microphone className="w-6 h-6" /> : <Icons.MicrophoneOff className="w-6 h-6" />}
                                </button>
                                <button onClick={toggleVideo} className={`p-4 rounded-full ${videoEnabled ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-red-500 hover:bg-red-600 text-white'} transition-all shadow-lg transform hover:scale-105 active:scale-95`}>
                                    {videoEnabled ? <Icons.Video className="w-6 h-6" /> : <Icons.VideoOff className="w-6 h-6" />}
                                </button>
                                <div className="w-px bg-white/20 mx-2"></div>
                                <button onClick={handleSave} className="p-4 rounded-full bg-red-600 hover:bg-red-700 transition-all text-white font-bold px-8 shadow-lg transform hover:scale-105 active:scale-95 flex items-center gap-2">
                                    <Icons.Square className="w-5 h-5 fill-current" /> Stop & Submit
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Right: Grading Panel */}
                    <div className="w-2/5 bg-gray-50 text-gray-800 flex flex-col h-full">
                        <div className="p-6 bg-white border-b border-gray-200 shadow-sm z-10">
                            <h2 className="text-xl font-bold flex items-center gap-2 text-gray-800"><Icons.Cpu className="w-6 h-6 text-indigo-600" /> Viva Grading</h2>
                            <div className="flex justify-between items-center mt-2">
                                <p className="text-gray-500 text-sm font-medium">{isGeneric ? 'Generic Assessment' : (qp?.qpName || 'General Viva')}</p>
                                <span className="bg-indigo-100 text-indigo-700 text-xs font-bold px-2 py-1 rounded-md border border-indigo-200">Ref: {student.enrollmentNo}</span>
                            </div>
                        </div>


                        <div className="flex-1 overflow-y-auto p-6 scrollbar-thin bg-gray-50/50">
                            {isGeneric ? (
                                <div className="space-y-6">
                                    <div className="p-8 border-2 border-dashed border-indigo-200 rounded-2xl bg-indigo-50/50 flex flex-col items-center justify-center text-center">
                                        <div className="bg-white p-4 rounded-full shadow-md mb-4">
                                            <Icons.Edit3 className="w-8 h-8 text-indigo-600" />
                                        </div>
                                        <h3 className="text-xl font-bold text-gray-800 mb-2">Manual Grading Mode</h3>
                                        <p className="text-gray-600 mb-6 max-w-xs">No specific question paper assigned. Please evaluate the candidate based on overall performance.</p>

                                        <div className="w-full max-w-sm">
                                            <label className="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Total Score Awarded</label>
                                            <input
                                                type="number"
                                                min="0"
                                                className="w-full p-4 border-2 border-indigo-300 rounded-xl font-extrabold text-4xl text-indigo-700 focus:border-indigo-600 focus:outline-none text-center shadow-inner"
                                                value={genericScore}
                                                onChange={e => setGenericScore(e.target.value)}
                                                placeholder="00"
                                                autoFocus
                                            />
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    {questions.map((q, idx) => (
                                        <div key={q.id} className={`p-5 rounded-xl border transition-all duration-200 ${currentQIdx === idx ? 'border-indigo-500 bg-white shadow-md ring-1 ring-indigo-200 transform scale-[1.01]' : 'border-gray-200 bg-white hover:border-gray-300'}`}>
                                            <div className="flex justify-between items-start mb-3">
                                                <span className="text-xs font-bold text-gray-400 uppercase tracking-widest">Question {idx + 1}</span>
                                                <span className="text-xs font-bold bg-gray-100 text-gray-600 px-2.5 py-1 rounded-full border border-gray-200">Max: {q.totalMarks}</span>
                                            </div>
                                            <p className="font-semibold text-lg mb-5 text-gray-800 leading-relaxed whitespace-pre-wrap">{q.question}</p>

                                            <div className="flex items-center gap-4 bg-gray-50 p-3 rounded-lg border border-gray-100">
                                                <label className="text-sm font-bold text-gray-600 uppercase tracking-wide">Score:</label>
                                                <input
                                                    type="number"
                                                    max={q.totalMarks}
                                                    min="0"
                                                    className="w-20 p-2 border-2 border-gray-300 rounded-lg text-center font-bold text-xl text-indigo-700 focus:border-indigo-500 focus:outline-none transition-all shadow-inner bg-white"
                                                    value={marks[idx] || ''}
                                                    onChange={e => {
                                                        const val = Math.min(parseFloat(e.target.value) || 0, q.totalMarks);
                                                        setMarks({ ...marks, [idx]: val });
                                                    }}
                                                    onFocus={() => setCurrentQIdx(idx)}
                                                />
                                                <span className="text-gray-400 font-medium text-sm">/ {q.totalMarks}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            <hr className="my-8 border-gray-200 border-dashed" />

                            <div className="mb-6 bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                                <label className="block text-sm font-bold text-gray-700 mb-3 uppercase tracking-wide flex items-center gap-2"><Icons.Edit3 className="w-4 h-4" /> Overall Remarks</label>
                                <textarea
                                    className="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500/50 outline-none resize-none text-sm leading-relaxed"
                                    rows="4"
                                    placeholder="Enter detailed feedback for the student..."
                                    value={remarks}
                                    onChange={e => setRemarks(e.target.value)}
                                ></textarea>
                            </div>
                        </div>

                        <div className="p-6 border-t bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] flex justify-between items-center z-10">
                            <div>
                                <span className="text-gray-500 text-xs font-bold uppercase tracking-wide block mb-1">Total Score</span>
                                <div className="flex items-baseline">
                                    <strong className="text-3xl text-indigo-600 font-extrabold">{isGeneric ? (parseFloat(genericScore) || 0) : Object.values(marks).reduce((a, b) => a + parseFloat(b || 0), 0)}</strong>
                                    {!isGeneric && <span className="text-gray-400 mx-1 text-lg">/</span>}
                                    {!isGeneric && <span className="text-gray-500 font-bold text-xl">{qp.totalMarks}</span>}
                                </div>
                            </div>
                            <button onClick={handleSave} className="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-8 py-3.5 rounded-xl font-bold shadow-lg shadow-green-200 transform hover:-translate-y-0.5 transition-all flex items-center gap-2.5">
                                <Icons.Save className="w-5 h-5" /> Submit Evaluation
                            </button>
                        </div>
                    </div>
                </div >
            );
        };

        // VIVA LOBBY (ZOOM-STYLE WAITING ROOM)
        const VivaLobby = ({ batch, onClose }) => {
            const [students, setStudents] = useState([]);
            const [activeStudent, setActiveStudent] = useState(null);
            const [completedIds, setCompletedIds] = useState([]);

            useEffect(() => {
                refreshLobby();
            }, [batch]);

            const refreshLobby = () => {
                // RESOLVE REAL BATCH ID: The prop 'batch' might be a User session object ({batchId: '...' }) OR a real Batch ({id: '...' })
                const targetBatchId = batch.id || batch.batchId;

                // Fetch full batch details if we only have the ID (to get the Name)
                const fullBatch = window.Utils.getBatches().find(b => b.id === targetBatchId) || batch;

                // Debug: Handle string vs number mismatch
                const all = window.Utils.getStudents();
                const allStudents = all.filter(s => String(s.batchId) === String(targetBatchId));
                console.log("Lobby Debug:", { targetBatchId, totalStudents: all.length, matchedStudents: allStudents.length });

                // Force refresh responses from storage
                const responses = JSON.parse(localStorage.getItem('se_responses') || '[]');

                // Find students who have a VIVA response for this batch
                const completed = responses
                    .filter(r => r.batchId === targetBatchId && r.examType === 'VIVA')
                    .map(r => r.studentId);

                setStudents(allStudents);
                setCompletedIds(completed);

                // Update local state to show correct name in UI (hacky but works without refactoring props)
                if (fullBatch.name && fullBatch.name !== batch.name) {
                    batch.resolvedName = fullBatch.name;
                    batch.resolvedId = fullBatch.id;
                }
            };

            const waitingList = students.filter(s => !completedIds.includes(s.id));
            const doneList = students.filter(s => completedIds.includes(s.id));

            return (
                <div className="fixed inset-0 bg-gray-900 z-50 flex font-sans text-white animate-fade-in">
                    {/* Left Sidebar: Meeting Participants */}
                    <div className="w-1/4 bg-gray-800 border-r border-gray-700 flex flex-col shadow-xl z-20">
                        <div className="p-4 border-b border-gray-700 bg-gray-900/50">
                            <h2 className="text-lg font-bold flex items-center gap-2 text-indigo-400">
                                <Icons.Video className="w-5 h-5 text-green-400" /> Meeting Room
                            </h2>
                            <div className="mt-2 text-xs text-gray-400 font-mono bg-gray-900 p-2 rounded border border-gray-700">
                                <p>Batch: {batch.resolvedName || batch.name || batch.batchName || 'Unknown'}</p>
                                <p>ID: {batch.resolvedId || batch.id || 'N/A'}</p>
                                <p>Students Found: {students.length}</p>
                                <details className="mt-2 text-[10px] cursor-pointer">
                                    <summary>Raw Object</summary>
                                    <pre className="whitespace-pre-wrap">{JSON.stringify(batch, null, 2)}</pre>
                                </details>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 scrollbar-thin">
                            {/* Waiting Room Section */}
                            <div className="mb-6">
                                <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3 flex items-center justify-between sticky top-0 bg-gray-800 py-1 z-10">
                                    Waiting Room <span className="bg-indigo-600 text-white px-2 py-0.5 rounded-full text-[10px] shadow-sm">{waitingList.length}</span>
                                </h3>
                                <div className="space-y-2">
                                    {waitingList.map(s => (
                                        <div key={s.id} className="flex items-center justify-between p-3 bg-gray-700/30 rounded-lg hover:bg-gray-700 transition-colors border border-gray-700/50 hover:border-gray-600 group">
                                            <div className="flex items-center gap-3">
                                                <div className="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-xs font-bold shadow-sm">
                                                    {s.name.charAt(0)}
                                                </div>
                                                <div className="overflow-hidden">
                                                    <p className="text-sm font-medium text-gray-200 truncate group-hover:text-white transition-colors">{s.name}</p>
                                                    <p className="text-[10px] text-gray-500 truncate">{s.enrollmentNo}</p>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => {
                                                    setActiveStudent(s);
                                                    const bId = batch.resolvedId || batch.id || batch.batchId;
                                                    localStorage.setItem(`viva_active_${bId}`, s.id); // Signal student tab
                                                    console.log("Viva Signal Sent:", `viva_active_${bId}`, s.id);
                                                }}
                                                disabled={!!activeStudent}
                                                className="text-xs font-bold bg-green-600 hover:bg-green-500 text-white px-3 py-1.5 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:shadow-lg transform active:scale-95"
                                            >
                                                Admit
                                            </button>
                                        </div>
                                    ))}
                                    {waitingList.length === 0 && <p className="text-sm text-gray-500 italic text-center py-4 border-2 border-dashed border-gray-700 rounded-lg">No students waiting</p>}
                                </div>
                            </div>

                            {/* Joined/Completed Section */}
                            <div>
                                <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3 flex items-center justify-between sticky top-0 bg-gray-800 py-1 z-10">
                                    Completed <span className="bg-gray-700 text-green-400 px-2 py-0.5 rounded-full text-[10px]">{doneList.length}</span>
                                </h3>
                                <div className="space-y-2 opacity-60 hover:opacity-100 transition-opacity">
                                    {doneList.map(s => (
                                        <div key={s.id} className="p-3 bg-gray-900/50 rounded flex items-center gap-3 border border-gray-700">
                                            <div className="w-8 h-8 rounded-full bg-green-900/30 text-green-400 flex items-center justify-center text-xs font-bold border border-green-900">
                                                <Icons.Check className="w-4 h-4" />
                                            </div>
                                            <div className="overflow-hidden">
                                                <p className="font-bold truncate text-gray-400 line-through">{s.name}</p>
                                                <p className="text-[10px] text-gray-600">{s.enrollmentNo}</p>
                                            </div>
                                        </div>
                                    ))}
                                    {doneList.length === 0 && <p className="text-xs text-gray-600 italic text-center">No completed students yet.</p>}
                                </div>
                            </div>
                        </div>

                        <div className="p-4 border-t border-gray-700 bg-gray-900/50">
                            <button onClick={onClose} className="w-full py-3 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-bold transition-all shadow-lg hover:shadow-red-900/30 flex items-center justify-center gap-2">
                                <Icons.PhoneMissed className="w-4 h-4" /> End Meeting for All
                            </button>
                        </div>
                    </div>

                    {/* Main Stage */}
                    <div className="w-3/4 bg-black relative flex flex-col items-center justify-center overflow-hidden">
                        {/* Background Pattern */}
                        {!activeStudent && (
                            <div className="absolute inset-0 opacity-10 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-gray-700 via-gray-900 to-black"></div>
                        )}

                        {activeStudent ? (
                            <div className="w-full h-full relative z-10 animate-scale-in">
                                <LiveVivaConsole
                                    batch={{ ...batch, id: batch.resolvedId || batch.id || batch.batchId, name: batch.resolvedName || batch.name }}
                                    student={activeStudent}
                                    embedded={true}
                                    onClose={() => {
                                        setActiveStudent(null);
                                        const bId = batch.resolvedId || batch.id || batch.batchId;
                                        localStorage.removeItem(`viva_active_${bId}`); // Clear signal
                                        console.log("Viva Signal Cleared:", `viva_active_${bId}`);
                                        refreshLobby();
                                    }}
                                />
                            </div>
                        ) : (
                            <div className="text-center p-10 relative z-10 max-w-md animate-fade-in-up">
                                <div className="w-32 h-32 bg-gray-800/80 rounded-full flex items-center justify-center mx-auto mb-8 border-4 border-gray-700 shadow-2xl backdrop-blur-sm">
                                    <Icons.Video className="w-12 h-12 text-gray-500" />
                                </div>
                                <h2 className="text-3xl font-bold text-white mb-3 tracking-tight">The Meeting is Live</h2>
                                <p className="text-gray-400 text-lg">Waiting for you to admit a student from the sidebar.</p>
                                <div className="mt-8 flex gap-2 justify-center">
                                    <span className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce delay-0"></span>
                                    <span className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce delay-100"></span>
                                    <span className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce delay-200"></span>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const BatchesTab = () => {

            const [batches, setBatches] = useState([]);
            const [sscList, setSSCList] = useState([]);
            const [qpList, setQPList] = useState([]);
            const [filteredBatches, setFilteredBatches] = useState([]);

            const [showCreateModal, setShowCreateModal] = useState(false);
            const [showAssignModal, setShowAssignModal] = useState(false);
            const [showStudentModal, setShowStudentModal] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);

            const [selectedBatch, setSelectedBatch] = useState(null);
            const [assignmentType, setAssignmentType] = useState('Theory'); // 'Theory', 'Practical', 'Viva'
            const [selectedAssignQP, setSelectedAssignQP] = useState('');

            // Hierarchy Filters for Assign Modal
            const [assignSSC, setAssignSSC] = useState('');
            const [assignQPDef, setAssignQPDef] = useState('');
            const [vivaSession, setVivaSession] = useState(null); // {batch, student}

            // Filters
            const [filterSSC, setFilterSSC] = useState('');
            const [filterQP, setFilterQP] = useState('');
            const [filterStartDate, setFilterStartDate] = useState('');

            const [filterEndDate, setFilterEndDate] = useState('');
            const [searchQuery, setSearchQuery] = useState('');

            // Enhanced Batch State
            const [newBatch, setNewBatch] = useState({
                name: '',
                project: '',
                trainingCentre: '',
                state: '',
                spocContactNo: '',
                centerAddress: '',
                startDate: '',
                endDate: '',
                loginRestrictCount: '3',
                modeOfAssessment: '',
                batchSize: '',
                centerId: '',
                district: '',
                spocEmail: '',
                tpName: '',
                startTime: '',
                endTime: '',
                captureImage: true,
                cameraInterval: '60',
                sscId: '', // Added
                qpId: ''   // Added
            });

            const [showNewProjectInput, setShowNewProjectInput] = useState(false);

            // Mock Data for Dropdowns
            const projects = ['PMKVY', 'CMKVY', 'DDU-GKY', 'NULM', 'Corporate'];
            const trainingCentres = [
                { id: 'TC001', name: 'Alpha Tech Institute', state: 'Karnataka', district: 'Bangalore', centerId: 'C-BLR-01', address: '123 Tech Park, Bangalore', spoc: 'John Doe' },
                { id: 'TC002', name: 'Beta Skills Academy', state: 'Maharashtra', district: 'Pune', centerId: 'C-PUN-02', address: '456 Skill Ave, Pune', spoc: 'Jane Smith' },
                { id: 'TC003', name: 'Gamma Vocational Center', state: 'Delhi', district: 'New Delhi', centerId: 'C-DEL-03', address: '789 Edu Road, Delhi', spoc: 'Robert Brown' }
            ];

            const assessmentModes = ['Online', 'Offline', 'Hybrid'];

            const [allQPapers, setAllQPapers] = useState([]);

            useEffect(() => {
                const loadData = () => {
                    const b = window.Utils.getBatches();
                    setBatches(b);
                    setFilteredBatches(b);
                    setSSCList(window.Utils.getSSC());
                    setQPList(window.Utils.getQPs());
                    setAllQPapers(window.Utils.getQuestionPapers());
                };
                loadData();

                // Real-time listener
                window.addEventListener('cloud-sync-complete', loadData);
                return () => window.removeEventListener('cloud-sync-complete', loadData);
            }, []);

            const handleSearch = () => {
                let result = batches;
                if (searchQuery) {
                    result = result.filter(b => b.name.toLowerCase().includes(searchQuery.toLowerCase()));
                }

                // Filter by SSC and QP using Batch Metadata OR Resolved Papers
                result = result.filter(b => {
                    const tPaper = allQPapers.find(p => p.id === b.theoryPaperId);
                    const pPaper = allQPapers.find(p => p.id === b.practicalPaperId);

                    let matchesSSC = true;
                    if (filterSSC) {
                        const sscBatch = b.sscId && String(b.sscId) === String(filterSSC);
                        const sscT = tPaper && String(tPaper.sscId) === String(filterSSC);
                        const sscP = pPaper && String(pPaper.sscId) === String(filterSSC);
                        matchesSSC = sscBatch || sscT || sscP;
                    }

                    let matchesQP = true;
                    if (filterQP) {
                        const qpBatch = b.qpId && String(b.qpId) === String(filterQP);
                        const qpT = tPaper && String(tPaper.qpId) === String(filterQP);
                        const qpP = pPaper && String(pPaper.qpId) === String(filterQP);
                        matchesQP = qpBatch || qpT || qpP;
                    }

                    return matchesSSC && matchesQP;
                });

                if (filterStartDate) {
                    result = result.filter(b => b.startDate >= filterStartDate);
                }
                if (filterEndDate) {
                    result = result.filter(b => b.endDate <= filterEndDate);
                }

                setFilteredBatches(result);
            };

            // Auto-search when filters change (optional, but good for dropdowns)
            useEffect(() => {
                handleSearch();
            }, [filterSSC, filterQP, filterStartDate, filterEndDate, batches, searchQuery, allQPapers]);

            const handleTCSelection = (e) => {
                const tcName = e.target.value;
                const tc = trainingCentres.find(t => t.name === tcName);
                if (tc) {
                    setNewBatch({
                        ...newBatch,
                        trainingCentre: tcName,
                        state: tc.state,
                        district: tc.district, // Display only
                        centerId: tc.centerId, // Display only
                        centerAddress: tc.address,
                        spocName: tc.spoc
                    });
                } else {
                    setNewBatch({ ...newBatch, trainingCentre: tcName });
                }
            };

            const handleCreateBatch = (e) => {
                e.preventDefault();

                const isUpdate = !!newBatch.id;

                const batch = {
                    ...newBatch,
                    id: isUpdate ? newBatch.id : window.Utils.generateId(),
                    assessorUsername: isUpdate ? newBatch.assessorUsername : 'assessor_' + Math.random().toString(36).substr(2, 5),
                    assessorPassword: isUpdate ? newBatch.assessorPassword : Math.random().toString(36).substr(2, 6),
                    createdAt: isUpdate ? newBatch.createdAt : new Date().toISOString()
                };

                window.Utils.saveBatch(batch);
                // Atomic Sync handles upload now
                const updated = window.Utils.getBatches();
                setBatches(updated);
                setFilteredBatches(updated);
                setShowCreateModal(false);
                setNewBatch({
                    name: '', project: '', trainingCentre: '', state: '', spocContactNo: '', centerAddress: '',
                    startDate: '', endDate: '', loginRestrictCount: '3', modeOfAssessment: '',
                    batchSize: '', centerId: '', district: '', spocEmail: '', tpName: '', startTime: '', endTime: '',
                    captureImage: true, cameraInterval: '60', sscId: '', qpId: ''
                });
            };

            const handleEditBatch = (batch) => {
                setNewBatch(batch);
                setShowCreateModal(true);
            };

            const handleAssignQP = () => {
                if (!selectedBatch || !selectedAssignQP) return;

                // Find existing batch and update just that one
                const currentBatches = window.Utils.getBatches();
                const targetBatchIndex = currentBatches.findIndex(b => b.id === selectedBatch.id);

                if (targetBatchIndex >= 0) {
                    const field = assignmentType === 'Practical' ? 'practicalPaperId' : (assignmentType === 'Viva' ? 'vivaPaperId' : 'theoryPaperId');
                    const updatedBatch = { ...currentBatches[targetBatchIndex], [field]: selectedAssignQP };

                    // Use Atomic Save (which now supports Upsert & Sync)
                    window.Utils.saveBatch(updatedBatch);

                    // Refresh React State
                    const refreshed = window.Utils.getBatches();
                    setBatches(refreshed);
                    setFilteredBatches(refreshed);
                }

                setShowAssignModal(false);
                setSelectedBatch(null);
                setSelectedAssignQP('');
            };

            const handleStudentUpload = (e) => {
                const file = e.target.files[0];
                if (!file || !selectedBatch) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet);

                    let count = 0;
                    const existingStudents = window.Utils.getStudentsByBatch(selectedBatch.id);
                    let currentCount = existingStudents.length;

                    // DEBUG: Show detected keys
                    if (rows.length > 0) {
                        alert("Debug: Detected Excel Columns: " + Object.keys(rows[0]).join(", "));
                    }

                    rows.forEach(row => {
                        // Flexible matching for keys
                        const enrollmentNo = row['Enrollment No'] || row['EnrollmentNo'];
                        const studentName = row['Name of the Trainee'] || row['Trainee Name'] || row['Name'] || row['Student Name'] || row['StudentName'] || row['Candidate Name'] || row['CandidateName'] || row['Full Name'] || row['FullName'] || row['Trainee'];

                        if (studentName) {
                            const sequence = 100 + currentCount;

                            // Auto-increment name if it is just "U"
                            let finalName = studentName;
                            if (studentName.trim().toUpperCase() === 'U') {
                                finalName = `U${currentCount + 1}`;
                            }

                            const student = {
                                id: window.Utils.generateId(),
                                name: finalName,
                                username: sequence.toString(), // Sequential username: 100, 101...
                                enrollmentNo: enrollmentNo ? enrollmentNo.toString() : '',
                                password: enrollmentNo ? enrollmentNo.toString() : 'password',
                                batchId: selectedBatch.id,
                                role: 'student'
                            };
                            window.Utils.saveStudent(student);
                            currentCount++;
                            count++;
                        }
                    });

                    alert(`Uploaded ${count} students to ${selectedBatch.name}`);
                    setShowStudentModal(false);
                    // Force refresh by toggling selection or updating state if needed
                    // But setShowStudentModal(false) closes it, so next open will get fresh data.
                    setSelectedBatch(null);
                };
                reader.readAsArrayBuffer(file);
            };

            // NEW: Bulk Import with Batch Name Mapping
            const handleBulkStudentImport = (e) => {
                e.preventDefault();
                const fileInput = document.getElementById('bulkImportFile');
                const file = fileInput?.files[0];
                if (!file) { alert("Please select a file first."); return; }

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet); // [{BatchName: '...', Enrollment No: '...', ...}]

                    let addedCount = 0;
                    let errors = [];

                    // Get fresh batch list to ensure we match correctly
                    const currentBatches = window.Utils.getBatches();

                    // Pre-fetch student counts for involved batches to maintain sequence
                    const batchCounts = {};

                    rows.forEach((row, index) => {
                        // Expected keys: "BatchName", "Enrollment No", "Name of the Trainee"
                        // Flexible matching for keys
                        const batchName = row['BatchName'] || row['Batch Name'];
                        const enrollmentNo = row['Enrollment No'] || row['EnrollmentNo'];
                        const studentName = row['Name of the Trainee'] || row['Trainee Name'] || row['Name'] || row['Student Name'] || row['StudentName'] || row['Candidate Name'] || row['CandidateName'] || row['Full Name'] || row['FullName'] || row['Trainee'];

                        // Debug log to identify column issues
                        if (!studentName || studentName === 'U') console.log('Row detection:', row);

                        if (!batchName) {
                            errors.push(`Row ${index + 2}: Missing Batch Name`);
                            return;
                        }

                        // Find batch
                        const targetBatch = currentBatches.find(b => b.name.trim().toLowerCase() === batchName.toString().trim().toLowerCase());

                        if (!targetBatch) {
                            errors.push(`Row ${index + 2}: Batch "${batchName}" not found`);
                            return;
                        }

                        if (!studentName) {
                            errors.push(`Row ${index + 2}: Missing Student Name`);
                            return;
                        }

                        // Initialize count for this batch if not done yet
                        if (batchCounts[targetBatch.id] === undefined) {
                            batchCounts[targetBatch.id] = window.Utils.getStudentsByBatch(targetBatch.id).length;
                        }

                        const sequence = 100 + batchCounts[targetBatch.id];

                        // Auto-increment name if it is just "U"
                        let finalName = studentName;
                        if (studentName.trim().toUpperCase() === 'U') {
                            finalName = `U${batchCounts[targetBatch.id] + 1}`;
                        }

                        const student = {
                            id: window.Utils.generateId(),
                            name: finalName, // Use the auto-incremented name
                            username: sequence.toString(), // Sequential username: 100, 101...
                            enrollmentNo: enrollmentNo ? enrollmentNo.toString() : '', // Save Excel Enrollment No separately
                            password: enrollmentNo ? enrollmentNo.toString() : 'password', // Password is Enrollment No
                            batchId: targetBatch.id,
                            role: 'student'
                        };
                        window.Utils.saveStudent(student);

                        batchCounts[targetBatch.id]++; // Increment local count
                        addedCount++;
                    });

                    let msg = `Successfully uploaded ${addedCount} students across batches.`;
                    if (errors.length > 0) {
                        msg += `\n\nErrors:\n` + errors.slice(0, 10).join('\n') + (errors.length > 10 ? '\n...' : '');
                    }
                    alert(msg);
                    setShowImportModal(false);
                };
                reader.readAsArrayBuffer(file);
            };

            const questionPapers = window.Utils.getQuestionPapers();
            const getQPName = (id) => questionPapers.find(q => q.id === id)?.qpName || '-';

            return (
                <div className="animate-fade-in text-sm">
                    <h2 className="text-2xl font-bold mb-6 text-gray-800">Add / View Batches</h2>

                    {/* Filters */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div className="space-y-1">
                            <label className="text-xs font-bold text-gray-700">Sector Skill Council :</label>
                            <select className="w-full p-2 border rounded-md bg-gray-50 text-sm" value={filterSSC} onChange={e => setFilterSSC(e.target.value)}>
                                <option value="">Select SSC</option>
                                {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                        </div>
                        <div className="space-y-1">
                            <label className="text-xs font-bold text-gray-700">Qualification Pack :</label>
                            <select className="w-full p-2 border rounded-md bg-gray-50 text-sm" value={filterQP} onChange={e => setFilterQP(e.target.value)}>
                                <option value="">Select QP</option>
                                {(() => {
                                    const uniqueCodes = new Set();
                                    return qpList.filter(q => {
                                        if (!filterSSC || q.sscId === filterSSC) {
                                            const code = (q.code || '').trim().toLowerCase();
                                            if (uniqueCodes.has(code)) return false;
                                            uniqueCodes.add(code);
                                            return true;
                                        }
                                        return false;
                                    }).map(q => <option key={q.id} value={q.id}>{q.name} ({q.code})</option>);
                                })()}
                            </select>
                        </div>
                        <div className="flex items-end gap-2">
                            <div className="flex-1">
                                <input type="text" placeholder="Search with batch name" className="w-full p-2 border rounded-md" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} />
                            </div>
                            <button onClick={handleSearch} className="bg-green-500 text-white px-4 py-2 rounded flex items-center gap-1 hover:bg-green-600">
                                <Icons.Grid className="w-4 h-4" /> Search
                            </button>
                        </div>
                        <div className="space-y-1">
                            <input type="date" className="w-full p-2 border rounded-md text-gray-500" value={filterStartDate} onChange={e => setFilterStartDate(e.target.value)} />
                        </div>
                        <div className="space-y-1">
                            <input type="date" className="w-full p-2 border rounded-md text-gray-500" value={filterEndDate} onChange={e => setFilterEndDate(e.target.value)} />
                        </div>
                        <div className="flex items-end">
                            <button onClick={handleSearch} className="bg-red-500 text-white px-6 py-2 rounded shadow hover:bg-red-600 font-medium">Search</button>
                        </div>
                    </div>

                    {/* Main Content Area - Only visible if QP is selected or Search is active */}
                    {(filterQP || searchQuery) && (
                        <>
                            {/* Toolbar */}
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-2 text-gray-700 font-medium">
                                    <Icons.Book className="w-5 h-5 text-orange-500" />
                                    <span>Total Records : {filteredBatches.length}</span>
                                </div>
                                <div className="flex gap-2">
                                    <button className="bg-gray-600 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-gray-700 text-xs shadow-md">
                                        Export To <Icons.ChevronDown className="w-4 h-4" />
                                    </button>
                                    <button onClick={() => setShowImportModal(true)} className="bg-purple-600 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-purple-700 text-xs shadow-md shadow-purple-200">
                                        <Icons.UserPlus className="w-4 h-4" /> Import Students
                                    </button>
                                    <button onClick={() => setShowCreateModal(true)} className="bg-red-500 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-red-600 text-xs shadow-md shadow-red-200">
                                        <Icons.Plus className="w-4 h-4" /> Add New Batch
                                    </button>
                                </div>
                            </div>

                            {/* Batches Grid/Table */}
                            <div className="bg-white rounded-lg border shadow-sm overflow-hidden mb-8">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left">
                                        <thead className="bg-gray-50 border-b">
                                            <tr>
                                                <th className="p-3 text-left font-bold text-gray-600 border-r w-12">Sr.#</th>
                                                <th className="p-3 text-left font-bold text-gray-600 border-r w-32">Batch Name</th>
                                                <th className="p-3 text-left font-bold text-gray-600 border-r w-24">Center ID</th>
                                                <th className="p-3 text-left font-bold text-gray-600 border-r w-24">Total Students</th>
                                                <th className="p-3 text-left font-bold text-gray-600 border-r w-32">Start Date</th>
                                                <th className="p-3 text-left font-bold text-gray-600 border-r w-32">End Date</th>
                                                <th className="p-3 text-left font-bold text-gray-600 border-r w-24">State</th>
                                                <th className="p-3 text-left font-bold text-gray-600 border-r w-24">District</th>
                                                <th className="p-3 text-center font-bold text-gray-600 border-r w-16">Edit</th>
                                                <th className="p-3 text-center font-bold text-gray-600 border-r w-24">Students</th>
                                                <th className="p-3 text-center font-bold text-gray-600 border-r w-24">Assessor</th>
                                                <th className="p-3 text-center font-bold text-gray-600 border-r w-24">Theory QP</th>
                                                <th className="p-3 text-center font-bold text-gray-600 border-r w-24">Practical QP</th>
                                                <th className="p-3 text-center font-bold text-gray-600 border-r w-24">Viva QP</th>
                                                <th className="p-3 text-center font-bold text-gray-600 w-16">B</th>
                                            </tr>
                                        </thead >
                                        <tbody className="divide-y">
                                            {filteredBatches.map((batch, idx) => (
                                                <tr key={batch.id} className="hover:bg-gray-50">
                                                    <td className="p-3 border-r text-center">{idx + 1}</td>
                                                    <td className="p-3 border-r font-medium text-gray-700">{batch.name}</td>
                                                    <td className="p-3 border-r text-gray-600">{batch.centerId || '-'}</td>
                                                    <td className="p-3 border-r text-center">
                                                        {window.Utils.getStudentsByBatch(batch.id).length}
                                                    </td>
                                                    <td className="p-3 border-r text-xs text-gray-600">{batch.startDate ? new Date(batch.startDate).toLocaleString() : '-'}</td>
                                                    <td className="p-3 border-r text-xs text-gray-600">{batch.endDate ? new Date(batch.endDate).toLocaleDateString() : '-'}</td>
                                                    <td className="p-3 border-r text-gray-600">{batch.state || '-'}</td>
                                                    <td className="p-3 border-r text-gray-600">{batch.district || '-'}</td>
                                                    <td className="p-3 border-r text-center">
                                                        <button onClick={() => handleEditBatch(batch)} className="bg-cyan-700 text-white p-2 rounded hover:bg-cyan-800"><Icons.Edit3 className="w-4 h-4" /></button>
                                                    </td>
                                                    <td className="p-3 border-r text-center">
                                                        <button onClick={() => { setSelectedBatch(batch); setShowStudentModal(true); }}
                                                            className="bg-cyan-700 text-white px-3 py-1 rounded flex items-center justify-center gap-1 hover:bg-cyan-800 text-xs mx-auto">
                                                            <Icons.Eye className="w-3 h-3" /> View
                                                        </button>
                                                    </td>
                                                    <td className="p-3 border-r text-center text-xs">
                                                        {batch.assessorUsername ? (
                                                            <div title={`Pass: ${batch.assessorPassword}`} className="cursor-help font-mono bg-yellow-50 px-2 py-1 rounded inline-block border border-yellow-200 text-yellow-800 font-bold">
                                                                {batch.assessorUsername}
                                                            </div>
                                                        ) : (
                                                            <button onClick={() => {
                                                                const updated = batches.map(b => {
                                                                    if (b.id === batch.id) {
                                                                        return {
                                                                            ...b,
                                                                            assessorUsername: 'assessor_' + Math.random().toString(36).substr(2, 5),
                                                                            assessorPassword: Math.random().toString(36).substr(2, 6)
                                                                        };
                                                                    }
                                                                    return b;
                                                                });
                                                                window.Utils.updateBatches(updated);
                                                                setBatches(updated);
                                                                setFilteredBatches(updated);
                                                            }} className="text-blue-600 hover:text-blue-800 text-xs flex items-center gap-1 bg-blue-50 px-2 py-1 rounded border border-blue-200">
                                                                <Icons.PlusSquare className="w-3 h-3" /> Gen ID
                                                            </button>
                                                        )}
                                                    </td>
                                                    <td className="p-3 border-r text-center">
                                                        {batch.theoryPaperId ? (
                                                            <div className="flex items-center justify-center gap-1">
                                                                <span className="bg-cyan-700 text-white px-2 py-1 rounded text-xs">{getQPName(batch.theoryPaperId)}</span>
                                                                <button onClick={() => {
                                                                    const qp = questionPapers.find(q => q.id === batch.theoryPaperId);
                                                                    setSelectedBatch(batch); setAssignmentType('Theory'); setSelectedAssignQP(batch.theoryPaperId);
                                                                    setAssignSSC(qp ? qp.sscId : ''); setAssignQPDef(qp ? qp.qpId : '');
                                                                    setShowAssignModal(true);
                                                                }} className="text-gray-500 hover:text-blue-600">
                                                                    <Icons.Edit3 className="w-3 h-3" />
                                                                </button>
                                                            </div>
                                                        ) : (
                                                            <button onClick={() => {
                                                                setSelectedBatch(batch); setAssignmentType('Theory'); setSelectedAssignQP('');
                                                                setAssignSSC(''); setAssignQPDef('');
                                                                setShowAssignModal(true);
                                                            }} className="text-blue-600 underline text-xs">Assign</button>
                                                        )}
                                                    </td>
                                                    <td className="p-3 border-r text-center">
                                                        {batch.practicalPaperId ? (
                                                            <div className="flex items-center justify-center gap-1">
                                                                <span className="bg-cyan-700 text-white px-2 py-1 rounded text-xs">{getQPName(batch.practicalPaperId)}</span>
                                                                <button onClick={() => {
                                                                    const qp = questionPapers.find(q => q.id === batch.practicalPaperId);
                                                                    setSelectedBatch(batch); setAssignmentType('Practical'); setSelectedAssignQP(batch.practicalPaperId);
                                                                    setAssignSSC(qp ? qp.sscId : ''); setAssignQPDef(qp ? qp.qpId : '');
                                                                    setShowAssignModal(true);
                                                                }} className="text-gray-500 hover:text-blue-600">
                                                                    <Icons.Edit3 className="w-3 h-3" />
                                                                </button>
                                                            </div>
                                                        ) : (
                                                            <button onClick={() => {
                                                                setSelectedBatch(batch); setAssignmentType('Practical'); setSelectedAssignQP('');
                                                                setAssignSSC(''); setAssignQPDef('');
                                                                setShowAssignModal(true);
                                                            }} className="text-blue-600 underline text-xs">Assign</button>
                                                        )}
                                                    </td>
                                                    <td className="p-3 border-r text-center">
                                                        {batch.vivaPaperId ? (
                                                            <div className="flex items-center justify-center gap-1">
                                                                <span className="bg-cyan-700 text-white px-2 py-1 rounded text-xs">{getQPName(batch.vivaPaperId)}</span>
                                                                <button onClick={() => {
                                                                    const qp = questionPapers.find(q => q.id === batch.vivaPaperId);
                                                                    setSelectedBatch(batch); setAssignmentType('Viva'); setSelectedAssignQP(batch.vivaPaperId);
                                                                    setAssignSSC(qp ? qp.sscId : ''); setAssignQPDef(qp ? qp.qpId : '');
                                                                    setShowAssignModal(true);
                                                                }} className="text-gray-500 hover:text-blue-600">
                                                                    <Icons.Edit3 className="w-3 h-3" />
                                                                </button>
                                                            </div>
                                                        ) : (
                                                            <button onClick={() => {
                                                                setSelectedBatch(batch); setAssignmentType('Viva'); setSelectedAssignQP('');
                                                                setAssignSSC(''); setAssignQPDef('');
                                                                setShowAssignModal(true);
                                                            }} className="text-blue-600 underline text-xs">Assign</button>
                                                        )}
                                                    </td>
                                                    <td className="p-3 text-center flex items-center justify-center gap-2">
                                                        <button onClick={() => setVivaSession({ batch })} className="bg-indigo-600 text-white p-2 rounded hover:bg-indigo-700 shadow-sm transition-colors" title="Start Viva Meeting"><Icons.Video className="w-4 h-4" /></button>
                                                        <button onClick={() => { if (confirm('Delete Batch?')) { window.Utils.deleteBatch(batch.id); setBatches(window.Utils.getBatches()); setFilteredBatches(window.Utils.getBatches()); window.Utils.uploadToCloud(true); } }}
                                                            className="bg-cyan-700 text-white p-2 rounded hover:bg-cyan-800"><Icons.Trash2 className="w-4 h-4" /></button>
                                                    </td>
                                                </tr>
                                            ))}
                                            {filteredBatches.length === 0 && <tr><td colSpan="14" className="p-8 text-center text-gray-400">No batches records found</td></tr>}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {filteredBatches.length === 0 && <div className="text-center text-gray-400 py-4">No batches found matching your criteria.</div>}
                        </>
                    )}

                    {/* New Import Students Modal */}
                    {
                        showImportModal && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto font-sans">
                                <div className="bg-gray-100 w-full max-w-4xl my-8 shadow-xl rounded-lg overflow-hidden">
                                    {/* Header */}
                                    <div className="bg-gray-200 px-6 py-4 flex justify-between items-center border-b border-gray-300">
                                        <h3 className="text-xl font-bold text-gray-800">Import Students</h3>
                                        <button onClick={() => setShowImportModal(false)} className="text-gray-500 hover:text-gray-700">
                                            <Icons.XCircle className="w-6 h-6" />
                                        </button>
                                    </div>

                                    <div className="p-8 bg-white m-4 rounded-lg shadow-sm">
                                        <div className="grid grid-cols-[200px_1fr] gap-4 mb-6">
                                            <div className="font-bold text-gray-700 text-right">Sector Skill Council :</div>
                                            <div className="text-gray-600">Beauty Wellness Sector Skill Council</div>

                                            <div className="font-bold text-gray-700 text-right">Qualification Pack :</div>
                                            <div className="text-gray-600">Assistant Hair Dresser & Stylist</div>
                                        </div>

                                        <div className="space-y-4">
                                            <p className="text-gray-700 font-medium">
                                                <span className="font-bold">Note :</span> It will accept only Excel files with *.xls extension only.
                                            </p>
                                            <p className="text-gray-700">
                                                Use the same format as given below : <a href="#" className="text-green-500 hover:underline">Download</a>
                                            </p>

                                            {/* Format Table */}
                                            <div className="border border-gray-200 rounded overflow-hidden mb-6">
                                                <table className="w-full text-left border-collapse">
                                                    <thead>
                                                        <tr className="bg-gray-50">
                                                            <th className="p-3 border border-gray-200 font-bold text-gray-700">BatchName</th>
                                                            <th className="p-3 border border-gray-200 font-bold text-gray-700">Enrollment No</th>
                                                            <th className="p-3 border border-gray-200 font-bold text-gray-700">Name of Training Agency</th>
                                                            <th className="p-3 border border-gray-200 font-bold text-gray-700">Name of the Trainee</th>
                                                            <th className="p-3 border border-gray-200 font-bold text-gray-700">Gender(M/F/T)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td className="p-8 border border-gray-200"></td>
                                                            <td className="p-8 border border-gray-200"></td>
                                                            <td className="p-8 border border-gray-200"></td>
                                                            <td className="p-8 border border-gray-200"></td>
                                                            <td className="p-8 border border-gray-200"></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>

                                            {/* File Input */}
                                            <div className="bg-gray-100 p-6 rounded border border-gray-200">
                                                <label className="block font-bold text-red-500 mb-2">* Select Excel File :</label>
                                                <div className="flex bg-white border border-gray-300 rounded p-1 max-w-md">
                                                    <input id="bulkImportFile" type="file" accept=".xlsx, .xls" className="w-full p-1" />
                                                </div>
                                            </div>

                                            <div className="pt-4">
                                                <button onClick={handleBulkStudentImport} className="bg-red-500 text-white px-6 py-3 rounded shadow hover:bg-red-600 font-medium">
                                                    Validate Sheet
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )
                    }

                    {
                        showCreateModal && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto font-sans">
                                <div className="bg-white rounded-xl p-8 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                                    <h3 className="text-2xl font-bold mb-6 text-gray-800">{newBatch.id ? 'Edit Batch' : 'Add New Batch'}</h3>
                                    <form onSubmit={handleCreateBatch} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        <div className="col-span-1 md:col-span-2 lg:col-span-3 pb-4 border-b mb-2">
                                            <h4 className="font-bold text-gray-500 uppercase text-xs tracking-wider mb-4">Project Details</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                                <div>
                                                    <label className="block text-sm font-bold text-gray-700 mb-1">Project Name</label>
                                                    {showNewProjectInput ? (
                                                        <div className="flex gap-2">
                                                            <input type="text" className="w-full p-3 border rounded-lg bg-gray-50 focus:bg-white transition-colors outline-none focus:ring-2 focus:ring-blue-500"
                                                                placeholder="Enter new project name"
                                                                value={newBatch.project} onChange={e => setNewBatch({ ...newBatch, project: e.target.value })} autoFocus />
                                                            <button type="button" onClick={() => setShowNewProjectInput(false)} className="text-gray-500 hover:text-red-500"><Icons.XCircle /></button>
                                                        </div>
                                                    ) : (
                                                        <select className="w-full p-3 border rounded-lg bg-gray-50 focus:bg-white transition-colors outline-none focus:ring-2 focus:ring-blue-500"
                                                            value={newBatch.project} onChange={e => {
                                                                if (e.target.value === 'NEW') setShowNewProjectInput(true);
                                                                else setNewBatch({ ...newBatch, project: e.target.value });
                                                            }}>
                                                            <option value="">Select Project</option>
                                                            {projects.map(p => <option key={p} value={p}>{p}</option>)}
                                                            <option value="NEW" className="font-bold text-blue-600">+ Add New Project</option>
                                                        </select>
                                                    )}
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold text-gray-700 mb-1">Batch Name</label>
                                                    <input type="text" required className="w-full p-3 border rounded-lg bg-gray-50 focus:bg-white transition-colors outline-none focus:ring-2 focus:ring-blue-500"
                                                        value={newBatch.name} onChange={e => setNewBatch({ ...newBatch, name: e.target.value })} />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold text-gray-700 mb-1">Training Partner Name</label>
                                                    <input type="text" required className="w-full p-3 border rounded-lg bg-gray-50 focus:bg-white transition-colors outline-none focus:ring-2 focus:ring-blue-500"
                                                        value={newBatch.tpName} onChange={e => setNewBatch({ ...newBatch, tpName: e.target.value })} />
                                                </div>
                                            </div>
                                        </div>
                                        {/* Left Column */}
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-700 mb-1">Sector Skill Council</label>
                                                    <select className="w-full p-2 border border-gray-300 rounded text-sm"
                                                        value={newBatch.sscId} onChange={e => setNewBatch({ ...newBatch, sscId: e.target.value, qpId: '' })}>
                                                        <option value="">Select Sector</option>
                                                        {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-gray-700 mb-1">Qualification Pack</label>
                                                    <select className="w-full p-2 border border-gray-300 rounded text-sm"
                                                        value={newBatch.qpId} onChange={e => setNewBatch({ ...newBatch, qpId: e.target.value })}>
                                                        <option value="">Select QP</option>
                                                        {qpList.filter(q => !newBatch.sscId || q.sscId === newBatch.sscId).map(q => <option key={q.id} value={q.id}>{q.name}</option>)}
                                                    </select>
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-xs font-bold text-gray-700 mb-1">Project Name <span className="text-red-500">*</span></label>
                                                <div className="flex gap-2">
                                                    {showNewProjectInput ? (
                                                        <input className="w-full p-2 border border-gray-300 rounded text-sm"
                                                            placeholder="Enter Project Name"
                                                            value={newBatch.project} onChange={e => setNewBatch({ ...newBatch, project: e.target.value })}
                                                            onBlur={() => !newBatch.project && setShowNewProjectInput(false)}
                                                            autoFocus
                                                        />
                                                    ) : (
                                                        <select className="flex-1 p-2 border border-gray-300 rounded text-sm bg-white"
                                                            value={newBatch.project} onChange={e => setNewBatch({ ...newBatch, project: e.target.value })}
                                                        >
                                                            <option value="">Select Project</option>
                                                            {projects.map(p => <option key={p} value={p}>{p}</option>)}
                                                        </select>
                                                    )}

                                                    {!showNewProjectInput && (
                                                        <button type="button" onClick={() => setShowNewProjectInput(true)}
                                                            className="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600 whitespace-nowrap flex items-center gap-1">
                                                            <Icons.Plus className="w-3 h-3" /> New Project
                                                        </button>
                                                    )}
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Training Centre :</label>
                                                <div className="col-span-2">
                                                    <select className="w-full p-2 border border-gray-300 rounded text-sm bg-white"
                                                        value={newBatch.trainingCentre} onChange={handleTCSelection}
                                                    >
                                                        <option value="">Select Training Centre</option>
                                                        {trainingCentres.map(tc => <option key={tc.id} value={tc.name}>{tc.name}</option>)}
                                                    </select>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">State:</label>
                                                <div className="col-span-2">
                                                    <input readOnly className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 text-gray-500"
                                                        value={newBatch.state}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Spoc Contact No:</label>
                                                <div className="col-span-2">
                                                    <input className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 placeholder-gray-400"
                                                        placeholder="Center Contact No"
                                                        value={newBatch.spocContactNo} onChange={e => setNewBatch({ ...newBatch, spocContactNo: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-start pt-2">
                                                <label className="text-xs font-bold text-gray-700 mt-1">Center Address:</label>
                                                <div className="col-span-2">
                                                    <textarea rows="3" className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 placeholder-gray-400 resize-none"
                                                        placeholder="Center Address"
                                                        value={newBatch.centerAddress} onChange={e => setNewBatch({ ...newBatch, centerAddress: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Assessment Start Date :</label>
                                                <div className="col-span-2 relative">
                                                    <input type="date" required className="w-full p-2 border border-gray-300 rounded text-sm text-gray-500"
                                                        value={newBatch.startDate ? newBatch.startDate.split('T')[0] : ''}
                                                        onChange={e => setNewBatch({ ...newBatch, startDate: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Assessment End Date :</label>
                                                <div className="col-span-2 relative">
                                                    <input type="date" required className="w-full p-2 border border-gray-300 rounded text-sm text-gray-500"
                                                        value={newBatch.endDate}
                                                        onChange={e => setNewBatch({ ...newBatch, endDate: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Login Restrict Count:</label>
                                                <div className="col-span-2">
                                                    <input type="number" className="w-full p-2 border border-gray-300 rounded text-sm"
                                                        value={newBatch.loginRestrictCount} onChange={e => setNewBatch({ ...newBatch, loginRestrictCount: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Mode Of Assessment :</label>
                                                <div className="col-span-2">
                                                    <select className="w-full p-2 border border-gray-300 rounded text-sm bg-white"
                                                        value={newBatch.modeOfAssessment} onChange={e => setNewBatch({ ...newBatch, modeOfAssessment: e.target.value })}
                                                    >
                                                        <option value="">--Select--</option>
                                                        {assessmentModes.map(m => <option key={m} value={m}>{m}</option>)}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Right Column */}
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Batch Size:</label>
                                                <div className="col-span-2">
                                                    <input className="w-full p-2 border border-gray-300 rounded text-sm placeholder-gray-400"
                                                        placeholder="Batch Size"
                                                        value={newBatch.batchSize} onChange={e => setNewBatch({ ...newBatch, batchSize: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Center ID :</label>
                                                <div className="col-span-2">
                                                    <input readOnly className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 text-gray-500 placeholder-gray-400"
                                                        placeholder="Center ID"
                                                        value={newBatch.centerId}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">District:</label>
                                                <div className="col-span-2">
                                                    <input readOnly className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 text-gray-500"
                                                        value={newBatch.district}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Spoc EmailID:</label>
                                                <div className="col-span-2">
                                                    <input className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 placeholder-gray-400"
                                                        placeholder="Center EmailID"
                                                        value={newBatch.spocEmail} onChange={e => setNewBatch({ ...newBatch, spocEmail: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">T.P Name:</label>
                                                <div className="col-span-2">
                                                    <input className="w-full p-2 border border-gray-300 rounded text-sm bg-gray-100 placeholder-gray-400"
                                                        placeholder="Training Partner Name"
                                                        value={newBatch.tpName} onChange={e => setNewBatch({ ...newBatch, tpName: e.target.value })}
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">Start Time:</label>
                                                <div className="col-span-2 flex gap-2">
                                                    <input type="time" className="flex-1 p-2 border border-gray-300 rounded text-sm text-gray-500"
                                                        value={newBatch.startTime} onChange={e => setNewBatch({ ...newBatch, startTime: e.target.value })}
                                                    />
                                                    <select className="p-2 border border-gray-300 rounded text-sm bg-white">
                                                        <option>AM</option>
                                                        <option>PM</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="text-xs font-bold text-gray-700">End Time:</label>
                                                <div className="col-span-2 flex gap-2">
                                                    <input type="time" className="flex-1 p-2 border border-gray-300 rounded text-sm text-gray-500"
                                                        value={newBatch.endTime} onChange={e => setNewBatch({ ...newBatch, endTime: e.target.value })}
                                                    />
                                                    <select className="p-2 border border-gray-300 rounded text-sm bg-white">
                                                        <option>PM</option>
                                                        <option>AM</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-3 items-center">
                                                <label className="flex items-center gap-2 text-xs font-bold text-gray-700 cursor-pointer select-none">
                                                    <input type="checkbox" className="w-4 h-4 text-blue-600 rounded"
                                                        checked={newBatch.captureImage} onChange={e => setNewBatch({ ...newBatch, captureImage: e.target.checked })}
                                                    />
                                                    Capture Image
                                                </label>
                                                <div className="col-span-2">
                                                    <input className="w-full p-2 border border-gray-300 rounded text-sm placeholder-gray-400"
                                                        placeholder="Camera Interval in Seconds."
                                                        value={newBatch.cameraInterval} onChange={e => setNewBatch({ ...newBatch, cameraInterval: e.target.value })}
                                                        disabled={!newBatch.captureImage}
                                                    />
                                                </div>
                                            </div>
                                        </div>


                                        {/* Footer */}
                                        <div className="flex gap-4 justify-start pt-8 mt-4">
                                            <button type="submit" className="px-8 py-2 bg-green-500 text-white rounded text-sm font-medium hover:bg-green-600 shadow-sm">
                                                {newBatch.id ? 'Update Batch' : 'Create Batch'}
                                            </button>
                                            <button type="button" onClick={() => setShowCreateModal(false)} className="px-6 py-2 bg-white text-gray-600 hover:bg-gray-50 rounded text-sm font-medium border border-gray-300">Cancel</button>
                                        </div>
                                    </form>
                                </div>
                            </div >
                        )
                    }

                    {
                        showAssignModal && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                                <div className="bg-white rounded-xl p-6 w-full max-w-md">
                                    <h3 className="text-xl font-bold mb-4">Assign {assignmentType} QP</h3>
                                    <div className="space-y-4">
                                        <p className="text-gray-600">Assigning to batch: <span className="font-bold">{selectedBatch?.name}</span></p>

                                        {/* Modal Filters */}
                                        <div className="space-y-4 mb-4 bg-gray-50 p-3 rounded">
                                            <div>
                                                <label className="text-xs font-bold text-gray-700 block mb-1">Sector Skill Council</label>
                                                <select className="w-full p-2 border rounded text-sm" value={assignSSC} onChange={e => { setAssignSSC(e.target.value); setAssignQPDef(''); setSelectedAssignQP(''); }}>
                                                    <option value="">Select SSC</option>
                                                    {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-xs font-bold text-gray-700 block mb-1">Qualification Pack</label>
                                                <select className="w-full p-2 border rounded text-sm" value={assignQPDef} onChange={e => { setAssignQPDef(e.target.value); setSelectedAssignQP(''); }}>
                                                    <option value="">Select QP</option>
                                                    {(() => {
                                                        const uniqueCodes = new Set();
                                                        return qpList.filter(q => {
                                                            if (!assignSSC || q.sscId === assignSSC) {
                                                                const code = (q.code || '').trim().toLowerCase();
                                                                if (uniqueCodes.has(code)) return false;
                                                                uniqueCodes.add(code);
                                                                return true;
                                                            }
                                                            return false;
                                                        }).map(q => <option key={q.id} value={q.id}>{q.name} ({q.code})</option>);
                                                    })()}
                                                </select>
                                            </div>
                                        </div>

                                        <label className="text-xs font-bold text-gray-700 block mb-1">Select Question Paper</label>
                                        <select className="w-full px-4 py-2 border rounded mb-4" value={selectedAssignQP} onChange={e => setSelectedAssignQP(e.target.value)}>
                                            <option value="">Select Question Paper</option>
                                            {questionPapers.filter(qp => (!assignSSC || qp.sscId === assignSSC) && (!assignQPDef || qp.qpId === assignQPDef)).map(qp => <option key={qp.id} value={qp.id}>{qp.qpName}</option>)}
                                        </select>
                                        <div className="flex gap-2">
                                            <button onClick={handleAssignQP} className="flex-1 bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">Assign</button>
                                            <button onClick={() => setShowAssignModal(false)} className="flex-1 bg-gray-100 text-gray-600 py-2 rounded hover:bg-gray-200">Cancel</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )
                    }

                    {
                        showStudentModal && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-5xl my-8">
                                    <div className="bg-gray-100 px-6 py-4 flex justify-between items-center border-b">
                                        <h3 className="text-xl font-bold text-gray-800">Students</h3>
                                        <button onClick={() => setShowStudentModal(false)} className="text-gray-500 hover:text-red-500">
                                            <Icons.XCircle className="w-6 h-6" />
                                        </button>
                                    </div>

                                    <div className="p-8">
                                        <div className="grid grid-cols-[200px_1fr] gap-4 mb-6">
                                            <div className="font-bold text-gray-700 text-right">Sector Skill Council :</div>
                                            <div className="text-gray-600">{sscList.find(s => s.id === selectedBatch?.sscId)?.name || 'Apparel'}</div>

                                            <div className="font-bold text-gray-700 text-right">Qualification Pack :</div>
                                            <div className="text-gray-600">{qpList.find(q => q.id === selectedBatch?.theoryPaperId)?.name || 'Advanced Course for Stylist'}</div>
                                        </div>

                                        <div className="flex justify-between items-center mb-4">
                                            <div className="flex items-center gap-2 text-gray-700 font-medium">
                                                <Icons.Users className="w-5 h-5 text-blue-500" />
                                                <span>Total Records : {selectedBatch ? window.Utils.getStudentsByBatch(selectedBatch.id).length : 0}</span>
                                            </div>
                                            <div className="bg-gray-100 p-2 rounded border border-dashed border-gray-300 flex items-center gap-2">
                                                <span className="text-xs font-bold text-gray-500">Add Students:</span>
                                                <input type="file" accept=".xlsx, .xls" onChange={handleStudentUpload} className="text-xs" />
                                            </div>
                                        </div>

                                        <div className="bg-white border rounded shadow-sm overflow-hidden">
                                            <table className="w-full text-left">
                                                <thead className="bg-gray-50 border-b">
                                                    <tr>
                                                        <th className="p-3 font-bold text-gray-700 border-r w-24">Photo</th>
                                                        <th className="p-3 font-bold text-gray-700 border-r">Enrollment No</th>
                                                        <th className="p-3 font-bold text-gray-700 border-r">User Name</th>
                                                        <th className="p-3 font-bold text-gray-700 border-r">Student Name</th>
                                                        <th className="p-3 font-bold text-gray-700 w-24 text-center">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y">
                                                    {selectedBatch && window.Utils.getStudentsByBatch(selectedBatch.id).map((student, idx) => (
                                                        <tr key={student.id} className="hover:bg-gray-50">
                                                            <td className="p-3 border-r text-center">
                                                                <div className="w-12 h-12 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-500 mx-auto">
                                                                    No Image
                                                                </div>
                                                            </td>
                                                            <td className="p-3 border-r text-gray-700">{student.enrollmentNo || student.username}</td>
                                                            <td className="p-3 border-r text-gray-700">{student.username}</td>
                                                            <td className="p-3 border-r text-gray-700">{student.name}</td>
                                                            <td className="p-3 text-center">
                                                                <button onClick={() => { if (confirm('Delete?')) { window.Utils.deleteStudent(student.id); setSelectedBatch({ ...selectedBatch }); window.Utils.uploadToCloud(true); } }}
                                                                    className="text-red-500 hover:text-red-700 p-2 hover:bg-red-50 rounded-full transition-colors" title="Delete Student">
                                                                    <Icons.Trash2 className="w-4 h-4" />
                                                                </button>
                                                                <button onClick={() => setVivaSession({ batch: selectedBatch, student: student })}
                                                                    className="ml-2 bg-green-50 text-green-600 hover:bg-green-100 hover:text-green-700 px-3 py-1 rounded-full text-xs font-bold border border-green-200 transition-colors flex items-center gap-1" title="Start Live Viva">
                                                                    <Icons.Video className="w-3 h-3" /> Live Viva
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                    {(!selectedBatch || window.Utils.getStudentsByBatch(selectedBatch.id).length === 0) && (
                                                        <tr>
                                                            <td colSpan="5" className="p-8 text-center text-gray-400">No students found in this batch.</td>
                                                        </tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )
                    }
                    {vivaSession && <VivaLobby batch={vivaSession.batch} onClose={() => setVivaSession(null)} />}
                </div >
            );
        };

        // Helper Component: Video from IndexedDB
        const VideoPlayerDB = ({ videoKey }) => {
            const [url, setUrl] = useState(null);
            const [status, setStatus] = useState('loading');

            useEffect(() => {
                VideoDB.getVideo(videoKey).then(blob => {
                    if (blob) {
                        setUrl(URL.createObjectURL(blob));
                        setStatus('ready');
                    } else {
                        setStatus('error');
                    }
                }).catch(() => setStatus('error'));
            }, [videoKey]);

            if (status === 'loading') return <div className="p-4 text-gray-500 text-center text-xs">Loading Video...</div>;
            if (status === 'error') return <div className="p-4 text-red-500 text-center text-xs">Video File Not Found</div>;

            return (
                <div className="relative">
                    <video src={url} controls className="w-full h-32 object-cover bg-black" />
                    <a href={url} download={`exam_video_${videoKey}.webm`} className="absolute bottom-2 right-2 bg-white/80 p-1 rounded text-xs hover:bg-white flex items-center shadow">
                        <Icons.Save className="w-3 h-3 mr-1" /> Download
                    </a>
                </div>
            );
        };

        // RESULTS TAB


        const ResultsTab = () => {
            const [batches, setBatches] = useState([]);
            const [selectedBatch, setSelectedBatch] = useState(null);
            const [examType, setExamType] = useState(null);
            const [students, setStudents] = useState([]);
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [allResponses, setAllResponses] = useState([]); // State for reliable updates

            // Filters & Data
            const [sscList, setSscList] = useState([]);
            const [qpList, setQpList] = useState([]);
            const [filterSSC, setFilterSSC] = useState('');
            const [filterQP, setFilterQP] = useState('');
            const [allQPapers, setAllQPapers] = useState([]);


            useEffect(() => {
                setBatches(window.Utils.getBatches());
                setSscList(window.Utils.getSSC());
                setQpList(window.Utils.getQPs());
                setAllQPapers(window.Utils.getQuestionPapers());
                setAllResponses(window.Utils.getResponses()); // Load initially
            }, []);

            const loadResults = (type) => {
                setExamType(type);
                setStudents(window.Utils.getStudentsByBatch(selectedBatch.id));
            };

            const viewEvidence = (student) => {
                setSelectedStudent(student);
            };




            if (!selectedBatch) return (
                <div>
                    <div className="grid grid-cols-2 gap-4 mb-6 bg-white p-4 rounded shadow-sm">
                        <div>
                            <label className="text-xs font-bold text-gray-500 block mb-1">Filter by Sector (SSC)</label>
                            <select className="w-full p-2 border rounded" value={filterSSC} onChange={e => { setFilterSSC(e.target.value); setFilterQP(''); }}>
                                <option value="">All Sectors</option>
                                {sscList.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="text-xs font-bold text-gray-500 block mb-1">Filter by Qualification Pack (QP)</label>
                            <select className="w-full p-2 border rounded" value={filterQP} onChange={e => setFilterQP(e.target.value)}>
                                <option value="">All QPs</option>
                                {qpList.filter(q => filterSSC && q.sscId === filterSSC).map(q => <option key={q.id} value={q.id}>{q.name}</option>)}
                            </select>
                        </div>
                    </div>

                    <div className="grid gap-4 md:grid-cols-2">
                        {batches.filter(b => {
                            // Resolve the actual Question Papers assigned to this batch
                            const tPaper = allQPapers.find(p => p.id === b.theoryPaperId);
                            const pPaper = allQPapers.find(p => p.id === b.practicalPaperId);
                            const vPaper = allQPapers.find(p => p.id === b.vivaPaperId);

                            if (filterQP) {
                                // Check if either assigned paper belongs to the selected QP ID
                                console.log("Filtering QP", filterQP, "Batch", b.name, "T:", tPaper?.qpId, "P:", pPaper?.qpId, "V:", vPaper?.qpId);
                                const matchesTheory = tPaper && String(tPaper.qpId) === String(filterQP);
                                const matchesPractical = pPaper && String(pPaper.qpId) === String(filterQP);
                                const matchesViva = vPaper && String(vPaper.qpId) === String(filterQP);
                                return matchesTheory || matchesPractical || matchesViva;
                            }



                            return false;
                        }).map(b => (
                            <div key={b.id} onClick={() => setSelectedBatch(b)} className="bg-white p-6 rounded shadow cursor-pointer hover:shadow-lg border-l-4 border-indigo-500 group relative">
                                <button
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        if (confirm('Are you sure you want to delete this batch? All associated students and data will be removed.')) {
                                            window.Utils.deleteBatch(b.id);
                                            setBatches(window.Utils.getBatches());
                                        }
                                    }}
                                    className="absolute top-4 right-4 text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity p-2 hover:bg-red-50 rounded-full"
                                    title="Delete Batch"
                                >
                                    <Icons.Trash2 className="w-5 h-5" />
                                </button>
                                <h3 className="font-bold text-lg">{b.name}</h3>
                                <p className="text-gray-500 text-sm mb-2">{b.startDate} - {b.endDate}</p>
                                <div className="text-xs text-gray-400">
                                    QP: {qpList.find(q => q.id === (allQPapers.find(p => p.id === (b.theoryPaperId || b.practicalPaperId || b.vivaPaperId))?.qpId))?.name || 'N/A'}
                                </div>
                            </div>

                        ))}
                        {batches.length === 0 && <div className="text-gray-400 col-span-2 text-center py-8">No Batches Found</div>}
                    </div>
                </div>
            );

            if (!examType) return (
                <div>
                    <button onClick={() => setSelectedBatch(null)} className="mb-4 text-indigo-600 font-medium flex items-center gap-1"><Icons.ChevronDown className="rotate-90" /> Back to Batches</button>
                    <h3 className="text-xl font-bold mb-4">Select Exam Type</h3>
                    <div className="flex gap-4">
                        {['Theory', 'Practical', 'Viva', 'Photo'].map(t => (
                            <button key={t} onClick={() => loadResults(t)} className="flex-1 bg-white p-8 rounded shadow text-xl font-bold hover:shadow-lg border border-gray-100">{t}</button>
                        ))}
                    </div>
                </div>
            );

            if (!selectedStudent) return (
                <div>
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={() => setExamType(null)} className="text-indigo-600 font-medium flex items-center gap-1"><Icons.ChevronDown className="rotate-90" /> Back</button>
                        <button onClick={async () => {
                            const btn = document.getElementById('refresh-btn');
                            if (btn) btn.innerText = 'Syncing...';
                            await window.Utils.downloadFromCloud(true);
                            if (btn) btn.innerText = 'Refresh Results';

                            // Reliable Update: Refresh responses state
                            setAllResponses(window.Utils.getResponses());
                            setStudents([...students]); // Force re-render just in case
                        }} id="refresh-btn" className="bg-indigo-50 hover:bg-indigo-100 text-indigo-700 px-3 py-1 rounded text-sm font-bold flex items-center gap-2 border border-indigo-200">
                            <Icons.RefreshCw className="w-4 h-4" /> Refresh Results
                        </button>
                    </div>
                    <h3 className="text-xl font-bold mb-4">{selectedBatch.name} - {examType} Results</h3>
                    <div className="bg-white rounded overflow-hidden shadow">
                        {students.map((s, i) => {
                            const hasResponse = allResponses.some(r => r.studentId === s.id && r.examType === examType);
                            return (
                                <div key={s.id} className={`p-4 border-b flex justify-between items-center hover:opacity-90 transition-opacity ${hasResponse ? 'bg-green-50 border-green-100 text-green-900' : 'bg-red-50 border-red-100 text-red-900'}`}>
                                    <div className="flex items-center gap-2">
                                        <span className={`w-2 h-2 rounded-full ${hasResponse ? 'bg-green-500' : 'bg-red-500'}`}></span>
                                        <span className="font-medium">{i + 1}. {s.name} ({s.username})</span>
                                        <span className={`text-xs px-2 py-0.5 rounded border ${hasResponse ? 'bg-green-100 border-green-200 text-green-700' : 'bg-red-100 border-red-200 text-red-700'}`}>
                                            {hasResponse ? 'Present' : 'Absent'}
                                        </span>
                                    </div>
                                    <button onClick={() => viewEvidence(s)} className={`font-medium hover:underline flex items-center gap-1 ${hasResponse ? 'text-green-700' : 'text-red-700'}`}>
                                        View Evidence <Icons.ChevronRight className="w-4 h-4" />
                                    </button>
                                </div>
                            );
                        })}
                        {students.length === 0 && <div className="p-8 text-center text-gray-500">No students found</div>}
                    </div>
                </div>
            );

            if (selectedStudent) {
                return (
                    <StudentGradingView
                        student={selectedStudent}
                        batch={selectedBatch}
                        examType={examType}
                        allQPapers={allQPapers}
                        onBack={() => setSelectedStudent(null)}
                    />
                );
            }
        };

        // New StudentGradingView Component
        const StudentGradingView = ({ student, batch, examType, allQPapers, onBack, captureOnly = false }) => {
            const [evidence, setEvidence] = useState([]);
            const [answers, setAnswers] = useState({});
            const [grades, setGrades] = useState({});
            const [evidenceFilter, setEvidenceFilter] = useState('ALL');
            const [facingMode, setFacingMode] = useState('environment');
            const [showGallery, setShowGallery] = useState(false); // Default hidden as per user request

            // Camera State
            const [isCamActive, setIsCamActive] = useState(false);
            const [isRecording, setIsRecording] = useState(false);
            const mediaStreamRef = useRef(null);
            const videoRef = useRef(null);
            const mediaRecorderRef = useRef(null);
            const chunksRef = useRef([]);

            useEffect(() => {
                loadStudentResponse(student);
                return () => stopCam(); // Cleanup on unmount
            }, [student, examType]);

            // Fix: Attach stream to video element when it becomes active (Ref is available)
            useEffect(() => {
                if (isCamActive && videoRef.current && mediaStreamRef.current) {
                    videoRef.current.srcObject = mediaStreamRef.current;
                }
            }, [isCamActive]); // Depend on isCamActive

            const loadStudentResponse = async (s) => {
                const responses = window.Utils.getResponses();
                const resp = responses.find(r => r.studentId === s.id && r.examType === examType);

                let evList = resp?.evidence || [];
                // RESOLVE INDEXEDDB IMAGES
                const resolvedEvidence = await Promise.all(evList.map(async (e) => {
                    if (e.storage === 'indexeddb' && e.img) {
                        try {
                            const blob = await VideoDB.getVideo(e.img);
                            if (blob) {
                                return { ...e, img: URL.createObjectURL(blob), originalKey: e.img };
                            }
                        } catch (err) { console.error("Failed to load evidence image", err); }
                    }
                    return e;
                }));

                setEvidence(resolvedEvidence);
                setAnswers(resp?.answers || {});
                setGrades(resp?.assessorMarks || {});
            };

            // Camera Functions
            const startCam = async () => {
                stopCam(); // Cleanup

                // Wait 500ms for hardware to fully release
                await new Promise(r => setTimeout(r, 500));

                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert("Camera Error: Secure Context (HTTPS) required.");
                    return;
                }

                try {
                    // Force Back Camera with Standard Resolution (Fixes NotReadableError on high-res cams)
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: { ideal: "environment" },
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: true
                    });
                    mediaStreamRef.current = stream;
                    setIsCamActive(true);
                } catch (err) {
                    console.warn(`Camera failed`, err);
                    alert(`Back Camera Error: ${err.name}.\n${err.message}\nPlease close other tabs/apps.`);
                }
            };

            const stopCam = () => {
                if (mediaStreamRef.current) {
                    mediaStreamRef.current.getTracks().forEach(track => track.stop());
                    mediaStreamRef.current = null;
                }
                setIsCamActive(false);
                setIsRecording(false);
            };

            const capturePhoto = () => {
                if (!videoRef.current) return;
                const canvas = document.createElement('canvas');
                canvas.width = 640;
                canvas.height = 480;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(videoRef.current, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg');
                addEvidence(dataUrl, 'MANUAL_CAPTURE_PHOTO');
            };

            const toggleRecording = () => {
                if (isRecording) {
                    if (mediaRecorderRef.current) mediaRecorderRef.current.stop();
                    setIsRecording(false);
                } else {
                    if (!mediaStreamRef.current) return;
                    chunksRef.current = [];
                    const recorder = new MediaRecorder(mediaStreamRef.current);
                    recorder.ondataavailable = e => { if (e.data.size > 0) chunksRef.current.push(e.data); };
                    recorder.onstop = () => {
                        const blob = new Blob(chunksRef.current, { type: 'video/webm' });
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            addEvidence(reader.result, 'MANUAL_CAPTURE_VIDEO');
                        };
                        reader.readAsDataURL(blob);
                    };
                    recorder.start();
                    setIsRecording(true);
                    mediaRecorderRef.current = recorder;
                }
            };

            const addEvidence = async (data, type) => {
                const newEvidence = [...evidence, { img: data, time: new Date().toISOString(), type }];
                setEvidence(newEvidence);

                const responses = window.Utils.getResponses();
                let resp = responses.find(r => r.studentId === student.id && r.examType === examType);
                if (!resp) {
                    resp = {
                        id: window.Utils.generateId(),
                        studentId: student.id,
                        examType,
                        evidence: [],
                        answers: {},
                        assessorMarks: {}
                    };
                } else if (!resp.id) {
                    resp.id = window.Utils.generateId();
                }

                const saveObj = { ...resp, evidence: newEvidence };

                try {
                    await window.Utils.saveResponse(saveObj);
                    // Use uploadToCloud(true) handles rehydration and sync
                    window.Utils.uploadToCloud(true);
                } catch (err) {
                    console.error("Save Failed", err);
                }

                alert(type === 'MANUAL_CAPTURE_PHOTO' ? 'Photo Captured! (Saved)' : 'Video Saved!');
            };


            const saveGrades = () => {
                const responses = window.Utils.getResponses();
                let idx = responses.findIndex(r => r.studentId === student.id && r.examType === examType);

                if (idx === -1) {
                    // Create if not exists (e.g. starting fresh manual grade)
                    const newResp = {
                        id: window.Utils.generateId(),
                        studentId: student.id,
                        examType,
                        evidence,
                        answers, // might be empty for manual
                        assessorMarks: grades
                    };
                    responses.push(newResp);
                } else {
                    if (!responses[idx].id) responses[idx].id = window.Utils.generateId(); // backfill
                    responses[idx].assessorMarks = grades;
                    responses[idx].evidence = evidence; // Ensure evidence is synced

                    // Calculate Total
                    const total = Object.values(grades).reduce((a, b) => parseFloat(a || 0) + parseFloat(b || 0), 0);
                    responses[idx].totalScore = total;
                }

                try {
                    localStorage.setItem(DB_KEYS.RESPONSES, JSON.stringify(responses));
                } catch (e) {
                    console.error("Storage Full", e);
                }

                // DIRECT SYNC
                const currentResp = idx === -1 ? responses[responses.length - 1] : responses[idx];
                window.Utils.saveToCloud('responses', currentResp).catch(console.error);

                alert("Grades Saved Successfully! (Synced)");
            };

            const deleteEvidence = async () => {
                if (!confirm("Are you sure you want to DELETE ALL evidence for this student? This action cannot be undone.")) return;

                // 1. Delete Videos/Images from IndexedDB
                for (let e of evidence) {
                    const key = (e.type === 'VIDEO_INDEXED_DB' && e.key) ? e.key :
                        (e.storage === 'indexeddb' && (e.originalKey || e.img)) ? (e.originalKey || e.img) : null;

                    if (key && typeof key === 'string') {
                        try {
                            const db = await VideoDB.init();
                            const tx = db.transaction(VideoDB.storeName, 'readwrite');
                            tx.objectStore(VideoDB.storeName).delete(key);
                        } catch (err) { console.error("Failed to delete media", err); }
                    }
                }

                // 2. Update LocalStorage (Remove evidence array)
                const responses = window.Utils.getResponses();
                const idx = responses.findIndex(r => r.studentId === student.id && r.examType === examType);
                if (idx >= 0) {
                    if (!responses[idx].id) responses[idx].id = window.Utils.generateId(); // backfill
                    responses[idx].evidence = []; // Clear evidence

                    try {
                        localStorage.setItem(DB_KEYS.RESPONSES, JSON.stringify(responses));
                    } catch (e) {
                        console.error("Storage Full", e);
                    }

                    // DIRECT SYNC
                    window.Utils.saveToCloud('responses', responses[idx]).catch(console.error);
                }

                setEvidence([]); // Clear UI
                alert("Evidence Deleted Successfully. (Synced)");
            };

            // Helper to download all evidence
            const downloadAllEvidence = async () => {
                // ... existing implementation if needed or kept minimal
                alert("Download implementation preserved but hidden for brevity. Use original if restored.");
            };

            // Force Camera to be visible ONLY for Assessor (who has captureOnly=true)
            const showCamera = captureOnly;

            return (
                <div>
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={onBack} className="text-indigo-600 font-medium flex items-center gap-1"><Icons.ChevronDown className="rotate-90" /> Back</button>
                        <h3 className="text-xl font-bold">{captureOnly ? 'Capture Evidence: ' : 'Evidence: '}{student.name}</h3>
                        <div className="flex gap-2">
                            <button onClick={() => setShowGallery(!showGallery)} className="bg-gray-200 text-gray-700 px-4 py-2 rounded shadow hover:bg-gray-300 flex items-center gap-2 font-bold">
                                {showGallery ? <Icons.EyeOff className="w-4 h-4" /> : <Icons.Eye className="w-4 h-4" />} {showGallery ? 'Hide Gallery' : 'View Gallery'}
                            </button>
                            {!captureOnly && (
                                <>
                                    <button onClick={saveGrades} className="bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 flex items-center gap-2 font-bold transition-transform hover:scale-105">
                                        <Icons.Check className="w-4 h-4" /> Save Grades
                                    </button>
                                    <button onClick={deleteEvidence} className="text-red-600 hover:text-red-700 p-2" title="Reset Evidence">
                                        <Icons.Trash2 className="w-5 h-5" />
                                    </button>
                                </>
                            )}
                        </div>
                    </div>

                    {/* Assessor Camera Section - ALWAYS VISIBLE */}
                    {showCamera && (
                        <div className="bg-slate-900 p-4 rounded shadow mb-6 text-white text-center">
                            {!isCamActive ? (
                                <div className="py-8">
                                    <Icons.Camera className="w-16 h-16 mx-auto text-slate-700 mb-4" />
                                    <h4 className="text-xl font-bold mb-2">Ready to Capture</h4>
                                    <p className="text-gray-400 mb-6">Take photos or record videos for {examType} evidence.</p>
                                    <button onClick={startCam} className="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-full font-bold shadow-lg transform hover:scale-105 transition-all text-lg">
                                        <Icons.Camera className="w-5 h-5 inline mr-2" /> Start Camera
                                    </button>
                                </div>
                            ) : (
                                <div>
                                    <div className="grid md:grid-cols-2 gap-4">
                                        <div className="relative bg-black rounded overflow-hidden aspect-video shadow-2xl border border-gray-700">
                                            <video ref={videoRef} autoPlay muted playsInline className="w-full h-full object-cover"></video>
                                            {isRecording && (
                                                <div className="absolute top-4 right-4 animate-pulse flex items-center gap-2 bg-red-600/90 backdrop-blur text-white px-3 py-1 rounded-full text-xs font-bold ring-2 ring-red-500/50">
                                                    <span className="w-2 h-2 rounded-full bg-white"></span> RECORDING
                                                </div>
                                            )}
                                        </div>
                                        <div className="flex flex-col justify-center gap-4 px-8">
                                            <button onClick={capturePhoto} className="bg-white text-slate-900 hover:bg-indigo-50 py-4 rounded-xl font-bold flex items-center justify-center gap-3 shadow-xl transition-all hover:-translate-y-1 active:scale-95 border-b-4 border-gray-200">
                                                <Icons.Camera className="w-6 h-6 text-indigo-600" /> Capture Photo
                                            </button>
                                            <button onClick={toggleRecording} className={`py-4 rounded-xl font-bold flex items-center justify-center gap-3 shadow-xl transition-all hover:-translate-y-1 active:scale-95 border-b-4 ${isRecording ? 'bg-red-500 hover:bg-red-600 text-white border-red-700' : 'bg-slate-700 hover:bg-slate-600 text-white border-slate-900'}`}>
                                                {isRecording ? <><Icons.Square className="w-5 h-5" /> Stop Recording</> : <><Icons.Video className="w-6 h-6" /> Start Video Recording</>}
                                            </button>
                                            <button onClick={stopCam} className="mt-4 text-gray-500 hover:text-white text-sm font-medium w-full">Cancel / Turn Off Camera</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Evidence Gallery (Categorized) */}
                    {showGallery && (
                        <div className="bg-white rounded shadow animate-fade-in mb-6 border-l-4 border-indigo-500 overflow-hidden">
                            <div className="flex bg-gray-100 border-b">
                                {['ALL', 'PHOTOS', 'VIDEOS', 'LOGS'].map(tab => (
                                    <button
                                        key={tab}
                                        onClick={() => setEvidenceFilter(tab)}
                                        className={`px-6 py-3 font-bold text-sm transition-colors ${evidenceFilter === tab ? 'bg-white text-indigo-600 border-t-2 border-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}
                                    >
                                        {tab}
                                    </button>
                                ))}
                            </div>

                            <div className="p-6">
                                {(() => {
                                    let filtered = evidence;
                                    if (evidenceFilter === 'PHOTOS') filtered = evidence.filter(e => e.type?.includes('PHOTO') || e.type?.includes('IMG'));
                                    if (evidenceFilter === 'VIDEOS') filtered = evidence.filter(e => e.type?.includes('VIDEO'));
                                    if (evidenceFilter === 'LOGS') filtered = evidence.filter(e => !e.type?.includes('PHOTO') && !e.type?.includes('VIDEO')); // Assuming logs are everything else

                                    if (filtered.length === 0) return <p className="text-gray-400 text-sm text-center py-8">No records found for {evidenceFilter}</p>;

                                    if (evidenceFilter === 'LOGS') {
                                        return (
                                            <div className="space-y-2">
                                                {filtered.map((e, i) => (
                                                    <div key={i} className="flex items-center justify-between p-3 bg-gray-50 rounded border-l-4 border-amber-400">
                                                        <div className="flex items-center gap-3">
                                                            <Icons.TriangleAlert className="w-5 h-5 text-amber-500" />
                                                            <div>
                                                                <p className="font-bold text-sm text-gray-800">{(e.type || 'UNKNOWN').replace(/_/g, ' ')}</p>
                                                                <p className="text-xs text-gray-500">System Flag</p>
                                                            </div>
                                                        </div>
                                                        <span className="text-xs font-mono bg-white px-2 py-1 rounded border">{new Date(e.time).toLocaleString()}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        );
                                    }

                                    return (
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            {filtered.map((e, i) => (
                                                <div key={i} className="relative group bg-gray-100 rounded overflow-hidden border">
                                                    {e.type.includes('VIDEO') ? (
                                                        e.key ? (
                                                            // Video stored in IndexedDB
                                                            <VideoPlayerDB videoKey={e.key} />
                                                        ) : (
                                                            // Video as blob/data URL
                                                            <video src={e.img} controls className="w-full h-32 object-cover bg-black"
                                                                onError={(ev) => {
                                                                    ev.target.style.display = 'none';
                                                                    ev.target.nextSibling.style.display = 'flex';
                                                                }}
                                                            />
                                                        )
                                                    ) : (
                                                        <img src={e.img} className="w-full h-32 object-cover transition-transform group-hover:scale-105"
                                                            onClick={() => {
                                                                if (e.img.startsWith('blob:') || e.img.startsWith('data:')) {
                                                                    const w = window.open("");
                                                                    w.document.write(`<img src="${e.img}" style="max-width:100%"/>`);
                                                                } else {
                                                                    alert("Image not available on this device. Please sync from the source device.");
                                                                }
                                                            }}
                                                            onError={(ev) => {
                                                                ev.target.style.display = 'none';
                                                                ev.target.nextSibling.style.display = 'flex';
                                                            }}
                                                        />
                                                    )}
                                                    {/* Fallback for Error */}
                                                    <div className="absolute inset-0 hidden flex-col items-center justify-center bg-gray-200 text-gray-500 p-2 text-center">
                                                        <Icons.XCircle className="w-8 h-8 mb-1" />
                                                        <span className="text-[10px] font-bold">Media Not Found</span>
                                                    </div>

                                                    <div className="absolute top-0 left-0 bg-black/60 text-white text-[10px] px-2 py-1 rounded-br">
                                                        {new Date(e.time).toLocaleTimeString()}
                                                    </div>
                                                    <div className="absolute inset-x-0 bottom-0 bg-white/90 p-2 text-xs font-bold truncate text-center border-t">
                                                        {e.type.replace(/_/g, ' ')}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    );
                                })()}
                            </div>
                        </div>
                    )}

                    {!captureOnly && (
                        <div className="bg-white p-6 rounded shadow">
                            {(() => {
                                const currentQPId = examType === 'Theory' ? batch?.theoryPaperId : (examType === 'Viva' ? batch?.vivaPaperId : batch?.practicalPaperId);
                                const currentQP = allQPapers.find(q => q.id === currentQPId);

                                return (
                                    <>
                                        <h4 className="font-bold mb-4 flex items-center justify-between">
                                            <span>Grading: {currentQP?.name || 'Manual Grade'}</span>
                                            <span className="text-sm font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded">QP: {currentQP?.code || 'N/A'}</span>
                                        </h4>
                                        <div className="space-y-4">
                                            {currentQP?.questions?.map((question, index) => {
                                                const qIdx = String(index);
                                                const ans = answers[qIdx];
                                                return (
                                                    <div key={qIdx} className="bg-gray-50 p-4 rounded border flex items-center justify-between">
                                                        <div className="flex-1 pr-4">
                                                            <span className="font-bold text-gray-700 block mb-1">Q{index + 1}: {question?.question}</span>
                                                            {/* Tiny Answer preview */}
                                                            {typeof ans === 'string' && (
                                                                <div className="mt-1">
                                                                    <p className={`text-xs font-medium truncate max-w-md ${question?.correctAnswer && String(ans).toLowerCase() === String(question.correctAnswer).toLowerCase() ? 'text-green-600' : 'text-gray-600'}`}>
                                                                        Student Answer: {ans}
                                                                    </p>
                                                                    {question?.correctAnswer && (
                                                                        <p className="text-xs text-green-700 font-bold truncate max-w-md">
                                                                            Correct Answer: {question.correctAnswer}
                                                                        </p>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div className="flex items-center gap-3">
                                                            <div className="flex items-center gap-2 bg-white p-2 rounded border shadow-sm">
                                                                <span className="text-xs font-bold text-gray-500 uppercase">Score</span>
                                                                <input type="number"
                                                                    className="w-16 p-1 border-b-2 border-indigo-200 text-center font-bold text-indigo-700 outline-none focus:border-indigo-600"
                                                                    placeholder="0"
                                                                    max={question?.totalMarks}
                                                                    value={grades[qIdx] !== undefined ? grades[qIdx] : 0}
                                                                    onChange={e => setGrades({ ...grades, [qIdx]: e.target.value })}
                                                                />
                                                                <span className="text-xs text-gray-400">/ {question?.totalMarks}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                            {(!currentQP || !currentQP.questions || currentQP.questions.length === 0) && (
                                                <div className="p-8 text-center border-2 border-dashed rounded bg-gray-50">
                                                    <p className="text-gray-500 mb-4">No Question Paper assigned for {examType}.</p>
                                                    <label className="block text-sm font-bold text-gray-700 mb-1">Enter Total Score Manually</label>
                                                    <input type="number" className="p-2 border rounded w-32 text-center font-bold text-xl" placeholder="0"
                                                        onChange={e => setGrades({ 'MANUAL_TOTAL': e.target.value })}
                                                    />
                                                </div>
                                            )}
                                        </div>
                                    </>
                                );
                            })()}
                        </div>
                    )}
                </div>
            );
        };

        const CalendarTab = () => {
            const [date, setDate] = useState(new Date());
            const [events, setEvents] = useState([]);
            const [selectedDateEvents, setSelectedDateEvents] = useState([]);

            useEffect(() => {
                const loadEvents = () => {
                    const loadEvents = () => {
                        const batches = window.Utils.getBatches();
                        // Map batches to events
                        const evts = [];
                        batches.forEach(b => {
                            if (b.startDate) {
                                const d = new Date(b.startDate);
                                if (!isNaN(d.getTime())) {
                                    evts.push({
                                        date: d,
                                        title: `Start: ${b.name}`,
                                        type: 'start',
                                        data: b
                                    });
                                }
                            }
                            if (b.endDate) {
                                const d = new Date(b.endDate);
                                if (!isNaN(d.getTime())) {
                                    evts.push({
                                        date: d,
                                        title: `End: ${b.name}`,
                                        type: 'end',
                                        data: b
                                    });
                                }
                            }
                        });
                        setEvents(evts);
                    };
                };
                loadEvents();
                window.addEventListener('cloud-sync-complete', loadEvents);
                return () => window.removeEventListener('cloud-sync-complete', loadEvents);
            }, []);

            const daysInMonth = (month, year) => new Date(year, month + 1, 0).getDate();
            const firstDayOfMonth = (month, year) => new Date(year, month, 1).getDay();

            const renderCalendar = () => {
                const month = date.getMonth();
                const year = date.getFullYear();
                const totalDays = daysInMonth(month, year);
                const startDay = firstDayOfMonth(month, year);
                const days = [];

                // Empty slots for days before start of month
                for (let i = 0; i < startDay; i++) {
                    days.push(<div key={`empty-${i}`} className="h-24 bg-gray-50 border border-gray-100"></div>);
                }

                // Days of month
                for (let d = 1; d <= totalDays; d++) {
                    const currentDay = new Date(year, month, d);
                    const dayEvents = events.filter(e =>
                        e.date.getDate() === d &&
                        e.date.getMonth() === month &&
                        e.date.getFullYear() === year
                    );

                    days.push(
                        <div key={d}
                            onClick={() => setSelectedDateEvents(dayEvents)}
                            className={`h-24 border border-gray-100 p-2 cursor-pointer transition hover:bg-blue-50 ${dayEvents.length > 0 ? 'bg-blue-50/30' : 'bg-white'}`}>
                            <div className="flex justify-between items-start">
                                <span className={`text-sm font-bold ${dayEvents.length > 0 ? 'text-blue-600' : 'text-gray-700'}`}>{d}</span>
                                {dayEvents.length > 0 && <span className="w-2 h-2 rounded-full bg-blue-500"></span>}
                            </div>
                            <div className="mt-1 space-y-1 overflow-hidden h-14">
                                {dayEvents.map((ev, i) => (
                                    <div key={i} className={`text-[10px] truncate px-1 rounded ${ev.type === 'start' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                        {ev.title}
                                    </div>
                                ))}
                            </div>
                        </div>
                    );
                }
                return days;
            };

            const changeMonth = (offset) => {
                setDate(new Date(date.getFullYear(), date.getMonth() + offset, 1));
            };

            return (
                <div className="animate-fade-in grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="md:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-gray-800">{date.toLocaleString('default', { month: 'long', year: 'numeric' })}</h2>
                            <div className="flex gap-2">
                                <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-gray-100 rounded-full"><Icons.ChevronLeft /></button>
                                <button onClick={() => changeMonth(1)} className="p-2 hover:bg-gray-100 rounded-full"><Icons.ChevronRight /></button>
                            </div>
                        </div>
                        <div className="grid grid-cols-7 gap-px mb-2 text-center text-xs font-bold text-gray-500 uppercase">
                            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                        </div>
                        <div className="grid grid-cols-7 border border-gray-100 rounded-lg overflow-hidden">
                            {renderCalendar()}
                        </div>
                    </div>

                    {/* Event Details Sidebar */}
                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <h3 className="text-lg font-bold text-gray-800 mb-4">Events</h3>
                        {selectedDateEvents.length > 0 ? (
                            <div className="space-y-4">
                                {selectedDateEvents.map((evt, idx) => (
                                    <div key={idx} className="p-4 rounded-lg bg-gray-50 border border-gray-200">
                                        <div className={`text-xs font-bold uppercase mb-1 ${evt.type === 'start' ? 'text-green-600' : 'text-red-600'}`}>
                                            {evt.type === 'start' ? 'Batch Starting' : 'Batch Ending'}
                                        </div>
                                        <h4 className="font-bold text-gray-800">{evt.data.name}</h4>
                                        <p className="text-xs text-gray-500 mt-1">{evt.data.qpName || 'No QP Assigned'}</p>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="text-center text-gray-400 py-10">
                                <Icons.Calendar className="w-12 h-12 mx-auto mb-2 opacity-50" />
                                <p>Select a date with dots to see details</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const LocationTab = () => {
            const [centers, setCenters] = useState([]);

            useEffect(() => {
                const loadCenters = () => {
                    const batches = window.Utils.getBatches();
                    // Extract unique centers from batches
                    // Assuming batch has 'trainingCentre', 'district', 'state', 'centerId', 'centerAddress'
                    const centerMap = new Map();
                    batches.forEach(b => {
                        if (b.trainingCentre) {
                            if (!centerMap.has(b.trainingCentre)) {
                                centerMap.set(b.trainingCentre, {
                                    name: b.trainingCentre,
                                    id: b.centerId || 'N/A',
                                    district: b.district || 'Unknown',
                                    state: b.state || 'Unknown',
                                    spoc: b.spocName || 'N/A', // Assuming spocName exists or strictly spocEmail
                                    address: b.centerAddress || '',
                                    activeBatches: 0
                                });
                            }
                            centerMap.get(b.trainingCentre).activeBatches += 1;
                        }
                    });
                    setCenters(Array.from(centerMap.values()));
                };
                loadCenters();
                window.addEventListener('cloud-sync-complete', loadCenters);
                return () => window.removeEventListener('cloud-sync-complete', loadCenters);
            }, []);

            return (
                <div className="animate-fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">Assessment Locations</h2>
                        <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-bold">{centers.length} Centers Active</span>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {centers.map((center, idx) => (
                            <div key={idx} className="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition">
                                <div className="flex items-start justify-between mb-4">
                                    <div className="p-3 bg-indigo-50 text-indigo-600 rounded-lg">
                                        <Icons.MapPin className="w-6 h-6" />
                                    </div>
                                    <span className="text-xs font-bold bg-green-100 text-green-700 px-2 py-1 rounded-full">
                                        {center.activeBatches} Active batches
                                    </span>
                                </div>
                                <h3 className="text-lg font-bold text-gray-800 mb-1">{center.name}</h3>
                                <p className="text-sm text-gray-500 mb-4">{center.id}</p>

                                <div className="space-y-2 text-sm text-gray-600">
                                    <div className="flex items-center gap-2">
                                        <Icons.Map className="w-4 h-4 opacity-70" />
                                        <span>{center.district}, {center.state}</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <Icons.Home className="w-4 h-4 opacity-70" />
                                        <span className="truncate" title={center.address}>{center.address || 'No Address Provided'}</span>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    {centers.length === 0 && (
                        <div className="text-center py-20 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                            <Icons.MapPin className="w-16 h-16 mx-auto text-gray-300 mb-4" />
                            <h3 className="text-xl font-bold text-gray-400">No Training Centers Found</h3>
                            <p className="text-gray-500">Create Batches with Center details to populate this map.</p>
                        </div>
                    )}
                </div>
            );
        };

        const DashboardTab = () => {
            const [stats, setStats] = useState({ batches: 0, students: 0, qps: 0, assessors: 0 });
            const [recentBatches, setRecentBatches] = useState([]);

            useEffect(() => {
                const loadStats = () => {
                    const batches = window.Utils.getBatches();
                    const students = window.Utils.getStudents();
                    const qps = window.Utils.getQuestionPapers();
                    // Assessor count estimated from batches (unique usernames) or just hardcode for demo
                    // A better way: Count unique assessors assigned to batches
                    const assessors = new Set(batches.map(b => b.assessorUsername).filter(u => u)).size;

                    setStats({
                        batches: batches.length,
                        students: students.length,
                        qps: qps.length,
                        assessors: assessors
                    });
                    setRecentBatches(batches.slice(-5).reverse());
                };
                loadStats();
                window.addEventListener('cloud-sync-complete', loadStats);
                return () => window.removeEventListener('cloud-sync-complete', loadStats);
            }, []);

            return (
                <div className="animate-fade-in">
                    <h2 className="text-2xl font-bold mb-6 text-gray-800">Administrator Dashboard</h2>

                    {/* Stats Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
                            <div className="p-3 bg-blue-50 text-blue-600 rounded-lg"><Icons.Users className="w-8 h-8" /></div>
                            <div>
                                <h3 className="text-2xl font-bold text-gray-800">{stats.batches}</h3>
                                <p className="text-sm text-gray-500">Total Batches</p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
                            <div className="p-3 bg-green-50 text-green-600 rounded-lg"><Icons.User className="w-8 h-8" /></div>
                            <div>
                                <h3 className="text-2xl font-bold text-gray-800">{stats.students}</h3>
                                <p className="text-sm text-gray-500">Total Candidates</p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
                            <div className="p-3 bg-purple-50 text-purple-600 rounded-lg"><Icons.FileText className="w-8 h-8" /></div>
                            <div>
                                <h3 className="text-2xl font-bold text-gray-800">{stats.qps}</h3>
                                <p className="text-sm text-gray-500">Question Papers</p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
                            <div className="p-3 bg-orange-50 text-orange-600 rounded-lg"><Icons.Eye className="w-8 h-8" /></div>
                            <div>
                                <h3 className="text-2xl font-bold text-gray-800">{stats.assessors}</h3>
                                <p className="text-sm text-gray-500">Active Assessors</p>
                            </div>
                        </div>
                    </div>

                    {/* Recent Activity */}
                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <h3 className="text-lg font-bold text-gray-700 mb-4">Recent Batches</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="bg-gray-50 text-xs uppercase text-gray-500">
                                    <tr>
                                        <th className="p-3 rounded-l-lg">Batch Name</th>
                                        <th className="p-3">Training Centre</th>
                                        <th className="p-3">Start Date</th>
                                        <th className="p-3">Status</th>
                                        <th className="p-3 rounded-r-lg text-right">Candidates</th>
                                    </tr>
                                </thead>
                                <tbody className="text-sm">
                                    {recentBatches.map(b => (
                                        <tr key={b.id} className="border-b last:border-0 hover:bg-gray-50">
                                            <td className="p-3 font-medium text-gray-800">{b.name}</td>
                                            <td className="p-3 text-gray-600">{b.trainingCentre || '-'}</td>
                                            <td className="p-3 text-gray-600">{b.startDate}</td>
                                            <td className="p-3"><span className="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-bold">Active</span></td>
                                            <td className="p-3 text-right font-bold text-indigo-600">{window.Utils.getStudentsByBatch(b.id).length}</td>
                                        </tr>
                                    ))}
                                    {recentBatches.length === 0 && <tr><td colSpan="5" className="p-4 text-center text-gray-400">No recent activity</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // ADMIN DASHBOARD
        const AdminDashboard = () => {
            const [activeTab, setActiveTab] = useState('qps');
            const [selectedQPForNOS, setSelectedQPForNOS] = useState(null);
            const [allQPapers, setAllQPapers] = useState([]); // Added allQPapers state

            useEffect(() => {
                const loadQPs = () => setAllQPapers(window.Utils.getQuestionPapers());
                loadQPs();
                window.addEventListener('cloud-sync-complete', loadQPs);

                // Real-Time Sync Listener
                const socket = io(SERVER_URL);
                socket.on('data-change', (data) => {
                    console.log("Remote Change Detected:", data);
                    // Trigger Silent Cloud Download
                    window.Utils.downloadFromCloud(true);
                });

                return () => {
                    window.removeEventListener('cloud-sync-complete', loadQPs);
                    socket.disconnect();
                };
            }, []);

            const handleNavigateToNOS = (qp) => {
                setSelectedQPForNOS(qp);
                setActiveTab('nos');
            };

            return (
                <div className="flex bg-gray-100 min-h-screen">
                    <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} />
                    <div className="flex-1 overflow-auto h-screen">
                        {/* Header */}
                        <header className="bg-white shadow-sm p-4 flex justify-between items-center sticky top-0 z-10">
                            <div className="flex items-center text-sm text-gray-500">
                                <span className="hover:text-gray-700 cursor-pointer">Home</span>
                                <Icons.ChevronRight />
                                <span className="font-medium text-gray-900 capitalize">{activeTab.replace(/([A-Z])/g, ' $1')}</span>
                            </div>
                            <div className="flex items-center gap-4">
                                {/* CLOUD SYNC CONTROLS */}
                                <div className="flex items-center gap-2 mr-2 border-r pr-4">
                                    <span id="sync-status-text" className="text-xs text-gray-500 hidden md:inline-block">Sync:</span>
                                    <button onClick={() => window.Utils.uploadToCloud()} className="p-2 text-blue-600 hover:bg-blue-50 rounded transition-colors" title="Upload Local Data to Cloud">
                                        <Icons.Upload className="w-5 h-5" />
                                    </button>
                                    <button onClick={() => window.Utils.downloadFromCloud()} className="p-2 text-green-600 hover:bg-green-50 rounded transition-colors" title="Download Data from Cloud">
                                        <Icons.Download className="w-5 h-5" />
                                    </button>
                                </div>

                                <div className="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold">A</div>
                                <span className="text-sm font-medium">Administrator</span>
                            </div>
                        </header>

                        <div className="p-8">
                            {activeTab === 'dashboard' && <DashboardTab />}
                            {activeTab === 'calendar' && <CalendarTab />}
                            {activeTab === 'location' && <LocationTab />}

                            {activeTab === 'subjects' && <SubjectsTab />}
                            {activeTab === 'qps' && <QPsTab onNavigateToNOS={handleNavigateToNOS} />}
                            {activeTab === 'nos' && <NOSPC_Tab selectedQP={selectedQPForNOS} onBack={() => { setSelectedQPForNOS(null); setActiveTab('qps'); }} />}
                            {activeTab === 'questionPapers' && <QuestionPapersTab />}
                            {activeTab === 'batches' && <BatchesTab />}
                            {activeTab === 'results' && <ResultsTab />}
                        </div>
                    </div>
                </div>
            );
        };




        // Code Runner Component
        const CodeRunner = ({ code, onChange }) => {
            const [language, setLanguage] = useState('python');
            const [output, setOutput] = useState('');
            const [isRunning, setIsRunning] = useState(false);

            const LANGUAGES = {
                python: { version: '3.10.0', name: 'Python 3' },
                javascript: { version: '18.15.0', name: 'Node.js' },
                c: { version: '10.2.0', name: 'C (GCC)' },
                cpp: { version: '10.2.0', name: 'C++ (GCC)' },
                java: { version: '15.0.2', name: 'Java ' }
            };

            const runCode = async () => {
                if (!code || !code.trim()) {
                    setOutput("Please type some code first.");
                    return;
                }
                setIsRunning(true);
                setOutput("Running...");

                try {
                    const response = await fetch('https://emkc.org/api/v2/piston/execute', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            language: language,
                            version: LANGUAGES[language].version,
                            files: [{ content: code }]
                        })
                    });
                    const data = await response.json();
                    if (data.run) {
                        setOutput(data.run.output || "No Output");
                    } else {
                        setOutput("Error: " + (data.message || "Unknown API Error"));
                    }
                } catch (e) {
                    setOutput("Network Error: Could not reach compiler API. Check internet connection.\n" + e.message);
                } finally {
                    setIsRunning(false);
                }
            };

            return (
                <div className="flex flex-col h-full border rounded-lg overflow-hidden bg-gray-900 text-white">
                    <div className="flex items-center justify-between p-2 bg-gray-800 border-b border-gray-700">
                        <div className="flex items-center gap-2">
                            <select value={language} onChange={e => setLanguage(e.target.value)}
                                className="bg-gray-700 text-white text-sm p-1 rounded border border-gray-600 focus:ring-1 focus:ring-indigo-500">
                                {Object.entries(LANGUAGES).map(([key, info]) => (
                                    <option key={key} value={key}>{info.name}</option>
                                ))}
                            </select>
                            <span className="text-xs text-gray-400">Powered by Piston</span>
                        </div>
                        <button onClick={runCode} disabled={isRunning}
                            className={`flex items-center gap-1 px-3 py-1 rounded text-sm font-bold transition-all ${isRunning ? 'bg-gray-600 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 text-white'}`}>
                            {isRunning ? <Icons.Loader className="w-4 h-4 animate-spin" /> : <Icons.Play className="w-4 h-4" />}
                            {isRunning ? 'Running...' : 'Run Code'}
                        </button>
                    </div>

                    <div className="grid grid-rows-2 h-[450px]">
                        {/* Editor Area */}
                        <textarea
                            value={code || ''}
                            onChange={e => onChange(e.target.value)}
                            spellCheck="false"
                            className="w-full h-full p-4 bg-gray-900 text-gray-100 font-mono text-sm resize-none focus:outline-none border-b border-gray-800"
                            placeholder={`Type your ${LANGUAGES[language].name} code here...`}
                        ></textarea>

                        {/* Output Area */}
                        <div className="bg-black p-4 overflow-auto font-mono text-sm">
                            <div className="text-gray-500 mb-2 border-b border-gray-800 pb-1 text-xs">CONSOLE OUTPUT</div>
                            <pre className={`${output.includes('Error') ? 'text-red-400' : 'text-green-400'} whitespace-pre-wrap`}>
                                {output || 'Result will appear here...'}
                            </pre>
                        </div>
                    </div>
                </div>
            );
        };

        // PRACTICAL QUESTION RUNNER
        const PracticalQuestionRunner = ({ question, answer, onAnswer }) => {
            const [isRecording, setIsRecording] = useState(false);
            const [mediaRecorder, setMediaRecorder] = useState(null);
            const [videoChunks, setVideoChunks] = useState([]);
            const [previewUrl, setPreviewUrl] = useState(answer?.video || null);
            const [photoUrl, setPhotoUrl] = useState(answer?.photo || null);
            const videoRef = useRef(null);
            const streamRef = useRef(null);

            // Cleanup stream on unmount
            useEffect(() => {
                // Initialize camera on mount if no preview
                if (!previewUrl) startCamera();
                return () => {
                    if (streamRef.current) {
                        streamRef.current.getTracks().forEach(track => track.stop());
                    }
                };
            }, []);

            const startCamera = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    streamRef.current = stream;
                    if (videoRef.current) videoRef.current.srcObject = stream;
                } catch (e) {
                    console.error("Camera Error", e);
                    // alert("Camera Error: " + e.message); // Suppress alert to avoid spam if permission denied
                }
            };

            const startRecording = async () => {
                if (!streamRef.current) await startCamera();
                if (!streamRef.current) return;

                const stream = streamRef.current;
                const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                const chunks = [];
                recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
                recorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    setPreviewUrl(url);

                    // Save to IndexedDB
                    const key = `practical_q_${Date.now()}`;
                    try {
                        await VideoDB.saveVideo(key, blob);
                        onAnswer({ ...answer, videoKey: key, photo: answer?.photo });
                    } catch (e) {
                        console.error("Failed to save practical video", e);
                        alert("Video save failed. check storage.");
                    }
                };
                recorder.start();
                setMediaRecorder(recorder);
                setIsRecording(true);
            };

            const stopRecording = () => {
                if (mediaRecorder) mediaRecorder.stop();
                setIsRecording(false);
            };

            const capturePhoto = () => {
                if (!streamRef.current && !videoRef.current) { startCamera(); return; }
                const canvas = document.createElement('canvas');
                canvas.width = 640; canvas.height = 480;
                canvas.getContext('2d').drawImage(videoRef.current, 0, 0, canvas.width, canvas.height);
                const data = canvas.toDataURL('image/jpeg', 0.7);
                setPhotoUrl(data);
                onAnswer({ ...answer, photo: data });
            };

            return (
                <div className="border rounded-xl p-4 bg-gray-50 h-[500px]">
                    <div className="flex gap-4 mb-4 h-full">
                        {/* Camera / Preview Area */}
                        <div className="flex-1 bg-black rounded-lg overflow-hidden relative group">
                            {previewUrl && !isRecording ? (
                                <div className="relative h-full">
                                    <video src={previewUrl} controls className="w-full h-full object-contain" />
                                    <button onClick={() => { setPreviewUrl(null); startCamera(); }} className="absolute top-2 right-2 bg-gray-800 text-white p-2 rounded-full opacity-70 hover:opacity-100 transition-opacity">
                                        <Icons.XCircle className="w-6 h-6" />
                                    </button>
                                </div>
                            ) : (
                                <video ref={videoRef} autoPlay muted playsInline className="w-full h-full object-cover" />
                            )}

                            {/* Recording Indicator */}
                            {isRecording && (
                                <div className="absolute top-4 right-4 flex items-center gap-2 bg-red-600 text-white px-3 py-1 rounded-full animate-pulse z-10">
                                    <div className="w-3 h-3 bg-white rounded-full"></div> REC
                                </div>
                            )}
                        </div>

                        {/* Controls & Instructions */}
                        <div className="w-64 flex flex-col gap-4">
                            <div className="bg-white p-4 rounded-lg shadow-sm border text-sm">
                                <h4 className="font-bold text-gray-700 mb-2">Instructions</h4>
                                <ul className="list-disc pl-4 space-y-1 text-gray-600">
                                    <li>Ensure good lighting.</li>
                                    <li>Keep your face/hands visible.</li>
                                    <li>Description: {question.question}</li>
                                </ul>
                            </div>

                            {!isRecording ? (
                                <button onClick={startRecording} className="bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 shadow-sm transition-all">
                                    <div className="w-4 h-4 bg-white rounded-full"></div> Start Rec
                                </button>
                            ) : (
                                <button onClick={stopRecording} className="bg-gray-800 hover:bg-gray-900 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 shadow-sm animate-pulse">
                                    <div className="w-4 h-4 bg-red-500 rounded-sm"></div> Stop Rec
                                </button>
                            )}

                            <button onClick={capturePhoto} className="bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 shadow-sm transition-all">
                                <Icons.Camera /> Capture Photo
                            </button>

                            {/* Photo Preview */}
                            {photoUrl && (
                                <div className="mt-auto border-2 border-dashed border-gray-300 rounded-lg p-2 relative bg-white">
                                    <img src={photoUrl} className="w-full h-32 object-cover rounded" />
                                    <button onClick={() => { setPhotoUrl(null); onAnswer({ ...answer, photo: null }); }} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow hover:bg-red-600">
                                        <Icons.XCircle className="w-4 h-4" />
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // STUDENT PORTAL
        const StudentPortal = ({ user }) => {
            const [examMode, setExamMode] = useState(null); // 'Theory', 'Practical', 'VivaWait'
            const [questions, setQuestions] = useState([]);
            const [currentQ, setCurrentQ] = useState(0);
            const [answers, setAnswers] = useState({});

            // Poll for Assessor "Admit" signal (Replaced by Socket.io in VivaWait)
            // useEffect(() => { ... }, []);

            // AUTO-SYNC In Background (Every 60s)
            useEffect(() => {
                const autoSync = setInterval(() => {
                    // Only sync if online
                    if (navigator.onLine) {
                        // Silent sync (no alerts)
                        window.Utils.uploadToCloud(true);
                    }
                }, 60000); // 60 seconds

                return () => clearInterval(autoSync);
            }, []);

            const [timeLeft, setTimeLeft] = useState(0);
            const [webcamActive, setWebcamActive] = useState(false);

            // PROCTORING STATE
            const [warnings, setWarnings] = useState(0);
            const [isLocked, setIsLocked] = useState(false);
            const [proctoringModel, setProctoringModel] = useState(null);
            const [proctoringLogs, setProctoringLogs] = useState([]);
            const [lastWarning, setLastWarning] = useState(null); // State for Visual Alert
            // State for Visual Alert
            const detectionInterval = useRef(null);
            const autoCaptureInterval = useRef(null);
            const mediaRecorderRef = useRef(null);
            const videoChunksRef = useRef([]);
            const recordingExamType = useRef(null); // Persist exam type for the recording session
            const [isRecording, setIsRecording] = useState(false); // UI Indicator

            // WEBRTC STATE FOR VIVA LIVE
            const [remoteStream, setRemoteStream] = useState(null);
            const socketRef = useRef(null);
            const peerRef = useRef(null);

            useEffect(() => {
                if (examMode !== 'VivaLive' && examMode !== 'VivaWait') return;

                // Initialize Socket
                socketRef.current = io(SERVER_URL);
                const socket = socketRef.current;
                // Unique Room for 1-on-1: BatchID_StudentID
                const roomId = `${user.batchId}_${user.id}`;

                console.log("Student Joining Room:", roomId);
                socket.emit('join-room', roomId, user.id); // Student joins

                // Listen for Admit Signal (Assessor Joined)
                socket.on('user-connected', (userId) => {
                    // If we are waiting, and someone joins (Assessor), we are admitted?
                    // Or explicit signal? 'user-connected' is enough proof Assessor is here.
                    if (examMode === 'VivaWait') {
                        console.log("Assessor Joined, Auto-Admitting...");
                        setExamMode('VivaLive');
                    }
                });

                if (examMode === 'VivaWait') return; // Don't setup Peer yet

                // Initialize PeerConnection
                peerRef.current = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                const pc = peerRef.current;

                // Add Local Video Tracks
                // Wait for video element to be ready or get stream from elsewhere?
                // We likely already have stream usage in 'student-cam-viva' or we should get it fresh.
                navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                    const video = document.getElementById('student-cam-viva');
                    if (video) video.srcObject = stream; // Self view

                    stream.getTracks().forEach(track => {
                        pc.addTrack(track, stream);
                    });
                });

                // Handle Turn/Stun Candidates
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.emit('signal', { roomId, signal: { type: 'candidate', candidate: event.candidate } });
                    }
                };

                // Handle Remote Stream (Assessor Video)
                pc.ontrack = (event) => {
                    setRemoteStream(event.streams[0]);
                };

                // Signaling
                // user-connected handled above for admit, typically Assessor initiates offer so we wait for signal

                socket.on('signal', async (data) => {
                    if (!data.signal) return;

                    // FIX: If we get an OFFER while waiting, we should accept it and Go Live!
                    if (examMode === 'VivaWait' && data.signal.type === 'offer') {
                        console.log("Offer Received while waiting -> Auto Admit");
                        setExamMode('VivaLive');
                        // The rest of the logic will run on next render in VivaLive block? 
                        // No, we need to handle it NOW or ensure state persists.
                        // Actually, switching mode unmounts this effect and mounts the VivaLive one?
                        // If we switch mode, this component re-renders. We might lose this specific socket event?
                        // Better to stay in "VivaWait" visually but start the logic? 
                        // No, simpliest fix: Switch mode, and Assessor will retry or we can manually join.
                        return; // Let re-render handle it? No, Assessor won't send offer again unless we ask.
                        // Better approach: Manual Button backing this up.
                    }

                    if (data.signal.type === 'offer') {
                        await pc.setRemoteDescription(new RTCSessionDescription(data.signal.sdp));
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        socket.emit('signal', { roomId, signal: { type: 'answer', sdp: answer } });
                    } else if (data.signal.type === 'answer') {
                        await pc.setRemoteDescription(new RTCSessionDescription(data.signal.sdp));
                    } else if (data.signal.type === 'candidate') {
                        await pc.addIceCandidate(new RTCIceCandidate(data.signal.candidate));
                    }
                });

                return () => {
                    socket.disconnect();
                    if (peerRef.current) peerRef.current.close();
                };
            }, [examMode, user.batchId]);
            // Poll for Assessor "Admit" signal
            // (Socket logic handled separately)

            // Dynamic Update Listener (For Exam Start Times etc)
            const [forceUpdate, setForceUpdate] = useState(0);
            useEffect(() => {
                const refresh = () => setForceUpdate(n => n + 1);
                window.addEventListener('cloud-sync-complete', refresh);
                return () => window.removeEventListener('cloud-sync-complete', refresh);
            }, []);

            // Cleanup Polling (Deleted)


            // No need for syncing effect that clears on null

            // Load Model
            useEffect(() => {
                if (window.cocoSsd) {
                    window.cocoSsd.load().then(model => {
                        console.log("Proctoring Model Loaded");
                        setProctoringModel(model);
                    });
                }
            }, []);

            // Check Lock Status on Load
            useEffect(() => {
                const checkLock = () => {
                    const status = JSON.parse(localStorage.getItem('se_student_lock_' + user.id) || 'null');
                    if (status) {
                        setIsLocked(false); // MODIFIED: Never restore lock state
                        setWarnings(status.warnings);
                    }
                };
                checkLock();
                const interval = setInterval(checkLock, 2000); // Poll for unlock
                return () => clearInterval(interval);
            }, [user.id]);

            // Save Lock Status
            const updateLockStatus = (newWarnings, locked) => {
                setWarnings(newWarnings);
                if (locked) setIsLocked(true);
                localStorage.setItem('se_student_lock_' + user.id, JSON.stringify({ isLocked: locked, warnings: newWarnings }));
            };

            // Log Violation
            const logViolation = (msg) => {
                if (isLocked) return;
                const newWarnings = warnings + 1;
                const log = `${new Date().toLocaleTimeString()}: ${msg} (Strike ${newWarnings}/5)`;
                setProctoringLogs(prev => [log, ...prev]);

                // Show Visual Warning
                setLastWarning(`${msg} (Strike ${newWarnings}/5)`);
                setTimeout(() => setLastWarning(null), 4000); // Hide after 4s

                // SAVE VIOLATION AS EVIDENCE
                window.Utils.saveResponse({
                    studentId: user.id,
                    examType: examMode,
                    evidence: [{ img: null, time: new Date().toISOString(), type: 'VIOLATION_LOG', message: msg }]
                });

                // MODIFIED: Never Lock Exam, just count warnings
                updateLockStatus(newWarnings, false);
                if (newWarnings >= 5) {
                    alert(`Warning: You have reached ${newWarnings} violations! The proctor has been notified.`);
                }
            };

            // 60-Second Auto-Capture Loop (Photos)
            useEffect(() => {
                if (!examMode || isLocked) {
                    if (autoCaptureInterval.current) clearInterval(autoCaptureInterval.current);
                    return;
                }

                autoCaptureInterval.current = setInterval(() => {
                    const video = document.getElementById('student-cam');
                    if (video && video.readyState === 4) {
                        const c = document.createElement('canvas'); c.width = 320; c.height = 240;
                        c.getContext('2d').drawImage(video, 0, 0, c.width, c.height);
                        const img = c.toDataURL('image/jpeg', 0.5);

                        window.Utils.saveResponse({
                            studentId: user.id,
                            examType: examMode,
                            evidence: [{ img, time: new Date().toISOString(), type: 'AUTO_CAPTURE_PHOTO' }]
                        });
                    }
                }, 60000); // MODIFIED: 60 Seconds Interval

                return () => clearInterval(autoCaptureInterval.current);
            }, [examMode, isLocked, user.id]);

            // Full Video Recording Logic (Single Continuous Video with PIP for Viva)
            useEffect(() => {
                // Allow recording for viva even if webcamActive is false (viva manages its own stream)
                const shouldRecord = examMode && !isLocked && (webcamActive || examMode === 'VivaLive' || examMode === 'VivaWait');

                if (!shouldRecord) {
                    if (mediaRecorderRef.current && mediaRecorderRef.current.state === 'recording') {
                        mediaRecorderRef.current.stop();
                        setIsRecording(false);
                    }
                    return;
                }

                const startRecording = async () => {
                    // VIVA MODE: Picture-in-Picture Recording
                    if (examMode === 'VivaLive') {
                        const studentVideo = document.getElementById('student-cam-viva');
                        const assessorVideoElement = document.querySelector('video[autoplay]:not([id])'); // Remote stream video

                        if (!studentVideo || !assessorVideoElement) {
                            console.warn("Viva videos not ready for recording");
                            return;
                        }

                        // Create canvas for compositing
                        const canvas = document.createElement('canvas');
                        canvas.width = 1280;
                        canvas.height = 720;
                        const ctx = canvas.getContext('2d');

                        videoChunksRef.current = [];
                        recordingExamType.current = examMode;

                        // Animation loop to composite both streams
                        let animationId;
                        const drawFrame = () => {
                            // Clear canvas
                            ctx.fillStyle = '#000000';
                            ctx.fillRect(0, 0, 1280, 720);

                            // Draw student video (main, full canvas)
                            if (studentVideo.readyState >= 2) {
                                ctx.save();
                                // Flip horizontally for natural view
                                ctx.scale(-1, 1);
                                ctx.drawImage(studentVideo, -1280, 0, 1280, 720);
                                ctx.restore();
                            }

                            // Draw assessor video (overlay, bottom-right, 20% size)
                            if (assessorVideoElement.readyState >= 2) {
                                const pipWidth = 256;
                                const pipHeight = 144;
                                const pipX = 1280 - pipWidth - 20; // 20px from right
                                const pipY = 720 - pipHeight - 20; // 20px from bottom

                                // Draw border
                                ctx.strokeStyle = '#4F46E5';
                                ctx.lineWidth = 3;
                                ctx.strokeRect(pipX - 2, pipY - 2, pipWidth + 4, pipHeight + 4);

                                // Draw assessor video
                                ctx.drawImage(assessorVideoElement, pipX, pipY, pipWidth, pipHeight);
                            }

                            animationId = requestAnimationFrame(drawFrame);
                        };
                        drawFrame();

                        try {
                            // Capture canvas stream
                            const stream = canvas.captureStream(30); // 30 FPS
                            let options = { mimeType: 'video/webm; codecs=vp8' };
                            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                                console.warn("VP8 not supported, falling back to default webm");
                                options = { mimeType: 'video/webm' };
                            }

                            const recorder = new MediaRecorder(stream, options);
                            recorder.ondataavailable = e => {
                                if (e.data.size > 0) videoChunksRef.current.push(e.data);
                            };

                            recorder.onstop = () => {
                                setIsRecording(false);
                                cancelAnimationFrame(animationId); // Stop animation loop

                                const blob = new Blob(videoChunksRef.current, { type: 'video/webm' });
                                const savedExamType = recordingExamType.current;
                                console.log(`Viva PIP Recording Finalized. Size: ${blob.size} bytes`);

                                const videoKey = `video_${user.id}_${savedExamType}_${Date.now()}`;
                                VideoDB.saveVideo(videoKey, blob).then(() => {
                                    console.log("Viva PIP video saved to IndexedDB:", videoKey);
                                    if (savedExamType) {
                                        window.Utils.saveResponse({
                                            studentId: user.id,
                                            examType: savedExamType,
                                            evidence: [{ img: null, time: new Date().toISOString(), type: 'VIDEO_INDEXED_DB', key: videoKey }]
                                        });
                                        setTimeout(() => window.Utils.uploadToCloud(true), 1000);
                                    }
                                }).catch(err => {
                                    console.error("IndexedDB Save Failed", err);
                                    alert("Video Save Failed: " + err.message);
                                });
                            };

                            recorder.start(1000);
                            mediaRecorderRef.current = recorder;
                            setIsRecording(true);
                            console.log("Viva PIP Recording Started");
                        } catch (e) {
                            console.error("Viva Recording Error", e);
                            cancelAnimationFrame(animationId);
                        }
                    }
                    // REGULAR EXAMS: Student-only recording
                    else {
                        const stream = document.getElementById('student-cam')?.srcObject;
                        if (stream) {
                            videoChunksRef.current = [];
                            recordingExamType.current = examMode;
                            try {
                                let options = { mimeType: 'video/webm; codecs=vp8' };
                                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                                    console.warn("VP8 not supported, falling back to default webm");
                                    options = { mimeType: 'video/webm' };
                                }

                                const recorder = new MediaRecorder(stream, options);
                                recorder.ondataavailable = e => {
                                    if (e.data.size > 0) videoChunksRef.current.push(e.data);
                                };

                                recorder.onstop = () => {
                                    setIsRecording(false);
                                    const blob = new Blob(videoChunksRef.current, { type: 'video/webm' });
                                    const savedExamType = recordingExamType.current;
                                    console.log(`Video Finalized. Size: ${blob.size} bytes. Exam Type: ${savedExamType}`);

                                    const videoKey = `video_${user.id}_${savedExamType}`;
                                    VideoDB.saveVideo(videoKey, blob).then(() => {
                                        console.log("Full Video saved to IndexedDB:", videoKey);
                                        if (savedExamType) {
                                            window.Utils.saveResponse({
                                                studentId: user.id,
                                                examType: savedExamType,
                                                evidence: [{ img: null, time: new Date().toISOString(), type: 'VIDEO_INDEXED_DB', key: videoKey }]
                                            });
                                            setTimeout(() => window.Utils.uploadToCloud(true), 1000);
                                        }
                                    }).catch(err => {
                                        console.error("IndexedDB Save Failed", err);
                                        alert("Video Save Failed: " + err.message);
                                    });
                                };

                                recorder.start(1000);
                                mediaRecorderRef.current = recorder;
                                setIsRecording(true);
                            } catch (e) {
                                console.error("MediaRecorder Error", e);
                            }
                        }
                    }
                };

                // Poll stream start
                const attemptStart = setInterval(() => {
                    if (examMode === 'VivaLive') {
                        // For viva, wait for both video elements to be ready
                        const studentVideo = document.getElementById('student-cam-viva');
                        const assessorVideo = document.querySelector('video[autoplay]:not([id])');
                        if (studentVideo?.srcObject && assessorVideo?.srcObject) {
                            clearInterval(attemptStart);
                            startRecording();
                        }
                    } else {
                        // For regular exams, wait for student camera
                        const stream = document.getElementById('student-cam')?.srcObject;
                        if (stream && stream.active) {
                            clearInterval(attemptStart);
                            startRecording();
                        } else if (!examMode || isLocked) {
                            clearInterval(attemptStart);
                        }
                    }
                }, 500);

                return () => clearInterval(attemptStart);
            }, [examMode, webcamActive, isLocked, remoteStream]);

            // Security: Block Right Click, Copy, Paste
            useEffect(() => {
                if (!examMode || isLocked) return;

                const preventDefault = (e) => {
                    e.preventDefault();
                    // Optional: logViolation("Action Blocked"); // Can be too noisy
                };

                const blockCopyPaste = (e) => {
                    e.preventDefault();
                    // logViolation("Copy/Paste Attempted");
                    alert("Copy/Paste is disabled during the exam!");
                };

                document.addEventListener('contextmenu', preventDefault);
                document.addEventListener('copy', blockCopyPaste);
                document.addEventListener('cut', blockCopyPaste);
                document.addEventListener('paste', blockCopyPaste);
                document.addEventListener('selectstart', preventDefault); // Block Selection

                return () => {
                    document.removeEventListener('contextmenu', preventDefault);
                    document.removeEventListener('copy', blockCopyPaste);
                    document.removeEventListener('cut', blockCopyPaste);
                    document.removeEventListener('paste', blockCopyPaste);
                    document.removeEventListener('selectstart', preventDefault);
                };
            }, [examMode, isLocked]);

            useEffect(() => {
                if (examMode === 'VivaLive') {
                    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                        const v = document.getElementById('student-cam-viva');
                        if (v) v.srcObject = stream;
                    });
                }
            }, [examMode]);
            useEffect(() => {
                if (!examMode || isLocked) return;

                // DISABLE PROCTORING FOR VIVA (To allow 2-tab simulation)
                if (examMode === 'VivaWait' || examMode === 'VivaLive') return;

                const handleVisibility = () => {
                    if (document.hidden) {
                        logViolation("Tab Switch / Minimized Browser");
                    }
                };

                document.addEventListener('visibilitychange', handleVisibility);
                return () => document.removeEventListener('visibilitychange', handleVisibility);
            }, [examMode, isLocked, warnings]);

            // Object Detection Loop
            useEffect(() => {
                if (!examMode || !webcamActive || isLocked || !proctoringModel) {
                    if (detectionInterval.current) clearInterval(detectionInterval.current);
                    return;
                }

                let tick = 0;
                detectionInterval.current = setInterval(async () => {
                    tick++;
                    const video = document.getElementById('student-cam');
                    if (video && video.readyState === 4) {
                        const predictions = await proctoringModel.detect(video);

                        // Check for Mobile Phone
                        const hasPhone = predictions.some(p => p.class === 'cell phone' || p.class === 'remote'); // cell phone usually
                        if (hasPhone) {
                            logViolation("Mobile Device Detected");
                            // Capture Violation Evidence
                            const c = document.createElement('canvas'); c.width = 300; c.height = 200;
                            c.getContext('2d').drawImage(video, 0, 0, 300, 200);
                            window.Utils.saveResponse({
                                studentId: user.id, examType: examMode,
                                evidence: [{ img: c.toDataURL(), time: new Date().toISOString(), type: 'VIOLATION_PHONE' }]
                            });
                        }

                        // Check for Person Count
                        const personCount = predictions.filter(p => p.class === 'person').length;
                        if (personCount > 1) {
                            logViolation("Multiple Persons Detected");
                            // Capture Violation Evidence
                            const c = document.createElement('canvas'); c.width = 300; c.height = 200;
                            c.getContext('2d').drawImage(video, 0, 0, 300, 200);
                            window.Utils.saveResponse({
                                studentId: user.id, examType: examMode,
                                evidence: [{ img: c.toDataURL(), time: new Date().toISOString(), type: 'VIOLATION_MULTIPLE_PERSONS' }]
                            });
                        }

                        // PERIODIC SNAPSHOT (Every ~1 minute = 20 ticks of 3000ms)
                        if (tick % 20 === 0) {
                            const c = document.createElement('canvas'); c.width = 300; c.height = 200;
                            c.getContext('2d').drawImage(video, 0, 0, 300, 200);
                            window.Utils.saveResponse({
                                studentId: user.id, examType: examMode,
                                evidence: [{ img: c.toDataURL(), time: new Date().toISOString(), type: 'AUTO_SNAPSHOT' }]
                            });
                        }
                    }
                }, 3000); // Check every 3 seconds

                return () => clearInterval(detectionInterval.current);
            }, [examMode, webcamActive, isLocked, proctoringModel, warnings]);

            useEffect(() => {
                let interval;
                if (examMode && timeLeft > 0) interval = setInterval(() => setTimeLeft(t => t - 1), 1000);
                return () => clearInterval(interval);
            }, [examMode, timeLeft]);

            const startExam = async (mode) => {
                let batch = window.Utils.getBatches().find(b => b.id === user.batchId);

                if (!batch) {
                    alert('Exam Error: Your assigned Batch was not found.\nPlease contact Admin to re-assign/update.');
                    return;
                }

                // Helper to parse potential DD/MM/YYYY or YYYY-MM-DD
                const parseDateTime = (dateStr, timeStr) => {
                    if (!dateStr || !timeStr) return null;
                    let d = new Date(`${dateStr}T${timeStr}`);
                    if (isNaN(d.getTime())) {
                        if (dateStr.includes('/')) {
                            const parts = dateStr.split('/');
                            if (parts.length === 3) {
                                d = new Date(`${parts[2]}-${parts[1]}-${parts[0]}T${timeStr}`);
                            }
                        }
                    }
                    return d;
                };

                const checkExpiry = (b) => {
                    if (!b.startDate || !b.startTime || !b.endDate || !b.endTime) return 'OK';
                    const now = new Date();
                    const start = parseDateTime(b.startDate, b.startTime);
                    const end = parseDateTime(b.endDate, b.endTime);
                    if (!start || !end) return 'ERROR';
                    if (now < start) return { status: 'FUTURE', time: start };
                    if (now > end) return { status: 'EXPIRED', time: end };
                    return 'OK';
                };

                let status = checkExpiry(batch);

                // AUTO-HEAL: If expired, try syncing once in case it's stale data
                if (status && status.status === 'EXPIRED') {
                    const btn = document.getElementById('sync-status-text');
                    if (btn) btn.innerText = "Verifying Date...";

                    try {
                        await window.Utils.downloadFromCloud(true);
                        // Re-fetch batch
                        batch = window.Utils.getBatches().find(b => b.id === user.batchId);
                        status = checkExpiry(batch);

                        alert(`Auto-Sync Completed.\nNew End Date: ${batch.endDate} ${batch.endTime}\nStatus: ${status === 'OK' ? 'Active' : status.status}`);

                    } catch (e) {
                        console.error("Auto-heal sync failed", e);
                        alert(`Auto-Sync Failed: ${e.message}\nPlease check internet connection.`);
                    }
                }

                if (status === 'ERROR') {
                    alert("Date Error: Invalid Date Format in Batch settings.");
                    return;
                }
                if (status && status.status === 'FUTURE') {
                    alert(`Exam has not started yet.\nStart Time: ${status.time.toLocaleString()}`);
                    return;
                }
                if (status && status.status === 'EXPIRED') {
                    alert(`Exam has expired.\nEnd Time: ${status.time.toLocaleString()}`);
                    return;
                }

                const pid = mode === 'Theory' ? batch.theoryPaperId : batch.practicalPaperId;
                console.log(`Starting ${mode}: Batch=${batch.name}, AssignedID=${pid}, AvailableQPs=${window.Utils.getQuestionPapers().length}`);

                let qp = window.Utils.getQuestionPapers().find(q => String(q.id) === String(pid));

                // AUTO-HEAL 2: QP Missing? Try Syncing.
                if (!qp) {
                    const btn = document.getElementById('sync-status-text');
                    if (btn) btn.innerText = "Fetching Exam Paper...";
                    try {
                        await window.Utils.downloadFromCloud(true);
                        qp = window.Utils.getQuestionPapers().find(q => String(q.id) === String(pid));
                    } catch (e) {
                        console.error("Auto-heal QP sync failed", e);
                    }
                }

                if (qp) {
                    setQuestions(qp.questions);
                    setTimeLeft(qp.totalTime * 60);
                    setExamMode(mode);
                    setWebcamActive(true);
                    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
                        document.getElementById('student-cam').srcObject = stream;
                    });
                } else {
                    alert(`Exam Error: The Question Paper (ID: ${pid}) assigned to this batch was not found.\nPlease contact Admin to Assign QP and Sync.`);
                }
            };

            const [isSubmitting, setIsSubmitting] = useState(false);

            const submitExam = async () => {
                if (isSubmitting) return;
                setIsSubmitting(true);

                // Capture final image (Safe Mode)
                let finalEvidence = [];
                try {
                    const v = document.getElementById('student-cam');
                    if (v && v.readyState === 4) { // HAVE_ENOUGH_DATA
                        const c = document.createElement('canvas'); c.width = 300; c.height = 200;
                        c.getContext('2d').drawImage(v, 0, 0, 300, 200);
                        finalEvidence.push({ img: c.toDataURL(), time: new Date().toISOString(), type: 'SUBMISSION' });
                    }
                } catch (e) {
                    console.error("Final Capture Failed", e);
                }

                // Calculate Auto-Grades (Initial System Grading)
                const autoGrades = {};
                questions.forEach((q, idx) => {
                    if (q.questionType !== 'CODING' && q.questionType !== 'PRACTICAL' && q.questionType !== 'VIVA') {
                        // Exact String Match (Case-Insensitive Trimmed)
                        const studentAns = String(answers[idx] || '').trim().toLowerCase();
                        const correctAns = String(q.correctAnswer || '').trim().toLowerCase();
                        if (studentAns && studentAns === correctAns) {
                            autoGrades[idx] = q.totalMarks;
                        } else {
                            autoGrades[idx] = 0;
                        }
                    } else {
                        // For Coding/Practical, leave as 0 or undefined for Manual Grading
                        autoGrades[idx] = 0;
                    }
                });

                const respObj = {
                    studentId: user.id,
                    examType: examMode,
                    answers,
                    assessorMarks: autoGrades, // Pre-fill with system grades
                    evidence: finalEvidence
                };

                // AUTO-UPLOAD: Attempt to sync immediately
                try {
                    const statusBtn = document.getElementById('sync-status-text');
                    if (statusBtn) statusBtn.innerText = "Uploading Answer...";

                    await window.Utils.saveResponse(respObj);

                    // Small delay to ensure UI updates
                    await new Promise(r => setTimeout(r, 100));
                    await window.Utils.uploadToCloud(true);

                    alert('Submitted and Synced to Cloud Successfully!');
                } catch (e) {
                    console.error(e);
                    alert('Submitted Locally! (Upload Failed. Please click "Upload" button manually)');
                }

                setExamMode(null);
                setWebcamActive(false);
                setIsSubmitting(false);
            };


            if (examMode) {
                if (isLocked) return (
                    <div className="flex h-screen fixed inset-0 z-50 bg-red-50 flex-col items-center justify-center text-center p-8 box-border">
                        <Icons.Lock className="w-24 h-24 text-red-600 mb-6" />
                        <h1 className="text-4xl font-bold text-red-700 mb-4">Exam Locked</h1>
                        <p className="text-xl text-gray-700 mb-8">You have exceeded the maximum number of warnings (5/5).<br />Please contact your Assessor to unlock your exam.</p>
                        <div className="bg-white p-6 rounded shadow max-w-md w-full text-left">
                            <h3 className="font-bold mb-2">Violation Log:</h3>
                            <ul className="text-sm text-red-600 list-disc pl-5 max-h-48 overflow-y-auto">
                                {proctoringLogs.map((l, i) => <li key={i}>{l}</li>)}
                            </ul>
                        </div>
                    </div>
                );

                if (examMode === 'VivaWait') return (
                    <div className="flex h-screen fixed inset-0 z-50 bg-gray-900 flex-col items-center justify-center text-center p-8 box-border text-white animate-fade-in">
                        <div className="w-32 h-32 bg-gray-800 rounded-full flex items-center justify-center mb-8 border-4 border-indigo-500 shadow-[0_0_20px_rgba(99,102,241,0.5)] animate-pulse">
                            <Icons.Video className="w-16 h-16 text-indigo-400" />
                        </div>
                        <h1 className="text-4xl font-bold mb-4 tracking-tight">Waiting for Host</h1>
                        <p className="text-xl text-gray-400 mb-8 max-w-md">Please wait here. The assessor will admit you to the Viva session shortly.</p>
                        <div className="bg-gray-800 p-2 rounded text-xs px-4 mb-4 font-mono text-gray-500">
                            Room: {`${user.batchId}_${user.id}`}
                        </div>
                        <div className="flex gap-2 justify-center mb-12">
                            <div className="w-3 h-3 bg-white rounded-full animate-bounce delay-0"></div>
                            <div className="w-3 h-3 bg-white rounded-full animate-bounce delay-100"></div>
                            <div className="w-3 h-3 bg-white rounded-full animate-bounce delay-200"></div>
                        </div>
                        <div className="flex gap-4">
                            <button onClick={() => setExamMode('VivaLive')} className="px-6 py-2 bg-indigo-600 rounded-lg text-white hover:bg-indigo-700 transition-colors text-sm font-bold">
                                Join Now (Force)
                            </button>
                            <button onClick={() => setExamMode(null)} className="px-6 py-2 border border-gray-600 rounded-lg text-gray-400 hover:text-white hover:border-gray-400 transition-colors text-sm">
                                Leave Waiting Room
                            </button>
                        </div>
                    </div>
                );

                if (examMode === 'VivaLive') return (
                    <div className="flex h-screen fixed inset-0 z-50 bg-black flex-col animate-fade-in">
                        <div className="flex-1 relative">
                            {/* Assessor Feed (Center) */}
                            {remoteStream ? (
                                <video
                                    ref={ref => { if (ref && remoteStream) ref.srcObject = remoteStream }}
                                    autoPlay
                                    className="absolute inset-0 w-full h-full object-contain bg-black"
                                />
                            ) : (
                                <div className="absolute inset-0 flex items-center justify-center">
                                    <div className="text-center text-gray-500">
                                        <div className="w-24 h-24 mx-auto mb-4 rounded-full bg-gray-800 flex items-center justify-center animate-pulse">
                                            <Icons.Video className="w-12 h-12 text-gray-600" />
                                        </div>
                                        <h2 className="text-2xl font-bold text-gray-400">Connecting to Assessor...</h2>
                                        <p className="text-sm">Please wait for the video stream.</p>
                                    </div>
                                </div>
                            )}

                            {/* Student Self-View (Bottom Right) */}
                            <div className="absolute bottom-6 right-6 w-48 h-36 bg-gray-900 rounded-lg border-2 border-gray-700 shadow-xl overflow-hidden">
                                <video id="student-cam-viva" autoPlay muted className="w-full h-full object-cover transform scale-x-[-1]" />
                            </div>

                            {/* Controls */}
                            <div className="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex gap-6 bg-gray-900/80 backdrop-blur-md px-8 py-3 rounded-full border border-gray-700">
                                <div className="p-3 rounded-full bg-gray-700 text-white"><Icons.Microphone className="w-6 h-6" /></div>
                                <div className="p-3 rounded-full bg-gray-700 text-white"><Icons.Video className="w-6 h-6" /></div>
                                <button onClick={() => setExamMode(null)} className="p-3 rounded-full bg-red-600 text-white hover:bg-red-700"><Icons.PhoneMissed className="w-6 h-6" /></button>
                            </div>
                        </div>
                    </div>
                );

                return (
                    <div className="flex h-screen fixed inset-0 z-50 bg-white">
                        <div className="w-3/4 p-8 overflow-y-auto">
                            <div className="flex justify-between mb-4">
                                <h2 className="font-bold text-xl">Exam: {examMode}</h2>
                                <div className="flex items-center gap-4">
                                    <div className={`px-4 py-1 rounded font-bold ${warnings > 2 ? 'bg-red-100 text-red-700' : (warnings > 0 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700')}`}>
                                        Warnings: {warnings}/5
                                    </div>
                                    <div className="font-mono text-xl">{Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}</div>
                                </div>
                            </div>
                            {lastWarning && (
                                <div className="bg-red-600 text-white p-4 rounded shadow-lg mb-6 text-center font-bold text-lg animate-pulse flex items-center justify-center">
                                    <Icons.TriangleAlert className="inline w-8 h-8 mr-3" />
                                    <span>WARNING: {lastWarning}</span>
                                </div>
                            )}
                            {questions[currentQ] && (
                                <div>
                                    <h3 className="text-lg font-medium mb-4">Q{currentQ + 1}: {questions[currentQ].question}</h3>
                                    {questions[currentQ].questionType === 'CODING' ? (
                                        <div className="h-[500px] mb-4">
                                            <CodeRunner
                                                code={answers[currentQ] || ''}
                                                onChange={val => setAnswers({ ...answers, [currentQ]: val })}
                                            />
                                        </div>
                                    ) : (questions[currentQ].questionType === 'PRACTICAL' || questions[currentQ].questionType === 'VIVA') ? (
                                        <PracticalQuestionRunner
                                            question={questions[currentQ]}
                                            answer={answers[currentQ] || {}}
                                            onAnswer={val => setAnswers({ ...answers, [currentQ]: val })}
                                        />
                                    ) : (
                                        <div className="space-y-2">
                                            {questions[currentQ].options.map(o => (
                                                <button key={o} onClick={() => setAnswers({ ...answers, [currentQ]: o })}
                                                    className={`w-full text-left p-3 border rounded ${answers[currentQ] === o ? 'bg-indigo-100 border-indigo-500' : ''}`}>{o}</button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                            <div className="mt-6 flex justify-between">
                                <button disabled={currentQ === 0} onClick={() => setCurrentQ(c => c - 1)} className="px-4 py-2 border rounded">Prev</button>
                                {currentQ < questions.length - 1 ?
                                    <button onClick={() => setCurrentQ(c => c + 1)} className="px-4 py-2 bg-indigo-600 text-white rounded">Next</button> :
                                    <button onClick={submitExam} disabled={isSubmitting} className={`px-4 py-2 text-white rounded flex items-center gap-2 ${isSubmitting ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'}`}>
                                        {isSubmitting && <Icons.Loader className="w-4 h-4 animate-spin" />}
                                        {isSubmitting ? 'Submitting...' : 'Submit Exam'}
                                    </button>
                                }
                            </div>
                        </div>
                        <div className="w-1/4 bg-gray-100 p-4 border-l">
                            <video id="student-cam" autoPlay muted playsInline className="w-full bg-black rounded mb-2"></video>
                            <div className="grid grid-cols-4 gap-2">
                                {questions.map((_, i) => <div key={i} onClick={() => setCurrentQ(i)} className={`h-8 flex items-center justify-center cursor-pointer rounded ${answers[i] ? 'bg-green-200' : 'bg-white'}`}>{i + 1}</div>)}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="p-8">
                    <h2 className="text-2xl font-bold mb-6">Student Portal</h2>
                    <div className="grid gap-6 md:grid-cols-2">
                        <div onClick={() => startExam('Theory')} className="bg-white p-8 rounded shadow cursor-pointer hover:shadow-lg border-l-4 border-indigo-600">
                            <h3 className="text-xl font-bold text-indigo-900">Theory Exam</h3>
                            <p className="text-gray-500">Multiple choice questions</p>
                            <button className="mt-4 bg-indigo-600 text-white px-4 py-2 rounded">Start</button>
                        </div>
                        <div onClick={() => startExam('Practical')} className="bg-white p-8 rounded shadow cursor-pointer hover:shadow-lg border-l-4 border-purple-600">
                            <h3 className="text-xl font-bold text-purple-900">Practical Exam</h3>
                            <p className="text-gray-500">Coding challenges</p>
                            <button className="mt-4 bg-purple-600 text-white px-4 py-2 rounded">Start</button>
                        </div>

                        <div onClick={() => setExamMode('VivaWait')} className="bg-white p-8 rounded shadow cursor-pointer hover:shadow-lg border-l-4 border-green-500">
                            <h3 className="text-xl font-bold text-green-700">Live Viva</h3>
                            <p className="text-gray-500">Join the live video assessment</p>
                            <button className="mt-4 bg-green-600 text-white px-4 py-2 rounded flex items-center gap-2"><Icons.Video className="w-4 h-4" /> Join Session</button>
                        </div>
                    </div>
                </div>
            );
        };

        // ASSESSOR PORTAL
        const AssessorPortal = ({ user }) => {
            const [view, setView] = useState('dashboard'); // dashboard, batches, students, exam_type, capture
            const [flowMode, setFlowMode] = useState('MANUAL'); // 'MANUAL' or 'VIVA'

            // Workflow State
            const [selectedBatch, setSelectedBatch] = useState(null);
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [selectedExamType, setSelectedExamType] = useState(null);

            // Data
            const [batches, setBatches] = useState([]);
            const [batchStudents, setBatchStudents] = useState([]);
            const [allQPapers, setAllQPapers] = useState([]);
            const [showVivaLobby, setShowVivaLobby] = useState(false);

            useEffect(() => {
                // Initialize Data
                setBatches(window.Utils.getBatches());
                setAllQPapers(window.Utils.getQuestionPapers());
            }, []);

            // Effect to load students when batch changes
            useEffect(() => {
                if (selectedBatch) {
                    setBatchStudents(window.Utils.getStudentsByBatch(selectedBatch.id));
                }
            }, [selectedBatch]);

            if (showVivaLobby) return <VivaLobby batch={selectedBatch || user} onClose={() => setShowVivaLobby(false)} />;

            // VIEW 1: DASHBOARD
            if (view === 'dashboard') {
                return (
                    <div className="p-8">
                        <h2 className="text-2xl font-bold mb-6">Assessor Dashboard</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <button onClick={() => { setFlowMode('MANUAL'); setView('batches'); }} className="h-48 bg-white rounded shadow hover:shadow-xl transition-all border-l-8 border-indigo-600 flex flex-col items-center justify-center gap-4 group">
                                <div className="bg-indigo-100 p-4 rounded-full group-hover:bg-indigo-200 transition-colors">
                                    <Icons.FileText className="w-12 h-12 text-indigo-700" />
                                </div>
                                <div className="text-center">
                                    <h3 className="text-xl font-bold text-gray-800">Capture Evidence</h3>
                                    <p className="text-gray-500">Capture photos & videos</p>
                                </div>
                            </button>

                            <button onClick={() => { setFlowMode('VIVA'); setView('batches'); }} className="h-48 bg-white rounded shadow hover:shadow-xl transition-all border-l-8 border-green-600 flex flex-col items-center justify-center gap-4 group">
                                <div className="bg-green-100 p-4 rounded-full group-hover:bg-green-200 transition-colors">
                                    <Icons.Video className="w-12 h-12 text-green-700" />
                                </div>
                                <div className="text-center">
                                    <h3 className="text-xl font-bold text-gray-800">Live Viva Lobby</h3>
                                    <p className="text-gray-500">Join virtual assessment room</p>
                                </div>
                            </button>
                        </div>
                    </div>
                );
            }

            // VIEW 2: SELECT BATCH (Common for both flows)
            if (view === 'batches') {
                return (
                    <div className="p-8">
                        <button onClick={() => setView('dashboard')} className="mb-6 text-gray-500 hover:text-gray-800 flex items-center gap-1 font-bold text-lg">&larr; Back to Dashboard</button>
                        <h2 className="text-2xl font-bold mb-6">Select Batch for {flowMode === 'MANUAL' ? 'Capture Evidence' : 'Viva'}</h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            {batches.map(batch => (
                                <div key={batch.id} onClick={() => {
                                    setSelectedBatch(batch);
                                    if (flowMode === 'MANUAL') setView('students'); // Manual: Batch -> Student
                                    else { setShowVivaLobby(true); } // Viva: Batch -> Lobby (Zoom)
                                }}
                                    className="bg-white p-6 rounded shadow cursor-pointer hover:border-indigo-500 border-2 border-transparent transition-all">
                                    <h3 className="font-bold text-lg mb-1">{String(batch.name)}</h3>
                                    <p className="text-xs text-gray-500 mb-4">ID: {String(batch.batchId || batch.id)}</p>
                                    <div className="flex items-center gap-2 text-sm text-gray-600">
                                        <span>{window.Utils.getStudentsByBatch(batch.id).length} Students</span>
                                    </div>
                                </div>
                            ))}
                            {batches.length === 0 && <p className="text-gray-500">No batches found.</p>}
                        </div>
                    </div>
                );
            }

            // VIEW 3: SELECT STUDENT (Moved before Exam Type as requested)
            if (view === 'students') {
                return (
                    <div className="p-8">
                        <button onClick={() => setView('batches')} className="mb-6 text-gray-500 hover:text-gray-800 flex items-center gap-1 font-bold text-lg">&larr; Back to Batches</button>
                        <h2 className="text-2xl font-bold mb-2">Select Student</h2>
                        <div className="flex gap-2 mb-6 text-sm">
                            <span className="bg-gray-200 px-2 py-1 rounded text-gray-700">{selectedBatch.name}</span>
                        </div>

                        <div className="bg-white rounded shadow text-sm">
                            <div className="p-4 border-b font-bold bg-gray-50 flex justify-between">
                                <span>Student Name</span>
                                <span>Action</span>
                            </div>
                            {batchStudents.map(s => (
                                <div key={s.id} onClick={() => { setSelectedStudent(s); setView('exam_type'); }}
                                    className="p-4 border-b hover:bg-indigo-50 cursor-pointer flex justify-between items-center group transition-colors">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center font-bold group-hover:bg-indigo-200 group-hover:text-indigo-700 transition-colors">
                                            {s.name.charAt(0)}
                                        </div>
                                        <div>
                                            <p className="font-medium">{s.name}</p>
                                            <p className="text-xs text-gray-400">{s.username}</p>
                                        </div>
                                    </div>
                                    <span className="text-indigo-600 font-bold opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">
                                        <Icons.ChevronRight className="w-4 h-4" /> Select
                                    </span>
                                </div>
                            ))}
                            {batchStudents.length === 0 && <p className="p-8 text-center text-gray-500">No students found in this batch.</p>}
                        </div>
                    </div>
                );
            }

            // VIEW 4: SELECT EXAM TYPE (Moved after Student as requested)
            if (view === 'exam_type') {
                return (
                    <div className="p-8">
                        <button onClick={() => setView('students')} className="mb-6 text-gray-500 hover:text-gray-800 flex items-center gap-1 font-bold text-lg">&larr; Back to Students</button>
                        <h2 className="text-2xl font-bold mb-2">Select Assessment Type</h2>
                        <div className="flex gap-2 mb-6 text-sm">
                            <span className="bg-gray-200 px-2 py-1 rounded text-gray-700">{selectedBatch.name}</span>
                            <span className="bg-indigo-100 text-indigo-700 px-2 py-1 rounded font-bold">{selectedStudent.name}</span>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {['Photo', 'Viva'].map(type => (
                                <button key={type} onClick={() => { setSelectedExamType(type); setView('capture'); }}
                                    className="bg-white p-8 rounded shadow hover:shadow-lg transition-all text-left group border-t-4 border-indigo-500">
                                    <h3 className="text-xl font-bold group-hover:text-indigo-600 transition-colors mb-2">{type === 'Photo' ? 'General Photo / Evidence' : type}</h3>
                                    <p className="text-sm text-gray-500">Capture evidence for {type}.</p>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            // VIEW 5: CAPTURE INTERFACE (StudentGradingView)
            if (view === 'capture') {
                return (
                    <div className="p-8">
                        <StudentGradingView
                            student={selectedStudent}
                            batch={selectedBatch}
                            examType={selectedExamType}
                            allQPapers={allQPapers}
                            onBack={() => setView('exam_type')}
                            captureOnly={true} // Hide grading controls
                        />
                    </div>
                );
            }

            return <div>Unknown View</div>;
        };


        // MAIN APP
        const App = () => {
            const [user, setUser] = useState(null);

            // AUTO-DOWNLOAD ON START (Silent) & PERIODIC SYNC
            useEffect(() => {
                const initSync = async () => {
                    if (navigator.onLine) {
                        try {
                            console.log("Initial Auto-Sync...");
                            await window.Utils.downloadFromCloud(true);
                        } catch (e) { console.error("Initial Sync Failed", e); }
                    }
                };
                initSync();

                // Periodic Poll for Updates (Every 20 seconds) - Dynamic Data
                const pollInterval = setInterval(async () => {
                    if (navigator.onLine) {
                        try {
                            // console.log("Background Polling..."); // Too noisy
                            await window.Utils.downloadFromCloud(true);
                        } catch (e) { }
                    }
                }, 20000);

                return () => clearInterval(pollInterval);
            }, []);

            // Real-Time Socket Sync
            useEffect(() => {
                const handleDataChange = async () => {
                    console.log("Remote Data Change Detected -> Auto-Syncing...");
                    if (navigator.onLine) {
                        try {
                            await window.Utils.downloadFromCloud(true);
                            // Optional: Force re-render if needed, but Utils updates localStorage
                            // and components using localStorage or listeners will update.
                            window.dispatchEvent(new Event('cloud-sync-complete'));
                        } catch (e) {
                            console.error("Auto-Sync Failed", e);
                        }
                    }
                };

                socket.on('data-change', handleDataChange);

                return () => {
                    socket.off('data-change', handleDataChange);
                };
            }, []);
            // useEffect(() => { if (window.lucide) window.lucide.createIcons(); }); // REMOVED: Managed by LucideIcon
            if (!user) return <LoginScreen onLogin={setUser} />;
            return (
                <div className="min-h-screen bg-slate-50">
                    <header className="bg-white shadow-sm border-b px-8 py-4 flex justify-between items-center">
                        <div className="flex items-center gap-2 font-bold text-xl text-gray-800">
                            <div className="bg-indigo-600 text-white rounded p-1">N</div> NSXpertise
                        </div>
                        <div className="flex gap-4 items-center">
                            {/* GLOBAL CLOUD SYNC */}
                            <div className="flex items-center gap-2 bg-gray-50 rounded-lg p-1 border">
                                <button onClick={() => window.Utils.uploadToCloud()} className="p-1 px-2 text-blue-600 hover:bg-blue-100 rounded text-xs font-bold flex items-center gap-1" title="Upload to Cloud">
                                    <Icons.Upload className="w-4 h-4" /> Upload
                                </button>
                                <div className="w-px h-4 bg-gray-300"></div>
                                <button onClick={() => window.Utils.downloadFromCloud()} className="p-1 px-2 text-green-600 hover:bg-green-100 rounded text-xs font-bold flex items-center gap-1" title="Download from Cloud">
                                    <Icons.Download className="w-4 h-4" /> Download
                                </button>
                            </div>

                            <span className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold uppercase">{user.role}</span>
                            <button onClick={() => setUser(null)} className="text-gray-500 hover:text-red-600 text-sm">Logout</button>
                        </div>
                    </header>
                    <main>
                        <ErrorBoundary>
                            {user.role === 'admin' && <AdminDashboard />}
                            {user.role === 'student' && <StudentPortal user={user} />}
                            {user.role === 'assessor' && <AssessorPortal user={user} />}
                        </ErrorBoundary>
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>